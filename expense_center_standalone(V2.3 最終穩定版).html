<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGB è²»ç”¨ç®¡ç†ä¸­å¿ƒ - ç¨ç«‹æ¨¡çµ„ (V2.3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#10497E',
                        'secondary-gray': '#F7F9FB',
                        'accent-orange': '#FF7A00',
                        'status-draft': '#9CA3AF', /* Gray-400 */
                        'status-pending': '#F97316', /* Orange-500 */
                        'status-approved': '#10B981', /* Green-500 */
                        'status-rejected': '#EF4444', /* Red-500 */

                        /* çµ±ä¸€æ¨£å¼ï¼šç”¨æ–¼æ–°è¡¨å–®çš„é¡è‰² */
                        'primary-indigo': '#10497E',
                        'light-indigo': '#E0F2FE',
                        'compliance-yellow': '#FFFBEB', /* Yellow-50 */
                        'compliance-yellow-text': '#B45309', /* Amber-700 */
                        'compliance-yellow-border': '#FDE68A', /* Amber-200 */
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <style>
        .claim-row { cursor: pointer; transition: background-color 0.2s; }
        .claim-row:hover:not(.active) { background-color: #f3f4f6; }
        .claim-row.active { background-color: #E0F2F1; border-left: 4px solid theme('colors.primary-blue'); }
        .view-switch-btn.active { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transform: translateY(-2px); }

        #messageBox.hidden { display: none !important; }
        #messageBox.flex { display: flex !important; }

        .kpi-card { transition: transform 0.2s, box-shadow 0.2s; }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<script>
    // åˆå§‹åŒ– Chart.js å¯¦ä¾‹çš„è®Šæ•¸ (é ‚å±¤)
    const chartInstances = {
        cashFlow: null, expense: null, inventoryValue: null, purchaseCategory: null,
        workOrderStatus: null, employeeDistribution: null, salesFunnel: null,
        profitTrend: null, balanceAnalysis: null, projectType: null
    };

    const moduleTitles = {
        'finance-module-view': ['è²¡å‹™ç®¡ç† (Finance)', 'å³æ™‚ç¾é‡‘æµèˆ‡è²»ç”¨ç¸½è¦½'],
        'scm-module-view': ['ä¾›æ‡‰éˆç®¡ç† (SCM)', 'æ¡è³¼ã€åº«å­˜å’Œä¾›æ‡‰å•†ç¸¾æ•ˆæ¦‚è¦½'],
        'manufacturing-module-view': ['ç”Ÿç”¢è£½é€  (Manufacturing)', 'OEEã€å·¥å–®ç‹€æ…‹å’Œç”¢èƒ½ç›£æ§'],
        'hr-module-view': ['äººåŠ›è³‡æº (HR)', 'å“¡å·¥ã€è–ªé…¬èˆ‡é›¢è·ç‡åˆ†æ'],
        'crm-module-view': ['å®¢æˆ¶é—œä¿‚ç®¡ç† (CRM)', 'éŠ·å”®æ¼æ–—ã€è½‰æ›ç‡å’Œå®¢æˆ¶æœå‹™'],
        'bi-module-view': ['å•†æ¥­æ™ºæ…§ (BI)', 'è·¨éƒ¨é–€ç­–ç•¥æ•¸æ“šåˆ†æèˆ‡é æ¸¬'],
        'project-mgmt-module-view': ['å°ˆæ¡ˆç®¡ç† (Project Mgmt)', 'å°ˆæ¡ˆé€²åº¦ã€è³‡æºå’Œé ç®—å¥åº·åº¦'],
        'wms-module-view': ['å€‰å„²ç®¡ç† (WMS)', 'åº«å­˜æ°´ä½ã€å„²ä½å’Œå‡ºå…¥åº«ä½œæ¥­æ•ˆç‡'],
        'general-ledger-view': ['ç¸½å¸³æ˜ç´° (General Ledger)', 'æ‰€æœ‰å€Ÿè²¸åˆ†éŒ„çš„è©³ç´°æ¸…å–®'],
        'fixed-assets-view': ['å›ºå®šè³‡ç”¢ (Fixed Assets)', 'è¿½è¹¤è³‡ç”¢å£½å‘½ã€æŠ˜èˆŠè¨ˆç®—å’Œç¶­è­·æ’ç¨‹'],
        'accounts-receivable-view': ['æ‡‰æ”¶å¸³æ¬¾ (Accounts Receivable)', 'è¿½è¹¤å®¢æˆ¶æœªä»˜æ¬¾é …å’Œæ§åˆ¶ä¿¡ç”¨é¡åº¦'],
        'accounts-payable-view': ['æ‡‰ä»˜å¸³æ¬¾ (Accounts Payable)', 'ç®¡ç†ä¾›æ‡‰å•†ç™¼ç¥¨ã€æ”¯ä»˜æ™‚ç¨‹å’Œç¾é‡‘æµé æ¸¬'],
        'api-docs-view': ['API æ–‡ä»¶/æ¸¬è©¦ (FastAPI)', 'å¾Œç«¯æœå‹™æ–‡ä»¶èˆ‡æ¸¬è©¦ä»‹é¢'],
        'single-expense-view': ['å–®ç­†è²»ç”¨ç”³å ±', 'å¿«é€Ÿå¡«å¯«ä¸¦ç”Ÿæˆå ±éŠ·è‰ç¨¿']
    };

    // â˜…â˜…â˜… æ–°å¢ï¼šæ¨¡æ“¬å ±éŠ·å–®æ•¸æ“š (ç”¨æ–¼å–®ç­†è²»ç”¨ç”³å ±) â˜…â˜…â˜…
    let mockClaims = [
        { id: 101, title: "2025å¹´11æœˆå®¢æˆ¶æ‹œè¨ªè²»ç”¨", total: 7350, date: "2025-10-25", status: "Pending", projectId: 'P2025-5',
          purpose: "æ‹œè¨ªå°åŒ—é‡è¦å®¢æˆ¶ï¼Œè¨è«–å¹´åº¦åˆä½œæ–¹æ¡ˆã€‚",
          details: ["äº¤é€šè²»: TWD 3,000", "é¤é£²è²»: TWD 850", "ä½å®¿è²»: TWD 3,500"],
          approverNotes: "", accountCode: "åœ‹å…§å·®æ—…è²» (Domestic)" },

        { id: 102, title: "è¾¦å…¬å®¤ç”¨å“æ¡è³¼", total: 1200, date: "2025-10-24", status: "Draft", projectId: 'None',
          purpose: "è³¼è²·å½±å°ç´™å’Œå¢¨æ°´ã€‚",
          details: ["å½±å°ç´™: TWD 700", "å¢¨æ°´åŒ£: TWD 500"],
          approverNotes: "", accountCode: "è¾¦å…¬ç”¨å“åŠè€—æ (Supplies)" },
    ];

    // --- è²»ç”¨ç”³å ±è¡¨å–®æ•¸æ“š (æå–åˆ°å…¨åŸŸ) ---
    const expenseCategories = [
        { title: "ğŸ’¼ æ—…è²»åŠäº¤é€šè²»", subItems: ["åœ‹å…§å·®æ—…è²» (Domestic)", "åœ‹å¤–å·®æ—…è²» (International)", "å¸‚å€äº¤é€šè²» (Local Transit)", "é«˜éµ/ç«è»Šç¥¨ (Rail Fare)", "æ©Ÿç¥¨è²»ç”¨ (Airfare)", "ä½å®¿è²»ç”¨ (Accommodation)"] },
        { title: "ğŸ½ï¸ é¤è²»åŠæ‹›å¾…è²»", subItems: ["å®¢æˆ¶æ‹›å¾…è²» (Client Entertainment)", "å“¡å·¥ç¦åˆ©é¤è²» (Staff Welfare)", "å…§éƒ¨æœƒè­°é¤é£² (Internal Meeting F&B)"] },
        { title: "ğŸ“¦ è¾¦å…¬èˆ‡è¡Œæ”¿è²»", subItems: ["è¾¦å…¬ç”¨å“åŠè€—æ (Supplies)", "éƒµé›»/é€šè¨Šè²» (Post & Telecom)", "ç§Ÿé‡‘æ”¯å‡º (Rent Expense)", "æ°´é›»ç“¦æ–¯è²» (Utilities)", "ä¿®ç¹•èˆ‡ç¶­è­·è²» (Repair & Maint.)", "å ±ç« é›œèªŒè¨‚é–±è²» (Subscriptions)"] },
        { title: "ğŸ’» è³‡è¨Šèˆ‡è»Ÿé«”è²»", subItems: ["è»Ÿé«”è¨‚é–±è²» (Software Subscription)", "ç¡¬é«”æ¡è³¼è²» (Hardware Purchase)", "è³‡è¨Šæœå‹™è²» (IT Services)", "é›²ç«¯æœå‹™è²» (Cloud Services)", "ç¶²ç«™ç¶²åŸŸåç¨±è²» (Domain/Web Fees)"] },
        { title: "ğŸ“ˆ è¡ŒéŠ·èˆ‡æ¥­å‹™è²»", subItems: ["å»£å‘Šèˆ‡å®£å‚³è²» (Advertising)", "æ¥­å‹™äº¤éš›è²» (Sales Relations)", "å±•è¦½è²» (Exhibition Fees)", "å°åˆ·å®£å‚³å“ (Printed Materials)", "å¸‚å ´èª¿ç ”è²» (Market Research)"] },
        { title: "ğŸ“š åŸ¹è¨“èˆ‡äººæ‰è²»", subItems: ["å°ˆæ¥­åŸ¹è¨“è²» (Professional Training)", "æ‹›å‹Ÿè²»ç”¨ (Recruitment Costs)", "æ•™è‚²è¨“ç·´èª²ç¨‹è²» (Course Fees)", "å“¡å·¥å¥åº·æª¢æŸ¥è²» (Health Check-ups)"] },
        { title: "ğŸ§‘â€ğŸ’» å°ˆæ¥­æœå‹™è²»", subItems: ["é¡§å•è²» (Consulting)", "æ³•å¾‹åŠæœƒè¨ˆè²»ç”¨ (Legal & Accounting)", "å¤–éƒ¨å¯©è¨ˆè²» (External Audit)", "ç¿»è­¯/å£è­¯è²» (Translation/Interpreting)"] },
        { title: "ğŸ¦ è²¡å‹™èˆ‡é›œé …è²»", subItems: ["éŠ€è¡Œæ‰‹çºŒè²» (Bank Charges)", "åˆ©æ¯æ”¯å‡º (Interest Expense)", "æ”¿åºœè¦è²»èˆ‡ç½°é° (Fees & Penalties)", "ä¿éšªè²» (Insurance Premiums)", "æ…ˆå–„æè´ˆ (Donations)"] },
        { title: "â“ å…¶ä»–é›œé …è²»ç”¨", subItems: ["å…¶ä»–é›œé …è²»ç”¨ (Misc. Other)"] }
    ];

    // æ¨¡æ“¬å°ˆæ¡ˆæ¸…å–®/æ¨¡çµ„æ¡è³¼æ¸…å–® (æå–åˆ°å…¨åŸŸ)
    const mockProjects = [
        { id: '', name: 'è«‹é¸æ“‡å°ˆæ¡ˆ (å¿…é¸)' },
        { id: 'OPEX-GEN', name: 'OPEX-GEN (ä¸€èˆ¬ç‡Ÿé‹æ”¯å‡º)' },
        { id: 'P2025-4', name: 'P2025-4 (DDR5 è¨˜æ†¶é«”æ¡è³¼)' },
        { id: 'P2025-5', name: 'P2025-5 (OLED é¡¯ç¤ºæ¨¡çµ„æ¡è³¼)' },
        { id: 'RND-001', name: 'RND-001 (ç”¢å“åŸå‹è¨­è¨ˆ)' },
    ];

    // ç¸½å¸³æ¨¡æ“¬æ•¸æ“š (æå–åˆ°å…¨åŸŸ)
    const journalEntries = [
        { date: '2024-10-25', voucher: 'J001', description: 'æ”¯ä»˜å“¡å·¥è–ªè³‡', account: 'è–ªè³‡è²»ç”¨', debit: 800000.00, credit: 0.00 },
        { date: '2024-10-25', voucher: 'J001', description: 'æ”¯ä»˜å“¡å·¥è–ªè³‡', account: 'éŠ€è¡Œå­˜æ¬¾', debit: 0.00, credit: 800000.00 },
        { date: '2024-10-26', voucher: 'J002', description: 'æ¡è³¼è¾¦å…¬è¨­å‚™', account: 'è¨­å‚™è³‡ç”¢', debit: 150000.00, credit: 0.00 },
        { date: '2024-10-26', voucher: 'J002', description: 'æ¡è³¼è¾¦å…¬è¨­å‚™', account: 'æ‡‰ä»˜å¸³æ¬¾', debit: 0.00, credit: 150000.00 },
        { date: '2024-10-26', voucher: 'J003', description: 'ç”¢å“ A éŠ·è²¨', account: 'æ‡‰æ”¶å¸³æ¬¾', debit: 450000.00, credit: 0.00 },
        { date: '2024-10-26', voucher: 'J003', description: 'ç”¢å“ A éŠ·è²¨', account: 'éŠ·è²¨æ”¶å…¥', debit: 0.00, credit: 450000.00 },
        { date: '2024-10-27', voucher: 'J004', description: 'æ”¶åˆ°å®¢æˆ¶ä»˜æ¬¾', account: 'ç¾é‡‘', debit: 300000.00, credit: 0.00 },
        { date: '2024-10-27', voucher: 'J004', description: 'æ”¶åˆ°å®¢æˆ¶ä»˜æ¬¾', account: 'æ‡‰æ”¶å¸³æ¬¾', debit: 0.00, credit: 300000.00 },
        { date: '2024-10-27', voucher: 'J005', description: 'æ”¯ä»˜è¾¦å…¬å®¤ç§Ÿé‡‘', account: 'ç§Ÿé‡‘è²»ç”¨', debit: 50000.00, credit: 0.00 },
        { date: '2024-10-27', voucher: 'J005', description: 'æ”¯ä»˜è¾¦å…¬å®¤ç§Ÿé‡‘', account: 'éŠ€è¡Œå­˜æ¬¾', debit: 0.00, credit: 50000.00 },
        { date: '2024-10-28', voucher: 'J006', description: 'æ”¯ä»˜éŠ€è¡Œå€Ÿæ¬¾åˆ©æ¯', account: 'åˆ©æ¯è²»ç”¨', debit: 15000.00, credit: 0.00 },
        { date: '2024-10-28', voucher: 'J006', description: 'æ”¯ä»˜éŠ€è¡Œå€Ÿæ¬¾åˆ©æ¯', account: 'ç¾é‡‘', debit: 0.00, credit: 15000.00 },
    ];


    // --- æ ¸å¿ƒåœ–è¡¨éŠ·æ¯€å‡½æ•¸ ---
    function destroyAllCharts() {
        Object.keys(chartInstances).forEach(key => {
            if (chartInstances[key]) {
                chartInstances[key].destroy();
                chartInstances[key] = null;
            }
        });
        // æ›¿æ› Canvas å®¹å™¨ä»¥å¼·åˆ¶æ¸…é™¤ DOM å¼•ç”¨ (ä¿®æ­£å¡é “çš„é—œéµ)
        const chartIds = ['cashFlowChart', 'expenseChart', 'inventoryValueChart', 'purchaseCategoryChart', 'workOrderStatusChart', 'employeeDistributionChart', 'salesFunnelChart', 'profitTrendChart', 'balanceAnalysisChart', 'projectTypeChart'];
        chartIds.forEach(id => {
            const oldCanvas = document.getElementById(id);
            if (oldCanvas) {
                const parent = oldCanvas.parentNode;
                const newCanvas = document.createElement('canvas');
                newCanvas.id = id;
                newCanvas.className = "w-full h-full"; // ç¢ºä¿æ–° Canvas å°ºå¯¸æ­£ç¢º
                parent.appendChild(newCanvas);
                oldCanvas.remove();
            }
        });
    }

    // --- æ ¸å¿ƒåœ–è¡¨æ¸²æŸ“é‚è¼¯ (ä½¿ç”¨ Canvas æ›¿æ›æ©Ÿåˆ¶) ---
    // (çœç•¥å…·é«”å¯¦ç¾ï¼Œä½†é€™äº›å‡½æ•¸æ˜¯å­˜åœ¨çš„)
    function renderCashFlowChart() {
         const ctx = document.getElementById('cashFlowChart').getContext('2d');
         const data = {labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],datasets: [{label: 'æ·¨ç¾é‡‘æµ (Net Flow)',data: [120000, 190000, 300000, 50000, 200000, 400000, 350000],backgroundColor: 'rgba(79, 70, 229, 0.8)',borderColor: 'rgba(79, 70, 229, 1)',borderWidth: 1,tension: 0.4,fill: true,}]};
         chartInstances.cashFlow = new Chart(ctx, {type: 'line',data: data,options: {responsive: true,maintainAspectRatio: false,scales: {y: { beginAtZero: true }}}});
    }
    function renderExpenseChart() {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        const data = {labels: ['è–ªè³‡', 'ç§Ÿé‡‘', 'æ¡è³¼', 'ç‡ŸéŠ·', 'é›œé …'],datasets: [{label: 'è²»ç”¨åˆ†ä½ˆ',data: [40, 25, 15, 10, 10],backgroundColor: ['#4f46e5', '#f59e0b', '#10b981', '#ef4444', '#6b7280'],hoverOffset: 10}]};
        chartInstances.expense = new Chart(ctx, {type: 'doughnut',data: data,options: {responsive: true,maintainAspectRatio: false,plugins: {legend: { position: 'right'}}}});
    }
    function renderInventoryValueChart() { /* WMS */
        const ctx = document.getElementById('inventoryValueChart').getContext('2d');
        const data = {labels: ['æˆå“', 'åŸææ–™', 'åŠæˆå“', 'è€—æ'],datasets: [{label: 'åº«å­˜åƒ¹å€¼',data: [50, 30, 15, 5],backgroundColor: ['#06b6d4', '#f97316', '#a855f7', '#10b981'],hoverOffset: 10}]};
        chartInstances.inventoryValue = new Chart(ctx, {type: 'pie',data: data,options: {responsive: true,maintainAspectRatio: false,plugins: {legend: { position: 'bottom'}}}});
    }
    function renderPurchaseCategoryChart() { /* SCM */
        const ctx = document.getElementById('purchaseCategoryChart').getContext('2d');
        const data = {labels: ['é›»å­å…ƒä»¶ (35è¬)', 'æ©Ÿæ§‹é›¶ä»¶ (20è¬)', 'åŸç‰©æ–™ (15è¬)', 'æœå‹™/å…¶ä»– (10è¬)'],datasets: [{label: 'æ¡è³¼æ”¯å‡º (TWD)',data: [350000, 200000, 150000, 100000],backgroundColor: ['#f59e0b', '#3b82f6', '#10b981', '#a855f7'],hoverOffset: 8}]};
        chartInstances.purchaseCategory = new Chart(ctx, {type: 'pie',data: data,options: {responsive: true,maintainAspectRatio: false,plugins: {legend: { position: 'right'}}}});
    }
    function renderWorkOrderStatusChart() { /* Manufacturing */
        const ctx = document.getElementById('workOrderStatusChart').getContext('2d');
        const data = {labels: ['å·²å®Œæˆ (25)', 'ç”Ÿç”¢ä¸­ (45)', 'å¾…é–‹å·¥ (10)', 'åœæ»¯/ç•°å¸¸ (5)'],datasets: [{label: 'å·¥å–®æ•¸é‡',data: [25, 45, 10, 5],backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444'],hoverOffset: 8}]};
        chartInstances.workOrderStatus = new Chart(ctx, {type: 'doughnut',data: data,options: {responsive: true,maintainAspectRatio: false,plugins: {legend: { position: 'bottom'}}}});
    }
    function renderEmployeeDistributionChart() { /* HR */
        const ctx = document.getElementById('employeeDistributionChart').getContext('2d');
        const data = {labels: ['è£½é€  (100)', 'ç ”ç™¼ (45)', 'éŠ·å”® (30)', 'è¡Œæ”¿ (25)', 'IT/è²¡å‹™ (15)'],datasets: [{label: 'å“¡å·¥äººæ•¸',data: [100, 45, 30, 25, 15],backgroundColor: ['#ef4444', '#a855f7', '#3b82f6', '#f59e0b', '#10b981'],hoverOffset: 8}]};
        chartInstances.employeeDistribution = new Chart(ctx, {type: 'doughnut',data: data,options: {responsive: true,maintainAspectRatio: false,plugins: {legend: { position: 'right'}}}});
    }
    function renderSalesFunnelChart() { /* CRM */
        const ctx = document.getElementById('salesFunnelChart').getContext('2d');
        const data = {labels: ['æ½›åœ¨å®¢æˆ¶ (850K)', 'åˆæ ¼ç·šç´¢ (400K)', 'å ±åƒ¹éšæ®µ (250K)', 'å¾…çµæ¡ˆ (100K)'],datasets: [{label: 'éŠ·å”®æ©Ÿæœƒåƒ¹å€¼ (TWD)',data: [850, 400, 250, 100],backgroundColor: ['#818cf8', '#a78bfa', '#c4b5fd', '#d8b4fe'],indexAxis: 'y',borderWidth: 1,borderRadius: 5,minBarLength: 10}]};
        chartInstances.salesFunnel = new Chart(ctx, {type: 'bar',data: data,options: {responsive: true,maintainAspectRatio: false,indexAxis: 'y',plugins: { legend: { display: false } },scales: { x: { beginAtZero: true, ticks: { callback: (v) => `$${v}K` } } }}});
    }
    function renderProfitTrendChart() { /* BI 1 */
        const ctx = document.getElementById('profitTrendChart').getContext('2d');
        const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
        const profitData = [350, 380, 410, 450, 420, 480, 510, 550, 580, 600, 620, 650].map(v => v * 1000);
        chartInstances.profitTrend = new Chart(ctx, {type: 'line', data: {labels: months,datasets: [{label: 'ç¶œåˆæ·¨åˆ©æ½¤ (TWD)',data: profitData,borderColor: 'rgb(20, 184, 166)',backgroundColor: 'rgba(20, 184, 166, 0.1)',tension: 0.4,fill: true}]},options: {responsive: true,maintainAspectRatio: false,plugins: { legend: { labels: { color: '#4b5563' } } },scales: { x: { ticks: { color: '#6b7280' }, grid: { color: '#e5e7eb' } }, y: { ticks: { color: '#6b7280', callback: function(value) { return '$' + (value / 1000) + 'K'; } }, grid: { color: '#e5e7eb' }}}}});
    }
    function renderBalanceAnalysisChart() { /* BI 2 */
        const ctx = document.getElementById('balanceAnalysisChart').getContext('2d');
        const weeks = ['W38', 'W39', 'W40', 'W41', 'W42', 'W43'];
        const inventory = [1200, 1150, 1300, 1250, 1400, 1350];
        const manufacturing = [900, 950, 1000, 1050, 1100, 1150];
        const sales = [100, 110, 105, 120, 115, 130];
        chartInstances.balanceAnalysis = new Chart(ctx, {type: 'line', data: {labels: weeks,datasets: [{label: 'åº«å­˜å–®ä½',data: inventory,borderColor: 'rgb(59, 130, 246)',backgroundColor: 'rgba(59, 130, 246, 0.5)',yAxisID: 'y'},{label: 'è£½é€ ç”¢å‡ºå–®ä½',data: manufacturing,borderColor: 'rgb(168, 85, 247)',backgroundColor: 'rgba(168, 85, 247, 0.5)',yAxisID: 'y'},{label: 'éŠ·å”®æŒ‡æ•¸ (K TWD)',data: sales,borderColor: 'rgb(245, 158, 11)',backgroundColor: 'rgba(245, 158, 11, 0.5)',yAxisID: 'y1',tension: 0.2,borderDash: [5, 5]}]},options: {responsive: true,maintainAspectRatio: false,plugins: { legend: { labels: { color: '#4b5563' } } },scales: {x: { ticks: { color: '#6b7280' }, grid: { color: '#e5e7eb' } },y: {type: 'linear',position: 'left',ticks: { color: '#6b7280' },title: { display: true, text: 'å–®ä½ (Unit)', color: '#6b7280' },grid: { color: '#e5e7eb' }},y1: {type: 'linear',position: 'right',min: 0,max: 200,ticks: { color: '#f59e0b', callback: function(value) { return '$' + value + 'K'; } },title: { display: true, text: 'éŠ·å”®é‡‘é¡ (K TWD)', color: '#f59e0b' },grid: { drawOnChartArea: false }}}}});
    }
    function renderProjectTypeChart() { /* Project Mgmt */
        const ctx = document.getElementById('projectTypeChart').getContext('2d');
        const data = {labels: ['ç ”ç™¼ (4)', 'IT/ç³»çµ± (2)', 'å¸‚å ´ (1)', 'ç‡Ÿé‹å„ªåŒ– (3)'],datasets: [{label: 'å°ˆæ¡ˆæ•¸é‡',data: [4, 2, 1, 3],backgroundColor: ['#a855f7', '#6366f1', '#f97316', '#10b981'],hoverOffset: 4}]};
        chartInstances.projectType = new Chart(ctx, {type: 'doughnut',data: data,options: {responsive: true,maintainAspectRatio: false,plugins: {legend: { position: 'bottom'}}}});
    }


    // --- è¦–åœ–åˆ‡æ›é‚è¼¯ ---
    function switchModule(viewId, subModule = null) {

        const targetViewId = viewId;
        let finalViewId = targetViewId;

        // è™•ç†æ¨™é¡Œå’Œå‰¯æ¨™é¡Œ
        const titleElement = document.getElementById('view-title');
        const subtitleElement = document.getElementById('view-subtitle');

        // æª¢æŸ¥æ˜¯å¦ç‚º Placeholder å‘¼å«
        if (targetViewId === 'placeholder-view' && subModule) {
             titleElement.textContent = `${subModule} æ¨¡çµ„ (é–‹ç™¼ä¸­)`;
             subtitleElement.textContent = "æ­¤ç‚º V2 æ¨¡çµ„çš„ Light Mode é·ç§»ä½”ä½ç¬¦ï¼Œè©³ç´°å„€è¡¨æ¿å°‡åœ¨ V3 éšæ®µä¾åºå®Œæˆæ•´åˆã€‚";
        } else {
            const [newTitle, newSubtitle] = moduleTitles[viewId] || [viewId.replace('-module-view', ''), ''];
            titleElement.textContent = newTitle;
            subtitleElement.textContent = newSubtitle;
        }

        // éš±è—æ‰€æœ‰è¦–åœ–å…§å®¹
        document.querySelectorAll('.module-view').forEach(view => {
            view.classList.add('hidden');
        });
        // ç§»é™¤æ‰€æœ‰ Tab/æ¨¡çµ„æŒ‰éˆ•çš„ active æ¨£å¼
        document.querySelectorAll('.module-button').forEach(button => {
            button.classList.remove('active');
        });

        // é¡¯ç¤ºé¸å®šçš„è¦–åœ–å…§å®¹
        const targetElement = document.getElementById(finalViewId);
        if (targetElement) {
             targetElement.classList.remove('hidden');
        } else {
             // æ¨¡çµ„åç¨±ä¸å­˜åœ¨ï¼Œåˆ‡æ›åˆ°é€šç”¨ä½”ä½ç¬¦
             document.getElementById('placeholder-view').classList.remove('hidden');
             document.getElementById('placeholder-text').textContent = `æ¨¡çµ„ ID: ${targetViewId} å°šæœªå¯¦ä½œã€‚è«‹ç­‰å¾… V3 éšæ®µå®Œæˆã€‚`;
             finalViewId = 'placeholder-view';
        }

        // è¨­ç½®é¸å®šçš„æ¨¡çµ„æŒ‰éˆ•ç‚º active
        const navId = viewId.replace('-view', '');
        const navButton = document.getElementById(`nav-${navId.replace('-module', '').replace('single-expense', 'single-expense')}`);
        if (navButton) {
            navButton.classList.add('active');
        }

        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ­£ï¼šåƒ…åœ¨ expense-center-view å•Ÿç”¨æ™‚æ‰åˆå§‹åŒ–å…¶å­è¦–åœ– â˜…â˜…â˜…
        if (viewId === 'expense-center-view') {
             // é è¨­é€²å…¥å ±éŠ·äººå„€è¡¨æ¿
             switchExpenseSubView('claimer');
        }

        // --- æ ¸å¿ƒåœ–è¡¨ç®¡ç†å’Œåˆå§‹åŒ–é‚è¼¯ ---
        destroyAllCharts(); // 1. éŠ·æ¯€æ‰€æœ‰ç¾æœ‰åœ–è¡¨

        const initMap = {
            'finance-module-view': [renderCashFlowChart, renderExpenseChart],
            'wms-module-view': [renderInventoryValueChart],
            'scm-module-view': [renderPurchaseCategoryChart],
            'manufacturing-module-view': [renderWorkOrderStatusChart],
            'hr-module-view': [renderEmployeeDistributionChart],
            'crm-module-view': [renderSalesFunnelChart],
            'bi-module-view': [renderProfitTrendChart, renderBalanceAnalysisChart],
            'project-mgmt-module-view': [renderProjectTypeChart],
            'expense-center-view': [() => switchExpenseSubView('claimer')]
        };

        const initFuncs = initMap[finalViewId];

        if (initFuncs) {
            // 2. ç•°æ­¥æ¸²æŸ“ç›®æ¨™æ¨¡çµ„åœ–è¡¨/å‡½æ•¸
            initFuncs.forEach(func => {
                window.requestAnimationFrame(() => {
                    func();
                });
            });
        } else if (finalViewId === 'general-ledger-view') {
            renderGeneralLedger();
        }
    }

    // --- è²»ç”¨ç”³å ±è¡¨å–®é‚è¼¯ (New) ---

    // è¼”åŠ©å‡½å¼ï¼šæ¸²æŸ“æœƒè¨ˆç§‘ç›®ä¸‹æ‹‰é¸å–® (ä¿®æ­£å¾Œï¼Œå–®ä¸€ Select)
    function renderCategorySelects() {
        const finalSelect = document.getElementById('single-category-final');
        if (!finalSelect) return;

        finalSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡è²»ç”¨ç§‘ç›® (å¤§é … | ç´°ç›®)</option>';

        expenseCategories.forEach(cat => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = cat.title;

            cat.subItems.forEach(minor => {
                const option = document.createElement('option');
                // é—œéµï¼šå°‡å¤§é …å’Œç´°ç›®æ‹¼æ¥åœ¨ value ä¸­ï¼Œä¾¿æ–¼å¾ŒçºŒè§£æ
                option.value = `${cat.title} | ${minor}`;
                option.textContent = minor;
                optgroup.appendChild(option);
            });
            finalSelect.appendChild(optgroup);
        });
    }

    // è¼”åŠ©å‡½å¼ï¼šæ¸²æŸ“å°ˆæ¡ˆä¸‹æ‹‰é¸å–®
    function renderProjectSelect() {
        const projectSelect = document.getElementById('single-project');
        if (!projectSelect) return;

        projectSelect.innerHTML = '';
        mockProjects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            // é¡¯ç¤ºï¼šID - ç°¡æ½”åç¨±
            option.textContent = `${project.id} - ${project.name.replace(/ *\([^)]*\) */g, "")}`;
            if (project.id === '') {
                option.disabled = true;
                option.selected = true;
            }
            projectSelect.appendChild(option);
        });
    }

    function handleSingleExpenseSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        const categoryFinal = formData.get('category-final');
        const projectId = formData.get('project-id');

        if (!form.checkValidity() || projectId === "" || categoryFinal === "" || categoryFinal === null) {
             alert("éŒ¯èª¤ï¼šè«‹ç¢ºä¿æ‰€æœ‰å¿…å¡«æ¬„ä½éƒ½å·²å¡«å¯«ï¼ŒåŒ…æ‹¬æœƒè¨ˆç§‘ç›®å’Œå°ˆæ¡ˆ IDã€‚");
             form.reportValidity();
             return;
        }

        // è§£æç§‘ç›®ï¼šcategoryFinal æ ¼å¼ç‚º "å¤§é … | ç´°ç›®"
        const [majorCategoryTitle, minorCategory] = categoryFinal.split('|').map(s => s.trim());
        const claimId = (mockClaims.length > 0 ? Math.max(...mockClaims.map(c => c.id)) : 100) + 1;

        const newClaim = {
            id: claimId,
            title: `${minorCategory} - ${formData.get('date')}`,
            total: parseFloat(formData.get('amount')),
            submitDate: new Date().toISOString().slice(0, 10),
            status: 'Draft',
            projectCode: projectId,
            accountCode: minorCategory, // ç”³å ±ç´°ç›®ä½œç‚ºç§‘ç›®
            purpose: formData.get('description') || 'ç„¡è©³ç´°èªªæ˜',
            details: [`${minorCategory}: ${formData.get('currency')} ${formData.get('amount')}`],
            claimer: "ç‹å°æ˜",
            department: "æ¥­å‹™ç™¼å±•éƒ¨"
        };

        mockClaims.push(newClaim);

        alert(`âœ… ç”³å ±æˆåŠŸï¼å ±éŠ·å–® #${claimId} (${minorCategory}) å·²å„²å­˜ç‚ºè‰ç¨¿ã€‚`);
        form.reset();
        switchModule('finance-module-view'); // æäº¤å¾Œè¿”å›ä¸»å„€è¡¨æ¿
    }


    // --- ç¸½å¸³æ¸²æŸ“èˆ‡ç¯©é¸é‚è¼¯ (ä¿æŒä¸è®Š) ---
    function formatCurrency(value) { return value === 0 ? '-' : 'NT$ ' + parseFloat(value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    function filterLedger(entries = journalEntries) {
        const dateRange = document.getElementById('date-range').value.trim();
        const accountFilter = document.getElementById('account-filter').value;
        const searchText = document.getElementById('search-text').value.toLowerCase().trim();
        let filteredEntries = journalEntries;
        if (accountFilter) { filteredEntries = filteredEntries.filter(entry => entry.account === accountFilter); }
        if (searchText) { filteredEntries = filteredEntries.filter(entry => entry.description.toLowerCase().includes(searchText) || entry.voucher.toLowerCase().includes(searchText)); }
        if (dateRange && dateRange.length === 10) { filteredEntries = filteredEntries.filter(entry => entry.date === dateRange); }
        renderGeneralLedger(filteredEntries);
    }
    function resetFilters() { document.getElementById('date-range').value = ''; document.getElementById('account-filter').value = ''; document.getElementById('search-text').value = ''; renderGeneralLedger(); }
    function renderGeneralLedger(entries = journalEntries) {
        const tbody = document.getElementById('ledger-body');
        const balanceSummary = document.getElementById('balance-summary');
        const noResults = document.getElementById('no-results');
        tbody.innerHTML = ''; let totalDebit = 0; let totalCredit = 0;
        if (entries.length === 0) { noResults.classList.remove('hidden'); balanceSummary.innerHTML = ''; return; } else { noResults.classList.add('hidden'); }
        entries.forEach((entry, index) => {
            totalDebit += entry.debit; totalCredit += entry.credit;
            const row = document.createElement('tr'); row.classList.add(index % 2 === 0 ? 'bg-white' : 'bg-gray-50', 'hover:bg-indigo-50', 'transition');
            const debitDisplay = formatCurrency(entry.debit); const creditDisplay = formatCurrency(entry.credit);
            const isGroupStart = index === 0 || entry.voucher !== entries[index - 1].voucher;
            const dateDisplay = isGroupStart ? entry.date : ''; const voucherDisplay = isGroupStart ? entry.voucher : '';
            row.innerHTML = `<td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900">${dateDisplay}</td><td class_name="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${voucherDisplay}</td><td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900">${entry.description}</td><td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-indigo-600">${entry.account}</td><td class="px-6 py-3 whitespace-nowrap text-sm text-right text-green-700 font-mono">${debitDisplay}</td><td class="px-6 py-3 whitespace-nowrap text-sm text-right text-red-700 font-mono">${creditDisplay}</td>`;
        });
        const isBalanced = Math.abs(totalDebit - totalCredit) < 0.01;
        const balanceColor = isBalanced ? 'text-green-700 bg-green-100' : 'text-red-700 bg-red-100';
        const balanceStatus = isBalanced ? 'å¹³è¡¡ (Balanced)' : 'ä¸å¹³è¡¡ (Out of Balance)';
        balanceSummary.innerHTML = `<div class="flex justify-between items-center text-lg font-bold"><div class="space-y-1"><p class="text-gray-600">å€Ÿæ–¹ç¸½é¡ (Total Debit): <span class="text-green-600">${formatCurrency(totalDebit)}</span></p><p class="text-gray-600">è²¸æ–¹ç¸½é¡ (Total Credit): <span class="text-red-600">${formatCurrency(totalCredit)}</span></p></div><div class="p-3 rounded-lg ${balanceColor} font-extrabold text-xl shadow-md">${balanceStatus}</div></div>`;
    }


    // --- é é¢åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        // ç¶å®šæ–°è¡¨å–®çš„æäº¤äº‹ä»¶
        const newExpenseForm = document.getElementById('newExpenseForm');
        if (newExpenseForm) {
            newExpenseForm.addEventListener('submit', handleSingleExpenseSubmit);
        }

        // é è¨­é¡¯ç¤ºè²¡å‹™å„€è¡¨æ¿ (Finance)
        switchModule('finance-module-view');
    });
</script>
</body>
</html>
<body class="bg-gray-100 font-sans p-4 sm:p-8">

    <div id="mainAppContainer" class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl">

        <header class="bg-primary-blue text-white p-6 rounded-t-xl flex justify-between items-center flex-wrap">
            <h1 class="text-3xl font-bold mb-2 sm:mb-0">è²»ç”¨ç®¡ç†ä¸­å¿ƒ</h1>
            <div id="viewSelector" class="flex space-x-4 p-1 bg-white/10 rounded-lg">
                <button id="claimerViewBtn" onclick="switchView('claimer')" class="view-switch-btn py-2 px-4 rounded-md text-sm font-semibold bg-accent-orange text-white active">å ±éŠ·äººå„€è¡¨æ¿</button>
                <button id="approverViewBtn" onclick="switchView('approver')" class="view-switch-btn py-2 px-4 rounded-md text-sm font-semibold bg-white text-primary-blue hover:bg-gray-100">å¯©æ‰¹äººä¸­å¿ƒ</button>
            </div>
        </header>

        <main class="p-6">

            <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full transform transition-all scale-100 opacity-100">
                    <h3 id="msgTitle" class="text-xl font-bold mb-3 text-primary-blue">æç¤º</h3>
                    <p id="msgText" class="text-gray-700 mb-4">æ“ä½œè¨Šæ¯ã€‚</p>
                    <div class="flex justify-end">
                        <button onclick="closeMessageBox()" class="bg-primary-blue text-white py-2 px-4 rounded-md hover:bg-primary-blue/90">ç¢ºå®š</button>
                    </div>
                </div>
            </div>

            <div id="claimerViewContainer" class="view-container">
                <h2 class="text-2xl font-semibold text-primary-blue mb-6 border-b pb-2">æˆ‘çš„å ±éŠ·å–®è¿½è¹¤ (<span id="claimerName">ç‹å°æ˜</span>)</h2>

                <div id="claimerDashboardView" class="view-section">

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="kpi-card bg-white p-5 rounded-lg shadow-lg border-l-4 border-status-draft">
                            <p class="text-sm font-medium text-gray-500">å¾…è™•ç† (è‰ç¨¿)</p>
                            <p id="statClaimerDraft" class="text-3xl font-bold text-status-draft mt-1">0</p>
                        </div>
                        <div class="kpi-card bg-white p-5 rounded-lg shadow-lg border-l-4 border-status-pending">
                            <p class="text-sm font-medium text-gray-500">å¯©æ ¸ä¸­ (å¾…å¯©æ‰¹)</p>
                            <p id="statClaimerPending" class="text-3xl font-bold text-status-pending mt-1">0</p>
                        </div>
                        <div class="kpi-card bg-white p-5 rounded-lg shadow-lg border-l-4 border-status-rejected">
                            <p class="text-sm font-medium text-gray-500">å·²é§å› (éœ€ä¿®æ”¹)</p>
                            <p id="statClaimerRejected" class="text-3xl font-bold text-status-rejected mt-1">0</p>
                        </div>
                    </div>

                    <div class="flex flex-wrap justify-between items-center mb-4 gap-3">
                        <div>
                            <button onclick="changeClaimerFilter('All')" class="claimer-filter-btn py-1 px-3 text-sm font-medium rounded-full bg-primary-blue text-white shadow-md transition duration-150" data-filter="All">å…¨éƒ¨</button>
                            <button onclick="changeClaimerFilter('Draft')" class="claimer-filter-btn py-1 px-3 text-sm font-medium rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition duration-150" data-filter="Draft">è‰ç¨¿</button>
                            <button onclick="changeClaimerFilter('Pending')" class="claimer-filter-btn py-1 px-3 text-sm font-medium rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition duration-150" data-filter="Pending">å¾…å¯©æ‰¹</button>
                            <button onclick="changeClaimerFilter('Rejected')" class="claimer-filter-btn py-1 px-3 text-sm font-medium rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition duration-150" data-filter="Rejected">å·²é§å›</button>
                        </div>
                        <button onclick="createNewClaim()" class="flex items-center space-x-1 py-2 px-4 bg-accent-orange text-white rounded-lg hover:bg-accent-orange/90 font-semibold shadow-md transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            <span>æ–°å¢å ±éŠ·å–®</span>
                        </button>
                    </div>

                    <div class="bg-secondary-gray p-4 rounded-lg shadow-inner">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-primary-blue/10">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">æ¨™é¡Œ</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">é—œè¯å°ˆæ¡ˆ</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">ç¸½é‡‘é¡</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">ç‹€æ…‹</th>
                                    <th class="px-4 py-3 text-right text-xs font-bold text-gray-600 uppercase w-20">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="claimerClaimListBody" class="bg-white divide-y divide-gray-100">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="claimerEditFormView" class="view-section hidden max-w-2xl mx-auto p-6 bg-white border border-gray-200 rounded-lg shadow-lg">
                    <h3 class="text-xl font-bold text-primary-blue mb-4"><span id="formActionTitle">ç·¨è¼¯</span>å ±éŠ·å–® <span id="editClaimIdDisplay" class="text-accent-orange">#N/A</span></h3>

                    <form id="editForm" class="space-y-4">
                        <div>
                            <label for="editTitle" class="block text-sm font-medium text-gray-700 mb-1">å ±éŠ·å–®æ¨™é¡Œ</label>
                            <input type="text" id="editTitle" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                        </div>

                        <div>
                            <label for="editProjectId" class="block text-sm font-medium text-gray-700 mb-1">é—œè¯å°ˆæ¡ˆ/æ¨¡çµ„ç·¨è™Ÿ</label>
                            <select id="editProjectId" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                                </select>
                        </div>

                        <div>
                            <label for="editTotal" class="block text-sm font-medium text-gray-700 mb-1">ç¸½é‡‘é¡ (TWD)</label>
                            <input type="number" id="editTotal" required min="1" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                        </div>

                        <div>
                            <label for="editPurpose" class="block text-sm font-medium text-gray-700 mb-1">å ±éŠ·äº‹ç”±</label>
                            <textarea id="editPurpose" rows="3" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue"></textarea>
                        </div>

                        <div>
                            <p class="text-sm font-medium text-gray-700 mb-1">è²»ç”¨æ˜ç´° (æ¯è¡Œä¸€é …)</p>
                            <textarea id="editDetails" rows="5" placeholder="ä¾‹å¦‚ï¼š
äº¤é€šè²»: TWD 3000
é¤é£²è²»: TWD 850" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue"></textarea>
                        </div>

                        <div id="rejectedReasonBox" class="p-3 bg-status-rejected/10 border border-status-rejected rounded-lg hidden">
                            <p class="font-bold text-status-rejected mb-1">åŸé§å›ç†ç”±:</p>
                            <p id="rejectedReasonText" class="text-sm text-gray-700 italic"></p>
                        </div>

                        <div class="flex justify-end space-x-3 pt-3">
                            <button type="button" onclick="cancelEdit()" class="py-2 px-4 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-semibold">
                                å–æ¶ˆ
                            </button>
                            <button type="button" onclick="saveClaim('Draft')" class="py-2 px-4 bg-accent-orange text-white rounded-lg hover:bg-accent-orange/90 font-semibold">
                                <span id="saveDraftText">å„²å­˜è‰ç¨¿</span>
                            </button>
                            <button type="button" onclick="saveClaim('Pending')" class="py-2 px-4 bg-status-approved text-white rounded-lg hover:bg-status-approved/90 font-semibold">
                                <span id="resubmitText">æäº¤å¯©æ‰¹</span>
                            </button>
                        </div>
                    </form>
                </div>

                <div id="newClaimFormView" class="view-section hidden max-w-2xl mx-auto p-6 bg-white border border-gray-200 rounded-lg shadow-lg">
                    <h3 class="text-2xl font-bold text-primary-blue mb-6 border-b pb-3 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-primary-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        æ–°å¢è²»ç”¨ç”³å ± (å»ºç«‹è‰ç¨¿)
                    </h3>
                    <p class="text-gray-500 mb-8">è«‹å¡«å¯«å–®ç­†è²»ç”¨è³‡è¨Šã€‚å„²å­˜å¾Œå°‡åœ¨æ‚¨çš„å„€è¡¨æ¿å»ºç«‹ä¸€ç­†æ–°è‰ç¨¿ï¼Œæ‚¨ä¹‹å¾Œå¯ä»¥å†ç·¨è¼¯ç¸½æ¨™é¡Œå’Œåˆä½µæ˜ç´°ã€‚</p>

                    <form id="newExpenseForm" onsubmit="handleNewExpenseSubmit(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label for="new-category-final" class="block text-sm font-medium text-gray-700">æœƒè¨ˆç§‘ç›® (å¤§é … | ç´°ç›®)*</label>
                                <select id="new-category-final" name="category-final" required onchange="checkCompliance()"
                                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-blue focus:border-primary-blue sm:text-sm rounded-md border shadow-sm">
                                    </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="new-amount" class="block text-sm font-medium text-gray-700">é‡‘é¡ (Amount)*</label>
                                <input type="number" step="0.01" min="0.01" id="new-amount" name="amount" required oninput="checkCompliance()"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-blue focus:border-primary-blue sm:text-sm" placeholder="1200.00">
                            </div>
                            <div>
                                <label for="new-currency" class="block text-sm font-medium text-gray-700">å¹£åˆ¥ (Currency)*</label>
                                <select id="new-currency" name="currency" required
                                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-blue focus:border-primary-blue sm:text-sm rounded-md border shadow-sm">
                                    <option value="TWD" selected>TWD (æ–°è‡ºå¹£)</option>
                                    <option value="USD">USD (ç¾å…ƒ)</option>
                                    <option value="EUR">EUR (æ­å…ƒ)</option>
                                    <option value="JPY">JPY (æ—¥åœ“)</option>
                                </select>
                            </div>
                        </div>

                        <div id="compliance-prompt" class="p-4 bg-compliance-yellow border border-compliance-yellow-border rounded-lg hidden">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-compliance-yellow-text" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.636-1.107 2.37-1.107 3.006 0l7.236 12.533c.636 1.107-.23 2.502-1.503 2.502H2.524c-1.273 0-2.139-1.395-1.503-2.502L8.257 3.099zM9 9a1 1 0 00-1 1v4a1 1 0 102 0v-4a1 1 0 00-1-1zm1 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-bold text-compliance-yellow-text">æ³•è¦éµå¾ªæç¤º</h3>
                                    <div id="compliance-text" class="mt-2 text-sm text-compliance-yellow-text/90">
                                        <ul class="list-disc list-inside space-y-1">
                                            </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="new-project" class="block text-sm font-medium text-gray-700">é—œè¯å°ˆæ¡ˆ/æ¨¡çµ„ ID*</label>
                            <select id="new-project" name="project-id" required
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-blue focus:border-primary-blue sm:text-sm rounded-md border shadow-sm">
                                </select>
                        </div>


                        <div>
                            <label for="new-date" class="block text-sm font-medium text-gray-700">ç™¼ç”Ÿæ—¥æœŸ (Date)*</label>
                            <input type="date" id="new-date" name="date" required
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-blue focus:border-primary-blue sm:text-sm">
                        </div>

                        <div class="md:col-span-2">
                            <label for="new-description" class="block text-sm font-medium text-gray-700">èªªæ˜/å‚™è¨» (Description)</label>
                            <textarea id="new-description" name="description" rows="3" placeholder="è«‹ç°¡è¿°é€™ç­†è²»ç”¨çš„ç”¨é€”..."
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-blue focus:border-primary-blue sm:text-sm"></textarea>
                        </div>

                        <div class="pt-4 flex justify-end space-x-3">
                            <button type="button" onclick="cancelEdit()"
                                class="inline-flex justify-center rounded-lg border border-gray-300 bg-white px-5 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none transition duration-150 ease-in-out">
                                å–æ¶ˆ
                            </button>
                            <button id="new-save-button" type="submit"
                                class="inline-flex justify-center items-center py-3 px-6 border border-transparent shadow-lg text-sm font-medium rounded-lg text-white bg-primary-blue hover:bg-primary-blue/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-blue transition duration-150">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v8a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4L14 7m0 0l-2-2m2 2l2 2"/></svg>
                                å„²å­˜ç‚ºè‰ç¨¿
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="approverViewContainer" class="view-container-inner hidden">
                <h2 class="text-2xl font-semibold text-primary-blue mb-6 border-b pb-2">å¯©æ‰¹ä¸­å¿ƒ</h2>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                    <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="kpi-card bg-white p-5 rounded-lg shadow-lg border-l-4 border-status-pending">
                            <p class="text-sm font-medium text-gray-500">å¾…å¯©æ‰¹æ•¸é‡</p>
                            <p id="statPendingCount" class="text-3xl font-bold text-status-pending mt-1">0</p>
                        </div>
                        <div class="kpi-card bg-white p-5 rounded-lg shadow-lg border-l-4 border-accent-orange">
                            <p class="text-sm font-medium text-gray-500">å¾…å¯©æ‰¹ç¸½é‡‘é¡ (TWD)</p>
                            <p id="statPendingTotal" class="text-3xl font-bold text-accent-orange mt-1">0</p>
                        </div>
                        <div class="kpi-card bg-white p-5 rounded-lg shadow-lg border-l-4 border-status-approved">
                            <p class="text-sm font-medium text-gray-500">å·²æ‰¹å‡†ç¸½é‡‘é¡ (æœ¬æœŸ)</p>
                            <p id="statApprovedTotal" class="text-3xl font-bold text-status-approved mt-1">0</Lp>
                        </div>
                    </div>


                    <div class="lg:col-span-1 bg-secondary-gray p-4 rounded-lg shadow-inner border border-gray-200">
                        <h3 class="text-xl font-semibold text-primary-blue mb-4">å ±éŠ·å–®æ¸…å–® (å¾…è™•ç†ï¼š<span id="approverPendingCount" class="text-accent-orange">0</span> ç­†)</h3>

                        <div class="flex space-x-2 mb-4">
                            <button data-status="Pending" onclick="changeApproverFilter('Pending')" class="approver-status-tab py-1 px-3 text-sm font-medium rounded-full bg-primary-blue text-white shadow-md">å¾…å¯©æ‰¹</button>
                            <button data-status="Approved" onclick="changeApproverFilter('Approved')" class="approver-status-tab py-1 px-3 text-sm font-medium rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300">å·²æ‰¹å‡†</button>
                            <button data-status="Rejected" onclick="changeApproverFilter('Rejected')" class="approver-status-tab py-1 px-3 text-sm font-medium rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300">å·²é§å›</button>
                        </div>

                        <div class="overflow-y-auto max-h-[60vh]">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="sticky top-0 bg-primary-blue/10">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-bold text-gray-600">æ¨™é¡Œ/å ±éŠ·äºº</th>
                                        <th class="px-4 py-2 text-left text-xs font-bold text-gray-600 w-24">é‡‘é¡</th>
                                        <th class="px-4 py-2 text-left text-xs font-bold text-gray-600 w-24">ç‹€æ…‹</th>
                                    </tr>
                                </thead>
                                <tbody id="approverClaimListBody" class="bg-white divide-y divide-gray-100">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-xl border border-primary-blue/20">
                        <div id="approverDetailPlaceholder" class="text-center p-10 text-gray-500 mt-20">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 text-primary-blue/50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p class="text-lg font-medium">è«‹å¾å·¦å´æ¸…å–®é¸æ“‡ä¸€ç­†å ±éŠ·å–®ä»¥æŸ¥çœ‹è©³æƒ…ã€‚</p>
                        </div>

                        <div id="approverClaimDetailView" class="hidden space-y-6">
                            <div class="border-b pb-3 mb-4">
                                <h3 id="approverDetailTitle" class="text-2xl font-bold text-primary-blue"></h3>
                                <div class="flex items-center space-x-4 mt-2 text-sm text-gray-600 flex-wrap gap-y-2">
                                    <p>å ±éŠ·äºº: <span id="approverDetailClaimer" class="font-medium"></span></p>
                                    <p>éƒ¨é–€: <span id="approverDetailDepartment" class="font-medium"></span></p>
                                    <p>å°ˆæ¡ˆç·¨è™Ÿ: <span id="approverDetailProjectCode" class="font-medium text-primary-blue"></span></p>
                                    <p>æœƒè¨ˆç§‘ç›®: <span id="approverDetailAccountCode" class="font-medium text-primary-blue"></span></p>
                                    <p>æäº¤æ—¥æœŸ: <span id="approverDetailSubmitDate" class="font-medium"></span></p>
                                    <p>ç¸½é‡‘é¡: <span id="approverDetailTotal" class="text-lg font-extrabold text-accent-orange"></span></p>
                                    <span id="approverDetailStatus" class="px-3 py-1 text-xs font-semibold rounded-full"></span>
                                </div>
                            </div>

                            <div>
                                <p class="text-lg font-semibold text-gray-800 mb-2">å ±éŠ·äº‹ç”±ï¼š</p>
                                <div id="approverDetailPurpose" class="p-3 bg-secondary-gray rounded-md border border-gray-300 text-gray-700 italic mb-4"></div>
                                <p class="text-md font-semibold text-gray-800 mb-1">è²»ç”¨æ˜ç´°ï¼š</p>
                                <ul id="approverDetailMockDetails" class="list-disc list-inside ml-4 mt-2 space-y-1 text-gray-700 text-sm"></ul>
                            </div>

                            <div class="pt-6 border-t border-dashed mt-6 space-y-4">
                                <p class="text-lg font-semibold text-primary-blue" id="approverActionTitle">å¯©æ‰¹æ„è¦‹èˆ‡æ“ä½œ</p>

                                <div id="approverActionsDiv">
                                    <textarea id="approverNotesInput" rows="3" placeholder="è«‹è¼¸å…¥å¯©æ‰¹æ„è¦‹ï¼ˆæ‰¹å‡†æ™‚å¯é¸å¡«ï¼Œé§å›æ™‚å¿…å¡«ï¼‰" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue transition duration-150"></textarea>

                                    <div class="flex justify-end space-x-4 mt-3">
                                        <button onclick="handleApproval('Rejected')" class="bg-status-rejected text-white py-2 px-4 rounded-lg hover:bg-status-rejected/90 font-semibold shadow-md">é§å›</button>
                                        <button onclick="handleApproval('Approved')" class="bg-status-approved text-white py-2 px-4 rounded-lg hover:bg-status-approved/90 font-semibold shadow-md">æ‰¹å‡†</button>
                                    </div>
                                </div>

                                <div id="approverHistoryDiv" class="hidden space-y-2">
                                    <p id="approverHistoryStatus" class="font-bold text-lg"></p>
                                    <p class="text-sm text-gray-600">å¯©æ‰¹äººå‚™è¨»:</p>
                                    <div id="approverHistoryNotes" class="p-3 bg-gray-100 rounded-md border border-gray-200 italic text-gray-700"></div>
                                    <p class="text-xs text-gray-500 pt-1">å¯©æ‰¹æ™‚é–“: <span id="approverHistoryDate"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</body>
</html>
