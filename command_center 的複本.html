<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGB ERP 數位企業命令中心</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        /* 使用 Inter 字體 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* 隱藏預設滾動條並使用自定義樣式 */
        .gl-table-container {
            max-height: 60vh;
            overflow-y: auto;
            border-radius: 0.5rem;
        }
        .gl-table-container::-webkit-scrollbar {
            width: 8px;
        }
        .gl-table-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .gl-table-container::-webkit-scrollbar-track {
            background-color: #f1f5f9;
        }
        .tab-button.active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .kpi-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-extrabold text-gray-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600 mr-3" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM5 8a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm0 4a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" />
                </svg>
                IGB ERP 數位企業命令中心
            </h1>
            <p class="text-gray-500 text-sm mt-1">即時總覽、財務追蹤與模組化管理介面</p>
        </header>

        <!-- 導航/分頁按鈕 -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tab-dashboard" onclick="switchView('dashboard-view')" class="tab-button active py-3 px-1 text-sm font-medium transition duration-150 ease-in-out">
                    財務儀表板 (Dashboard)
                </button>
                <button id="tab-ledger" onclick="switchView('general-ledger-view')" class="tab-button py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 transition duration-150 ease-in-out">
                    總帳管理 (General Ledger)
                </button>
                <button id="tab-api" onclick="switchView('api-docs-view')" class="tab-button py-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 transition duration-150 ease-in-out">
                    API 文件/測試 (FastAPI)
                </button>
            </nav>
        </div>

        <!-- 1. 財務儀表板 (Dashboard) 視圖 -->
        <div id="dashboard-view" class="view-content space-y-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">關鍵財務指標 (KPI)</h2>
            
            <!-- KPI 卡片區塊 -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- 現金餘額 -->
                <div class="kpi-card bg-white p-6 rounded-xl shadow-lg border border-indigo-100">
                    <p class="text-sm font-medium text-gray-500">現金餘額 (Cash Balance)</p>
                    <p class="text-3xl font-bold text-indigo-600 mt-1" id="kpi-cash-balance">NT$ 2,500,000</p>
                    <span class="text-xs text-green-500 flex items-center mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
                        +5% YoY
                    </span>
                </div>
                <!-- 應收帳款 -->
                <div class="kpi-card bg-white p-6 rounded-xl shadow-lg border border-yellow-100">
                    <p class="text-sm font-medium text-gray-500">應收帳款 (A/R)</p>
                    <p class="text-3xl font-bold text-yellow-600 mt-1" id="kpi-ar">NT$ 850,000</p>
                    <span class="text-xs text-red-500 flex items-center mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>
                        -2% MoM
                    </span>
                </div>
                <!-- 應付帳款 -->
                <div class="kpi-card bg-white p-6 rounded-xl shadow-lg border border-red-100">
                    <p class="text-sm font-medium text-gray-500">應付帳款 (A/P)</p>
                    <p class="text-3xl font-bold text-red-600 mt-1" id="kpi-ap">NT$ 420,000</p>
                    <span class="text-xs text-green-500 flex items-center mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
                        +10% QoQ (良好控制)
                    </span>
                </div>
                <!-- 庫存價值 -->
                <div class="kpi-card bg-white p-6 rounded-xl shadow-lg border border-green-100">
                    <p class="text-sm font-medium text-gray-500">庫存總價值 (Inventory)</p>
                    <p class="text-3xl font-bold text-green-600 mt-1" id="kpi-inventory">NT$ 1,980,000</p>
                    <span class="text-xs text-gray-500 mt-2">
                        週轉天數：45 天
                    </span>
                </div>
            </div>

            <!-- 圖表區塊 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pt-6">
                <!-- 月度現金流圖表 -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">月度現金流趨勢 (Net Cash Flow)</h3>
                    <div class="h-80">
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                </div>

                <!-- 費用類別分佈圖表 (圓餅圖) -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">費用類別分佈</h3>
                    <div class="h-80 flex justify-center items-center">
                        <canvas id="expenseChart" class="max-h-72"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. 總帳管理 (General Ledger) 視圖 -->
        <div id="general-ledger-view" class="view-content hidden space-y-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">日記帳分錄 (Journal Entries)</h2>

            <!-- 篩選與搜尋欄位 -->
            <div class="bg-white p-4 rounded-xl shadow-md flex flex-wrap items-end gap-4">
                <div class="flex-1 min-w-[200px]">
                    <label for="date-range" class="block text-sm font-medium text-gray-700">日期範圍</label>
                    <input type="text" id="date-range" oninput="filterLedger()" placeholder="YYYY-MM-DD 至 YYYY-MM-DD" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div class="flex-1 min-w-[150px]">
                    <label for="account-filter" class="block text-sm font-medium text-gray-700">帳戶名稱</label>
                    <select id="account-filter" onchange="filterLedger()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="">所有帳戶</option>
                        <option value="現金">現金</option>
                        <option value="應收帳款">應收帳款</option>
                        <option value="銷貨收入">銷貨收入</option>
                        <option value="薪資費用">薪資費用</option>
                        <option value="銀行存款">銀行存款</option>
                    </select>
                </div>
                <div class="flex-1 min-w-[250px]">
                    <label for="search-text" class="block text-sm font-medium text-gray-700">搜尋描述/憑證</label>
                    <input type="text" id="search-text" oninput="filterLedger()" placeholder="輸入關鍵字" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <button onclick="resetFilters()" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-md hover:bg-gray-300 transition shadow-sm">
                    重設
                </button>
            </div>

            <!-- 日記帳分錄表格 -->
            <div class="gl-table-container bg-white shadow-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">憑證號碼</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">描述</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">帳戶名稱</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">借方 (Debit)</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">貸方 (Credit)</th>
                        </tr>
                    </thead>
                    <tbody id="ledger-body" class="bg-white divide-y divide-gray-200">
                        <!-- 數據將由 JavaScript 載入 -->
                    </tbody>
                </table>
                <div id="no-results" class="text-center py-10 text-gray-500 hidden">
                    找不到符合篩選條件的日記帳分錄。
                </div>
            </div>

            <!-- 借貸平衡檢查總結 -->
            <div class="mt-4 p-4 rounded-xl shadow-lg" id="balance-summary">
                <!-- 總結將由 JavaScript 載入 -->
            </div>
        </div>

        <!-- 3. API 文件/測試 (FastAPI) 視圖 -->
        <div id="api-docs-view" class="view-content hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">FastAPI 模組 API 文件</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg space-y-4">
                <p class="text-lg text-gray-600">
                    此區域用於嵌入或連結到您的 FastAPI 伺服器所提供的 API 文件，例如 **Swagger UI** (`/docs`) 或 **ReDoc** (`/redoc`) 介面。
                </p>
                <p class="text-gray-500">
                    在實際部署中，您會將 API 文件嵌入到一個 IFrame 中，讓開發人員可以在此處測試 `/modules` 路由 (POST, GET, PATCH, DELETE) 的所有 CRUD 操作。
                </p>
                <a href="http://127.0.0.1:8000/docs" target="_blank" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 transition">
                    開啟 Swagger UI 外部連結
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                </a>
            </div>
        </div>

    </div>

    <script>
        // 初始化 Chart.js 實例的變數
        let cashFlowChartInstance = null;
        let expenseChartInstance = null;

        // --- 視圖切換邏輯 ---
        function switchView(viewId) {
            // 隱藏所有視圖內容
            document.querySelectorAll('.view-content').forEach(view => {
                view.classList.add('hidden');
            });
            // 移除所有 Tab 按鈕的 active 樣式
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
                button.classList.add('text-gray-500', 'hover:text-gray-700');
            });

            // 顯示選定的視圖內容
            document.getElementById(viewId).classList.remove('hidden');

            // 設置選定的 Tab 按鈕為 active
            document.getElementById(`tab-${viewId.replace('-view', '')}`).classList.add('active');
            document.getElementById(`tab-${viewId.replace('-view', '')}`).classList.remove('text-gray-500', 'hover:text-gray-700');

            // 重新渲染圖表 (防止切換回來時圖表變形)
            if (viewId === 'dashboard-view') {
                if (cashFlowChartInstance) cashFlowChartInstance.destroy();
                if (expenseChartInstance) expenseChartInstance.destroy();
                setTimeout(() => {
                    renderCashFlowChart();
                    renderExpenseChart();
                }, 50); // 延遲渲染以確保 canvas 元素已可見
            } else if (viewId === 'general-ledger-view') {
                renderGeneralLedger(); // 渲染總帳數據
            }
        }

        // --- 模擬數據 (總帳分錄) ---
        const journalEntries = [
            // 薪資支付
            { date: '2024-10-25', voucher: 'J001', description: '支付員工薪資', account: '薪資費用', debit: 800000.00, credit: 0.00 },
            { date: '2024-10-25', voucher: 'J001', description: '支付員工薪資', account: '銀行存款', debit: 0.00, credit: 800000.00 },
            // 採購設備
            { date: '2024-10-26', voucher: 'J002', description: '採購辦公設備', account: '設備資產', debit: 150000.00, credit: 0.00 },
            { date: '2024-10-26', voucher: 'J002', description: '採購辦公設備', account: '應付帳款', debit: 0.00, credit: 150000.00 },
            // 銷貨收入
            { date: '2024-10-26', voucher: 'J003', description: '產品 A 銷貨', account: '應收帳款', debit: 450000.00, credit: 0.00 },
            { date: '2024-10-26', voucher: 'J003', description: '產品 A 銷貨', account: '銷貨收入', debit: 0.00, credit: 450000.00 },
            // 收到應收帳款
            { date: '2024-10-27', voucher: 'J004', description: '收到客戶付款', account: '現金', debit: 300000.00, credit: 0.00 },
            { date: '2024-10-27', voucher: 'J004', description: '收到客戶付款', account: '應收帳款', debit: 0.00, credit: 300000.00 },
            // 支付租金
            { date: '2024-10-27', voucher: 'J005', description: '支付辦公室租金', account: '租金費用', debit: 50000.00, credit: 0.00 },
            { date: '2024-10-27', voucher: 'J005', description: '支付辦公室租金', account: '銀行存款', debit: 0.00, credit: 50000.00 },
            // 借款利息支出
            { date: '2024-10-28', voucher: 'J006', description: '支付銀行借款利息', account: '利息費用', debit: 15000.00, credit: 0.00 },
            { date: '2024-10-28', voucher: 'J006', description: '支付銀行借款利息', account: '現金', debit: 0.00, credit: 15000.00 },
        ];

        // --- 總帳渲染與篩選邏輯 (優化後的核心功能) ---
        function formatCurrency(value) {
            if (value === 0) return '-';
            return 'NT$ ' + parseFloat(value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function filterLedger() {
            const dateRange = document.getElementById('date-range').value.trim();
            const accountFilter = document.getElementById('account-filter').value;
            const searchText = document.getElementById('search-text').value.toLowerCase().trim();

            let filteredEntries = journalEntries;

            // 1. 帳戶篩選
            if (accountFilter) {
                filteredEntries = filteredEntries.filter(entry => entry.account === accountFilter);
            }

            // 2. 關鍵字搜尋 (描述或憑證號碼)
            if (searchText) {
                filteredEntries = filteredEntries.filter(entry => 
                    entry.description.toLowerCase().includes(searchText) || 
                    entry.voucher.toLowerCase().includes(searchText)
                );
            }

            // 3. 日期範圍篩選 (簡化邏輯：只檢查是否包含起始日期)
            // 由於日期範圍輸入是一個單一文字框，這裡只模擬檢查一個精確日期或憑證號碼
            // 實際應用中會使用日期選擇器
            if (dateRange && dateRange.length === 10) { // 假設輸入格式 YYYY-MM-DD
                filteredEntries = filteredEntries.filter(entry => entry.date === dateRange);
            }
            
            renderGeneralLedger(filteredEntries);
        }

        function resetFilters() {
            document.getElementById('date-range').value = '';
            document.getElementById('account-filter').value = '';
            document.getElementById('search-text').value = '';
            renderGeneralLedger();
        }

        function renderGeneralLedger(entries = journalEntries) {
            const tbody = document.getElementById('ledger-body');
            const balanceSummary = document.getElementById('balance-summary');
            const noResults = document.getElementById('no-results');
            
            tbody.innerHTML = '';
            
            let totalDebit = 0;
            let totalCredit = 0;

            if (entries.length === 0) {
                noResults.classList.remove('hidden');
                balanceSummary.innerHTML = '';
                return;
            } else {
                noResults.classList.add('hidden');
            }

            entries.forEach((entry, index) => {
                totalDebit += entry.debit;
                totalCredit += entry.credit;

                const row = document.createElement('tr');
                row.classList.add(index % 2 === 0 ? 'bg-white' : 'bg-gray-50', 'hover:bg-indigo-50', 'transition');

                // 只有借方或貸方有值的行才顯示金額，另一方為 '-'
                const debitDisplay = formatCurrency(entry.debit);
                const creditDisplay = formatCurrency(entry.credit);
                
                // 為了視覺上分組，相同憑證號碼的行會被合併
                const isGroupStart = index === 0 || entry.voucher !== entries[index - 1].voucher;
                const dateDisplay = isGroupStart ? entry.date : '';
                const voucherDisplay = isGroupStart ? entry.voucher : '';

                row.innerHTML = `
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900">${dateDisplay}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${voucherDisplay}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900">${entry.description}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-indigo-600">${entry.account}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-right text-green-700 font-mono">${debitDisplay}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-right text-red-700 font-mono">${creditDisplay}</td>
                `;
                tbody.appendChild(row);
            });

            // 渲染借貸平衡總結
            const isBalanced = Math.abs(totalDebit - totalCredit) < 0.01;
            const balanceColor = isBalanced ? 'text-green-700 bg-green-100' : 'text-red-700 bg-red-100';
            const balanceStatus = isBalanced ? '平衡 (Balanced)' : '不平衡 (Out of Balance)';

            balanceSummary.innerHTML = `
                <div class="flex justify-between items-center text-lg font-bold">
                    <div class="space-y-1">
                        <p class="text-gray-600">借方總額 (Total Debit): <span class="text-green-600">${formatCurrency(totalDebit)}</span></p>
                        <p class="text-gray-600">貸方總額 (Total Credit): <span class="text-red-600">${formatCurrency(totalCredit)}</span></p>
                    </div>
                    <div class="p-3 rounded-lg ${balanceColor} font-extrabold text-xl shadow-md">
                        ${balanceStatus}
                    </div>
                </div>
            `;
        }

        // --- 圖表渲染邏輯 (Dashboard) ---
        
        // 月度現金流圖表
        function renderCashFlowChart() {
            const ctx = document.getElementById('cashFlowChart').getContext('2d');
            const data = {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                datasets: [{
                    label: '淨現金流 (Net Flow)',
                    data: [120000, 190000, 300000, 50000, 200000, 400000, 350000],
                    backgroundColor: 'rgba(79, 70, 229, 0.8)',
                    borderColor: 'rgba(79, 70, 229, 1)',
                    borderWidth: 1,
                    tension: 0.4,
                    fill: true,
                }]
            };
            cashFlowChartInstance = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // 費用類別分佈圖表 (圓餅圖)
        function renderExpenseChart() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const data = {
                labels: ['薪資', '租金', '採購', '營銷', '雜項'],
                datasets: [{
                    label: '費用分佈',
                    data: [40, 25, 15, 10, 10], // 百分比
                    backgroundColor: [
                        '#4f46e5', // Indigo
                        '#f59e0b', // Amber
                        '#10b981', // Emerald
                        '#ef4444', // Red
                        '#6b7280'  // Gray
                    ],
                    hoverOffset: 10
                }]
            };
            expenseChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }

        // --- 頁面初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            // 預設顯示儀表板
            switchView('dashboard-view'); 
        });
    </script>
</body>
</html>
