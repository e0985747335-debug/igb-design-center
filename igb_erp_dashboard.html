<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGB ERP 2.0 戰略指揮中心</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide icons -->
    <script src="https://unpkg.com/lucide-icons"></script>
    <!-- 引入 Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- 引入科技感字體 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* 自定義樣式 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #d1d5db; /* text-gray-300 */
        }

        /* 使用 Orbitron 字體作為標題 */
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        /* 自定義儀表板卡片樣式 */
        .dashboard-card {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06),
                        0 0 15px rgba(139, 92, 246, 0.1); /* 輕微的紫羅蘭色輝光 */
        }

        /* 標籤頁按鈕樣式 */
        .tab-btn {
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            color: #a78bfa; /* text-violet-400 */
            border-bottom-color: #a78bfa; /* border-violet-400 */
            font-weight: 600;
        }

        /* 進度條背景 */
        .progress-bar-bg {
            background-color: #374151; /* bg-gray-700 */
        }

        /* 自定義顏色 (來自用戶數據) */
        .text-neon-violet {
            color: #a78bfa; /* 接近 text-violet-400 */
        }

        /* MDM 時間軸樣式 */
        .timeline-item {
            position: relative;
            padding-bottom: 1.5rem;
            padding-left: 2.5rem;
            border-left: 2px solid #374151; /* border-gray-700 */
        }
        .timeline-item:last-child {
            border-left: 2px solid transparent;
        }
        .timeline-marker {
            position: absolute;
            left: -0.6rem;
            top: 0;
            width: 1.125rem;
            height: 1.125rem;
            border-radius: 9999px;
            border: 2px solid #1f2937; /* bg-gray-800 */
        }
        .timeline-marker-milestone { background-color: #a78bfa; } /* violet */
        .timeline-marker-progress { background-color: #fbbf24; } /* amber */
        .timeline-marker-current {
            background-color: #34d399; /* green */
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .timeline-marker-upcoming { background-color: #6b7280; } /* gray */
        .timeline-marker-go-live { background-color: #ef4444; } /* red */

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* 表格樣式 */
        th, td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #374151; /* border-gray-700 */
        }
        th {
            background-color: #374151; /* bg-gray-700 */
            text-align: left;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        tbody tr:nth-child(even) {
            background-color: #1f2937; /* bg-gray-800 */
        }
        tbody tr:nth-child(odd) {
            background-color: #263142; /* bg-gray-800 稍亮 */
        }

        /* 風險狀態標籤 */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-high { background-color: #991b1b; color: #fecaca; } /* red */
        .status-medium { background-color: #9a3412; color: #fed7aa; } /* orange */
        .status-solved { background-color: #166534; color: #bbf7d0; } /* green */
        .status-open { background-color: #9a3412; color: #fed7aa; } /* orange */
        .status-solving { background-color: #1d4ed8; color: #dbeafe; } /* blue */

        /* 系統健康指示燈 */
        .health-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }
        .status-Operational { background-color: #34d399; } /* green-400 */
        .status-Degraded { background-color: #fbbf24; } /* amber-400 */
        .status-HighLatency { background-color: #ef4444; } /* red-500 */
        .status-Maintenance { background-color: #60a5fa; } /* blue-400 */

        /* 浮動通知 */
        #notification-box {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            padding: 0.75rem 1.5rem;
            background-color: #10b981; /* bg-emerald-500 */
            color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(-20px);
        }
        #notification-box.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="antialiased">

    <!-- 浮動通知框 -->
    <div id="notification-box" role="alert">
        <div class="flex items-center space-x-2">
            <i data-lucide="check" class="w-5 h-5"></i>
            <p id="notification-message" class="font-medium"></p>
        </div>
    </div>


    <div class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">

        <!-- 標題 -->
        <header class="text-center mb-8">
            <h1 class="font-orbitron text-3xl font-bold text-white tracking-wider">
                IGB ERP 2.0 戰略指揮中心
            </h1>
            <p class="text-lg text-gray-400 mt-2">Strategic Command Center - 狀態更新: <span id="current-time"></span></p>
        </header>

        <!-- 標籤頁導航 -->
        <nav class="flex justify-center border-b border-gray-700 mb-6 space-x-4 sm:space-x-8 overflow-x-auto whitespace-nowrap">
            <button id="tab-btn-dashboard" class="tab-btn py-3 px-2 sm:px-4 text-sm sm:text-base" onclick="showTab('dashboard')">
                專案儀表板
            </button>
            <button id="tab-btn-mdm" class="tab-btn py-3 px-2 sm:px-4 text-sm sm:text-base" onclick="showTab('mdm')">
                MDM 執行時間軸
            </button>
            <button id="tab-btn-tech" class="tab-btn py-3 px-2 sm:px-4 text-sm sm:text-base" onclick="showTab('tech')">
                技術規格與架構
            </button>
            <button id="tab-btn-risk" class="tab-btn py-3 px-2 sm:px-4 text-sm sm:text-base" onclick="showTab('risk')">
                風險與問題追蹤
            </button>
            <button id="tab-btn-accounting" class="tab-btn py-3 px-2 sm:px-4 text-sm sm:text-base" onclick="showTab('accounting')">
                即時會計系數
            </button>
            <button id="tab-btn-health" class="tab-btn py-3 px-2 sm:px-4 text-sm sm:text-base" onclick="showTab('health')">
                系統健康監控
            </button>
            <button id="tab-btn-deployment" class="tab-btn py-3 px-2 sm:px-4 text-sm sm:text-base" onclick="showTab('deployment')">
                部署與切換狀態
            </button>
        </nav>

        <!-- 標籤頁內容 -->
        <main>
            <!-- 1. 專案儀表板 -->
            <div id="dashboard-content" class="tab-content">
                <!-- KPIs -->
                <div id="kpi-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6">
                    <!-- KPI 內容將由 JS 動態載入 -->
                </div>

                <!-- Row 2: 模組進度 (1/3) + KPI 曲線圖 (2/3) -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <!-- 模組進度 -->
                    <div class="dashboard-card rounded-lg p-6 lg:col-span-1">
                        <h2 class="font-orbitron text-xl font-semibold text-white mb-4">核心模組進度</h2>
                        <div id="modules-list" class="space-y-4">
                            <!-- 模組進度將由 JS 動態載入 -->
                        </div>
                    </div>

                    <!-- 新增: 專案進度追蹤 S 曲線圖 -->
                    <div class="dashboard-card rounded-lg p-6 lg:col-span-2">
                        <h2 class="font-orbitron text-xl font-semibold text-white mb-4">專案進度追蹤 (S 曲線)</h2>
                        <!-- 圖表容器 -->
                        <div class="h-72">
                            <canvas id="kpi-line-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Row 3: 專案狀態摘要 (Full Width) -->
                <div class="dashboard-card rounded-lg p-6">
                    <h2 class="font-orbitron text-xl font-semibold text-white mb-4">專案狀態摘要</h2>
                    <div id="status-summary-list" class="space-y-4">
                        <!-- 狀態摘要將由 JS 動態載入 -->
                    </div>
                </div>
            </div>

            <!-- 2. MDM 執行時間軸 -->
            <div id="mdm-content" class="tab-content hidden">
                <div class="dashboard-card rounded-lg p-6 sm:p-8">
                    <h2 class="font-orbitron text-xl font-semibold text-white mb-6">MDM 數據治理執行時間軸</h2>
                    <div id="mdm-timeline" class="relative">
                        <!-- MDM 時間軸將由 JS 動態載入 -->
                    </div>
                </div>
            </div>

            <!-- 3. 技術規格與架構 -->
            <div id="tech-content" class="tab-content hidden">
                <div class="dashboard-card rounded-lg p-6">
                    <h2 class="font-orbitron text-xl font-semibold text-white mb-4">EHSN 核心技術棧 (PostgreSQL/FastAPI)</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-max">
                            <thead>
                                <tr>
                                    <th>項目 (Item)</th>
                                    <th>規格 (Specification)</th>
                                    <th>負責人 (Owner)</th>
                                </tr>
                            </thead>
                            <tbody id="tech-specs-table">
                                <!-- 技術規格將由 JS 動態載入 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 4. 風險與問題追蹤 -->
            <div id="risk-content" class="tab-content hidden">
                <div class="dashboard-card rounded-lg p-6">
                    <h2 class="font-orbitron text-xl font-semibold text-white mb-4">關鍵風險與問題追蹤</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-[1000px]">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>類型</th>
                                    <th>模組</th>
                                    <th>優先級</th>
                                    <th>狀態</th>
                                    <th>負責人</th>
                                    <th class="w-1/3">描述</th>
                                    <th class="w-1/3">緩解措施</th>
                                    <th>日期</th>
                                </tr>
                            </thead>
                            <tbody id="risk-issues-table">
                                <!-- 風險與問題將由 JS 動態載入 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 5. 即時會計系數 (更新內容) -->
            <div id="accounting-content" class="tab-content hidden">
                <div class="dashboard-card rounded-lg p-6 sm:p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="font-orbitron text-xl font-semibold text-white">即時關鍵會計系數 (截至 2025/09/30)</h2>
                        <button onclick="copyAccountingDataToClipboard()" class="flex items-center space-x-2 text-sm font-semibold text-white bg-violet-600 hover:bg-violet-700 transition duration-150 px-4 py-2 rounded-lg shadow-lg">
                            <i data-lucide="clipboard-copy" class="w-4 h-4"></i>
                            <span>複製數據到剪貼簿</span>
                        </button>
                    </div>
                    <div id="accounting-ratios-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- Ratios will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- 6. 系統健康監控 -->
            <div id="health-content" class="tab-content hidden">
                <div class="dashboard-card rounded-lg p-6 sm:p-8">
                    <h2 class="font-orbitron text-xl font-semibold text-white mb-6">EHSN 核心微服務健康狀態</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="system-health-grid">
                        <!-- System health data will be rendered here -->
                    </div>
                </div>
                <div class="mt-6 p-4 dashboard-card rounded-lg text-sm text-gray-400">
                    <p class="font-semibold text-white">健康狀態定義:</p>
                    <div class="flex flex-wrap gap-4 mt-2">
                        <span class="flex items-center"><span class="health-indicator status-Operational"></span>Operational (運行正常)</span>
                        <span class="flex items-center"><span class="health-indicator status-Degraded"></span>Degraded (性能下降)</span>
                        <span class="flex items-center"><span class="health-indicator status-HighLatency"></span>High Latency (高延遲/錯誤率高)</span>
                        <span class="flex items-center"><span class="health-indicator status-Maintenance"></span>Maintenance (維護中)</span>
                    </div>
                </div>
            </div>

            <!-- 7. 部署與切換狀態 -->
            <div id="deployment-content" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- 環境狀態卡片 -->
                    <div class="dashboard-card rounded-lg p-6 lg:col-span-1">
                        <h2 class="font-orbitron text-xl font-semibold text-white mb-4">系統環境概覽</h2>
                        <div id="environment-status-list" class="space-y-4">
                            <!-- Environments will be rendered here -->
                        </div>
                    </div>

                    <!-- 切換清單進度 -->
                    <div class="dashboard-card rounded-lg p-6 lg:col-span-2">
                        <h2 class="font-orbitron text-xl font-semibold text-white mb-4">核心上線切換清單 (Cutover Checklist)</h2>
                        <div id="cutover-checklist-list" class="space-y-4">
                            <!-- Cutover tasks will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>

    </div>

    <script>
        // ==================================================================
        // IGB ERP 2.0 戰略指揮中心 JavaScript 數據與邏輯
        // ==================================================================

        // 1. 專案儀表板數據 (dashboardData)
        const dashboardData = {
            kpis: [
                { id: 'progress', icon: 'trending-up', title: '總體專案進度', value: '85%', color: 'text-green-400', indicator: '+5% MTD' },
                { id: 'mdm-sync', icon: 'database', title: 'MDM 核心數據清洗率', value: '85%', color: 'text-neon-violet', indicator: '目標 95%' },
                { id: 'integration', icon: 'git-merge', title: '核心微服務 API 完成度', value: '7/10', color: 'text-yellow-400', indicator: '待開發 3 個' },
                { id: 'risk', icon: 'alert-triangle', title: '關鍵風險等級', value: '低 (1)', color: 'text-orange-400', indicator: '待解決 2 項' },
            ],
            modules: [
                { name: '財務總帳 (GL/COA)', progress: 99, status: '規格定案', color: 'bg-green-500' },
                { name: '物料/永續盤存 (IM/COGS)', progress: 80, status: '數據清洗中', color: 'bg-violet-500' },
                { name: '訂單/退貨 (SD/RMA)', progress: 75, status: '核心 API 完成', color: 'bg-yellow-500' },
                { name: '微物流網絡 (SiteLink)', progress: 60, status: 'GPS 介面開發', color: 'bg-orange-500' },
            ],
            statusSummary: [
                { stage: '技術藍圖定案', date: '2025/Q3', status: '已完成', description: 'PostgreSQL/FastAPI/ZTNA 架構確認。' },
                { stage: 'MDM 數據清洗', date: '2025/Q4', status: '進行中 (85%)', description: 'COA/客戶/物料數據清洗與轉換規格。' },
                { stage: '核心 API 開發', date: '2025/Q4', status: '進行中 (75%)', description: 'Wallet/Inventory/Logistics 服務開發。' },
                { stage: 'PostgreSQL HA 建置', date: '2025/Q4', status: '進行中 (90%)', description: 'Patroni 三節點集群部署與測試。' },
                { stage: '整合測試 (E2E)', date: '2026/Q1', status: '待開始', description: 'RMA/E-Invoice/COGS 閉環流程測試。' },
                { stage: '上線切換 (Go-Live)', date: '2026/Q2', status: '規劃中', description: '數據最終載入與系統啟用。' },
            ]
        };

        // 專案進度曲線圖數據 (S-Curve)
        const kpiChartData = {
            labels: ['2025 Q3', '2025 Q4', '2026 Q1', '2026 Q2', '2026 Q3 (Go-Live)'],
            planned: [10, 45, 80, 95, 100], // 計劃進度百分比
            actual: [10, 40, 75, 85, 85],   // 實際進度百分比 (目前到 Q2)
        };

        // 2. MDM 執行時間軸數據 (mdmTimelineData)
        const mdmTimelineData = [
            { date: '2025-01-15', title: 'COA 與財務規格定案', description: 'IGB ERP COA (4xxx-7xxx) 定義完成，為自動結算奠定基礎。', type: 'milestone' },
            { date: '2025-03-01', title: '舊數據結構提取與 Mapping', description: '完成舊系統 Raw Data 提取與新舊欄位對應（Mapping）規格文件。', type: 'progress' },
            { date: '2025-06-20', title: '活躍數據清洗與標準化', description: '集中精力清洗過去 12 個月有交易的活躍客戶和物料數據。', type: 'progress' },
            { date: '2025-08-10', title: 'D2/D4 維度數據校準', description: '校準 SiteLink 地域 (D2) 和固定資產 (D4) 數據，以支持報表追溯。', type: 'progress' },
            { date: '2025-10-25', title: 'MDM 模擬上線測試 (Mock Cutover)', description: '將清洗後數據載入 PostgreSQL 環境，進行 RMA 閉環流程測試。', type: 'current' },
            { date: '2026-01-30', title: 'UAT 階段數據負責人簽核', description: '各部門 Data Owner 最終確認數據質量報告 (DQR)。', type: 'upcoming' },
            { date: '2026-04-01', title: 'MDM 正式上線', description: '核心主數據切換至 IGB ERP 2.0 MDM Service。', type: 'go-live' },
        ];

        // 3. 技術規格數據 (techSpecs)
        const techSpecs = [
            { item: '核心資料庫系統', spec: 'PostgreSQL 15+ (Master-Slave-Witness HA)', owner: '張架構師 (Architect)' },
            { item: '應用服務框架', spec: 'FastAPI (Python) / 微服務架構', owner: '王工程師 (Dev Lead)' },
            { item: '安全與閘道器', spec: 'ZTNA (Zero Trust) / API Gateway (Kong/Nginx) Header 注入', owner: '李介面專家 (Integration)' },
            { item: '數據庫 HA 策略', spec: 'Patroni 或 Repmgr (確保 99.99% 可用性)', owner: '張架構師 (Architect)' },
            { item: '主數據/配置管理', spec: 'Admin Hub (自建 MDM Service) 確保 D1/D2/D4 維度完整性', owner: '趙數據主管 (Data Mgmt)' },
            { item: '實時分析與 BI', spec: 'Grafana/Looker (讀取 EHSN 實時 KPI)', owner: '陳分析師 (BI)' },
            { item: '交易事務保證', spec: 'PostgreSQL ACID 事務 (強制用於 Wallet Ledger)', owner: '王工程師 (Dev Lead)' },
        ];

        // 4. 核心風險與問題追蹤 (riskIssuesData)
        const riskIssuesData = [
            { id: 1, type: '問題', module: '基礎設施', priority: '高', status: '已解決', owner: '張架構師', description: '舊 MySQL/MariaDB 服務殘留，可能導致連接錯誤或資源衝突。', mitigation: '已執行徹底 Purge 移除，並鎖定環境變數為 PostgreSQL。', date: '2025-10-22' },
            { id: 2, type: '風險', module: '基礎設施', priority: '中', status: '開啟', owner: '張架構師', description: 'PostgreSQL Patroni 仲裁節點配置錯誤，可能導致腦裂 (Split-Brain) 風險。', mitigation: 'Tech Lead 正在審查 Witness 節點配置，預計本週完成修復。', date: '2025-10-22' },
            { id: 3, type: '風險', module: 'FI/CO (財務)', priority: '中', status: '開啟', owner: '趙數據主管', description: '舊系統財務歷史數據格式不一致，可能延遲資料遷徙。', mitigation: '與財務團隊確認最小必要遷移數據範圍，調整清洗腳本。', date: '2025-10-20' },
            { id: 4, type: '問題', module: 'Logistics', priority: '高', status: '解決中', owner: '王工程師', description: 'SiteLink API 閘道器 ZTNA Header 注入邏輯測試失敗。', mitigation: 'Tech Lead 重新配置 API Gateway 的 proxy_set_header 指令。', date: '2025-10-22' },
            { id: 5, type: '風險', module: 'SD/RMA', priority: '中', status: '開啟', owner: '李顧問', description: 'RMA 流程 ACID 事務 (退款與紅沖) 延遲，影響客戶體驗。', mitigation: '隔離測試 Wallet/E-Invoice 服務的同步調用和異步重試邏輯。', date: '2025-10-21' },
        ];

        // 5. 即時會計系數數據 (accountingRatiosData)
        const accountingRatiosData = [
            { id: 'quick', title: '速動比率 (Quick Ratio)', value: 1.55, unit: '倍', benchmark: 1.0, trend: 'up', change: '+0.05 QTD', color: 'text-green-400', description: '衡量短期償債能力，不含存貨。' },
            { id: 'current', title: '流動比率 (Current Ratio)', value: 2.10, unit: '倍', benchmark: 2.0, trend: 'down', change: '-0.10 QTD', color: 'text-yellow-400', description: '衡量流動資產償還流動負債的能力。' },
            { id: 'debt_equity', title: '負債權益比 (Debt/Equity)', value: 0.45, unit: '倍', benchmark: 0.6, trend: 'up', change: '+0.02 QTD', color: 'text-blue-400', description: '衡量公司槓桿程度，越低越穩健。' },
            { id: 'gross_margin', title: '毛利率 (Gross Margin)', value: 42.5, unit: '%', benchmark: 40.0, trend: 'up', change: '+1.2% QTD', color: 'text-green-400', description: '反映產品定價和成本控制效率。' },
            { id: 'roe', title: '股東權益報酬率 (ROE)', value: 18.2, unit: '%', benchmark: 15.0, trend: 'up', change: '+0.8% YTD', color: 'text-neon-violet', description: '衡量公司利用自有資金賺取利潤的能力。' },
            { id: 'inventory_turnover', title: '存貨週轉率 (Inventory Turnover)', value: 6.8, unit: '次', benchmark: 7.0, trend: 'down', change: '-0.2 QTD', color: 'text-orange-400', description: '衡量存貨變現速度，數值越高越好。' },
            { id: 'receivable_days', title: '應收帳款天數 (DSO)', value: 35, unit: '天', benchmark: 40, trend: 'down', change: '-2 天 QTD', color: 'text-green-400', description: '資金回收速度，越低越好。' },
            { id: 'operating_cash', title: '營運現金流比率', value: 1.15, unit: '倍', benchmark: 1.0, trend: 'up', change: '+0.10 QTD', color: 'text-green-400', description: '衡量獲利轉為現金的能力。' },
        ];

        // 6. 系統健康監控數據 (systemHealthData)
        const systemHealthData = [
            { name: '核心 API Gateway (ZTNA)', status: 'Operational', latency: '15ms', errors: '0.01%', icon: 'shield-check' },
            { name: 'PostgreSQL HA Cluster', status: 'Operational', latency: '5ms', errors: '0%', icon: 'database' },
            { name: 'Wallet Ledger Service', status: 'Operational', latency: '20ms', errors: '0%', icon: 'wallet' },
            { name: 'Inventory Service', status: 'Degraded', latency: '45ms', errors: '1.2%', icon: 'boxes' },
            { name: 'Logistics Tracking Service', status: 'Operational', latency: '25ms', errors: '0%', icon: 'truck' },
            { name: 'MDM Data Sync Service', status: 'Maintenance', latency: 'N/A', errors: 'N/A', icon: 'settings' },
            { name: 'E-Invoice Generator', status: 'Operational', latency: '18ms', errors: '0%', icon: 'file-text' },
            { name: 'Reporting BI Interface', status: 'HighLatency', latency: '2.1s', errors: '5.5%', icon: 'bar-chart-2' },
        ];

        // 7. 部署與切換狀態數據 (deploymentStatusData)
        const deploymentStatusData = {
            environments: [
                { name: 'Development (DEV)', status: 'Active', version: '2.0.1.5', lastUpdate: '2025-10-24', health: 'Operational' },
                { name: 'Quality Assurance (QA)', status: 'Active', version: '2.0.1.2', lastUpdate: '2025-10-20', health: 'Degraded' },
                { name: 'User Acceptance Test (UAT)', status: 'Ready', version: '2.0.1.0', lastUpdate: '2025-10-15', health: 'Operational' },
                { name: 'Production (PROD)', status: 'Legacy (1.0)', version: '1.5.8.9', lastUpdate: 'N/A', health: 'Operational' },
            ],
            cutoverChecklist: [
                { task: '財務數據最終清洗確認 (COA)', responsible: '財務', status: 'Completed', progress: 100 },
                { task: 'RMA/SD 閉環 E2E 測試', responsible: '業務', status: 'In Progress', progress: 70 },
                { task: '舊系統數據靜默 (Freeze)', responsible: 'IT Infra', status: 'Pending', progress: 0 },
                { task: 'PostgreSQL Prod HA 環境驗證', responsible: 'Tech Lead', status: 'Completed', progress: 100 },
                { task: '核心服務壓力測試 (Load Test)', responsible: 'QA Lead', status: 'In Progress', progress: 50 },
                { task: '用戶權限矩陣最終審核', responsible: 'HR/Admin', status: 'Pending', progress: 0 },
            ]
        };


        // ==================================================================
        // 渲染邏輯 (Rendering Logic)
        // ==================================================================

        document.addEventListener('DOMContentLoaded', () => {
            // 設置當前時間
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('zh-TW', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });

            // 渲染所有內容
            renderDashboard();
            renderKPIChart(); // 新增：渲染 KPI 曲線圖
            renderMDMTimeline();
            renderTechSpecs();
            renderRiskIssues();
            renderAccountingRatios();
            renderSystemHealth();
            renderDeploymentStatus();

            // 激活 Lucide icons
            lucide.createIcons();

            // 顯示默認標籤頁
            showTab('dashboard');
        });

        // 標籤頁切換邏輯
        function showTab(tabId) {
            // 隱藏所有內容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            // 移除所有按鈕的 active 狀態
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // 顯示目標內容
            document.getElementById(tabId + '-content').classList.remove('hidden');
            // 激活目標按鈕
            document.getElementById('tab-btn-' + tabId).classList.add('active');

            // 每次切換時重新激活 Lucide icons (特別是 for 新渲染的內容)
            lucide.createIcons();
        }

        // 渲染專案儀表板
        function renderDashboard() {
            const kpiGrid = document.getElementById('kpi-grid');
            kpiGrid.innerHTML = dashboardData.kpis.map(kpi => `
                <div class="dashboard-card rounded-lg p-5 flex items-center space-x-4">
                    <div class="flex-shrink-0 w-12 h-12 flex items-center justify-center rounded-full ${kpi.color.replace('text-', 'bg-')} bg-opacity-20">
                        <i data-lucide="${kpi.icon}" class="${kpi.color} w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">${kpi.title}</p>
                        <p class="text-2xl font-bold ${kpi.color}">${kpi.value}</p>
                        <p class="text-xs text-gray-500">${kpi.indicator}</p>
                    </div>
                </div>
            `).join('');

            const modulesList = document.getElementById('modules-list');
            modulesList.innerHTML = dashboardData.modules.map(module => `
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-300">${module.name}</span>
                        <span class="text-sm font-medium text-gray-400">${module.status} - ${module.progress}%</span>
                    </div>
                    <div class="w-full progress-bar-bg rounded-full h-2.5">
                        <div class="${module.color} h-2.5 rounded-full" style="width: ${module.progress}%"></div>
                    </div>
                </div>
            `).join('');

            const statusList = document.getElementById('status-summary-list');
            statusList.innerHTML = dashboardData.statusSummary.map(item => `
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0 text-right">
                        <p class="font-semibold ${item.status.startsWith('進行中') ? 'text-yellow-400' : (item.status === '已完成' ? 'text-green-400' : 'text-gray-500')}">${item.status}</p>
                        <p class="text-sm text-gray-500">${item.date}</p>
                    </div>
                    <div class="border-l border-gray-700 pl-4">
                        <p class="font-medium text-white">${item.stage}</p>
                        <p class="text-sm text-gray-400">${item.description}</p>
                    </div>
                </div>
            `).join('');
        }

        // 新增：渲染專案進度追蹤 S 曲線圖
        function renderKPIChart() {
            const ctx = document.getElementById('kpi-line-chart');

            // Chart.js 全局配置，使顏色適應黑暗主題
            Chart.defaults.color = '#9ca3af'; // gray-400
            Chart.defaults.borderColor = '#374151'; // gray-700

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: kpiChartData.labels,
                    datasets: [
                        {
                            label: '實際進度 (%)',
                            data: kpiChartData.actual,
                            borderColor: '#34d399', // Green
                            backgroundColor: 'rgba(52, 211, 153, 0.1)',
                            pointRadius: 6,
                            pointBackgroundColor: '#34d399',
                            tension: 0.4,
                            fill: true,
                        },
                        {
                            label: '計劃進度 (S 曲線)',
                            data: kpiChartData.planned,
                            borderColor: '#a78bfa', // Violet
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            pointRadius: 4,
                            pointBackgroundColor: '#a78bfa',
                            tension: 0.4,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // 允許容器控制大小
                    plugins: {
                        legend: {
                            labels: {
                                usePointStyle: true,
                                color: '#d1d5db', // text-gray-300
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '進度百分比 (%)',
                                color: '#d1d5db'
                            },
                            min: 0,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: '#374151' // gray-700
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '時間節點',
                                color: '#d1d5db'
                            },
                            grid: {
                                color: '#374151' // gray-700
                            }
                        }
                    }
                }
            });
        }


        // 渲染 MDM 時間軸
        function renderMDMTimeline() {
            const timeline = document.getElementById('mdm-timeline');
            const markerClasses = {
                'milestone': 'timeline-marker-milestone',
                'progress': 'timeline-marker-progress',
                'current': 'timeline-marker-current',
                'upcoming': 'timeline-marker-upcoming',
                'go-live': 'timeline-marker-go-live'
            };
            timeline.innerHTML = mdmTimelineData.map(item => `
                <div class="timeline-item">
                    <div class="timeline-marker ${markerClasses[item.type] || 'timeline-marker-progress'}"></div>
                    <p class="text-sm text-gray-400 mb-1">${item.date}</p>
                    <h3 class="font-semibold text-lg ${item.type === 'current' ? 'text-green-400' : 'text-white'}">${item.title}</h3>
                    <p class="text-gray-300">${item.description}</p>
                </div>
            `).join('');
        }

        // 渲染技術規格
        function renderTechSpecs() {
            const tableBody = document.getElementById('tech-specs-table');
            tableBody.innerHTML = techSpecs.map(spec => `
                <tr>
                    <td class="font-medium text-white">${spec.item}</td>
                    <td class="text-gray-300">${spec.spec}</td>
                    <td class="text-gray-400">${spec.owner}</td>
                </tr>
            `).join('');
        }

        // 渲染風險與問題
        function renderRiskIssues() {
            const tableBody = document.getElementById('risk-issues-table');
            const priorityClasses = {
                '高': 'status-high',
                '中': 'status-medium'
            };
            const statusClasses = {
                '已解決': 'status-solved',
                '開啟': 'status-open',
                '解決中': 'status-solving'
            };

            tableBody.innerHTML = riskIssuesData.map(item => `
                <tr>
                    <td class="text-gray-400">${item.id}</td>
                    <td class="font-medium ${item.type === '風險' ? 'text-orange-400' : 'text-blue-400'}">${item.type}</td>
                    <td class="text-gray-300">${item.module}</td>
                    <td><span class="status-badge ${priorityClasses[item.priority]}">${item.priority}</span></td>
                    <td><span class="status-badge ${statusClasses[item.status]}">${item.status}</span></td>
                    <td class="text-gray-400">${item.owner}</td>
                    <td class="text-gray-300 text-sm">${item.description}</td>
                    <td class="text-gray-300 text-sm">${item.mitigation}</td>
                    <td class="text-gray-500 text-sm">${item.date}</td>
                </tr>
            `).join('');
        }

        // Helper function for trend icon
        function getTrendIcon(trend) {
            if (trend === 'up') return 'trending-up';
            if (trend === 'down') return 'trending-down';
            return 'minus';
        }

        // 渲染即時會計系數
        function renderAccountingRatios() {
            const grid = document.getElementById('accounting-ratios-grid');
            grid.innerHTML = accountingRatiosData.map(ratio => `
                <div class="dashboard-card rounded-xl p-5 border-l-4 border-violet-500">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm font-medium text-gray-400">${ratio.title}</p>
                        <i data-lucide="${getTrendIcon(ratio.trend)}" class="w-5 h-5 ${ratio.color}"></i>
                    </div>
                    <p class="text-3xl font-bold text-white mb-2">${ratio.value.toFixed(ratio.unit === '%' ? 1 : 2)} <span class="text-lg font-normal text-gray-400">${ratio.unit}</span></p>

                    <div class="flex justify-between items-center text-xs">
                        <div class="flex items-center space-x-2">
                            <span class="${ratio.color} font-medium">${ratio.change}</span>
                            <span class="text-gray-500">| 基準: ${ratio.benchmark}${ratio.unit}</span>
                        </div>
                        <i data-lucide="info" class="w-4 h-4 text-gray-600 ml-2" title="${ratio.description}"></i>
                    </div>
                </div>
            `).join('');
        }

        // 渲染系統健康監控
        function renderSystemHealth() {
            const grid = document.getElementById('system-health-grid');

            // 映射狀態到 Tailwind 顏色
            const statusColorMap = {
                'Operational': 'text-green-400',
                'Degraded': 'text-amber-400',
                'HighLatency': 'text-red-500',
                'Maintenance': 'text-blue-400'
            };

            const statusPillMap = {
                'Operational': 'bg-green-600/30 text-green-300',
                'Degraded': 'bg-amber-600/30 text-amber-300',
                'HighLatency': 'bg-red-600/30 text-red-300',
                'Maintenance': 'bg-blue-600/30 text-blue-300'
            };

            grid.innerHTML = systemHealthData.map(service => `
                <div class="dashboard-card rounded-lg p-5 flex flex-col justify-between h-full">
                    <div>
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="font-semibold text-white text-lg">${service.name}</h3>
                            <i data-lucide="${service.icon}" class="w-6 h-6 ${statusColorMap[service.status]}"></i>
                        </div>
                        <span class="py-1 px-3 rounded-full text-xs font-bold ${statusPillMap[service.status] || 'bg-gray-600/30 text-gray-300'} flex items-center w-fit">
                            <span class="health-indicator status-${service.status} mr-2"></span>
                            ${service.status}
                        </span>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-700 text-sm space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-400">平均延遲 (Latency)</span>
                            <span class="font-medium ${service.status === 'HighLatency' ? 'text-red-400' : 'text-white'}">${service.latency}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">錯誤率 (Error Rate)</span>
                            <span class="font-medium ${parseFloat(service.errors) > 1.0 ? 'text-red-400' : 'text-white'}">${service.errors}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 渲染部署與切換狀態
        function renderDeploymentStatus() {
            const envList = document.getElementById('environment-status-list');
            const checkList = document.getElementById('cutover-checklist-list');

            const healthIconMap = {
                'Operational': { icon: 'check-circle', color: 'text-green-400' },
                'Degraded': { icon: 'alert-triangle', color: 'text-amber-400' },
                'Ready': { icon: 'download', color: 'text-blue-400' },
                'Legacy (1.0)': { icon: 'archive', color: 'text-gray-500' },
            };

            // 渲染環境狀態
            envList.innerHTML = deploymentStatusData.environments.map(env => {
                const iconData = healthIconMap[env.health] || { icon: 'help-circle', color: 'text-gray-500' };
                return `
                    <div class="flex items-start space-x-4 p-3 rounded-md bg-gray-700/30 border border-gray-700">
                        <i data-lucide="${iconData.icon}" class="flex-shrink-0 w-6 h-6 ${iconData.color} mt-1"></i>
                        <div>
                            <p class="font-semibold text-white">${env.name}</p>
                            <p class="text-sm text-gray-400">狀態: ${env.status} | 版本: ${env.version}</p>
                            <p class="text-xs text-gray-500">最近更新: ${env.lastUpdate}</p>
                        </div>
                    </div>
                `;
            }).join('');

            // 渲染切換清單
            checkList.innerHTML = deploymentStatusData.cutoverChecklist.map(task => {
                let statusColor = 'bg-gray-700/50';
                let progressColor = 'bg-red-500';
                if (task.status === 'Completed') {
                    statusColor = 'bg-green-600/50';
                    progressColor = 'bg-green-500';
                } else if (task.status === 'In Progress') {
                    statusColor = 'bg-yellow-600/50';
                    progressColor = 'bg-yellow-500';
                } else if (task.status === 'Pending') {
                    statusColor = 'bg-violet-600/50';
                    progressColor = 'bg-violet-500';
                }

                return `
                    <div class="p-3 border-b border-gray-700 last:border-b-0">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-medium text-white">${task.task}</span>
                            <span class="py-1 px-3 text-xs font-bold rounded-full ${statusColor}">${task.status}</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-400 mb-2">
                            <span>負責人: ${task.responsible}</span>
                        </div>

                        <div class="w-full progress-bar-bg rounded-full h-2">
                            <div class="${progressColor} h-2 rounded-full transition-all duration-500" style="width: ${task.progress}%"></div>
                        </div>
                        <span class="text-xs text-gray-500 mt-1 block text-right">${task.progress}% 完成</span>
                    </div>
                `;
            }).join('');
        }

        // ==================================================================
        // 輔助功能: 複製會計系數數據到剪貼簿 (Copy Accounting Ratios)
        // ==================================================================

        function showNotification(message) {
            const box = document.getElementById('notification-box');
            const msg = document.getElementById('notification-message');
            msg.textContent = message;
            box.classList.add('show');
            setTimeout(() => {
                box.classList.remove('show');
            }, 3000);
        }

        function copyAccountingDataToClipboard() {
            const header = "| 指標名稱 | 數值 | 單位 | 基準 | 季度變化 | 說明 |\n";
            const separator = "|---|---|---|---|---|---|\n";

            const rows = accountingRatiosData.map(ratio => {
                const value = ratio.unit === '%' ? ratio.value.toFixed(1) : ratio.value.toFixed(2);
                return `| ${ratio.title} | ${value} | ${ratio.unit} | ${ratio.benchmark}${ratio.unit} | ${ratio.change} | ${ratio.description} |`;
            }).join('\n');

            const outputText = `# IGB ERP 2.0 即時關鍵會計系數 (截至 2025/09/30)\n\n` + header + separator + rows;

            // 使用 document.execCommand('copy') 來保證在 iFrame 環境中能夠複製
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = outputText;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();

            try {
                document.execCommand('copy');
                showNotification('會計數據已複製到剪貼簿 (Markdown 格式)');
            } catch (err) {
                console.error('無法複製到剪貼簿:', err);
                showNotification('複製失敗，請手動複製。');
            } finally {
                document.body.removeChild(tempTextArea);
            }
        }
    </script>
</body>
</html>
