#!/usr/bin/env bash
# ==========================================================
# ğŸ§  IGB ERP Smart Heavy Cleaner v5.4-pro
# ä½œè€…: IGB Tung (generated)
# åŠŸèƒ½:
#   - åµæ¸¬ä¸¦æ¬ç§» >100MB å¤§æª”è‡³ ~/.cache/igb-heavy/
#   - å»ºç«‹å°ˆæ¡ˆå£“ç¸®å‚™ä»½ä¸¦ä¿ç•™æœ€è¿‘ N å€‹å‚™ä»½
#   - æ›´æ–° .gitignore (å®‰å…¨æ’é™¤æ¸…å–®)
#   - Git å®‰å…¨æäº¤èˆ‡æ¨é€ (å«æ¬Šé™/é€£ç·šæª¢æŸ¥)
#   - Telegram æˆåŠŸ/å¤±æ•—é€šçŸ¥ (è‹¥å·²è¨­å®šç’°å¢ƒè®Šæ•¸)
#   - ç”¢ç”Ÿå‘½ä»¤èˆ‡çµæœæ—¥èªŒ
# ==========================================================

set -euo pipefail

PROJECT_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
cd "$PROJECT_ROOT"

DATE="$(date '+%Y-%m-%d_%H-%M-%S')"
LOG_DIR="$PROJECT_ROOT/tools/logs"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/smart-heavy-cleaner-v5.4-pro-$DATE.log"

HEAVY_CACHE="$HOME/.cache/igb-heavy"
mkdir -p "$HEAVY_CACHE"
BACKUP_DIR="$PROJECT_ROOT/tools/backups"
mkdir -p "$BACKUP_DIR"
KEEP_BACKUPS=5

# telegram env (optional)
TELEGRAM_BOT_TOKEN="${TELEGRAM_BOT_TOKEN-}"
TELEGRAM_CHAT_ID="${TELEGRAM_CHAT_ID-}"
TELEGRAM_ENABLED=0
if [[ -n "$TELEGRAM_BOT_TOKEN" && -n "$TELEGRAM_CHAT_ID" ]]; then
  TELEGRAM_ENABLED=1
fi

# helper: log
log(){
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

# start
log "ğŸš€ Smart Heavy Cleaner v5.4-pro å•Ÿå‹•"

# Step 1: find and move files >100M (exclude .git, tools/backups, yes, node_modules)
log "ğŸ” åµæ¸¬ >100MB æª”æ¡ˆ..."
MOVED_COUNT=0
find . -type f -size +100M -not -path './.git/*' -not -path './yes/*' -not -path './tools/backups/*' -not -path './tools/reports/*' -not -path './node_modules/*' 2>/dev/null | while read -r FILE; do
  # normalize
  FILE="${FILE#./}"
  TARGET_DIR="$HEAVY_CACHE/$(dirname "$FILE")"
  mkdir -p "$TARGET_DIR"
  BASENAME="$(basename "$FILE")"
  log "âš™ åµæ¸¬åˆ°å¤§æª”æ¡ˆ: $FILE"
  if mv -- "$FILE" "$TARGET_DIR/" 2>/dev/null; then
    # create stub file to indicate removal
    printf "[MOVED to %s on %s]\n" "$TARGET_DIR/$BASENAME" "$(date '+%Y-%m-%d %H:%M:%S')" > "$FILE"
    log "âœ… å·²æ¬ç§»ï¼š$FILE -> $TARGET_DIR/$BASENAME"
    ((MOVED_COUNT++))
  else
    log "âš  ç„¡æ³•æ¬ç§»: $FILE"
  fi
done
log "ğŸ“¦ å¤§æª”æ¡ˆæ¬ç§»å®Œæˆ (å…±æ¬ç§»: $MOVED_COUNT)"

# Step 2: update .gitignore safely (append only missing entries)
log "ğŸ§¾ æ›´æ–° .gitignoreï¼ˆappend ç¼ºå¤±é …ç›®ï¼‰..."
GITIGNORE_FILE="$PROJECT_ROOT/.gitignore"
mkdir -p "$(dirname "$GITIGNORE_FILE")"
cat > "$GITIGNORE_FILE.tmp" <<'EOF'
# IGB ERP autogenerated ignores
/data/
/yes/
/pgdata/
/postgres/
/caddy/data/
/caddy/config/
/tools/reports/
/tools/backups/
/logs/
/backup/
/node_modules/
__pycache__/
*.pyc
.venv/
venv/
.env
dist/
build/
*.tar.gz
EOF

# merge: keep existing lines and add missing
if [[ -f "$GITIGNORE_FILE" ]]; then
  # preserve existing and add new if missing
  awk 'FNR==NR{a[$0]=1;next} !($0 in a){print $0}' "$GITIGNORE_FILE" "$GITIGNORE_FILE.tmp" > "$GITIGNORE_FILE.merged"
  mv "$GITIGNORE_FILE.merged" "$GITIGNORE_FILE"
else
  mv "$GITIGNORE_FILE.tmp" "$GITIGNORE_FILE"
fi
rm -f "$GITIGNORE_FILE.tmp"
log "âœ… .gitignore å·²æ›´æ–°"

# Step 3: create compressed backup excluding heavy and venv and git
BACKUP_NAME="igb-design-center-$DATE.tar.gz"
BACKUP_PATH="$BACKUP_DIR/$BACKUP_NAME"
log "ğŸ“¦ å»ºç«‹å°ˆæ¡ˆå‚™ä»½: $BACKUP_NAME (æœƒæ’é™¤ .git, yes, tools/backups)"
	tar --exclude='./.git' --exclude='./yes' --exclude='./tools/backups' --exclude='./tools/reports' --exclude='./backup' -czf "$BACKUP_PATH" . 2>>"$LOG_FILE" || true
if [[ -f "$BACKUP_PATH" ]]; then
  log "âœ… å‚™ä»½å®Œæˆ: $BACKUP_PATH"
else
  log "âš  å‚™ä»½æª”æ¡ˆæœªå»ºç«‹ï¼š$BACKUP_PATH"
fi

# retention: keep last N backups
log "ğŸ—‘ ä¿ç•™æœ€è¿‘ $KEEP_BACKUPS å€‹å‚™ä»½ï¼Œå…¶é¤˜åˆªé™¤"
(ls -1t "$BACKUP_DIR"/*.tar.gz 2>/dev/null || true) | tail -n +$((KEEP_BACKUPS+1)) | while read -r OLD; do
  if [[ -n "$OLD" ]]; then
    rm -f -- "$OLD" && log "ğŸ—‘ åˆªé™¤èˆŠå‚™ä»½: $OLD"
  fi
done

# Step 4: git add/commit/push safely
log "ğŸ”„ æº–å‚™ Git commit + push..."
# check inside a git repo
if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  # show status
  git status --porcelain | tee -a "$LOG_FILE"
  # stage changes (exclude heavy cache and venv)
  git add -A
  # commit if there are changes
  if git diff --cached --quiet; then
    log "â„¹ ç„¡æ–°è®Šæ›´å¯æäº¤"
    COMMIT_DONE=0
  else
    if git commit -m "ğŸ§¹ Auto-clean + backup @ $DATE" >/dev/null 2>&1; then
      log "âœ… å·² commit æœ¬æ¬¡è®Šæ›´"
      COMMIT_DONE=1
    else
      log "âš  commit å¤±æ•—ï¼Œæª¢æŸ¥ Git è¨­å®šèˆ‡æ¬Šé™"
      COMMIT_DONE=0
    fi
  fi
  # push if committed
  if [[ "$COMMIT_DONE" -eq 1 ]]; then
    # check remote access
    REMOTE_URL=$(git config --get remote.origin.url || true)
    if [[ -z "$REMOTE_URL" ]]; then
      log "âš  æœªè¨­å®š remote.origin.urlï¼Œè·³é push"
      PUSH_OK=0
    else
      if git ls-remote "$REMOTE_URL" >/dev/null 2>&1; then
        if git push origin main >/dev/null 2>&1; then
          log "âœ… Git push æˆåŠŸ"
          PUSH_OK=1
        else
          log "âš  Git push å¤±æ•— (æ¨é€éŒ¯èª¤)ï¼Œè«‹æ‰‹å‹•æª¢æŸ¥"
          PUSH_OK=0
        fi
      else
        log "âš  ç„¡æ³•å­˜å–é ç«¯å€‰åº« ($REMOTE_URL)ï¼›è«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™"
        PUSH_OK=0
      fi
    fi
  else
    PUSH_OK=0
  fi
else
  log "âŒ ç›®å‰ä¸åœ¨ Git å·¥ä½œç›®éŒ„ï¼Œç„¡æ³•åŸ·è¡Œ Git æ“ä½œ"
  PUSH_OK=0
fi

# Step 5: Telegram notification (summary)
SUMMARY="IGB Smart Heavy Cleaner çµæœ:\nMoved:$MOVED_COUNT backups:$(ls -1 "$BACKUP_DIR"/*.tar.gz 2>/dev/null | wc -l) commit:$COMMIT_DONE push:$PUSH_OK"
log "ğŸ“£ ç™¼é€ Telegram é€šçŸ¥ (è‹¥å•Ÿç”¨)"
if [[ "$TELEGRAM_ENABLED" -eq 1 ]]; then
  # send message and include the last backup as document if push ok
  curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" -d chat_id="${TELEGRAM_CHAT_ID}" -d text="$SUMMARY" >/dev/null || true
  if [[ -f "$BACKUP_PATH" ]]; then
    curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument" -F chat_id="${TELEGRAM_CHAT_ID}" -F document=@"${BACKUP_PATH}" >/dev/null || true
  fi
  log "âœ… Telegram é€šçŸ¥å·²ç™¼é€"
else
  log "âš  Telegram æœªå•Ÿç”¨ï¼Œè·³éé€šçŸ¥"
fi

log "âœ… Smart Heavy Cleaner v5.4-pro å®Œæˆ"

# EOF
