<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼æ¥­å”ä½œå¯©æ‰¹ç³»çµ± (ç¶“ç†å¯©æ‰¹ç‰ˆ)</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter ä½œç‚ºä¸»è¦å­—é«”ï¼Œç¢ºä¿åœ¨å„ç¨®è¨­å‚™ä¸Šçš„ä¸€è‡´æ€§å’Œå¯è®€æ€§ */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        /* éš±è—é è¨­çš„æ²è»¸ï¼Œä½†å…è¨±å…§å®¹æ²å‹• */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* è¼‰å…¥å‹•ç•« */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5; /* indigo-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- æ‡‰ç”¨ç¨‹å¼è¼‰å…¥ä¸­ä»‹ç•«é¢ -->
    <div id="app-loading-spinner" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-50 z-[100] transition-opacity duration-300">
        <div class="spinner mb-4"></div>
        <p id="loading-status-text" class="text-indigo-600 font-medium">æ­£åœ¨å•Ÿå‹•ç³»çµ±ä¸¦é©—è­‰èº«ä»½...</p>
    </div>

    <!-- ä¸»å…§å®¹å€åŸŸ (åˆå§‹éš±è—ï¼Œå¾… Firebase æº–å‚™å°±ç·’å¾Œé¡¯ç¤º) -->
    <div id="main-content" class="hidden p-4 md:p-8 max-w-7xl mx-auto flex flex-col lg:flex-row gap-8">

        <!-- å·¦å´ï¼šæäº¤è¡¨å–® (Form) -->
        <div class="lg:w-1/3">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 sticky top-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-3">ğŸ’¡ æäº¤æ–°å¯©æ‰¹è«‹æ±‚</h2>

                <!-- ç”¨æˆ¶IDå’Œç¶“ç†IDé¡¯ç¤º -->
                <div class="mb-4 p-3 bg-indigo-50 rounded-xl text-sm text-indigo-800 border-l-4 border-indigo-600">
                    <p class="font-semibold mb-1 flex items-center">
                        æ‚¨çš„ç”¨æˆ¶ ID (Requester ID):
                        <span id="config-warning" class="hidden ml-2 px-2 py-0.5 text-xs font-bold bg-red-200 text-red-800 rounded-full">
                            âš ï¸ æ¨¡æ“¬æ¨¡å¼
                        </span>
                    </p>
                    <p id="current-user-id" class="break-all font-mono text-xs bg-indigo-100 p-1 rounded-md">
                        è¼‰å…¥ä¸­...
                    </p>
                    <p class="font-semibold mt-3 mb-1">
                        ç›®æ¨™å¯©æ‰¹ç¶“ç† ID (Manager ID):
                    </p>
                    <p id="manager-id-display" class="break-all font-mono text-xs bg-purple-100 p-1 rounded-md text-purple-800">
                        <!-- MANAGER_ID å°‡ç”± JS å¡«å…… -->
                    </p>
                </div>

                <form id="request-form">
                    <div class="mb-4">
                        <label for="title" class="block text-sm font-medium text-gray-700 mb-1">è«‹æ±‚æ¨™é¡Œ (Title)</label>
                        <input type="text" id="title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="ä¾‹å¦‚ï¼šè³¼è²·æ–°çš„è¾¦å…¬è¨­å‚™">
                    </div>
                    <div class="mb-4">
                        <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">é‡‘é¡/é ç®— (Amount)</label>
                        <input type="number" id="amount" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="ä¾‹å¦‚ï¼š12000">
                    </div>
                    <div class="mb-6">
                        <label for="details" class="block text-sm font-medium text-gray-700 mb-1">è©³ç´°èªªæ˜ (Details)</label>
                        <textarea id="details" rows="4" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="è«‹è©³ç´°æè¿°è«‹æ±‚çš„åŸå› å’Œç›®çš„..."></textarea>
                    </div>

                    <button type="submit" id="submit-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-xl shadow-md transition duration-300 transform hover:scale-[1.01] active:scale-[0.99] focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        æäº¤å¯©æ‰¹è«‹æ±‚
                    </button>
                    <p id="submission-message" class="mt-3 text-center text-sm hidden"></p>
                </form>
            </div>
        </div>

        <!-- å³å´ï¼šå¯©æ‰¹åˆ—è¡¨ (List) -->
        <div class="lg:w-2/3">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">âœ… å¯©æ‰¹ç‹€æ…‹ç¸½è¦½</h2>

                <!-- æ¨™ç±¤å°èˆª -->
                <div class="flex border-b border-gray-200 mb-4">
                    <button id="tab-pending-my-approval" data-filter="pendingMyApproval" class="tab-button px-4 py-2 text-sm font-medium text-center text-indigo-600 border-b-2 border-indigo-600 hover:text-indigo-700 transition duration-150">
                        å¾…æˆ‘å¯©æ‰¹
                    </button>
                    <button id="tab-my-requests" data-filter="myRequests" class="tab-button px-4 py-2 text-sm font-medium text-center text-gray-500 hover:text-gray-700 transition duration-150">
                        æˆ‘çš„è«‹æ±‚
                    </button>
                    <button id="tab-approved-rejected" data-filter="approvedOrRejected" class="tab-button px-4 py-2 text-sm font-medium text-center text-gray-500 hover:text-gray-700 transition duration-150">
                        å·²è™•ç†
                    </button>
                    <span class="flex-grow"></span>
                    <!-- é€™æ˜¯æ•¸æ“šè¼‰å…¥æŒ‡ç¤ºå™¨ï¼Œåˆå§‹éš±è— -->
                    <div id="data-loading-indicator" class="flex items-center text-sm text-indigo-600 hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        æ›´æ–°ä¸­...
                    </div>
                </div>

                <!-- åˆ—è¡¨å®¹å™¨ -->
                <div id="requests-list" class="space-y-4 hide-scrollbar min-h-[200px]">
                    <!-- åˆå§‹ç‹€æ…‹è¨Šæ¯ -->
                    <div id="empty-state-message" class="text-center p-8 text-gray-500 bg-gray-50 rounded-lg border border-dashed border-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 mx-auto mb-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="text-lg font-medium">æš«ç„¡å¯©æ‰¹è«‹æ±‚</p>
                        <p>æäº¤æ–°çš„è«‹æ±‚æˆ–ç­‰å¾…åŒäº‹ç™¼èµ·å¯©æ‰¹ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ…‹æ¡†å®¹å™¨ (ç”¨æ–¼å¯©æ‰¹æ“ä½œ) -->
    <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div id="approval-modal" class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100 opacity-100">
            <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">å¯©æ‰¹è«‹æ±‚</h3>
            <p class="text-sm text-gray-600 mb-4">æ‚¨æ­£åœ¨å¯©æ‰¹ç·¨è™Ÿç‚º <span id="modal-doc-id" class="font-mono text-indigo-600"></span> çš„è«‹æ±‚ã€‚</p>

            <div id="modal-content" class="mb-4 text-gray-700 space-y-1 text-sm">
                <!-- è«‹æ±‚è©³ç´°å…§å®¹å°‡å‹•æ…‹è¼‰å…¥é€™è£¡ -->
            </div>

            <label for="comment" class="block text-sm font-medium text-gray-700 mb-1">å¯©æ‰¹æ„è¦‹ (é¸å¡«)</label>
            <textarea id="comment" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 mb-6" placeholder="è¼¸å…¥æ‚¨çš„å¯©æ‰¹è©•è«–..."></textarea>

            <div class="flex justify-end space-x-3">
                <button id="modal-close" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-lg transition duration-150">å–æ¶ˆ</button>
                <button id="modal-reject" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-medium rounded-lg transition duration-150">æ‹’çµ•</button>
                <button id="modal-approve" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg transition duration-150">æ‰¹å‡†</button>
            </div>
        </div>
    </div>


    <script type="module">
        // ====================================================================
        // Firebase Configuration and Initialization
        // ====================================================================
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        import {
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        import {
            getFirestore,
            collection,
            addDoc,
            onSnapshot,
            query,
            doc,
            updateDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- æ ¸å¿ƒè®Šæ•¸å®šç¾© ---

        // ğŸš¨ å„ªåŒ– 1: å®šç¾©ä¸€å€‹å›ºå®šçš„ç¶“ç† IDã€‚åªæœ‰ç”¨æˆ¶ ID èˆ‡æ­¤åŒ¹é…æ™‚ï¼Œæ‰èƒ½å¯©æ‰¹è«‹æ±‚ã€‚
        const MANAGER_ID = 'Approver_Manager_ID_001';

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let firebaseConfig = null;
        let useFallbackConfig = false;

        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) {
            console.error("è§£æ Firebase é…ç½®æ™‚ç™¼ç”ŸéŒ¯èª¤ (JSON.parse å¤±æ•—):", e);
        }

        if (!firebaseConfig) {
            console.warn("âš ï¸ æ‰¾ä¸åˆ° __firebase_configã€‚é€²å…¥æ¨¡æ“¬æ¨¡å¼ (æ•¸æ“šç„¡æ³•æŒä¹…ä¿å­˜)ã€‚");
            firebaseConfig = {
                apiKey: "dummy-api-key",
                authDomain: "dummy.firebaseapp.com",
                projectId: "dummy-project-id",
                storageBucket: "dummy-app-bucket.com",
                messagingSenderId: "1234567890",
                appId: "1:1234567890:web:1234567890",
            };
            useFallbackConfig = true;
        }


        // --- Global App State and Instances ---
        let app;
        let db;
        let auth;
        let userId = null; // ç•¶å‰ç™»å…¥ç”¨æˆ¶çš„ ID
        let allRequests = []; // å„²å­˜æ‰€æœ‰å¾ Firestore è¼‰å…¥çš„è«‹æ±‚
        let currentFilter = 'pendingMyApproval'; // ç•¶å‰é¸ä¸­çš„ç¯©é¸å™¨
        let requestCounter = 0; // ç”¨æ–¼æ¨¡æ“¬æ¨¡å¼ä¸‹çš„ ID è¨ˆæ•¸å™¨

        // --- Global DOM Cache ---
        const DOM = {};

        /**
         * å•Ÿå‹•ç³»çµ±æ™‚ï¼Œé¡¯ç¤ºä¸»å…§å®¹ä¸¦éš±è—è¼‰å…¥ç•«é¢ã€‚
         * @param {string} statusMsg é¡¯ç¤ºåœ¨ ID å€å¡Šçš„ç‹€æ…‹è¨Šæ¯ã€‚
         */
        function initializeUI(statusMsg) {
            DOM.appLoadingSpinner.classList.add('opacity-0');
            setTimeout(() => {
                DOM.appLoadingSpinner.classList.add('hidden');
                DOM.mainContent.classList.remove('hidden');
                DOM.currentUserIdSpan.textContent = statusMsg;
                // é¡¯ç¤ºç¶“ç† ID
                DOM.managerIdDisplay.textContent = MANAGER_ID;
            }, 300);
        }

        /**
         * åˆå§‹åŒ– Firebase æ‡‰ç”¨ç¨‹å¼ã€èº«ä»½é©—è­‰ä¸¦è¨­ç½®å³æ™‚ç›£è½ã€‚
         */
        async function initFirebase() {
            DOM.loadingStatusText.textContent = 'æ­£åœ¨å•Ÿå‹• Firebase æœå‹™...';

            // --- æ¨¡æ“¬æ¨¡å¼: ç›´æ¥å¯«å…¥å‡ ID ä¸¦æ¸²æŸ“ UI ---
            if (useFallbackConfig) {
                DOM.configWarning.classList.remove('hidden');
                userId = 'DUMMY-USER-' + Math.random().toString(36).substring(2, 8).toUpperCase();
                console.log("Firebase æ¨¡æ“¬æ¨¡å¼å•Ÿç”¨ã€‚");
                initializeUI(userId);
                renderRequests(currentFilter); // ç«‹å³æ¸²æŸ“ UI
                return;
            }

            // --- æ­£å¸¸ Firebase åˆå§‹åŒ–æµç¨‹ (å¦‚æœé…ç½®å­˜åœ¨) ---
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                DOM.loadingStatusText.textContent = 'æ­£åœ¨é€²è¡Œç”¨æˆ¶èº«ä»½é©—è­‰...';

                // 1. å˜—è©¦ç™»å…¥
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Firebase èªè­‰: ä½¿ç”¨ Custom Token ç™»å…¥æˆåŠŸã€‚");
                } else {
                    await signInAnonymously(auth);
                    console.warn("Firebase èªè­‰: Custom Token ä¸å¯ç”¨ï¼Œä½¿ç”¨åŒ¿åç™»å…¥ã€‚");
                }

                // 2. ç™»å…¥æˆåŠŸå¾Œï¼Œç«‹å³è¨­ç½®ç”¨æˆ¶IDä¸¦é–‹å§‹è¼‰å…¥æ•¸æ“š
                const user = auth.currentUser;
                if (user) {
                    userId = user.uid;
                    initializeUI(userId);
                    loadRequests(); // Start data loading
                } else {
                    console.error("èªè­‰å¤±æ•—: ç”¨æˆ¶æœªç™»å…¥ã€‚");
                    initializeUI("N/A - Auth Failed");
                    renderRequests(currentFilter); // Render empty UI
                }

                onAuthStateChanged(auth, (user) => {
                    if (!user) {
                        console.error("èªè­‰ç‹€æ…‹è®Šæ›´: ç”¨æˆ¶ç™»å‡ºæˆ–æœƒè©±éæœŸã€‚");
                    }
                });

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                const errorMsg = `åˆå§‹åŒ–éŒ¯èª¤: ${error.code || error.message}`;
                DOM.loadingStatusText.textContent = 'âŒ åˆå§‹åŒ–å¤±æ•—';
                initializeUI(errorMsg);
                renderRequests(currentFilter);
            }
        }

        // ====================================================================
        // Firestore CRUD Operations and Real-Time Listener
        // ====================================================================

        /**
         * ç²å– Firestore é›†åˆçš„è·¯å¾‘
         * @returns {string} é›†åˆè·¯å¾‘
         */
        function getCollectionPath() {
            // ç”±æ–¼å¯©æ‰¹æ•¸æ“šæ˜¯ç•¶å‰ç”¨æˆ¶æäº¤çš„ï¼Œæˆ‘å€‘ä»ç„¶ä½¿ç”¨æäº¤äººçš„ç§æœ‰è·¯å¾‘
            const safeUserId = userId || 'temp_user';
            return `/artifacts/${appId}/users/${safeUserId}/approval_requests`;
        }

        /**
         * æäº¤æ–°çš„å¯©æ‰¹è«‹æ±‚åˆ° Firestore (æˆ–æ¨¡æ“¬æäº¤)
         */
        async function createRequest(e) {
            e.preventDefault();

            if (!userId) {
                DOM.submissionMessage.textContent = 'âŒ ç³»çµ±å°šæœªæº–å‚™å¥½ (ç”¨æˆ¶ ID æœªè¼‰å…¥)ã€‚';
                DOM.submissionMessage.classList.remove('hidden', 'text-green-600');
                DOM.submissionMessage.classList.add('text-red-600');
                setTimeout(() => DOM.submissionMessage.classList.add('hidden'), 3000);
                return;
            }

            const title = DOM.titleInput.value.trim();
            const amount = parseFloat(DOM.amountInput.value);
            const details = DOM.detailsTextarea.value.trim();

            if (!title || isNaN(amount) || amount <= 0 || !details) {
                DOM.submissionMessage.textContent = 'è«‹å¡«å¯«æ‰€æœ‰æœ‰æ•ˆçš„è«‹æ±‚æ¬„ä½ï¼';
                DOM.submissionMessage.classList.remove('hidden', 'text-green-600');
                DOM.submissionMessage.classList.add('text-red-600');
                setTimeout(() => DOM.submissionMessage.classList.add('hidden'), 3000);
                return;
            }

            DOM.submitButton.disabled = true;
            DOM.submitButton.textContent = 'æäº¤ä¸­...';
            DOM.submissionMessage.classList.add('hidden');
            requestCounter++;

            const newRequest = {
                title: title,
                amount: amount,
                details: details,
                // metadata
                id: useFallbackConfig ? `sim-req-${requestCounter}` : null,
                requesterId: userId,
                // ğŸš¨ å„ªåŒ– 2: å›ºå®šæŒ‡å‘ MANAGER_IDï¼Œå¯¦ç¾ç¶“ç†å¯©æ‰¹
                approverId: MANAGER_ID,
                status: 'Pending',
                createdAt: useFallbackConfig ? { toDate: () => new Date() } : serverTimestamp(),
            };

            if (useFallbackConfig) {
                allRequests.push(newRequest);
                DOM.requestForm.reset();
                DOM.submissionMessage.textContent = 'âœ… è«‹æ±‚å·²æˆåŠŸæäº¤ (æœ¬åœ°æ¨¡æ“¬)ï¼';
                DOM.submissionMessage.classList.remove('hidden', 'text-red-600');
                DOM.submissionMessage.classList.add('text-green-600');
                renderRequests(currentFilter);
            } else {
                try {
                    const colRef = collection(db, getCollectionPath());
                    await addDoc(colRef, newRequest);

                    DOM.requestForm.reset();
                    DOM.submissionMessage.textContent = 'âœ… è«‹æ±‚å·²æˆåŠŸæäº¤ï¼';
                    DOM.submissionMessage.classList.remove('hidden', 'text-red-600');
                    DOM.submissionMessage.classList.add('text-green-600');
                } catch (error) {
                    console.error("[Submission Debug] âŒ æäº¤è«‹æ±‚å¤±æ•—:", error);
                    DOM.submissionMessage.textContent = `âŒ æäº¤å¤±æ•—: ${error.message}`;
                    DOM.submissionMessage.classList.remove('hidden', 'text-green-600');
                    DOM.submissionMessage.classList.add('text-red-600');
                }
            }

            DOM.submitButton.disabled = false;
            DOM.submitButton.textContent = 'æäº¤å¯©æ‰¹è«‹æ±‚';
            setTimeout(() => DOM.submissionMessage.classList.add('hidden'), 3000);
        }

        /**
         * è¨­ç½®å° Firestore é›†åˆçš„å³æ™‚ç›£è½ (onSnapshot) æˆ–åœ¨æ¨¡æ“¬æ¨¡å¼ä¸‹è·³éã€‚
         */
        function loadRequests() {
            if (useFallbackConfig || !db || !userId) {
                DOM.dataLoadingIndicator.classList.add('hidden');
                return;
            }

            const colRef = collection(db, getCollectionPath());
            const q = query(colRef);

            DOM.dataLoadingIndicator.classList.remove('hidden');

            const unsubscribe = onSnapshot(q, (snapshot) => {
                allRequests = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    allRequests.push({ id: doc.id, ...data });
                });

                renderRequests(currentFilter);

                DOM.dataLoadingIndicator.classList.add('hidden');
                console.log(`[Real-Time Data] ğŸ”„ æˆåŠŸè¼‰å…¥ ${allRequests.length} æ¢è«‹æ±‚ã€‚`);

            }, (error) => {
                console.error("å³æ™‚ç›£è½å¤±æ•— (onSnapshot Error):", error);
                DOM.dataLoadingIndicator.innerHTML = 'âŒ è¼‰å…¥å¤±æ•—';
                DOM.dataLoadingIndicator.classList.remove('hidden');
            });
        }

        /**
         * å¯©æ‰¹æˆ–æ‹’çµ•è«‹æ±‚ (æˆ–æ¨¡æ“¬å¯©æ‰¹)
         */
        async function handleApprovalAction(docId, newStatus, comment) {
            if (!userId) {
                console.error("éŒ¯èª¤: ç”¨æˆ¶æœªç™»å…¥ã€‚");
                return;
            }

            if (useFallbackConfig) {
                const requestIndex = allRequests.findIndex(r => r.id === docId);
                if (requestIndex !== -1) {
                    allRequests[requestIndex].status = newStatus;
                    allRequests[requestIndex].approvalComment = comment;
                    allRequests[requestIndex].approvedBy = userId;
                    renderRequests(currentFilter);
                    closeModal();
                }
                return;
            }

            const docRef = doc(db, getCollectionPath(), docId);

            try {
                await updateDoc(docRef, {
                    status: newStatus,
                    approvalComment: comment,
                    approvedBy: userId,
                    approvedAt: serverTimestamp(),
                });

                closeModal();

            } catch (error) {
                console.error(`[Approval Debug] âŒ æ›´æ–°è«‹æ±‚ ${docId} å¤±æ•—:`, error);
            }
        }

        // ====================================================================
        // Client-Side Rendering, Filtering, and Helpers
        // ====================================================================

        /**
         * æ ¼å¼åŒ– Firestore Timestamp æˆ– Date ç‰©ä»¶ç‚ºæœ¬åœ°æ—¥æœŸå­—ä¸²ã€‚
         */
        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : (timestamp instanceof Date ? timestamp : new Date(timestamp));

            if (isNaN(date.getTime())) return 'N/A';

            return date.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }


        /**
         * æ ¹æ“šç•¶å‰é¸ä¸­çš„ç¯©é¸å™¨éæ¿¾è«‹æ±‚åˆ—è¡¨ã€‚
         */
        function clientFilterFn(filterName) {
            const targetUserId = userId;
            let filteredList = allRequests.filter(request => {
                const requesterIdStr = request.requesterId ? String(request.requesterId) : null;
                const approverIdStr = request.approverId ? String(request.approverId) : null;

                switch (filterName) {
                    case 'pendingMyApproval':
                        // ğŸš¨ å„ªåŒ– 3: å¾…æˆ‘å¯©æ‰¹ = ç‹€æ…‹æ˜¯ Pending ä¸”æˆ‘å°±æ˜¯æŒ‡å®šçš„å¯©æ‰¹ç¶“ç† (approverId)
                        return request.status === 'Pending' && approverIdStr === targetUserId;

                    case 'myRequests':
                        // æˆ‘çš„è«‹æ±‚: è«‹æ±‚äººæ˜¯æˆ‘
                        return requesterIdStr === targetUserId;

                    case 'approvedOrRejected':
                        // å·²è™•ç†: ç‹€æ…‹ä¸æ˜¯ Pending
                        return request.status !== 'Pending';

                    default:
                        return true;
                }
            });

            // é€²è¡Œæ’åºï¼šæŒ‰å‰µå»ºæ™‚é–“ (createdAt) é™åºæ’åˆ— (æœ€æ–°çš„åœ¨å‰)
            filteredList.sort((a, b) => {
                const timeA = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
                const timeB = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
                return timeB - timeA;
            });

            return filteredList;
        }

        /**
         * æ ¹æ“šç¯©é¸çµæœæ¸²æŸ“åˆ—è¡¨åˆ° DOMã€‚
         */
        function renderRequests(filterName) {
            currentFilter = filterName;
            const requests = clientFilterFn(filterName);

            DOM.requestsList.innerHTML = '';

            if (requests.length === 0) {
                DOM.emptyStateMessage.classList.remove('hidden');

                const titleElement = DOM.emptyStateMessage.querySelector('p:nth-of-type(1)');
                const descriptionElement = DOM.emptyStateMessage.querySelector('p:nth-of-type(2)');

                if (filterName === 'pendingMyApproval') {
                    titleElement.textContent = 'ç›®å‰æ²’æœ‰å¾…æ‚¨å¯©æ‰¹çš„è«‹æ±‚';
                    descriptionElement.textContent = `åªæœ‰ç•¶æ‚¨çš„ç”¨æˆ¶ ID åŒ¹é…ç¶“ç† ID (${MANAGER_ID}) æ™‚ï¼Œæ‰èƒ½å¯©æ‰¹è«‹æ±‚ã€‚`;
                } else if (filterName === 'myRequests') {
                    titleElement.textContent = 'æ‚¨å°šæœªæäº¤ä»»ä½•è«‹æ±‚';
                    descriptionElement.textContent = 'è«‹ä½¿ç”¨å·¦å´è¡¨å–®æäº¤ä¸€å€‹æ–°çš„å¯©æ‰¹è«‹æ±‚ã€‚';
                } else {
                    titleElement.textContent = 'æš«ç„¡å·²è™•ç†çš„è«‹æ±‚';
                    descriptionElement.textContent = 'ç­‰å¾…è«‹æ±‚è¢«æ‰¹å‡†æˆ–æ‹’çµ•ã€‚';
                }
                return;
            }
            DOM.emptyStateMessage.classList.add('hidden');


            requests.forEach(request => {
                // ğŸš¨ å„ªåŒ– 4: åˆ¤æ–·æ˜¯å¦éœ€è¦å¯©æ‰¹çš„æ¢ä»¶æ”¹ç‚ºï¼šç‹€æ…‹æ˜¯ Pending ä¸”æˆ‘å°±æ˜¯æŒ‡å®šçš„å¯©æ‰¹ç¶“ç† (approverId)
                const isMyApproval = request.status === 'Pending' && request.approverId === userId;

                const statusClasses = {
                    'Pending': 'bg-yellow-100 text-yellow-800 ring-yellow-500/10',
                    'Approved': 'bg-green-100 text-green-800 ring-green-500/10',
                    'Rejected': 'bg-red-100 text-red-800 ring-red-500/10'
                };

                const date = formatDate(request.createdAt);

                let secondaryInfo = '';
                // å§‹çµ‚é¡¯ç¤ºç›®æ¨™å¯©æ‰¹äºº ID
                secondaryInfo = `å¯©æ‰¹äººID: <span class="font-mono text-xs">${request.approverId || 'N/A'}</span>`;

                const displayId = request.id || (useFallbackConfig ? 'Simulated' : 'N/A');

                const requestItem = document.createElement('div');
                requestItem.className = 'bg-white p-4 rounded-xl shadow-md hover:shadow-lg transition duration-200 border border-gray-100 flex justify-between items-center';

                requestItem.innerHTML = `
                    <div class="flex-grow min-w-0">
                        <div class="flex items-center space-x-3 mb-1">
                            <span class="px-2 py-0.5 text-xs font-semibold rounded-full ring-1 ring-inset ${statusClasses[request.status] || 'bg-gray-100 text-gray-800 ring-gray-500/10'}">
                                ${request.status === 'Pending' ? 'å¾…å¯©æ‰¹' : request.status === 'Approved' ? 'å·²æ‰¹å‡†' : 'å·²æ‹’çµ•'}
                            </span>
                            <span class="text-xs text-gray-500">${date}</span>
                        </div>
                        <p class="text-lg font-semibold text-gray-800 truncate">${request.title}</p>
                        <p class="text-sm text-gray-600">é‡‘é¡: <span class="font-bold text-indigo-600">$${request.amount.toLocaleString()}</span></p>
                        <p class="text-xs text-gray-500 mt-1 truncate">è«‹æ±‚äººID: <span class="font-mono text-xs">${request.requesterId}</span> | ${secondaryInfo}</p>
                    </div>
                    ${isMyApproval ? `
                        <button data-id="${request.id}" class="approve-button ml-4 flex-shrink-0 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg shadow-md transition duration-150 transform hover:scale-[1.05] active:scale-[0.98]">
                            å¯©æ‰¹
                        </button>
                    ` : ''}
                `;

                DOM.requestsList.appendChild(requestItem);

                if (isMyApproval) {
                    requestItem.querySelector('.approve-button').addEventListener('click', () => openModal(request));
                }
            });
        }

        // ====================================================================
        // UI Interaction Handlers (Tabs, Modal)
        // ====================================================================

        function handleTabClick(e) {
            const filterName = e.currentTarget.dataset.filter;
            if (!filterName) return;

            // 1. æ›´æ–°æŒ‰éˆ•æ¨£å¼
            DOM.tabButtons.forEach(btn => {
                btn.classList.remove('text-indigo-600', 'border-indigo-600');
                btn.classList.add('text-gray-500');
                btn.style.borderBottomWidth = '0px';
            });

            e.currentTarget.classList.remove('text-gray-500');
            e.currentTarget.classList.add('text-indigo-600', 'border-indigo-600');
            e.currentTarget.style.borderBottomWidth = '2px';

            // 2. æ¸²æŸ“æ–°åˆ—è¡¨
            renderRequests(filterName);
        }

        let currentDocId = null;

        function openModal(request) {
            currentDocId = request.id;

            DOM.modalDocId.textContent = request.id;
            DOM.modalContent.innerHTML = `
                <p><strong>æ¨™é¡Œ:</strong> ${request.title}</p>
                <p><strong>é‡‘é¡:</strong> $${request.amount.toLocaleString()}</p>
                <p><strong>è«‹æ±‚äºº:</strong> ${request.requesterId}</p>
                <p class="mt-2"><strong>è©³æƒ…:</strong></p>
                <p class="p-2 bg-gray-100 rounded-lg whitespace-pre-wrap">${request.details}</p>
                ${request.approvalComment ? `<p class="mt-2 text-gray-700"><strong>å¯©æ‰¹æ­·å²æ„è¦‹:</strong> ${request.approvalComment}</p>` : ''}
            `;
            DOM.commentTextarea.value = '';

            DOM.modalContainer.classList.remove('hidden');
            DOM.modalContainer.classList.add('flex');

            setTimeout(() => DOM.commentTextarea.focus(), 100);
        }

        function closeModal() {
            DOM.modalContainer.classList.add('hidden');
            DOM.modalContainer.classList.remove('flex');
            currentDocId = null;
        }


        // ====================================================================
        // Main Initialization
        // ====================================================================

        function setupEventListeners() {
            // 1. å¿«å– DOM å…ƒç´ 
            DOM.mainContent = document.getElementById('main-content');
            DOM.appLoadingSpinner = document.getElementById('app-loading-spinner');
            DOM.loadingStatusText = document.getElementById('loading-status-text');

            DOM.requestForm = document.getElementById('request-form');
            DOM.titleInput = document.getElementById('title');
            DOM.amountInput = document.getElementById('amount');
            DOM.detailsTextarea = document.getElementById('details');
            DOM.submitButton = document.getElementById('submit-button');
            DOM.submissionMessage = document.getElementById('submission-message');

            DOM.currentUserIdSpan = document.getElementById('current-user-id');
            // ğŸš¨ å„ªåŒ– 5: å¿«å–æ–°çš„ç¶“ç† ID é¡¯ç¤ºå…ƒç´ 
            DOM.managerIdDisplay = document.getElementById('manager-id-display');
            DOM.configWarning = document.getElementById('config-warning');
            DOM.requestsList = document.getElementById('requests-list');
            DOM.emptyStateMessage = document.getElementById('empty-state-message');
            DOM.dataLoadingIndicator = document.getElementById('data-loading-indicator');

            DOM.tabButtons = document.querySelectorAll('.tab-button');

            DOM.modalContainer = document.getElementById('modal-container');
            DOM.modalDocId = document.getElementById('modal-doc-id');
            DOM.modalContent = document.getElementById('modal-content');
            DOM.commentTextarea = document.getElementById('comment');
            DOM.modalCloseButton = document.getElementById('modal-close');
            DOM.modalRejectButton = document.getElementById('modal-reject');
            DOM.modalApproveButton = document.getElementById('modal-approve');

            // 2. ç¶å®šä¸»è¦äº‹ä»¶
            DOM.requestForm.addEventListener('submit', createRequest);
            DOM.tabButtons.forEach(button => button.addEventListener('click', handleTabClick));

            // 3. ç¶å®šæ¨¡æ…‹æ¡†äº‹ä»¶
            DOM.modalCloseButton.addEventListener('click', closeModal);
            DOM.modalContainer.addEventListener('click', (e) => {
                if (e.target === DOM.modalContainer) closeModal();
            });

            DOM.modalRejectButton.addEventListener('click', () => {
                if (currentDocId) {
                    const comment = DOM.commentTextarea.value.trim();
                    handleApprovalAction(currentDocId, 'Rejected', comment);
                }
            });

            DOM.modalApproveButton.addEventListener('click', () => {
                if (currentDocId) {
                    const comment = DOM.commentTextarea.value.trim();
                    handleApprovalAction(currentDocId, 'Approved', comment);
                }
            });

            // 4. åˆå§‹åŒ–é¡¯ç¤ºç¬¬ä¸€å€‹ç¯©é¸å™¨ (å¾…æˆ‘å¯©æ‰¹) æ¨£å¼
            document.getElementById('tab-pending-my-approval').style.borderBottomWidth = '2px';
        }

        // --- æ‡‰ç”¨ç¨‹å¼å…¥å£é» (ç«‹å³åŸ·è¡Œ) ---
        setupEventListeners();
        initFirebase(); // ç«‹å³é–‹å§‹ Firebase åˆå§‹åŒ–

    </script>
</body>
</html>
