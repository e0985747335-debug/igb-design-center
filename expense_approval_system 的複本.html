<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»å­åŒ–è²»ç”¨å ±éŠ·èˆ‡åˆ†æç³»çµ± (D3.js æ•¸æ“šå ±è¡¨)</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ D3.js for Data Visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }

        /* è‡ªè¨‚ Scrollbar */
        .scrollable-list::-webkit-scrollbar { width: 8px; }
        .scrollable-list::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 4px; }
        .scrollable-list::-webkit-scrollbar-track { background-color: #e5e7eb; }

        /* UI å„ªåŒ–ï¼šè‡ªè¨‚é€šçŸ¥æ¡†çš„è½‰æ›æ•ˆæœï¼Œè®“å®ƒæ»‘å…¥æ»‘å‡ºæ›´æµæš¢ */
        .notification-hidden { opacity: 0; transform: translateY(100%); visibility: hidden; }
        .notification-visible { opacity: 1; transform: translateY(0); visibility: visible; }

        /* ç¢ºä¿ SVG å®¹å™¨çš„å°ºå¯¸å’ŒéŸ¿æ‡‰æ€§ */
        #bar-chart-container {
            width: 100%;
            height: 500px; /* å›ºå®šé«˜åº¦ï¼Œå…§å®¹è‡ªå‹•èª¿æ•´å¯¬åº¦ */
            overflow-x: auto;
        }

        /* D3 åœ–è¡¨æ¨£å¼ */
        .bar {
            fill: #4c51bf; /* Indigo-600 */
            transition: fill 0.3s ease;
        }
        .bar:hover {
            fill: #374151; /* Gray-700 */
        }

        /* D3 Tooltip Style */
        #chart-tooltip {
            position: absolute;
            background: #1f2937; /* Gray-800 */
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
    </style>
    <!-- è¼‰å…¥ Google Icons for UI elements -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>

    <!-- ä¸»å®¹å™¨ -->
    <div id="app" class="min-h-screen p-4 sm:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900 border-b-4 border-indigo-600 pb-2 inline-block">
                è²»ç”¨å ±éŠ·èˆ‡åˆ†æç³»çµ±
            </h1>

            <!-- è§’è‰²åˆ‡æ›æ¨¡æ“¬ -->
            <div class="mt-4 flex flex-col sm:flex-row sm:items-center justify-between bg-white p-3 rounded-xl shadow-md border-l-4 border-orange-500">
                <p class="text-sm text-gray-700 font-medium mb-2 sm:mb-0">
                    <span class="material-icons text-lg align-middle mr-1 text-orange-600">person</span>
                    ç•¶å‰æ¨¡æ“¬è§’è‰²: <span id="current-role-display" class="font-bold text-lg text-indigo-700">æäº¤è€… (å“¡å·¥)</span>
                </p>
                <div class="flex space-x-2">
                    <button onclick="switchRole('submitter')" class="role-btn bg-indigo-500 hover:bg-indigo-600 text-white text-sm py-2 px-4 rounded-lg transition duration-200 shadow">
                        åˆ‡æ›ç‚º æäº¤è€… (å“¡å·¥)
                    </button>
                    <button onclick="switchRole('approver')" class="role-btn bg-green-500 hover:bg-green-600 text-white text-sm py-2 px-4 rounded-lg transition duration-200 shadow">
                        åˆ‡æ›ç‚º å¯©æ‰¹è€… (ç¶“ç†)
                    </button>
                </div>
            </div>

            <!-- è¦–åœ–åˆ‡æ›æ¨™ç±¤ -->
            <div class="mt-6 flex space-x-3 border-b border-gray-300">
                <button id="tab-dashboard" onclick="switchView('dashboard')"
                        class="px-4 py-2 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600 transition duration-150 flex items-center">
                    <span class="material-icons mr-1">paid</span> å ±éŠ·èˆ‡å¯©æ‰¹
                </button>
                <button id="tab-analysis" onclick="switchView('analysis')"
                        class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-400 hover:text-gray-700 transition duration-150 flex items-center">
                    <span class="material-icons mr-1">insights</span> æœƒè¨ˆç§‘ç›®åˆ†æ (å ±è¡¨)
                </button>
            </div>
        </header>

        <!-- å ±éŠ·/å¯©æ‰¹å„€è¡¨æ¿ (Dashboard View) -->
        <div id="dashboard-panel">
            <div id="main-content" class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                <!-- å ±éŠ·å–®æäº¤å€ (åƒ…æäº¤è€…é¡¯ç¤º) -->
                <div id="submission-area" class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
                    <h2 class="text-xl font-semibold text-indigo-700 mb-4 flex items-center">
                        <span class="material-icons mr-2 text-2xl">add_box</span> æäº¤æ–°çš„å ±éŠ·å–®
                    </h2>
                    <form id="expense-form" class="space-y-4">
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700">è²»ç”¨èªªæ˜ (å¿…å¡«)</label>
                            <input type="text" id="description" placeholder="ä¾‹å¦‚ï¼šå®¢æˆ¶é¤è²»æˆ–å°ˆæ¡ˆå·®æ—…è²»" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>

                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700">æœƒè¨ˆç§‘ç›® (å¿…é¸)</label>
                            <select id="category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-white">
                                <option value="" disabled selected>è«‹é¸æ“‡ä¸€å€‹ç§‘ç›®</option>

                                <!-- ğŸ’¼ æ—…è²»åŠäº¤é€šè²» (Travel & Transport) - å¢åŠ ç´°é … -->
                                <optgroup label="ğŸ’¼ æ—…è²»åŠäº¤é€šè²» (Travel & Transport)">
                                    <option value="åœ‹å…§å·®æ—…è²»">åœ‹å…§å·®æ—…è²» (Domestic)</option>
                                    <option value="åœ‹å¤–å·®æ—…è²»">åœ‹å¤–å·®æ—…è²» (International)</option>
                                    <option value="å¸‚å€äº¤é€šè²»">å¸‚å€äº¤é€šè²» (Local Transit)</option>
                                    <option value="é«˜éµ/ç«è»Šç¥¨">é«˜éµ/ç«è»Šç¥¨ (Rail Fare)</option>
                                    <option value="æ©Ÿç¥¨è²»ç”¨">æ©Ÿç¥¨è²»ç”¨ (Airfare)</option>
                                    <option value="ä½å®¿è²»ç”¨">ä½å®¿è²»ç”¨ (Accommodation)</option>
                                </optgroup>

                                <!-- ğŸ½ï¸ é¤è²»åŠæ‹›å¾…è²» (Meals & Entertainment) - å¢åŠ ç´°é … -->
                                <optgroup label="ğŸ½ï¸ é¤è²»åŠæ‹›å¾…è²» (Meals & Entertainment)">
                                    <option value="å®¢æˆ¶æ‹›å¾…è²»">å®¢æˆ¶æ‹›å¾…è²» (Client Entertainment)</option>
                                    <option value="å“¡å·¥ç¦åˆ©é¤è²»">å“¡å·¥ç¦åˆ©é¤è²» (Staff Welfare)</option>
                                    <option value="å…§éƒ¨æœƒè­°é¤é£²">å…§éƒ¨æœƒè­°é¤é£² (Internal Meeting F&B)</option>
                                </optgroup>

                                <!-- ğŸ“¦ è¾¦å…¬èˆ‡è¡Œæ”¿è²» (Office & Admin) - å¢åŠ ç´°é … -->
                                <optgroup label="ğŸ“¦ è¾¦å…¬èˆ‡è¡Œæ”¿è²» (Office & Admin)">
                                    <option value="è¾¦å…¬ç”¨å“åŠè€—æ">è¾¦å…¬ç”¨å“åŠè€—æ (Supplies)</option>
                                    <option value="éƒµé›»/é€šè¨Šè²»">éƒµé›»/é€šè¨Šè²» (Post & Telecom)</option>
                                    <option value="ç§Ÿé‡‘æ”¯å‡º">ç§Ÿé‡‘æ”¯å‡º (Rent Expense)</option>
                                    <option value="æ°´é›»ç“¦æ–¯è²»">æ°´é›»ç“¦æ–¯è²» (Utilities)</option>
                                    <option value="ä¿®ç¹•èˆ‡ç¶­è­·è²»">ä¿®ç¹•èˆ‡ç¶­è­·è²» (Repair & Maint.)</option>
                                    <option value="å ±ç« é›œèªŒè¨‚é–±è²»">å ±ç« é›œèªŒè¨‚é–±è²» (Subscriptions)</option>
                                </optgroup>

                                <!-- ğŸ’» è³‡è¨Šèˆ‡è»Ÿé«”è²» (IT & Software) - å¢åŠ ç´°é … -->
                                <optgroup label="ğŸ’» è³‡è¨Šèˆ‡è»Ÿé«”è²» (IT & Software)">
                                    <option value="è»Ÿé«”è¨‚é–±è²»">è»Ÿé«”è¨‚é–±è²» (Software Subscription)</option>
                                    <option value="ç¡¬é«”æ¡è³¼è²»">ç¡¬é«”æ¡è³¼è²» (Hardware Purchase)</option>
                                    <option value="è³‡è¨Šæœå‹™è²»">è³‡è¨Šæœå‹™è²» (IT Services)</option>
                                    <option value="é›²ç«¯æœå‹™è²»">é›²ç«¯æœå‹™è²» (Cloud Services)</option>
                                    <option value="ç¶²ç«™ç¶²åŸŸåç¨±è²»">ç¶²ç«™ç¶²åŸŸåç¨±è²» (Domain/Web Fees)</option>
                                </optgroup>

                                <!-- ğŸ“ˆ è¡ŒéŠ·èˆ‡æ¥­å‹™è²» (Marketing & Sales) - å¢åŠ ç´°é … -->
                                <optgroup label="ğŸ“ˆ è¡ŒéŠ·èˆ‡æ¥­å‹™è²» (Marketing & Sales)">
                                    <option value="å»£å‘Šèˆ‡å®£å‚³è²»">å»£å‘Šèˆ‡å®£å‚³è²» (Advertising)</option>
                                    <option value="æ¥­å‹™äº¤éš›è²»">æ¥­å‹™äº¤éš›è²» (Sales Relations)</option>
                                    <option value="å±•è¦½è²»">å±•è¦½è²» (Exhibition Fees)</option>
                                    <option value="å°åˆ·å®£å‚³å“">å°åˆ·å®£å‚³å“ (Printed Materials)</option>
                                    <option value="å¸‚å ´èª¿ç ”è²»">å¸‚å ´èª¿ç ”è²» (Market Research)</option>
                                </optgroup>

                                <!-- ğŸ“š åŸ¹è¨“èˆ‡äººæ‰è²» (Training & HR) - å¢åŠ ç´°é … -->
                                <optgroup label="ğŸ“š åŸ¹è¨“èˆ‡äººæ‰è²» (Training & HR)">
                                    <option value="å°ˆæ¥­åŸ¹è¨“è²»">å°ˆæ¥­åŸ¹è¨“è²» (Professional Training)</option>
                                    <option value="æ‹›å‹Ÿè²»ç”¨">æ‹›å‹Ÿè²»ç”¨ (Recruitment Costs)</option>
                                    <option value="æ•™è‚²è¨“ç·´èª²ç¨‹è²»">æ•™è‚²è¨“ç·´èª²ç¨‹è²» (Course Fees)</option>
                                    <option value="å“¡å·¥å¥åº·æª¢æŸ¥è²»">å“¡å·¥å¥åº·æª¢æŸ¥è²» (Health Check-ups)</option>
                                </optgroup>

                                <!-- ğŸ§‘â€ğŸ’» å°ˆæ¥­æœå‹™è²» (Professional Services) - å¢åŠ ç´°é … -->
                                <optgroup label="ğŸ§‘â€ğŸ’» å°ˆæ¥­æœå‹™è²» (Professional Services)">
                                    <option value="é¡§å•è²»">é¡§å•è²» (Consulting)</option>
                                    <option value="æ³•å¾‹åŠæœƒè¨ˆè²»ç”¨">æ³•å¾‹åŠæœƒè¨ˆè²»ç”¨ (Legal & Accounting)</option>
                                    <option value="å¤–éƒ¨å¯©è¨ˆè²»">å¤–éƒ¨å¯©è¨ˆè²» (External Audit)</option>
                                    <option value="ç¿»è­¯/å£è­¯è²»">ç¿»è­¯/å£è­¯è²» (Translation/Interpreting)</option>
                                </optgroup>

                                <!-- ğŸ¦ è²¡å‹™èˆ‡é›œé …è²» (Financial & Misc.) - å¢åŠ ç´°é … -->
                                <optgroup label="ğŸ¦ è²¡å‹™èˆ‡é›œé …è²» (Financial & Misc.)">
                                    <option value="éŠ€è¡Œæ‰‹çºŒè²»">éŠ€è¡Œæ‰‹çºŒè²» (Bank Charges)</option>
                                    <option value="åˆ©æ¯æ”¯å‡º">åˆ©æ¯æ”¯å‡º (Interest Expense)</option>
                                    <option value="æ”¿åºœè¦è²»èˆ‡ç½°é°">æ”¿åºœè¦è²»èˆ‡ç½°é° (Fees & Penalties)</option>
                                    <option value="ä¿éšªè²»">ä¿éšªè²» (Insurance Premiums)</option>
                                    <option value="æ…ˆå–„æè´ˆ">æ…ˆå–„æè´ˆ (Donations)</option>
                                </optgroup>

                                <!-- â“ å…¶ä»–é›œé …è²»ç”¨ (Miscellaneous) -->
                                <optgroup label="â“ å…¶ä»–é›œé …è²»ç”¨ (Miscellaneous)">
                                    <option value="å…¶ä»–é›œé …è²»ç”¨">å…¶ä»–é›œé …è²»ç”¨ (Misc. Other)</option>
                                </optgroup>
                            </select>
                        </div>

                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-700">é‡‘é¡ (å¿…å¡«)</label>
                            <input type="number" id="amount" placeholder="ä¾‹å¦‚ï¼š1500.50" required min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>

                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700">ç™¼ç”Ÿæ—¥æœŸ (å¿…å¡«)</label>
                            <input type="date" id="date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>

                        <button type="submit" id="submit-button" class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                            <span class="material-icons mr-1 text-base">send</span> æäº¤å ±éŠ·
                        </button>
                        <p id="submission-message" class="text-sm text-center mt-2 hidden"></p>
                    </form>
                </div>

                <!-- å ±éŠ·å–®åˆ—è¡¨å€ (æ ¹æ“šè§’è‰²èª¿æ•´å¯¬åº¦) -->
                <div id="list-area" class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="list-title" class="text-xl font-semibold text-green-700 flex items-center">
                            <span class="material-icons mr-2 text-2xl">list_alt</span> å¾…è™•ç†èˆ‡æ­·å²å ±éŠ·å–®
                        </h2>
                        <!-- éæ¿¾å™¨ (åªåœ¨å¯©æ‰¹è€…è§’è‰²é¡¯ç¤º) -->
                        <select id="status-filter" onchange="displayReports()" class="hidden bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 p-2.5">
                            <option value="all">æ‰€æœ‰å–®æ“š</option>
                            <option value="å¾…å¯©æ‰¹">åªçœ‹å¾…å¯©æ‰¹</option>
                            <option value="å·²æ‰¹å‡†">åªçœ‹å·²æ‰¹å‡†</option>
                            <option value="å·²æ‹’çµ•">åªçœ‹å·²æ‹’çµ•</option>
                        </select>
                    </div>

                    <!-- æ–°å¢ï¼šç¸½é‡‘é¡é¡¯ç¤ºå€ -->
                    <div id="total-amount-box" class="hidden mb-4 bg-gray-50 border-t border-b border-indigo-200 p-3 rounded-lg text-sm">
                        ç•¶å‰åˆ—è¡¨ç¸½é‡‘é¡: <span id="total-amount-display" class="font-extrabold text-lg text-indigo-700 ml-1">---</span> TWD
                    </div>

                    <div class="max-h-[60vh] overflow-y-auto scrollable-list">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¥æœŸ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">èªªæ˜/ç§‘ç›®</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é‡‘é¡ (TWD)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç‹€æ…‹</th>
                                    <th id="action-header" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="reports-list" class="bg-white divide-y divide-gray-200">
                                <!-- å ±éŠ·å–®åˆ—è¡¨å°‡ç”± JavaScript åŠ è¼‰åˆ°é€™è£¡ -->
                                <tr><td colspan="5" class="text-center py-4 text-gray-500">æ­£åœ¨åŠ è¼‰å ±éŠ·å–®...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœƒè¨ˆç§‘ç›®åˆ†æå„€è¡¨æ¿ (Analysis View) -->
        <div id="analysis-panel" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-indigo-700 mb-4 flex items-center">
                    <span class="material-icons mr-2 text-2xl">analytics</span> è²»ç”¨ç§‘ç›®ä½”æ¯”åˆ†æ (å·²æ‰¹å‡†å–®æ“š)
                </h2>
                <div class="text-sm text-gray-600 mb-6 border-b pb-4">
                    <span class="font-bold text-base text-red-600">* å ±è¡¨åƒ…ç´å…¥ç‹€æ…‹ç‚ºã€Œå·²æ‰¹å‡†ã€çš„è²»ç”¨å–®æ“šï¼Œä»¥åæ˜ å¯¦éš›æ”¯å‡ºã€‚</span>
                </div>

                <!-- çµ±è¨ˆç¸½è¦½å¡ç‰‡ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                        <p class="text-sm font-medium text-indigo-600">å·²æ‰¹å‡†å–®æ“šç¸½æ•¸</p>
                        <p id="stat-count" class="text-2xl font-extrabold text-indigo-800 mt-1">0</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <p class="text-sm font-medium text-green-600">å·²æ‰¹å‡†ç¸½é‡‘é¡ (TWD)</p>
                        <p id="stat-total" class="text-2xl font-extrabold text-green-800 mt-1">0.00</p>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <p class="text-sm font-medium text-yellow-600">æœ€é«˜è²»ç”¨ç§‘ç›®</p>
                        <p id="stat-top-category" class="text-2xl font-extrabold text-yellow-800 mt-1 truncate">N/A</p>
                    </div>
                </div>

                <!-- D3.js é•·æ¢åœ–å®¹å™¨ -->
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-t pt-4">å„ç§‘ç›®æ”¯å‡ºæ˜ç´°</h3>
                <div id="chart-area">
                    <div id="bar-chart-container">
                        <!-- D3 SVG åœ–è¡¨å°‡æ¸²æŸ“åœ¨é€™è£¡ -->
                    </div>
                </div>

                <div id="chart-no-data" class="hidden text-center py-10 text-gray-500">
                    <span class="material-icons text-4xl mb-2">info</span>
                    <p>ç›®å‰æ²’æœ‰ä»»ä½•ã€Œå·²æ‰¹å‡†ã€çš„å ±éŠ·å–®æ•¸æ“šå¯ä¾›åˆ†æã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ“¬é›»å­éƒµä»¶é€šçŸ¥æ¡† (ä½¿ç”¨è‡ªè¨‚ CSS é¡ä¾†æ§åˆ¶éš±è—/é¡¯ç¤º) -->
    <div id="email-notification-box"
        class="notification-hidden
               fixed bottom-4 right-4 max-w-sm w-full bg-white shadow-xl
               rounded-lg p-4 transition-all duration-500 ease-in-out border-l-4 border-indigo-500 z-50">
        <div class="flex items-start space-x-4">
            <span class="material-icons text-indigo-500 text-2xl mt-1">mail_outline</span>
            <div>
                <p class="text-sm font-semibold text-gray-900 flex items-center">
                    <span id="notification-icon" class="material-icons text-green-500 mr-1 text-base"></span>
                    <span id="notification-subject">æ¨¡æ“¬éƒµä»¶é€šçŸ¥</span>
                </p>
                <p id="notification-body" class="text-xs text-gray-500 mt-1">
                    [æ­¤ç‚ºæ¨¡æ“¬] å ±éŠ·å–®ç‹€æ…‹å·²è®Šæ›´ï¼Œè«‹å‰å¾€ç³»çµ±æŸ¥çœ‹ã€‚
                </p>
            </div>
        </div>
    </div>

    <!-- è²»ç”¨è©³æƒ…æ¨¡æ…‹æ¡† (Modal - ä¿æŒä¸è®Š) -->
    <div id="detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg transition-all transform duration-300 scale-100">
            <!-- Modal Header -->
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-indigo-700">å ±éŠ·å–®è©³ç´°è³‡è¨Š</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <span class="material-icons">close</span>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 space-y-4 text-sm">
                <!-- ID/åŸºæœ¬è³‡è¨Š -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-gray-500 font-medium">å ±éŠ·å–® ID:</p>
                        <p id="detail-id" class="font-mono text-gray-800">---</p>
                    </div>
                    <div>
                        <p class="text-gray-500 font-medium">ç‹€æ…‹:</p>
                        <p id="detail-status" class="font-bold text-lg">---</p>
                    </div>
                </div>

                <!-- æ ¸å¿ƒæ•¸æ“š -->
                <div class="border-t pt-4">
                    <p class="text-gray-500 font-medium">è²»ç”¨èªªæ˜:</p>
                    <p id="detail-description" class="text-gray-900 font-semibold text-lg mb-2">---</p>

                    <p class="text-gray-500 font-medium mt-3">æœƒè¨ˆç§‘ç›®:</p>
                    <p id="detail-category" class="text-indigo-600 font-medium">---</p>

                    <p class="text-gray-500 font-medium mt-3">ç™¼ç”Ÿæ—¥æœŸ:</p>
                    <p id="detail-date" class="text-gray-700">---</p>
                </div>

                <!-- é‡‘é¡ -->
                <div class="border-t pt-4">
                    <p class="text-gray-500 font-medium">å ±éŠ·é‡‘é¡:</p>
                    <p id="detail-amount" class="text-green-600 font-extrabold text-2xl">--- TWD</p>
                </div>

                <!-- æ™‚é–“è»¸/å¯©æ‰¹ç´€éŒ„ -->
                <div class="border-t pt-4">
                    <p class="text-gray-500 font-medium mb-2">æäº¤èˆ‡å¯©æ‰¹ç´€éŒ„:</p>
                    <ul class="space-y-2">
                        <li class="flex justify-between items-start">
                            <span class="text-gray-700">æäº¤æ™‚é–“:</span>
                            <span id="detail-createdAt" class="text-gray-600 text-right">---</span>
                        </li>
                        <li id="detail-approval-row" class="hidden flex justify-between items-start">
                            <span class="text-gray-700">å¯©æ‰¹è€…:</span>
                            <span id="detail-approvedBy" class="text-gray-600 text-right">---</span>
                        </li>
                         <li id="detail-approvedAt-row" class="hidden flex justify-between items-start">
                            <span class="text-gray-700">å¯©æ‰¹æ™‚é–“:</span>
                            <span id="detail-approvedAt" class="text-gray-600 text-right">---</span>
                        </li>
                        <li id="detail-rejection-reason-row" class="hidden">
                            <span class="text-red-500 font-semibold block mt-2">æ‹’çµ•åŸå›  (æ¨¡æ“¬):</span>
                            <span id="detail-rejection-reason" class="text-red-700 italic">ç„¡æä¾›ã€‚ (æ‡‰åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­è¦æ±‚å¡«å¯«)</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Modal Footer (åƒ…å¯©æ‰¹è€…åœ¨å¾…å¯©æ‰¹ç‹€æ…‹é¡¯ç¤º) -->
            <div id="detail-action-footer" class="p-5 border-t bg-gray-50 rounded-b-xl flex justify-end space-x-3 hidden">
                <button id="modal-approve-btn"
                        class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150 shadow-md flex items-center">
                    <span class="material-icons mr-1 text-base">done_all</span> æ‰¹å‡†
                </button>
                <button id="modal-reject-btn"
                        class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150 shadow-md flex items-center">
                    <span class="material-icons mr-1 text-base">close</span> æ‹’çµ•
                </button>
            </div>

        </div>
    </div>

    <!-- D3 Tooltip Element -->
    <div id="chart-tooltip"></div>


    <!-- è…³æœ¬ï¼šä½¿ç”¨æœ¬åœ°å„²å­˜ã€è§’è‰²æ¬Šé™åˆ†é›¢èˆ‡é›»å­éƒµä»¶é€šçŸ¥æ¨¡æ“¬ -->
    <script>
        // å¼•ç”¨ DOM å…ƒç´ 
        const form = document.getElementById('expense-form');
        const reportsList = document.getElementById('reports-list');
        const submissionArea = document.getElementById('submission-area');
        const listArea = document.getElementById('list-area');
        const listTitle = document.getElementById('list-title');
        const actionHeader = document.getElementById('action-header');
        const submitButton = document.getElementById('submit-button');
        const submissionMessage = document.getElementById('submission-message');

        const currentRoleDisplay = document.getElementById('current-role-display');
        const notificationBox = document.getElementById('email-notification-box');
        const statusFilter = document.getElementById('status-filter');
        const totalAmountBox = document.getElementById('total-amount-box');
        const totalAmountDisplay = document.getElementById('total-amount-display');

        // Modal å…ƒç´ å¼•ç”¨
        const detailModal = document.getElementById('detail-modal');
        const detailId = document.getElementById('detail-id');
        const detailStatus = document.getElementById('detail-status');
        const detailDescription = document.getElementById('detail-description');
        const detailCategory = document.getElementById('detail-category');
        const detailDate = document.getElementById('detail-date');
        const detailAmount = document.getElementById('detail-amount');
        const detailCreatedAt = document.getElementById('detail-createdAt');
        const detailApprovedBy = document.getElementById('detail-approvedBy');
        const detailApprovedAt = document.getElementById('detail-approvedAt');
        const detailRejectionReason = document.getElementById('detail-rejection-reason');
        const detailApprovalRow = document.getElementById('detail-approval-row');
        const detailApprovedAtRow = document.getElementById('detail-approvedAt-row');
        const detailRejectionReasonRow = document.getElementById('detail-rejection-reason-row');
        const detailActionFooter = document.getElementById('detail-action-footer');
        const modalApproveBtn = document.getElementById('modal-approve-btn');
        const modalRejectBtn = document.getElementById('modal-reject-btn');


        // æ–°å¢çš„è¦–åœ–å…ƒç´ å¼•ç”¨
        const dashboardPanel = document.getElementById('dashboard-panel');
        const analysisPanel = document.getElementById('analysis-panel');
        const tabDashboard = document.getElementById('tab-dashboard');
        const tabAnalysis = document.getElementById('tab-analysis');
        const chartContainer = document.getElementById('bar-chart-container');
        const chartNoData = document.getElementById('chart-no-data');

        // å ±è¡¨çµ±è¨ˆå¡ç‰‡å¼•ç”¨
        const statCount = document.getElementById('stat-count');
        const statTotal = document.getElementById('stat-total');
        const statTopCategory = document.getElementById('stat-top-category');

        // æœ¬åœ°å„²å­˜çš„éµå
        const STORAGE_KEY = 'local_expense_reports';
        // æ¨¡æ“¬ç•¶å‰ä½¿ç”¨è€…è§’è‰²
        let currentUserRole = 'submitter';

        // è¼”åŠ©å‡½æ•¸: æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
        function formatDateTime(isoString) {
            if (!isoString) return 'N/A';
            try {
                const date = new Date(isoString);
                return date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }).replace(/\//g, '-').replace(',', ' ');
            } catch (e) {
                return isoString;
            }
        }

        // è¼”åŠ©å‡½æ•¸: æ ¼å¼åŒ–é‡‘é¡
        function formatAmount(amount) {
            if (isNaN(amount) || amount === null) return 'N/A';
            // ä½¿ç”¨ en-US æ ¼å¼åŒ–ä»¥ç¢ºä¿åƒåˆ†ä½å’Œå…©ä½å°æ•¸é»
            return amount.toLocaleString('en-US', { minimumFractionDigits: 2 });
        }

        /**
         * è¼‰å…¥å ±éŠ·å–®è³‡æ–™ï¼ˆå¾ localStorageï¼‰
         */
        function loadReports() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error("éŒ¯èª¤ï¼šç„¡æ³•å¾ localStorage è¼‰å…¥æ•¸æ“š", error);
                return [];
            }
        }

        /**
         * å„²å­˜å ±éŠ·å–®è³‡æ–™ï¼ˆåˆ° localStorageï¼‰
         */
        function saveReports(reports) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(reports));
            } catch (error) {
                console.error("åš´é‡éŒ¯èª¤ï¼šç„¡æ³•å°‡æ•¸æ“šå­˜å„²åˆ° localStorageï¼Œå¯èƒ½ç©ºé–“å·²æ»¿æˆ–å­˜å„²è¢«ç¦ç”¨ã€‚", error);
            }
        }

        /**
         * ç°¡å–®çš„ ID ç”Ÿæˆå™¨
         */
        function generateId() {
            return 'R' + Date.now().toString(36) + Math.random().toString(36).substring(2, 5);
        }

        /**
         * æ¨¡æ“¬é›»å­éƒµä»¶é€šçŸ¥åŠŸèƒ½
         */
        function simulateEmailNotification(report, newStatus) {
            if (newStatus === 'å¾…å¯©æ‰¹') {
                // æäº¤æˆåŠŸé€šçŸ¥æäº¤è€…ï¼Œä½†é€™å€‹æ¨¡æ“¬ä¸éœ€è¦
                return;
            }

            let subject = '';
            let body = '';
            let icon = 'mail_outline';

            if (newStatus === 'å·²æ‰¹å‡†') {
                subject = 'âœ… å ±éŠ·å–®å·²æ‰¹å‡†: ' + report.description;
                body = `æ‚¨çš„è²»ç”¨å ±éŠ·å–® ID: ${report.id} (é‡‘é¡: ${formatAmount(report.amount)} TWD) å·²ç”±ç¶“ç†æ‰¹å‡†ã€‚`;
                icon = 'check_circle';
            } else if (newStatus === 'å·²æ‹’çµ•') {
                subject = 'âŒ å ±éŠ·å–®è¢«æ‹’çµ•: ' + report.description;
                body = `æ‚¨çš„è²»ç”¨å ±éŠ·å–® ID: ${report.id} (é‡‘é¡: ${formatAmount(report.amount)} TWD) å·²è¢«æ‹’çµ•ã€‚è«‹ç™»å…¥ç³»çµ±æŸ¥çœ‹è©³æƒ…ã€‚`;
                icon = 'cancel';
            }

            // é¡¯ç¤ºé€šçŸ¥
            document.getElementById('notification-subject').textContent = subject;
            document.getElementById('notification-body').textContent = `[æ¨¡æ“¬é€šçŸ¥] ${body}`;
            document.getElementById('notification-icon').textContent = icon;
            document.getElementById('notification-icon').classList.remove('text-green-500', 'text-red-500');
            document.getElementById('notification-icon').classList.add(newStatus === 'å·²æ‰¹å‡†' ? 'text-green-500' : 'text-red-500');


            notificationBox.classList.remove('notification-hidden');
            notificationBox.classList.add('notification-visible');

            // 5 ç§’å¾Œè‡ªå‹•éš±è—
            setTimeout(() => {
                notificationBox.classList.remove('notification-visible');
                notificationBox.classList.add('notification-hidden');
            }, 5000);
        }

        /**
         * è™•ç†å¯©æ‰¹æ“ä½œ (æ‰¹å‡†/æ‹’çµ•)
         */
        window.handleApproval = (reportId, newStatus) => {
            if (currentUserRole !== 'approver') {
                console.error("æ¬Šé™ä¸è¶³ï¼šåªæœ‰å¯©æ‰¹è€…å¯ä»¥åŸ·è¡Œæ­¤æ“ä½œã€‚è«‹åˆ‡æ›ç‚ºå¯©æ‰¹è€…è§’è‰²ã€‚");
                return;
            }

            let reports = loadReports();
            const reportIndex = reports.findIndex(r => r.id === reportId);

            if (reportIndex === -1 || reports[reportIndex].status !== 'å¾…å¯©æ‰¹') {
                console.warn(`å ±éŠ·å–® ID: ${reportId} ç‹€æ…‹å·²éå¾…å¯©æ‰¹ï¼Œç„¡æ³•æ“ä½œã€‚`);
                return;
            }

            try {
                const updatedReport = reports[reportIndex];
                updatedReport.status = newStatus;
                updatedReport.approvedBy = 'LocalManager'; // æ¨¡æ“¬å¯©æ‰¹è€…åç¨±
                updatedReport.approvedAt = new Date().toISOString();
                // æ¨¡æ“¬æ‹’çµ•ç†ç”±ï¼ˆå¦‚æœç‹€æ…‹ç‚ºæ‹’çµ•ï¼‰
                if (newStatus === 'å·²æ‹’çµ•') {
                    // åœ¨å¯¦éš›æ‡‰ç”¨ä¸­æ‡‰æç¤ºç¶“ç†è¼¸å…¥æ‹’çµ•åŸå› 
                    updatedReport.rejectionReason = "ä¸ç¬¦åˆå…¬å¸æ”¿ç­–æˆ–é ç®—é™åˆ¶ã€‚";
                } else {
                    delete updatedReport.rejectionReason;
                }

                saveReports(reports);
                simulateEmailNotification(updatedReport, newStatus);

                // å¯©æ‰¹å®Œæˆå¾Œï¼Œåˆ·æ–°å„€è¡¨æ¿å’Œåˆ†æå ±è¡¨
                displayReports();
                if (analysisPanel.classList.contains('hidden') === false) {
                    renderAnalysis();
                }

            } catch (e) {
                console.error("å¯©æ‰¹éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:", e);
            }
        };


        window.showReportDetails = (reportId) => {
            const reports = loadReports();
            const report = reports.find(r => r.id === reportId);

            if (!report) {
                console.error('å ±éŠ·å–®æœªæ‰¾åˆ°:', reportId);
                return;
            }

            // 1. å¡«å……åŸºæœ¬æ•¸æ“š
            detailId.textContent = report.id;
            detailDescription.textContent = report.description;
            detailCategory.textContent = report.category;
            detailDate.textContent = report.date;
            detailAmount.textContent = `${formatAmount(report.amount)} TWD`;
            detailCreatedAt.textContent = formatDateTime(report.createdAt);

            // 2. è™•ç†ç‹€æ…‹é¡è‰²
            let statusText = report.status;
            detailStatus.textContent = statusText;
            detailStatus.className = 'font-bold text-lg';
            if (statusText === 'å·²æ‰¹å‡†') detailStatus.classList.add('text-green-600');
            else if (statusText === 'å·²æ‹’çµ•') detailStatus.classList.add('text-red-600');
            else detailStatus.classList.add('text-yellow-600');

            // 3. è™•ç†å¯©æ‰¹/æ‹’çµ•è³‡è¨Š
            const isApprovedOrRejected = report.status === 'å·²æ‰¹å‡†' || report.status === 'å·²æ‹’çµ•';
            detailApprovalRow.classList.toggle('hidden', !isApprovedOrRejected);
            detailApprovedAtRow.classList.toggle('hidden', !isApprovedOrRejected);
            detailRejectionReasonRow.classList.toggle('hidden', report.status !== 'å·²æ‹’çµ•');

            if (report.status === 'å·²æ‰¹å‡†' || report.status === 'å·²æ‹’çµ•') {
                detailApprovedBy.textContent = report.approvedBy || 'N/A';
                detailApprovedAt.textContent = formatDateTime(report.approvedAt);
            }

            if (report.status === 'å·²æ‹’çµ•') {
                document.getElementById('detail-rejection-reason').textContent = report.rejectionReason || 'ç¶“ç†æœªæä¾›æ‹’çµ•ç†ç”± (æ¨¡æ“¬)';
            }

            // 4. è™•ç†æ“ä½œè…³éƒ¨ (å¯©æ‰¹è€…æ¬Šé™)
            const showActionFooter = currentUserRole === 'approver' && report.status === 'å¾…å¯©æ‰¹';
            detailActionFooter.classList.toggle('hidden', !showActionFooter);

            // è¨­ç½®æŒ‰éˆ•äº‹ä»¶ï¼Œç¢ºä¿å‚³éæ­£ç¢ºçš„ ID å’Œç‹€æ…‹
            if (showActionFooter) {
                modalApproveBtn.onclick = () => {
                    handleApproval(report.id, 'å·²æ‰¹å‡†');
                    closeModal();
                };
                modalRejectBtn.onclick = () => {
                    handleApproval(report.id, 'å·²æ‹’çµ•');
                    closeModal();
                };
            } else {
                 // ç¢ºä¿ Modal Footer ä¸Šçš„æŒ‰éˆ•åœ¨ä¸é¡¯ç¤ºæ™‚ä¸æœƒè¢«éŒ¯èª¤è§¸ç™¼
                 modalApproveBtn.onclick = null;
                 modalRejectBtn.onclick = null;
            }

            // 5. é¡¯ç¤º Modal
            detailModal.classList.remove('hidden');
        };

        window.closeModal = () => {
            detailModal.classList.add('hidden');
        };

        /**
         * é¡¯ç¤ºå ±éŠ·å–®åˆ—è¡¨ (æ ¹æ“šè§’è‰²å’Œéæ¿¾å™¨)
         */
        function displayReports() {
            let reports = loadReports();
            let filteredReports = [];
            const filterStatus = statusFilter.value;
            let totalAmount = 0;

            if (currentUserRole === 'submitter') {
                // æäº¤è€…çœ‹æ‰€æœ‰è‡ªå·±æäº¤çš„å–®æ“š (ç”±æ–¼æ˜¯æœ¬åœ°å„²å­˜æ¨¡æ“¬ï¼Œæˆ‘å€‘å‡è¨­æ‰€æœ‰å–®æ“šéƒ½æ˜¯ç•¶å‰ä½¿ç”¨è€…æäº¤çš„)
                filteredReports = reports;
                listTitle.innerHTML = `<span class="material-icons mr-2 text-2xl">list_alt</span> æˆ‘çš„å ±éŠ·å–®ç´€éŒ„`;
                actionHeader.textContent = 'æ“ä½œ';
                statusFilter.classList.add('hidden');
                totalAmountBox.classList.add('hidden');
            } else { // approver
                // å¯©æ‰¹è€…çœ‹æ‰€æœ‰å–®æ“šï¼Œä¸¦å¯ä»¥æ ¹æ“šç‹€æ…‹éæ¿¾
                if (filterStatus === 'all') {
                    filteredReports = reports;
                } else {
                    filteredReports = reports.filter(r => r.status === filterStatus);
                }
                listTitle.innerHTML = `<span class="material-icons mr-2 text-2xl">verified</span> å ±éŠ·å–®å¯©æ‰¹ä¸­å¿ƒ (${filterStatus === 'å¾…å¯©æ‰¹' ? '<span class="text-red-500 font-bold">' + filteredReports.length + ' ç­†å¾…è™•ç†</span>' : 'æ‰€æœ‰å–®æ“š'})`;
                statusFilter.classList.remove('hidden');
                totalAmountBox.classList.remove('hidden');

                // è¨ˆç®—åˆ—è¡¨ç¸½é‡‘é¡
                totalAmount = filteredReports.reduce((sum, report) => sum + report.amount, 0);
                totalAmountDisplay.textContent = formatAmount(totalAmount);
            }

            reportsList.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨

            if (filteredReports.length === 0) {
                reportsList.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">
                    <span class="material-icons text-xl align-middle mr-1">info</span>
                    æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„å ±éŠ·å–®ã€‚
                </td></tr>`;
                return;
            }

            // æ ¹æ“šæäº¤æ™‚é–“å€’åºæ’åˆ—
            filteredReports.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            filteredReports.forEach(report => {
                let statusClass = '';
                let statusText = report.status;
                let actionContent = '';
                let actionHeaderContent = 'æ“ä½œ';

                if (report.status === 'å¾…å¯©æ‰¹') {
                    statusClass = 'text-yellow-600 font-semibold';
                    if (currentUserRole === 'approver') {
                        // å¯©æ‰¹è€…ï¼šé¡¯ç¤ºå¯©æ‰¹æŒ‰éˆ•
                        actionContent = `
                            <button onclick="handleApproval('${report.id}', 'å·²æ‰¹å‡†'); event.stopPropagation();" class="text-green-600 hover:text-green-900 transition mr-2" title="æ‰¹å‡†">
                                <span class="material-icons text-lg">check</span>
                            </button>
                            <button onclick="handleApproval('${report.id}', 'å·²æ‹’çµ•'); event.stopPropagation();" class="text-red-600 hover:text-red-900 transition" title="æ‹’çµ•">
                                <span class="material-icons text-lg">close</span>
                            </button>
                        `;
                    } else {
                        actionContent = `<button class="text-indigo-600 hover:text-indigo-900 transition" title="æŸ¥çœ‹è©³æƒ…"><span class="material-icons text-lg">visibility</span></button>`;
                    }
                } else if (report.status === 'å·²æ‰¹å‡†') {
                    statusClass = 'text-green-600 font-semibold';
                    actionContent = `<button class="text-indigo-600 hover:text-indigo-900 transition" title="æŸ¥çœ‹è©³æƒ…"><span class="material-icons text-lg">visibility</span></button>`;
                } else {
                    statusClass = 'text-red-600 font-semibold';
                    actionContent = `<button class="text-indigo-600 hover:text-indigo-900 transition" title="æŸ¥çœ‹è©³æƒ…"><span class="material-icons text-lg">visibility</span></button>`;
                }

                // æ‰€æœ‰çš„å–®æ“šéƒ½å¯ä»¥é»æ“ŠæŸ¥çœ‹è©³æƒ…
                const rowClass = 'cursor-pointer hover:bg-indigo-50 transition duration-150';
                const rowOnClick = `window.showReportDetails('${report.id}')`;

                const row = `
                    <tr class="${rowClass}" onclick="${rowOnClick}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 truncate max-w-[150px]" title="${report.description}">
                            ${report.description}<br><span class="text-xs text-indigo-500 font-medium">${report.category}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-right">${formatAmount(report.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            <div class="flex justify-center items-center">
                                ${actionContent}
                            </div>
                        </td>
                    </tr>
                `;
                reportsList.insertAdjacentHTML('beforeend', row);
            });
             // æ ¹æ“šç•¶å‰è¦–åœ–èª¿æ•´æ¨™é¡Œ
             if (currentUserRole === 'approver' && statusFilter.value === 'å¾…å¯©æ‰¹') {
                 actionHeader.textContent = 'æ“ä½œ';
             } else {
                 actionHeader.textContent = 'æŸ¥çœ‹';
             }
             if (currentUserRole === 'submitter') {
                 actionHeader.textContent = 'æ“ä½œ';
             }
        }

        /**
         * åˆ‡æ›æ¨¡æ“¬è§’è‰²
         */
        window.switchRole = (role) => {
            currentUserRole = role;

            // 1. æ›´æ–°é¡¯ç¤ºå’Œæ¨£å¼
            currentRoleDisplay.textContent = role === 'submitter' ? 'æäº¤è€… (å“¡å·¥)' : 'å¯©æ‰¹è€… (ç¶“ç†)';
            const roleButtons = document.querySelectorAll('.role-btn');
            roleButtons.forEach(btn => btn.classList.remove('ring-4', 'ring-offset-2', 'ring-indigo-300', 'ring-green-300'));

            // 2. æ ¹æ“šè§’è‰²èª¿æ•´å„€è¡¨æ¿ä½ˆå±€å’Œå…§å®¹
            if (role === 'submitter') {
                submissionArea.classList.remove('hidden');
                submissionArea.classList.add('lg:col-span-1');
                listArea.classList.remove('lg:col-span-3');
                listArea.classList.add('lg:col-span-2');
                document.querySelector(`button[onclick="switchRole('submitter')"]`).classList.add('ring-4', 'ring-offset-2', 'ring-indigo-300');
            } else { // approver
                submissionArea.classList.add('hidden');
                submissionArea.classList.remove('lg:col-span-1');
                listArea.classList.remove('lg:col-span-2');
                listArea.classList.add('lg:col-span-3');
                statusFilter.value = 'å¾…å¯©æ‰¹';
                document.querySelector(`button[onclick="switchRole('approver')"]`).classList.add('ring-4', 'ring-offset-2', 'ring-green-300');
            }

            // 3. åˆ·æ–°æ•¸æ“šè¦–åœ–
            displayReports();

            // 4. å¦‚æœåœ¨åˆ†æå ±è¡¨é é¢ï¼Œä¹Ÿåˆ·æ–°åˆ†æå ±è¡¨
            if (analysisPanel.classList.contains('hidden') === false) {
                 renderAnalysis();
            }
        }

        /**
         * åˆ‡æ›è¦–åœ– (å„€è¡¨æ¿/åˆ†æ)
         */
        window.switchView = (view) => {
            if (view === 'dashboard') {
                dashboardPanel.classList.remove('hidden');
                analysisPanel.classList.add('hidden');

                tabDashboard.classList.add('border-indigo-600', 'text-indigo-600');
                tabDashboard.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-400', 'hover:text-gray-700');

                tabAnalysis.classList.remove('border-indigo-600', 'text-indigo-600');
                tabAnalysis.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-400', 'hover:text-gray-700');

                displayReports();

            } else { // analysis
                dashboardPanel.classList.add('hidden');
                analysisPanel.classList.remove('hidden');

                tabAnalysis.classList.add('border-indigo-600', 'text-indigo-600');
                tabAnalysis.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-400', 'hover:text-gray-700');

                tabDashboard.classList.remove('border-indigo-600', 'text-indigo-600');
                tabDashboard.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-400', 'hover:text-gray-700');

                renderAnalysis();
            }
        }

        /**
         * æ¸²æŸ“æœƒè¨ˆç§‘ç›®åˆ†æå ±è¡¨ (D3.js é•·æ¢åœ–)
         */
        window.renderAnalysis = () => {
            const reports = loadReports();
            const approvedReports = reports.filter(r => r.status === 'å·²æ‰¹å‡†');

            // 1. è™•ç†ç„¡æ•¸æ“šæƒ…æ³
            if (approvedReports.length === 0) {
                statCount.textContent = 0;
                statTotal.textContent = '0.00';
                statTopCategory.textContent = 'N/A';
                chartContainer.innerHTML = '';
                chartNoData.classList.remove('hidden');
                return;
            }
            chartNoData.classList.add('hidden');

            // 2. æ•¸æ“šèšåˆ (æŒ‰ category åˆ†çµ„ä¸¦è¨ˆç®—ç¸½é‡‘é¡)
            const categoryData = d3.group(approvedReports, d => d.category);
            const aggregatedData = Array.from(categoryData, ([category, reports]) => ({
                category: category,
                totalAmount: d3.sum(reports, d => d.amount)
            }));

            // æ ¹æ“šé‡‘é¡é™åºæ’åˆ—
            aggregatedData.sort((a, b) => b.totalAmount - a.totalAmount);

            // 3. è¨ˆç®—çµ±è¨ˆå¡ç‰‡æ•¸æ“š
            const totalApprovedCount = approvedReports.length;
            const totalApprovedAmount = d3.sum(aggregatedData, d => d.totalAmount);
            const topCategory = aggregatedData[0].category;

            statCount.textContent = totalApprovedCount;
            statTotal.textContent = formatAmount(totalApprovedAmount);
            statTopCategory.textContent = topCategory;

            // 4. D3.js ç¹ªè£½é•·æ¢åœ–

            // æ¸…ç©ºèˆŠåœ–è¡¨
            chartContainer.innerHTML = '';

            const margin = { top: 20, right: 30, bottom: 150, left: 90 };
            const containerWidth = chartContainer.clientWidth;
            const containerHeight = chartContainer.clientHeight;
            const width = containerWidth - margin.left - margin.right;
            const height = containerHeight - margin.top - margin.bottom;

            const svg = d3.select("#bar-chart-container")
                .append("svg")
                .attr("width", containerWidth)
                .attr("height", containerHeight)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // X è»¸ (æœƒè¨ˆç§‘ç›® - åºæ•¸å°ºè¦)
            const x = d3.scaleBand()
                .domain(aggregatedData.map(d => d.category))
                .range([0, width])
                .padding(0.2);

            // Y è»¸ (é‡‘é¡ - ç·šæ€§å°ºè¦)
            const y = d3.scaleLinear()
                .domain([0, d3.max(aggregatedData, d => d.totalAmount) * 1.1])
                .range([height, 0]);

            // ç¹ªè£½ X è»¸
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end")
                .style("font-size", "10px");

            // ç¹ªè£½ Y è»¸
            svg.append("g")
                .call(d3.axisLeft(y).tickFormat(d3.format(",.0f"))) // æ ¼å¼åŒ– Y è»¸æ•¸å­—ç‚ºåƒåˆ†ä½ï¼Œä¸å¸¶å°æ•¸
                .style("font-size", "12px");

            // Y è»¸æ¨™ç±¤
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("font-size", "14px")
                .style("fill", "#4b5563")
                .text("ç¸½æ”¯å‡ºé‡‘é¡ (TWD)");

            // ç¹ªè£½é•·æ¢åœ–
            svg.selectAll(".bar")
                .data(aggregatedData)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.category))
                .attr("y", d => y(d.totalAmount))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.totalAmount))
                // æ–°å¢ tooltip äº¤äº’
                .on("mouseover", function(event, d) {
                    d3.select(this).style("fill", "#374151"); // Hover æ•ˆæœ

                    // é¡¯ç¤º tooltip
                    d3.select("#chart-tooltip")
                        .style("opacity", 1)
                        .html(`<strong>${d.category}</strong><br>é‡‘é¡: ${formatAmount(d.totalAmount)} TWD`)
                        .style("left", (event.pageX + 15) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).style("fill", "#4c51bf"); // æ¢å¾©é¡è‰²
                    d3.select("#chart-tooltip").style("opacity", 0);
                });

            // æ•¸å€¼æ¨™ç±¤ (é¡¯ç¤ºåœ¨é•·æ¢åœ–ä¸Šæ–¹)
            svg.selectAll(".bar-label")
                .data(aggregatedData)
                .enter().append("text")
                .attr("class", "bar-label")
                .attr("x", d => x(d.category) + x.bandwidth() / 2)
                .attr("y", d => y(d.totalAmount) - 5) // ç•¥é«˜æ–¼é•·æ¢åœ–
                .attr("text-anchor", "middle")
                .style("font-size", "10px")
                .style("fill", "#1f2937")
                .text(d => formatAmount(d.totalAmount).split('.')[0]);

             // éŸ¿æ‡‰å¼ï¼šåœ¨è¦–çª—å¤§å°è®Šæ›´æ™‚é‡æ–°ç¹ªè£½åœ–è¡¨
            window.removeEventListener('resize', renderAnalysis); // é¿å…é‡è¤‡æ·»åŠ 
            window.addEventListener('resize', () => {
                if (analysisPanel.classList.contains('hidden') === false) {
                    renderAnalysis();
                }
            });
        }

        /**
         * è™•ç†è¡¨å–®æäº¤
         */
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const description = document.getElementById('description').value.trim();
            const category = document.getElementById('category').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const date = document.getElementById('date').value;

            if (!description || !category || isNaN(amount) || amount <= 0 || !date) {
                submissionMessage.textContent = 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼Œä¸¦ç¢ºä¿é‡‘é¡æœ‰æ•ˆã€‚';
                submissionMessage.classList.remove('text-green-600', 'hidden');
                submissionMessage.classList.add('text-red-600', 'block');
                return;
            }

            const newReport = {
                id: generateId(),
                description: description,
                category: category,
                amount: amount,
                date: date,
                createdAt: new Date().toISOString(),
                status: 'å¾…å¯©æ‰¹' // åˆå§‹ç‹€æ…‹
            };

            let reports = loadReports();
            reports.push(newReport);
            saveReports(reports);

            // æ¸…ç©ºè¡¨å–®
            form.reset();
            document.getElementById('date').valueAsDate = new Date(); // é‡è¨­æ—¥æœŸ
            submissionMessage.textContent = `âœ… å ±éŠ·å–® (ID: ${newReport.id}) æäº¤æˆåŠŸï¼Œå¾…å¯©æ‰¹ã€‚`;
            submissionMessage.classList.remove('text-red-600', 'hidden');
            submissionMessage.classList.add('text-green-600', 'block');

            displayReports();

            // 3ç§’å¾Œéš±è—è¨Šæ¯
            setTimeout(() => {
                submissionMessage.classList.add('hidden');
            }, 3000);
        });

        /**
         * æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–
         */
        function initializeApp() {
            // è¨­ç½®é è¨­è§’è‰²ä¸¦æ¸²æŸ“å„€è¡¨æ¿
            switchRole('submitter');

            // ç¢ºä¿æ—¥æœŸè¼¸å…¥æ¡†é è¨­ç‚ºä»Šå¤©
            document.getElementById('date').valueAsDate = new Date();

            // ç¢ºä¿ D3 tooltip å…ƒç´ å­˜åœ¨
            if (!document.getElementById('chart-tooltip')) {
                 const tooltip = document.createElement('div');
                 tooltip.id = 'chart-tooltip';
                 // CSS æ¨£å¼å·²åœ¨ <style> å¡Šä¸­å®šç¾©
                 document.body.appendChild(tooltip);
            }
        }

        initializeApp();
    </script>
</body>
</html>
