<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾ä»£åŒ– ERP å„€è¡¨æ¿</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ä½¿ç”¨ Inter å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .sidebar-item-active {
            background-color: #3b82f6;
            color: white;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#3b82f6',
                        'secondary': '#10b981',
                        'alert': '#f59e0b',
                        'danger': '#ef4444',
                    }
                }
            }
        }
    </script>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- å´é‚Šå°èˆªæ¬„ (Sidebar) -->
    <div id="sidebar" class="hidden md:flex flex-col w-64 bg-gray-800 text-white p-4 shadow-xl">
        <div class="text-2xl font-bold mb-8 text-primary">ERP å„€è¡¨æ¿</div>
        <nav class="flex-1 space-y-2">
            <a href="#" class="sidebar-item-active group flex items-center px-4 py-2 text-sm font-medium rounded-lg transition-colors hover:bg-gray-700">
                <!-- Icon: Home -->
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M14 10l-2-2m0 0l-2 2m2-2v8"></path></svg>
                å„€è¡¨æ¿
            </a>
            <a href="#" class="group flex items-center px-4 py-2 text-sm font-medium rounded-lg transition-colors hover:bg-gray-700">
                <!-- Icon: Shopping Cart -->
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                éŠ·å”®ç®¡ç†
            </a>
            <a href="#" class="group flex items-center px-4 py-2 text-sm font-medium rounded-lg transition-colors hover:bg-gray-700">
                <!-- Icon: Box -->
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m-8-4v10l8 4m8-10v10l-8 4m0-10v10"></path></svg>
                åº«å­˜ç®¡ç†
            </a>
            <a href="#" class="group flex items-center px-4 py-2 text-sm font-medium rounded-lg transition-colors hover:bg-gray-700">
                <!-- Icon: Clipboard Check -->
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-9 0V3h4m-4 2h4m-4 0a1 1 0 00-1 1v1m10-2v1m-1 0h-4m2 2l-2 2m0 0l-2-2m2 2v4m-2 4h4"></path></svg>
                æ¡è³¼è·Ÿé€²
            </a>
            <a href="#" class="group flex items-center px-4 py-2 text-sm font-medium rounded-lg transition-colors hover:bg-gray-700">
                <!-- Icon: Chart -->
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                å ±å‘Šä¸­å¿ƒ
            </a>
        </nav>
    </div>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <div class="flex-1 flex flex-col overflow-hidden">

        <!-- é ‚éƒ¨æ¬„ -->
        <header class="flex justify-between items-center p-4 bg-white shadow-md">
            <h1 class="text-2xl font-semibold text-gray-800">ç¾ä»£åŒ–ç‡Ÿé‹æ¦‚è¦½</h1>
            <div class="flex items-center space-x-4">
                <button id="menu-button" class="md:hidden p-2 text-gray-600 hover:text-gray-800 focus:outline-none">
                    <!-- Icon: Menu -->
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
                <div class="text-sm text-gray-500">æ­¡è¿, ä½¿ç”¨è€… ID: <span id="user-id" class="font-medium text-gray-700">loading...</span></div>
                <button class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm transition duration-150">è¨­å®š</button>
            </div>
        </header>

        <!-- å…§å®¹æ»¾å‹•å€ -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto p-4 md:p-6 space-y-6">

            <!-- I. é—œéµç¸¾æ•ˆæŒ‡æ¨™ (KPIs) å€å¡Š -->
            <div id="kpi-section" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- KPI Card 1: ç¸½éŠ·å”®é¡ -->
                <div class="bg-white p-5 rounded-xl shadow-lg border-l-4 border-primary transition duration-300 hover:shadow-xl">
                    <p class="text-sm font-medium text-gray-500">ç•¶æœˆç¸½éŠ·å”®é¡ (TWD)</p>
                    <p id="kpi-sales" class="text-3xl font-bold text-gray-900 mt-1">--</p>
                    <div id="kpi-sales-change" class="text-sm mt-2 flex items-center">
                        <!-- Dynamic Change Text -->
                    </div>
                </div>

                <!-- KPI Card 2: åº«å­˜ç¸½åƒ¹å€¼ -->
                <div class="bg-white p-5 rounded-xl shadow-lg border-l-4 border-secondary transition duration-300 hover:shadow-xl">
                    <p class="text-sm font-medium text-gray-500">ç¾æœ‰åº«å­˜ç¸½åƒ¹å€¼ (TWD)</p>
                    <p id="kpi-inventory-value" class="text-3xl font-bold text-gray-900 mt-1">--</p>
                    <p class="text-sm mt-2 text-gray-400">åŸºæ–¼æœ€è¿‘ä¸€æ¬¡ç›¤é»</p>
                </div>

                <!-- KPI Card 3: å¾…è™•ç† POs -->
                <div class="bg-white p-5 rounded-xl shadow-lg border-l-4 border-alert transition duration-300 hover:shadow-xl">
                    <p class="text-sm font-medium text-gray-500">å¾…è™•ç†æ¡è³¼è¨‚å–® (POs)</p>
                    <p id="kpi-po-count" class="text-3xl font-bold text-alert mt-1">--</p>
                    <p class="text-sm mt-2 text-gray-400">éœ€è¦æ‰¹å‡†/è·Ÿé€²</p>
                </div>

                <!-- KPI Card 4: å®¢æˆ¶æ»¿æ„åº¦ -->
                <div class="bg-white p-5 rounded-xl shadow-lg border-l-4 border-gray-400 transition duration-300 hover:shadow-xl">
                    <p class="text-sm font-medium text-gray-500">å®¢æˆ¶æ»¿æ„åº¦ (CSAT)</p>
                    <p id="kpi-csat" class="text-3xl font-bold text-gray-900 mt-1">--</p>
                    <p class="text-sm mt-2 text-gray-400">æœ€è¿‘ 30 å¤©æ•¸æ“š</p>
                </div>
            </div>

            <!-- II. åœ–è¡¨èˆ‡è¦–è¦ºåŒ–å€å¡Š -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- Chart 1: æœˆåº¦æ”¶å…¥è¶¨å‹¢ -->
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">æœˆåº¦æ”¶å…¥è¶¨å‹¢ (TWD)</h2>
                    <div id="revenue-chart" class="h-80 w-full flex items-end justify-between p-2">
                        <!-- Chart Bars will be rendered here by JS -->
                        <div class="text-center text-gray-500 w-full h-full flex items-center justify-center">è¼‰å…¥ä¸­...</div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 pt-2 border-t mt-4" id="revenue-labels">
                        <!-- Month Labels will be rendered here -->
                    </div>
                </div>

                <!-- Chart 2: åº«å­˜å¥åº·ç‹€æ…‹ -->
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">é—œéµåº«å­˜å¥åº·ç‹€æ…‹</h2>
                    <div id="inventory-status" class="space-y-4">
                        <!-- Progress Bars will be rendered here by JS -->
                    </div>
                </div>
            </div>

            <!-- III. è¡Œå‹•èˆ‡è­¦å ±ä¸­å¿ƒ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                <!-- Action Center: ç·Šæ€¥æ¡è³¼ä»»å‹™ -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-800">ğŸš¨ ç·Šæ€¥æ¡è³¼ä»»å‹™ (Action Center)</h2>
                        <span id="urgent-count" class="px-3 py-1 text-sm font-medium rounded-full bg-danger text-white">0 é …</span>
                    </div>
                    <ul id="urgent-tasks" class="space-y-3 max-h-64 overflow-y-auto">
                        <!-- Urgent tasks will be listed here -->
                    </ul>
                </div>

                <!-- Activity Log: æœ€æ–°æ´»å‹•æ—¥èªŒ -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">æœ€æ–°æ´»å‹•æ—¥èªŒ</h2>
                    <ul id="activity-log" class="space-y-3 text-sm text-gray-600 max-h-64 overflow-y-auto">
                        <li class="border-b pb-2">**[09:15]** éŠ·å”®è¨‚å–® #54782 å·²æˆåŠŸç™¼è²¨ã€‚</li>
                        <li class="border-b pb-2">**[10:30]** åº«å­˜æ‰¹æ¬¡ A-901 ä½æ–¼å®‰å…¨é–¾å€¼ã€‚</li>
                        <li class="border-b pb-2">**[11:40]** ä¾›æ‡‰å•† XYZ Tech çš„æ¡è³¼è¨‚å–®å·²ç¢ºèªã€‚</li>
                        <li class="border-b pb-2">**[13:05]** ç³»çµ±å‚™ä»½å®Œæˆï¼Œé‹è¡Œç‹€æ…‹æ­£å¸¸ã€‚</li>
                        <li>**[13:58]** å®¢æˆ¶æœå‹™æ¡ˆä¾‹ #1901 å·²çµæ¡ˆã€‚</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase åˆå§‹åŒ–èˆ‡ JS é‚è¼¯ -->
    <script type="module">
        // ç¢ºä¿å…¨å±€è®Šæ•¸å­˜åœ¨ï¼Œç”¨æ–¼åˆå§‹åŒ– Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot, collection, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase æ—¥èªŒç´šåˆ¥
        setLogLevel('Debug');

        // åˆå§‹åŒ– Firebase App, Firestore, Auth
        let app, db, auth;
        let currentUserId = 'anonymous';

        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } else {
            // Placeholder initialization if config is missing (for local testing)
            console.warn("Firebase configuration is missing. Using mock data only.");
        }


        // æ¨¡æ“¬æ•¸æ“š
        const MOCK_DATA = {
            kpis: {
                totalSales: 4850000,
                salesChange: 12.5, // 12.5% å¢é•·
                inventoryValue: 12500000,
                poCount: 5,
                csat: 4.7
            },
            revenueTrend: [
                { month: '4æœˆ', amount: 3200000 },
                { month: '5æœˆ', amount: 3500000 },
                { month: '6æœˆ', amount: 3800000 },
                { month: '7æœˆ', amount: 4500000 },
                { month: '8æœˆ', amount: 4200000 },
                { month: '9æœˆ', amount: 4850000 }
            ],
            inventoryHealth: [
                { name: 'é«˜é€Ÿæ¨¡å¡Š A', level: 0.9, color: 'secondary' }, // High (90%)
                { name: 'è™•ç†å™¨æ™¶ç‰‡', level: 0.55, color: 'alert' }, // Medium (55%)
                { name: 'å‚³æ„Ÿå™¨é™£åˆ— C', level: 0.25, color: 'danger' }, // Low (25%)
            ],
            // æ ¹æ“šä¸Šæ¬¡çš„æ¡è³¼æ¸…å–®æ¨¡æ“¬çš„ç·Šæ€¥ä»»å‹™
            urgentProcurementTasks: [
                { id: 1, item: 'DDR5 32GB é«˜é€Ÿè¨˜æ†¶é«”æ¨¡çµ„', urgency: 'æ€¥è¿«', amount: '125,000 TWD' },
                { id: 2, item: 'ARM Cortex-A78 è™•ç†å™¨æ™¶ç‰‡', urgency: 'ç·Šæ€¥', amount: '150,000 TWD' },
                { id: 3, item: 'é«˜é€Ÿç„¡ç·šé€šè¨Šæ¨¡å¡Š A', urgency: 'é«˜', amount: '25,000 TWD' },
            ]
        };

        // =========================================================================
        // æ¸²æŸ“å‡½æ•¸
        // =========================================================================

        function formatCurrency(amount) {
            return amount.toLocaleString('en-US'); // ä½¿ç”¨é€—è™Ÿåˆ†éš”ç¬¦
        }

        function renderKPIs() {
            const { totalSales, salesChange, inventoryValue, poCount, csat } = MOCK_DATA.kpis;

            // ç¸½éŠ·å”®é¡
            document.getElementById('kpi-sales').textContent = formatCurrency(totalSales);
            const changeElement = document.getElementById('kpi-sales-change');
            const isPositive = salesChange >= 0;
            const changeClass = isPositive ? 'text-secondary' : 'text-danger';
            const arrowIcon = isPositive ?
                '<svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>' :
                '<svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 112 0v7.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';

            changeElement.className = `text-sm mt-2 flex items-center ${changeClass}`;
            changeElement.innerHTML = `${arrowIcon} <span class="font-bold">${Math.abs(salesChange)}%</span> (è¼ƒä¸Šæœˆ)`;

            // å…¶ä»– KPI
            document.getElementById('kpi-inventory-value').textContent = formatCurrency(inventoryValue);
            document.getElementById('kpi-po-count').textContent = poCount;
            document.getElementById('kpi-csat').textContent = csat.toFixed(1);
        }

        function renderRevenueChart() {
            const chartEl = document.getElementById('revenue-chart');
            const labelsEl = document.getElementById('revenue-labels');
            chartEl.innerHTML = ''; // æ¸…ç©º
            labelsEl.innerHTML = ''; // æ¸…ç©º

            const maxAmount = Math.max(...MOCK_DATA.revenueTrend.map(d => d.amount));
            const baseHeight = 250; // åŸºç¤é«˜åº¦ (px)

            MOCK_DATA.revenueTrend.forEach(data => {
                const heightPercentage = (data.amount / maxAmount) * 100;
                const barHeight = (data.amount / maxAmount) * baseHeight; // æ ¹æ“šæ¯”ä¾‹è¨ˆç®—å¯¦éš›é«˜åº¦ (max 250px)

                const barDiv = document.createElement('div');
                barDiv.className = 'flex flex-col items-center w-1/6 h-full justify-end';
                barDiv.innerHTML = `
                    <div class="text-xs mb-1 font-medium text-gray-700">${formatCurrency(data.amount)}</div>
                    <div class="w-3/5 bg-primary rounded-t-lg transition-all duration-700 hover:bg-blue-600 cursor-pointer"
                         style="height: ${barHeight}px;"
                         title="${data.month}: ${formatCurrency(data.amount)} TWD">
                    </div>
                `;
                chartEl.appendChild(barDiv);

                // æ¸²æŸ“æœˆä»½æ¨™ç±¤
                const labelDiv = document.createElement('div');
                labelDiv.className = 'text-center w-1/6';
                labelDiv.textContent = data.month;
                labelsEl.appendChild(labelDiv);
            });
        }

        function renderInventoryStatus() {
            const container = document.getElementById('inventory-status');
            container.innerHTML = ''; // æ¸…ç©º

            MOCK_DATA.inventoryHealth.forEach(item => {
                const percentage = (item.level * 100).toFixed(0);
                let barColor, statusText;

                if (item.level >= 0.75) {
                    barColor = 'bg-secondary';
                    statusText = 'å……è¶³';
                } else if (item.level >= 0.4) {
                    barColor = 'bg-alert';
                    statusText = 'ä¸­ç­‰';
                } else {
                    barColor = 'bg-danger';
                    statusText = 'ä½é¢¨éšª';
                }

                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-3 bg-gray-50 rounded-lg shadow-sm';
                itemDiv.innerHTML = `
                    <div class="flex justify-between items-center text-sm font-medium">
                        <span>${item.name}</span>
                        <span class="text-gray-500">${percentage}% - ${statusText}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                        <div class="h-2 rounded-full ${barColor}" style="width: ${percentage}%;"></div>
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }

        function renderUrgentTasks() {
            const container = document.getElementById('urgent-tasks');
            container.innerHTML = ''; // æ¸…ç©º

            const urgentTasks = MOCK_DATA.urgentProcurementTasks;
            document.getElementById('urgent-count').textContent = `${urgentTasks.length} é …`;

            if (urgentTasks.length === 0) {
                 container.innerHTML = `<li class="text-center text-gray-500 py-4">ç›®å‰æ²’æœ‰ç·Šæ€¥æ¡è³¼ä»»å‹™ã€‚</li>`;
                 return;
            }

            urgentTasks.forEach(task => {
                let urgencyColor;
                if (task.urgency === 'ç·Šæ€¥') {
                    urgencyColor = 'bg-danger text-white';
                } else if (task.urgency === 'æ€¥è¿«' || task.urgency === 'é«˜') {
                    urgencyColor = 'bg-alert text-gray-900';
                } else {
                    urgencyColor = 'bg-gray-200 text-gray-800';
                }

                const taskLi = document.createElement('li');
                taskLi.className = 'flex justify-between items-center p-3 rounded-lg border-l-4 border-danger bg-red-50 hover:bg-red-100 transition duration-150';
                taskLi.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-800">${task.item}</p>
                        <p class="text-xs text-gray-500">${task.amount}</p>
                    </div>
                    <span class="px-2 py-0.5 text-xs font-semibold rounded ${urgencyColor}">
                        ${task.urgency}
                    </span>
                `;
                container.appendChild(taskLi);
            });
        }

        // =========================================================================
        // Firebase Auth & Firestore Setup (ä½¿ç”¨æ¨¡æ“¬çš„å…¬å…±æ•¸æ“šè·¯å¾‘)
        // =========================================================================

        function setupFirestoreListener() {
            if (!db) return;

            // ç¯„ä¾‹ï¼šè¨­ç½®ä¸€å€‹ç›£è½å™¨ï¼Œç›£è½å…¬å…±æ•¸æ“šä¸­çš„å¾…è¾¦æ¸…å–® (å‡è¨­æˆ‘å€‘æœ‰ä¸€å€‹å…¬å…±çš„ä»»å‹™æ¸…å–®)
            // è·¯å¾‘: /artifacts/{appId}/public/data/procurement_tasks
            const q = query(collection(db, `artifacts/${appId}/public/data/procurement_tasks`));

            // æ³¨æ„ï¼šé€™è£¡åªæ˜¯ä¸€å€‹ç¤ºç¯„å¦‚ä½•ä½¿ç”¨ onSnapshot ç›£è½æ•¸æ“š
            const unsubscribe = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    console.log("Firestore æ¡è³¼ä»»å‹™æ›´æ–°:", change.type, change.doc.data());
                    // å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œæ‚¨æœƒåœ¨é€™è£¡æ›´æ–° MOCK_DATA.urgentProcurementTasks
                });
                // ç”±æ–¼æˆ‘å€‘ä½¿ç”¨éœæ…‹æ¨¡æ“¬æ•¸æ“šï¼Œé€™è£¡ä¸æ›´æ–° UI
            }, (error) => {
                console.error("Firestore ç›£è½éŒ¯èª¤:", error);
            });

            // ç”±æ–¼é€™æ˜¯å–®é æ‡‰ç”¨ï¼Œæˆ‘å€‘ä¸æœƒæ‰‹å‹•èª¿ç”¨ unsubscribe
            console.log("Firestore ç›£è½å·²å•Ÿå‹• (procurement_tasks)");
        }

        // é©—è­‰ä¸¦ç²å–ä½¿ç”¨è€… ID
        async function authenticateUser() {
            if (!auth) {
                document.getElementById('user-id').textContent = 'MockUser';
                return;
            }

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase èªè­‰å¤±æ•—:", error.message);
                // å³ä½¿å¤±æ•—ä¹Ÿå…è¨± UI è¼‰å…¥ï¼Œä½¿ç”¨é è¨­ ID
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    document.getElementById('user-id').textContent = currentUserId.substring(0, 8) + '...';
                    console.log("ç”¨æˆ¶å·²ç™»å…¥ï¼ŒUID:", currentUserId);
                    setupFirestoreListener();
                } else {
                    currentUserId = crypto.randomUUID();
                    document.getElementById('user-id').textContent = 'Anon-' + currentUserId.substring(0, 4);
                    console.log("ç”¨æˆ¶åŒ¿åç™»å…¥ï¼Œä½¿ç”¨ UUID:", currentUserId);
                }
            });
        }

        // =========================================================================
        // ä¸»æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•
        // =========================================================================
        window.onload = function() {
            // 1. æ¸²æŸ“å„€è¡¨æ¿æ•¸æ“š
            renderKPIs();
            renderRevenueChart();
            renderInventoryStatus();
            renderUrgentTasks();

            // 2. è™•ç† Firebase èªè­‰å’Œæ•¸æ“š
            if (Object.keys(firebaseConfig).length > 0) {
                authenticateUser();
            } else {
                document.getElementById('user-id').textContent = 'Offline/Mock';
            }

            // 3. éŸ¿æ‡‰å¼ä½ˆå±€ï¼šå´é‚Šæ¬„åˆ‡æ›é‚è¼¯
            const sidebar = document.getElementById('sidebar');
            const menuButton = document.getElementById('menu-button');
            let isSidebarOpen = false;

            menuButton.addEventListener('click', () => {
                isSidebarOpen = !isSidebarOpen;
                if (isSidebarOpen) {
                    sidebar.classList.remove('hidden');
                    sidebar.classList.add('absolute', 'inset-y-0', 'left-0', 'z-20');
                } else {
                    sidebar.classList.add('hidden');
                    sidebar.classList.remove('absolute', 'inset-y-0', 'left-0', 'z-20');
                }
            });

            // è™•ç†è¦–çª—å¤§å°æ”¹è®Šï¼Œç¢ºä¿æ¡Œé¢é¡¯ç¤º
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 768) { // md breakpoint
                    sidebar.classList.remove('hidden', 'absolute', 'inset-y-0', 'left-0', 'z-20');
                    sidebar.classList.add('flex');
                    isSidebarOpen = false;
                }
            });
        }
    </script>
</body>
</html>
