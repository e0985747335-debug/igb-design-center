<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>開發流程規劃器與複雜決策設計</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }

        /* 流程步驟（通用） */
        .flow-step {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-height: 48px; /* 確保卡片高度一致 */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 流程箭頭樣式 */
        .flow-arrow {
            width: 4px;
            height: 40px;
            background-color: #3b82f6; /* 藍色 */
            margin: 0 auto;
            position: relative;
        }

        .flow-arrow::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: -8px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #3b82f6;
        }

        /* 決策菱形線路標籤 */
        .decision-label {
            position: absolute;
            top: -15px;
            background-color: white;
            padding: 0 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #4b5563;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-10">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 border-b-2 border-indigo-500 pb-2">
            開發流程與複雜決策設計 (Process Planner)
        </h1>
        <p class="text-gray-600 mb-6">
            本工具示範了流程規劃和如何透過「巢狀細化」來處理複雜的決策邏輯。
        </p>

        <!-- 輸入區塊 -->
        <div class="mb-8">
            <label for="flowInput" class="block text-lg font-medium text-gray-700 mb-2">
                輸入步驟清單：(請注意決策點的格式 `...?(決策)`)
            </label>
            <textarea id="flowInput" rows="8" class="w-full p-4 border-2 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-inner resize-y" placeholder="範例：&#10;1. 專案啟動（開始）&#10;2. 架構設計與模組規劃&#10;3. 撰寫主要功能程式碼&#10;4. 單元測試是否通過? (決策)&#10;5. 修復測試未通過的錯誤&#10;6. 執行系統整合測試&#10;7. 準備正式發佈&#10;8. 產品上線（結束）">1. 新用戶註冊（開始）
2. 收集用戶資料 (Email, 密碼, 用戶名)
3. 執行複雜的用戶驗證程序 (子流程)
4. 驗證是否全部通過? (決策)
5. 顯示錯誤訊息給用戶
6. 寫入資料庫並生成Token
7. 寄送歡迎郵件（結束）</textarea>
            <button onclick="generateFlow('flowInput', 'flowOutput')" class="mt-4 w-full md:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 transform hover:scale-[1.02]">
                生成主流程圖結構
            </button>
        </div>

        <!-- 輸出區塊 - 主流程 -->
        <div class="border-t-2 border-gray-200 pt-8 mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                流程視覺化 (主流程)
            </h2>
            <div id="flowOutput" class="space-y-4">
                <!-- 流程結構將在這裡動態生成 -->
            </div>
        </div>

        <!-- 輸出區塊 - 複雜決策細化範例 (子流程) -->
        <div class="border-t-2 border-gray-200 pt-8 mt-12 bg-purple-50 p-6 rounded-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b border-purple-300 pb-3">
                ⭐ 複雜決策細化範例：步驟 3「執行複雜的用戶驗證程序」子流程
            </h2>
            <p class="text-sm text-gray-600 mb-4">
                透過「巢狀細化」將複雜判斷（如多項驗證）獨立出來，保持主流程的簡潔。
            </p>
            <textarea id="refinementInput" rows="6" class="hidden">3.1. 開始驗證（子流程開始）
3.2. 檢查電子郵件格式是否正確? (決策)
3.3. 密碼強度是否達到標準? (決策)
3.4. 用戶名是否已存在? (決策)
3.5. 檢查是否通過機器人驗證? (決策)
3.6. 驗證失敗：返回主流程錯誤狀態
3.7. 驗證成功：返回主流程成功狀態（子流程結束）</textarea>
            <div id="refinementOutput" class="space-y-4">
                <button onclick="generateFlow('refinementInput', 'refinementOutput')" class="w-full md:w-auto px-6 py-2 text-sm bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-300">
                    顯示細化決策流程圖
                </button>
            </div>
        </div>

    </div>

    <script type="text/javascript">
        // 在頁面載入時自動執行一次，顯示預設流程
        window.onload = function() {
            generateFlow('flowInput', 'flowOutput');
        };

        /**
         * 將輸入的步驟清單轉換成視覺化的流程結構。
         * @param {string} inputId - 輸入 textarea 的 ID
         * @param {string} outputId - 輸出 div 的 ID
         */
        function generateFlow(inputId, outputId) {
            const input = document.getElementById(inputId).value;
            const outputDiv = document.getElementById(outputId);

            // 1. 清理輸入並過濾空行
            const steps = input.split('\n')
                               .map(step => step.trim())
                               .filter(step => step.length > 0);

            outputDiv.innerHTML = ''; // 清空舊內容

            if (steps.length === 0) {
                outputDiv.innerHTML = `<p class="text-center text-gray-500 italic">請輸入有效的流程步驟。</p>`;
                return;
            }


            steps.forEach((step, index) => {
                const isFirst = index === 0;
                const isLast = index === steps.length - 1;

                let cardHtml = '';
                let bgColor = 'bg-gray-100';
                let borderColor = 'border-gray-300';
                let shapeClass = 'rounded-lg';
                let textColor = 'text-gray-800';

                // 2. 判斷特殊步驟（開始/結束/決策/子流程）
                if (isFirst || step.toLowerCase().includes('開始') || step.toLowerCase().includes('start')) {
                    // 開始/結束
                    bgColor = (isFirst && index !== steps.length - 1) ? 'bg-indigo-100' : 'bg-green-100';
                    borderColor = (isFirst && index !== steps.length - 1) ? 'border-indigo-500' : 'border-green-500';
                    shapeClass = 'rounded-full px-8 py-3 font-bold';
                } else if (isLast || step.toLowerCase().includes('結束') || step.toLowerCase().includes('end')) {
                    // 結束
                    bgColor = 'bg-green-100';
                    borderColor = 'border-green-500';
                    shapeClass = 'rounded-full px-8 py-3 font-bold';
                } else if (step.toLowerCase().includes('子流程') || step.toLowerCase().includes('sub-process')) {
                    // 子流程 (巢狀細化)
                    bgColor = 'bg-blue-100';
                    borderColor = 'border-blue-500';
                    shapeClass = 'rounded-lg border-double border-4'; // 雙線邊框表示子流程
                } else if (step.toLowerCase().includes('決策') || step.toLowerCase().includes('decision') || step.includes('?')) {
                    // 決策
                    bgColor = 'bg-yellow-100';
                    borderColor = 'border-yellow-500';

                    // 菱形效果 (使用 transform: rotate(45deg) 和包裝 div 來模擬)
                    // 為了流程圖清晰，決策點不包含在自動生成箭頭的序列中，因為它會引導兩條線路
                    cardHtml = `
                        <div class="relative flex justify-center items-center h-32 my-4">
                            <!-- 菱形主體 -->
                            <div class="transform rotate-45 w-40 h-40 flex justify-center items-center border-2 ${borderColor} ${bgColor} border-dashed shadow-lg">
                            </div>
                            <!-- 菱形內文 (反轉角度以正向顯示文字) -->
                            <div class="absolute w-full h-full flex justify-center items-center p-2">
                                <span class="text-center text-sm font-bold ${textColor} leading-tight max-w-[80%]">${step}</span>
                            </div>

                            <!-- 決策分支線路 (模擬) -->
                            <div class="absolute top-1/2 left-0 w-full h-0 border-t-2 border-gray-400 border-dashed transform -translate-y-1/2 -z-10"></div>

                            <!-- YES/通過 分支出口 (右側) -->
                            <div class="absolute right-[-70px] top-1/2 w-16 h-1 border-t-2 border-green-500 border-dashed flex justify-end items-center">
                                <span class="decision-label bg-green-50 text-green-700 border-green-300">通過/是</span>
                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            </div>

                            <!-- NO/未通過 分支出口 (左側) -->
                            <div class="absolute left-[-70px] top-1/2 w-16 h-1 border-t-2 border-red-500 border-dashed flex justify-start items-center">
                                <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                                <span class="decision-label bg-red-50 text-red-700 border-red-300">未通過/否</span>
                            </div>
                        </div>
                    `;
                    // 跳過標準卡片生成
                }

                // 3. 生成步驟卡片 (如果不是決策菱形)
                if (!cardHtml) {
                    cardHtml = `
                        <div class="flow-step p-4 text-center border-2 ${borderColor} ${bgColor} ${shapeClass} mx-auto max-w-sm cursor-pointer hover:shadow-xl">
                            <p class="text-sm font-semibold ${textColor}">${step}</p>
                        </div>
                    `;
                }

                outputDiv.innerHTML += cardHtml;

                // 4. 生成箭頭 (除了最後一步和決策點之後)
                if (!isLast && !(step.toLowerCase().includes('決策') || step.includes('?'))) {
                    // 如果下一個步驟是決策點，則不畫箭頭，因為決策點有自己的分支
                    if (index + 1 < steps.length && !(steps[index+1].toLowerCase().includes('決策') || steps[index+1].includes('?'))) {
                         outputDiv.innerHTML += `
                            <div class="flow-arrow"></div>
                        `;
                    }
                }
            });
        }
    </script>
</body>
</html>
