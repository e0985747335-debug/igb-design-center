<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾…è¾¦æ¸…å–®</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®šå­—é«”ç‚º Inter */
        html { font-family: 'Inter', sans-serif; }
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ï¼Œè®“åˆ—è¡¨çœ‹èµ·ä¾†æ›´ç¾è§€ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* slate-100 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-start justify-center p-4 sm:p-8">

    <div id="app-container" class="w-full max-w-xl bg-white shadow-2xl rounded-3xl p-6 md:p-8 transition-all duration-300">
        <h1 class="text-3xl font-extrabold text-sky-700 mb-2 text-center">
            ğŸ’¾ æœ¬åœ°ä»»å‹™è¿½è¹¤æ¸…å–®
        </h1>
        <p class="text-xs text-center text-red-500 mb-6">
            âœ… ç„¡éœ€ç¶²è·¯é€£ç·šã€‚è³‡æ–™åƒ…å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ã€‚
        </p>

        <!-- ä»»å‹™è¼¸å…¥å€å¡Š -->
        <div class="flex space-x-3 mb-8">
            <input type="text" id="new-task-input"
                   class="flex-grow p-3 border-2 border-gray-300 rounded-xl focus:border-sky-500 focus:ring-sky-500 transition duration-200"
                   placeholder="æ–°å¢å¾…è¾¦äº‹é …...">
            <button id="add-task-button"
                    class="flex-shrink-0 bg-sky-600 text-white p-3 rounded-xl font-semibold hover:bg-sky-700 transition duration-200 shadow-md">
                æ–°å¢
            </button>
        </div>

        <!-- ä»»å‹™åˆ—è¡¨ -->
        <div id="todos-list-container" class="max-h-[60vh] overflow-y-auto custom-scrollbar">
            <ul id="todos-list" class="space-y-3">
                <!-- ä»»å‹™å°‡ç”± JavaScript å¡«å…… -->
            </ul>
            <!-- è¼‰å…¥èˆ‡ç„¡ä»»å‹™æç¤º -->
            <p id="empty-list-message" class="text-center text-gray-500 mt-4 hidden p-8 bg-gray-50 rounded-xl">
                å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰å¾…è¾¦äº‹é …ã€‚
            </p>
        </div>

        <!-- è‡ªå®šç¾©ç¢ºèªå½ˆçª— (å–ä»£ alert/confirm) -->
        <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all">
                <h3 class="text-xl font-bold text-gray-900 mb-4" id="modal-title">è¨Šæ¯</h3>
                <p class="text-gray-700 mb-6" id="modal-message">è¨Šæ¯å…§å®¹ã€‚</p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition hidden">å–æ¶ˆ</button>
                    <button id="modal-confirm" class="px-4 py-2 text-white bg-sky-600 rounded-lg hover:bg-sky-700 transition">ç¢ºå®š</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // --- è¨­å®šèˆ‡æœ¬åœ°å„²å­˜æ ¸å¿ƒ ---
        const STORAGE_KEY = 'local_todo_list_tasks_v1';

        /**
         * å¾ Local Storage è®€å–ä»»å‹™åˆ—è¡¨
         * @returns {Array<Object>} ä»»å‹™é™£åˆ—
         */
        function getTasks() {
            try {
                const json = localStorage.getItem(STORAGE_KEY);
                // å˜—è©¦è§£æï¼Œå¦‚æœè§£æå¤±æ•—å‰‡è¿”å›ç©ºé™£åˆ—
                return json ? JSON.parse(json) : [];
            } catch (e) {
                console.error("è®€å–æœ¬åœ°å„²å­˜å¤±æ•—:", e);
                return [];
            }
        }

        /**
         * å°‡ä»»å‹™åˆ—è¡¨å¯«å…¥ Local Storage
         * @param {Array<Object>} tasks ä»»å‹™é™£åˆ—
         */
        function saveTasks(tasks) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
                // æ¯æ¬¡å„²å­˜å¾Œè‡ªå‹•é‡æ–°æ¸²æŸ“ï¼Œç¢ºä¿ä»‹é¢åŒæ­¥
                renderAndCheckEmpty(tasks);
            } catch (e) {
                console.error("å¯«å…¥æœ¬åœ°å„²å­˜å¤±æ•—:", e);
                alertUser('å„²å­˜ä»»å‹™å¤±æ•—', 'ç€è¦½å™¨å¯èƒ½å·²æ»¿æˆ–ç¦æ­¢å„²å­˜ã€‚', 'ç¢ºå®š');
            }
        }

        // --- DOM å…ƒç´ å¿«å– ---
        const elements = {
            list: document.getElementById('todos-list'),
            input: document.getElementById('new-task-input'),
            addButton: document.getElementById('add-task-button'),
            emptyMessage: document.getElementById('empty-list-message'),
            modal: document.getElementById('delete-modal'),
            modalConfirm: document.getElementById('modal-confirm'),
            modalCancel: document.getElementById('modal-cancel'),
            modalMessage: document.getElementById('modal-message'),
            modalTitle: document.getElementById('modal-title'),
        };

        // --- æ ¸å¿ƒæ“ä½œå‡½å¼ ---

        /**
         * è™•ç†æ–°å¢ä»»å‹™çš„é‚è¼¯
         */
        function addTask() {
            const text = elements.input.value.trim();
            if (text === "") return;

            const tasks = getTasks();

            // ç”¢ç”Ÿä¸€å€‹ç°¡å–®çš„å”¯ä¸€ ID (ä½¿ç”¨æ™‚é–“æˆ³ + éš¨æ©Ÿæ•¸)
            const newId = Date.now().toString() + Math.random().toString(36).substring(2, 9);

            const newTask = {
                id: newId,
                text: text,
                completed: false,
                createdAt: Date.now(), // ç”¨æ–¼æ’åº
            };

            tasks.push(newTask);
            saveTasks(tasks);

            elements.input.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
        }

        /**
         * åˆ‡æ›ä»»å‹™çš„å®Œæˆç‹€æ…‹
         * @param {string} id ä»»å‹™ ID
         */
        function toggleTask(id) {
            const tasks = getTasks();
            const taskIndex = tasks.findIndex(t => t.id === id);

            if (taskIndex > -1) {
                // å‰µå»ºæ–°çš„ç‰©ä»¶ä»¥ç¢ºä¿éŸ¿æ‡‰æ€§ï¼ˆé›–ç„¶åœ¨é€™è£¡ä¸æ˜¯ Reactï¼Œä½†é€™æ˜¯è‰¯å¥½çš„å¯¦è¸ï¼‰
                tasks[taskIndex] = { ...tasks[taskIndex], completed: !tasks[taskIndex].completed };
                saveTasks(tasks);
            }
        }

        /**
         * åˆªé™¤ä»»å‹™ (å¯¦éš›åŸ·è¡Œåˆªé™¤æ“ä½œ)
         * @param {string} id ä»»å‹™ ID
         */
        function deleteTask(id) {
            const tasks = getTasks();
            const updatedTasks = tasks.filter(t => t.id !== id);
            saveTasks(updatedTasks);
        }

        /**
         * è™•ç†åˆªé™¤å‰çš„ç¢ºèªå½ˆçª—
         * @param {string} id ä»»å‹™ ID
         */
        function deleteTaskWithConfirmation(id) {
            // è¨­ç½®æ¨¡æ…‹æ¡†ç‚ºç¢ºèªåˆªé™¤æ¨¡å¼
            elements.modalTitle.textContent = 'ç¢ºèªåˆªé™¤';
            elements.modalMessage.textContent = 'æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤ä»»å‹™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚';
            elements.modalConfirm.textContent = 'åˆªé™¤';
            elements.modalConfirm.classList.remove('bg-sky-600');
            elements.modalConfirm.classList.add('bg-red-600');
            elements.modalCancel.classList.remove('hidden');

            // é¡¯ç¤ºè‡ªå®šç¾©å½ˆçª—
            elements.modal.classList.remove('hidden');
            elements.modal.classList.add('flex');

            // è¨­ç½®ç¢ºèªäº‹ä»¶ç›£è½å™¨ (ä¸€æ¬¡æ€§)
            const confirmHandler = () => {
                elements.modal.classList.add('hidden');
                elements.modal.classList.remove('flex');
                deleteTask(id); // åŸ·è¡Œåˆªé™¤

                // ç§»é™¤ç›£è½å™¨ä¸¦é‚„åŸæ¨£å¼
                cleanupModalListeners(confirmHandler, cancelHandler);
            };

            const cancelHandler = () => {
                elements.modal.classList.add('hidden');
                elements.modal.classList.remove('flex');
                cleanupModalListeners(confirmHandler, cancelHandler);
            };

            // é™„åŠ ä¸€æ¬¡æ€§ç›£è½å™¨
            elements.modalConfirm.addEventListener('click', confirmHandler, { once: true });
            elements.modalCancel.addEventListener('click', cancelHandler, { once: true });
        }

        /**
         * æ¸…ç†æ¨¡æ…‹æ¡†äº‹ä»¶ç›£è½å™¨ä¸¦é‡ç½®æŒ‰éˆ•æ¨£å¼
         */
        function cleanupModalListeners(confirmHandler, cancelHandler) {
            elements.modalConfirm.removeEventListener('click', confirmHandler);
            elements.modalCancel.removeEventListener('click', cancelHandler);

            // é‡ç½®ç‚ºé è¨­ï¼ˆè­¦å ±ï¼‰ç‹€æ…‹
            elements.modalTitle.textContent = 'è¨Šæ¯';
            elements.modalConfirm.textContent = 'ç¢ºå®š';
            elements.modalConfirm.classList.remove('bg-red-600');
            elements.modalConfirm.classList.add('bg-sky-600');
            elements.modalCancel.classList.add('hidden');
        }

        /**
         * ç”¨æ–¼å–ä»£ç€è¦½å™¨åŸç”Ÿ alert çš„è‡ªå®šç¾©å½ˆçª—
         * @param {string} title æ¨™é¡Œ
         * @param {string} message é¡¯ç¤ºçš„è¨Šæ¯
         * @param {string} confirmText ç¢ºèªæŒ‰éˆ•æ–‡å­—
         */
        function alertUser(title, message, confirmText) {
            elements.modalTitle.textContent = title;
            elements.modalMessage.textContent = message;
            elements.modalConfirm.textContent = confirmText;
            elements.modalCancel.classList.add('hidden');

            elements.modal.classList.remove('hidden');
            elements.modal.classList.add('flex');

            const dismissHandler = () => {
                elements.modal.classList.add('hidden');
                elements.modal.classList.remove('flex');
                elements.modalConfirm.removeEventListener('click', dismissHandler);
                // æ¢å¾©å½ˆçª—é è¨­ç‹€æ…‹
                cleanupModalListeners(dismissHandler, () => {});
            };

            elements.modalConfirm.addEventListener('click', dismissHandler, { once: true });
        }


        // --- æ¸²æŸ“èˆ‡åˆå§‹åŒ– ---

        /**
         * æ¸²æŸ“ä»»å‹™åˆ—è¡¨ä¸¦æª¢æŸ¥æ˜¯å¦ç‚ºç©º
         * @param {Array<Object>} tasks ä»»å‹™é™£åˆ—
         */
        function renderAndCheckEmpty(tasks) {
            // 1. åœ¨å…§å­˜ä¸­æ’åº (ä½¿ç”¨ createdAt å¯¦ç¾æ–°å¢çš„ä»»å‹™åœ¨æœ€ä¸‹æ–¹)
            tasks.sort((a, b) => a.createdAt - b.createdAt);

            // 2. æ¸²æŸ“åˆ—è¡¨
            elements.list.innerHTML = '';

            if (tasks.length === 0) {
                elements.emptyMessage.classList.remove('hidden');
                return;
            } else {
                elements.emptyMessage.classList.add('hidden');
            }

            tasks.forEach(todo => {
                const listItem = document.createElement('li');
                // ç¢ºä¿å¾ localStorage è®€å–çš„ completed æ˜¯å¸ƒæ—å€¼
                const isCompleted = !!todo.completed;

                listItem.className = `flex items-center p-4 rounded-xl shadow-sm transition duration-300 transform hover:scale-[1.01] ${isCompleted ? 'bg-green-50 border-l-4 border-green-400' : 'bg-white border-l-4 border-sky-400'}`;
                listItem.dataset.id = todo.id;

                // ä»»å‹™å…§å®¹
                const textClass = isCompleted ? 'line-through text-gray-500 italic' : 'text-gray-800 font-medium';
                const todoText = `<span class="flex-grow text-base ${textClass}">${todo.text}</span>`;

                // å‹•ä½œæŒ‰éˆ•å®¹å™¨
                const actions = `
                    <div class="flex items-center space-x-3 ml-4">
                        <!-- å®Œæˆ/æœªå®ŒæˆæŒ‰éˆ• -->
                        <button data-action="toggle" data-completed="${isCompleted}" class="p-2 rounded-full transition duration-150 ${isCompleted ? 'text-green-600 hover:bg-green-100' : 'text-gray-400 hover:text-sky-600 hover:bg-sky-100'}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </button>
                        <!-- åˆªé™¤æŒ‰éˆ• -->
                        <button data-action="delete" class="p-2 text-red-400 rounded-full hover:bg-red-100 hover:text-red-600 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                                <path d="M3 6h18"></path>
                                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                `;

                listItem.innerHTML = todoText + actions;
                elements.list.appendChild(listItem);
            });
        }

        /**
         * æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–
         */
        function initializeApp() {
            // å¾æœ¬åœ°å„²å­˜è¼‰å…¥ä¸¦æ¸²æŸ“åˆå§‹åˆ—è¡¨
            const initialTasks = getTasks();
            renderAndCheckEmpty(initialTasks);

            // --- äº‹ä»¶ç›£è½å™¨ ---

            // 1. æ–°å¢ä»»å‹™æŒ‰éˆ•é»æ“Š
            elements.addButton.addEventListener('click', addTask);

            // 2. è¼¸å…¥æ¡†æŒ‰ Enter éµ
            elements.input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addTask();
                }
            });

            // 3. åˆ—è¡¨å‹•ä½œ (Toggle/Delete) - ä½¿ç”¨äº‹ä»¶å§”æ´¾
            elements.list.addEventListener('click', (e) => {
                const listItem = e.target.closest('li');
                if (!listItem) return;

                const taskId = listItem.dataset.id;
                const actionButton = e.target.closest('button');

                if (actionButton) {
                    const action = actionButton.dataset.action;

                    if (action === 'toggle') {
                        toggleTask(taskId);
                    } else if (action === 'delete') {
                        deleteTaskWithConfirmation(taskId);
                    }
                }
            });
        }

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        initializeApp();

    </script>
</body>
</html>
