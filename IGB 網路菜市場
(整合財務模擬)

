import React, { useState, useMemo } from 'react';
import { ShoppingCart, LayoutDashboard, DollarSign, TrendingUp, TrendingDown, Package, CreditCard } from 'lucide-react';

// åˆå§‹æ•¸æ“šå®šç¾©
const initialMarketItems = [
  { id: 1, name: 'æ–°é®®è˜‹æœ', price: 50, cost: 30, stock: 15, emoji: 'ğŸ', unit: 'é¡†' },
  { id: 2, name: 'æœ‰æ©Ÿè èœ', price: 40, cost: 25, stock: 20, emoji: 'ğŸ¥¬', unit: 'æŠŠ' },
  { id: 3, name: 'ç•¶å­£é¦™è•‰', price: 35, cost: 20, stock: 10, emoji: 'ğŸŒ', unit: 'ä¸²' },
  { id: 4, name: 'åœŸé›é›è›‹', price: 80, cost: 50, stock: 50, emoji: 'ğŸ¥š', unit: 'ç›’' },
];

const initialFinancials = {
  initialCapital: 50000, // åˆå§‹ç‡Ÿé‹è³‡é‡‘
  revenue: 0,
  costOfGoodsSold: 0,
  totalTransactions: 0,
};

// --- KPI Card Component ---
const KPICard = ({ title, value, icon: Icon, colorClass, delta, unit = '' }) => (
  <div className={`p-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-[1.02] ${colorClass} text-white`}>
    <div className="flex items-center justify-between">
      <h3 className="text-sm font-medium opacity-80">{title}</h3>
      <Icon className="w-5 h-5 opacity-70" />
    </div>
    <div className="mt-2 flex justify-between items-end">
      <span className="text-3xl font-bold">
        ${value.toLocaleString()}
        {unit && <span className="text-base ml-1 opacity-80">{unit}</span>}
      </span>
      {delta !== undefined && (
        <span className={`text-sm font-semibold flex items-center ${delta >= 0 ? 'text-green-300' : 'text-red-300'}`}>
          {delta >= 0 ? <TrendingUp className="w-4 h-4 mr-1" /> : <TrendingDown className="w-4 h-4 mr-1" />}
          {delta.toLocaleString()}%
        </span>
      )}
    </div>
  </div>
);

// --- Dashboard Component ---
const FinancialDashboard = ({ financials, inventoryValue, profit, currentCapital }) => {
  const kpis = [
    { title: 'ç¸½ç‡Ÿæ”¶ (Revenue)', value: financials.revenue, icon: DollarSign, colorClass: 'bg-blue-600', delta: 15 },
    { title: 'éŠ·è²¨æˆæœ¬ (COGS)', value: financials.costOfGoodsSold, icon: TrendingDown, colorClass: 'bg-red-500', delta: -5 },
    { title: 'æ·¨åˆ©æ½¤ (Profit)', value: profit, icon: TrendingUp, colorClass: 'bg-green-600', delta: profit >= 0 ? 20 : -10 },
    { title: 'åº«å­˜åƒ¹å€¼ (Inventory)', value: inventoryValue, icon: Package, colorClass: 'bg-yellow-600', delta: 5 },
    { title: 'æµå‹•è³‡é‡‘ (Capital)', value: currentCapital, icon: CreditCard, colorClass: 'bg-purple-600', delta: 10 },
  ];

  const transactionData = [
    { name: 'ç‡Ÿæ”¶', amount: financials.revenue, color: 'bg-blue-500' },
    { name: 'æˆæœ¬', amount: financials.costOfGoodsSold, color: 'bg-red-500' },
    { name: 'åˆ©æ½¤', amount: profit > 0 ? profit : 0, color: 'bg-green-500' },
  ];

  const totalAmount = financials.revenue + financials.costOfGoodsSold + (profit > 0 ? profit : 0);

  return (
    <section className="space-y-6">
      <div className="flex items-center text-gray-800">
        <LayoutDashboard className="w-6 h-6 mr-2" />
        <h2 className="text-2xl font-semibold">æ•´åˆè²¡å‹™å„€è¡¨æ¿</h2>
      </div>

      {/* KPI Cards */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
        {kpis.map((kpi) => (
          <KPICard key={kpi.title} {...kpi} />
        ))}
      </div>

      {/* Mock Bar Chart Visualization */}
      <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
        <h3 className="text-lg font-medium mb-4 text-gray-700">è²¡å‹™æ´»å‹•æ¦‚è¦½ (ç­†æ•¸: {financials.totalTransactions})</h3>
        <div className="h-40 flex items-end space-x-4 p-2">
          {transactionData.map((data, index) => (
            <div key={index} className="flex flex-col items-center group relative h-full">
              {/* Tooltip */}
              <div className="absolute bottom-full mb-2 hidden group-hover:block px-3 py-1 bg-gray-800 text-white text-xs rounded-lg whitespace-nowrap">
                {data.name}: ${data.amount.toLocaleString()}
              </div>
              <div
                className={`${data.color} w-10 rounded-t-lg transition-all duration-500`}
                style={{ height: `${Math.min(100, (data.amount / (totalAmount > 0 ? totalAmount : 1)) * 100)}%` }}
              ></div>
              <span className="mt-2 text-sm font-medium text-gray-500">{data.name}</span>
            </div>
          ))}
          <div className="flex-1 border-l ml-4 h-full border-gray-200 pl-4 flex items-center justify-center">
             <p className="text-gray-400 text-sm">äº¤æ˜“é‡: {financials.totalTransactions} ç­†</p>
          </div>
        </div>
      </div>
    </section>
  );
};

// --- Market Item Card Component ---
const MarketItemCard = ({ item, onAddToCart }) => {
  const [quantity, setQuantity] = useState(1);

  const handleAddToCart = () => {
    if (quantity > 0 && quantity <= item.stock) {
      onAddToCart(item, quantity);
    } else if (quantity > item.stock) {
      alert(`åº«å­˜ä¸è¶³ï¼ ${item.name} åƒ…å‰© ${item.stock} ${item.unit}ã€‚`);
    } else {
      alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„è³¼è²·æ•¸é‡ã€‚');
    }
  };

  return (
    <div className="bg-white p-6 border border-gray-100 rounded-xl shadow-md flex flex-col transition duration-300 hover:shadow-xl">
      <div className="text-6xl text-center mb-4">{item.emoji}</div>
      <h3 className="text-xl font-semibold text-gray-800 mb-1">{item.name}</h3>
      <p className="text-2xl font-bold text-green-600 mb-3">${item.price} / {item.unit}</p>
      <div className="text-sm text-gray-500 mb-4">
        <p>æˆæœ¬: <span className="font-mono">${item.cost}</span> | åº«å­˜: <span className="font-mono text-blue-500">{item.stock} {item.unit}</span></p>
      </div>

      <div className="flex items-center space-x-2 mt-auto">
        <input
          type="number"
          min="1"
          max={item.stock}
          value={quantity}
          onChange={(e) => setQuantity(Math.max(1, Math.min(item.stock, Number(e.target.value))))}
          className="w-16 px-2 py-1 border border-gray-300 rounded-lg text-center focus:ring-blue-500 focus:border-blue-500"
          disabled={item.stock === 0}
        />
        <button
          onClick={handleAddToCart}
          className="flex-1 bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-2 px-3 rounded-xl font-medium text-sm transition duration-300 hover:shadow-lg hover:from-indigo-600 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed"
          disabled={item.stock === 0}
        >
          {item.stock > 0 ? 'åŠ å…¥è³¼ç‰©è»Š' : 'å”®ç½„'}
        </button>
      </div>
    </div>
  );
};


// --- Main Application Component ---
const App = () => {
  const [marketItems, setMarketItems] = useState(initialMarketItems);
  const [cart, setCart] = useState({}); // { itemId: quantity }
  const [financials, setFinancials] = useState(initialFinancials);
  const [isCheckoutModalOpen, setIsCheckoutModalOpen] = useState(false);

  // --- Derived State Calculations (Optimized with useMemo) ---
  const { cartItems, cartTotal, cartCOGS } = useMemo(() => {
    let total = 0;
    let totalCOGS = 0;
    const items = Object.entries(cart).map(([itemId, quantity]) => {
      const item = marketItems.find(i => i.id === Number(itemId));
      if (item) {
        const itemTotal = item.price * quantity;
        const itemCOGS = item.cost * quantity;
        total += itemTotal;
        totalCOGS += itemCOGS;
        return { ...item, quantity, itemTotal };
      }
      return null;
    }).filter(Boolean);
    return { cartItems: items, cartTotal: total, cartCOGS: totalCOGS };
  }, [cart, marketItems]);


  const inventoryValue = useMemo(() => {
    return marketItems.reduce((sum, item) => sum + item.stock * item.cost, 0);
  }, [marketItems]);

  const profit = useMemo(() => financials.revenue - financials.costOfGoodsSold, [financials]);

  const currentCapital = useMemo(() => financials.initialCapital + profit, [financials, profit]);

  // --- Handlers ---
  const handleAddToCart = (item, quantity) => {
    setCart(prevCart => {
      const currentQuantity = prevCart[item.id] || 0;
      // Prevent adding more than available stock
      const newQuantity = Math.min(item.stock, currentQuantity + quantity);

      if (newQuantity === currentQuantity) return prevCart; // No change if max stock reached

      return {
        ...prevCart,
        [item.id]: newQuantity
      };
    });
  };

  const handleUpdateCartQuantity = (itemId, newQuantity) => {
    setCart(prevCart => {
      const item = marketItems.find(i => i.id === Number(itemId));
      const maxStock = item ? item.stock : 0;
      const safeQuantity = Math.min(maxStock, Math.max(0, newQuantity));

      if (safeQuantity === 0) {
        const { [itemId]: removed, ...rest } = prevCart;
        return rest;
      }

      return { ...prevCart, [itemId]: safeQuantity };
    });
  };

  const handleCheckout = () => {
    if (cartTotal === 0) {
      alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œç„¡æ³•çµå¸³ã€‚');
      return;
    }

    // 1. Update Financials
    setFinancials(prev => ({
      ...prev,
      revenue: prev.revenue + cartTotal,
      costOfGoodsSold: prev.costOfGoodsSold + cartCOGS,
      totalTransactions: prev.totalTransactions + 1,
    }));

    // 2. Update Market Inventory
    setMarketItems(prevItems => prevItems.map(item => {
      const purchasedQuantity = cart[item.id] || 0;
      if (purchasedQuantity > 0) {
        return { ...item, stock: item.stock - purchasedQuantity };
      }
      return item;
    }));

    // 3. Clear Cart
    setCart({});
    setIsCheckoutModalOpen(false);
    // Use a custom message box instead of alert()
    const message = `æˆåŠŸäº¤æ˜“ï¼\n\n- ç‡Ÿæ”¶ï¼š$${cartTotal.toLocaleString()}\n- æˆæœ¬ï¼š$${cartCOGS.toLocaleString()}\n- åˆ©æ½¤ï¼š$${(cartTotal - cartCOGS).toLocaleString()}`;
    showMessageBox('äº¤æ˜“å®Œæˆ', message);
  };

  // Custom Message Box function (replaces alert)
  const showMessageBox = (title, message) => {
    const modal = document.createElement('div');
    modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4";
    modal.innerHTML = `
      <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-100">
        <h3 class="text-xl font-bold mb-3 text-indigo-600">${title}</h3>
        <p class="text-gray-700 whitespace-pre-line">${message}</p>
        <button id="close-msg-box" class="mt-4 w-full bg-indigo-500 text-white py-2 rounded-xl font-semibold hover:bg-indigo-600 transition duration-200">ç¢ºå®š</button>
      </div>
    `;
    document.body.appendChild(modal);

    document.getElementById('close-msg-box').onclick = () => {
      document.body.removeChild(modal);
    };
  };

  // --- Cart Modal Component (Rendered via JSX) ---
  const CartModal = ({ isOpen, onClose }) => {
    if (!isOpen) return null;

    return (
      <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
          {/* Modal Header */}
          <div className="p-5 border-b sticky top-0 bg-white rounded-t-xl z-10">
            <h2 className="text-2xl font-bold text-gray-800 flex items-center">
              <ShoppingCart className="w-6 h-6 mr-2 text-indigo-500" />
              è³¼ç‰©è»Š ({cartItems.length} é …)
            </h2>
            <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-3xl">
              &times;
            </button>
          </div>

          {/* Modal Body (Cart Items) */}
          <div className="p-5 space-y-4">
            {cartItems.length === 0 ? (
              <p className="text-center text-gray-500 py-10">è³¼ç‰©è»Šå…§æ²’æœ‰å•†å“ã€‚</p>
            ) : (
              cartItems.map(item => (
                <div key={item.id} className="flex justify-between items-center border-b pb-2">
                  <div className="flex items-center space-x-3">
                    <span className="text-2xl">{item.emoji}</span>
                    <div>
                      <p className="font-semibold text-gray-800">{item.name}</p>
                      <p className="text-sm text-gray-500">${item.price} x {item.quantity} {item.unit}</p>
                    </div>
                  </div>
                  <div className="flex items-center space-x-4">
                    <input
                      type="number"
                      min="1"
                      max={item.stock}
                      value={item.quantity}
                      onChange={(e) => handleUpdateCartQuantity(item.id, Number(e.target.value))}
                      className="w-14 px-1 py-1 border border-gray-300 rounded-lg text-center text-sm"
                    />
                    <span className="font-bold text-lg text-indigo-600">${item.itemTotal.toLocaleString()}</span>
                  </div>
                </div>
              ))
            )}
          </div>

          {/* Modal Footer (Summary & Checkout) */}
          <div className="p-5 bg-gray-50 rounded-b-xl sticky bottom-0 border-t">
            <div className="flex justify-between text-xl font-bold text-gray-800 mb-4">
              <span>ç¸½é‡‘é¡:</span>
              <span className="text-red-600">${cartTotal.toLocaleString()}</span>
            </div>
            <button
              onClick={handleCheckout}
              disabled={cartTotal === 0}
              className="w-full bg-green-500 text-white py-3 rounded-xl font-bold text-lg transition duration-300 hover:bg-green-600 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
            >
              ç¢ºèªçµå¸³ (${cartTotal.toLocaleString()})
            </button>
          </div>
        </div>
      </div>
    );
  };

  // --- Render App ---
  return (
    <div className="min-h-screen bg-gray-50 font-sans">
      {/* Header */}
      <header className="bg-white shadow-sm sticky top-0 z-20">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
          <h1 className="text-3xl font-extrabold text-indigo-700 flex items-center">
            <img src="https://placehold.co/32x32/indigo/white?text=I" alt="IGB Icon" className="mr-2 rounded-full"/>
            IGB ç¶²è·¯èœå¸‚å ´
            <span className="text-base font-normal ml-3 text-gray-500 hidden sm:inline">(æ•´åˆè²¡å‹™æ¨¡æ“¬)</span>
          </h1>
          <button
            onClick={() => setIsCheckoutModalOpen(true)}
            className="relative p-2 bg-indigo-500 text-white rounded-full transition duration-300 hover:bg-indigo-600 shadow-md"
          >
            <ShoppingCart className="w-6 h-6" />
            {cartItems.length > 0 && (
              <span className="absolute top-0 right-0 transform translate-x-1/4 -translate-y-1/4 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center ring-2 ring-white">
                {cartItems.length}
              </span>
            )}
          </button>
        </div>
      </header>

      {/* Main Content Area */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-10">

        {/* Financial Dashboard Section */}
        <FinancialDashboard
          financials={financials}
          inventoryValue={inventoryValue}
          profit={profit}
          currentCapital={currentCapital}
        />

        <div className="border-t border-gray-200 pt-8">
            <h2 className="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                <Package className="w-6 h-6 mr-2 text-green-600"/>
                å¸‚å ´å•†å“åˆ—è¡¨ (æ¨¡æ“¬äº¤æ˜“)
            </h2>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {marketItems.map((item) => (
              <MarketItemCard key={item.id} item={item} onAddToCart={handleAddToCart} />
            ))}
          </div>
        </div>
      </main>

      {/* Cart Modal */}
      <CartModal isOpen={isCheckoutModalOpen} onClose={() => setIsCheckoutModalOpen(false)} />
    </div>
  );
};

export default App;
