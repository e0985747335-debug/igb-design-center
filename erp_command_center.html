<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP 2.0 æˆ°ç•¥æŒ‡æ®ä¸­å¿ƒ</title>

    <!-- ä½¿ç”¨å¯é çš„ Chart.js CDN è·¯å¾‘ å’Œ Tailwind CSS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* è‡ªå®šç¾©å­—é«”å’Œæ·±è‰²ä¸»é¡Œ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        :root {
            --primary-color: #3b82f6; /* Blue-500 */
            --bg-dark: #1f2937;      /* Gray-800 */
            --bg-deep: #111827;      /* Gray-900 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-deep);
            color: #d1d5db; /* Light Gray */
            min-height: 100vh;
        }

        .dashboard-card {
            background-color: var(--bg-dark);
            border: 1px solid #374151; /* Gray-700 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
        }

        .nav-link.active {
            background-color: #374151; /* Gray-700 */
            border-left: 4px solid var(--primary-color);
            color: white;
        }

        /* é€šç”¨åœ–æ¨™æ¨£å¼ï¼Œç¾åœ¨ä½¿ç”¨ Emoji */
        .icon {
            display: inline-block;
            line-height: 1;
        }

        /* éŸ¿æ‡‰å¼ä½ˆå±€ï¼šå´é‚Šæ¬„åœ¨å°è¢å¹•ä¸Šéš±è—æˆ–è®Šç‚ºé ‚éƒ¨å°èˆª */
        @media (max-width: 1024px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                border-bottom: 1px solid #374151;
            }
            .content-area {
                padding-top: 0;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="flex flex-col lg:flex-row min-h-screen">
        <!-- å´é‚Šæ¬„/å°èˆª (Sidebar) -->
        <nav class="sidebar lg:w-64 bg-gray-900 lg:h-screen p-4 flex-shrink-0">
            <div class="text-2xl font-bold text-blue-400 mb-8 mt-2 tracking-wider border-b border-gray-700 pb-4">
                ERP 2.0 æŒ‡æ®ä¸­å¿ƒ
            </div>
            <div id="nav-container" class="lg:space-y-2 flex lg:block overflow-x-auto space-x-2 lg:space-x-0">
                <!-- å°èˆªé€£çµå°‡ç”± JS æ¸²æŸ“ -->
            </div>

            <div class="mt-8 pt-4 border-t border-gray-700">
                <p class="text-xs text-gray-500">ç³»çµ±ç‹€æ…‹: <span id="system-status" class="text-yellow-400">è¼‰å…¥ä¸­...</span></p>
                <!-- é¡¯ç¤ºå®Œæ•´çš„ User ID -->
                <p class="text-xs text-gray-500 mt-1">ç”¨æˆ¶ ID: <span id="user-id" class="font-mono text-xs break-all text-yellow-400">æ­£åœ¨ç­‰å¾…èº«ä»½é©—è­‰...</span></p>

                <!-- æ–°å¢ Google ç™»å…¥æŒ‰éˆ•å®¹å™¨ -->
                <div id="auth-actions" class="mt-4">
                    <!-- æŒ‰éˆ•å°‡ç”± JS æ¸²æŸ“ (ç™»å…¥æˆ–ç™»å‡º) -->
                </div>
            </div>
        </nav>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ (Main Content) -->
        <main class="flex-grow p-4 lg:p-8 content-area">
            <h2 id="module-title" class="text-3xl font-semibold text-white mb-6">æ­¡è¿ä½¿ç”¨ ERP 2.0 æˆ°ç•¥æŒ‡æ®ä¸­å¿ƒ</h2>
            <div id="module-content" class="min-h-[70vh]">
                <!-- åˆå§‹æ­¡è¿å…§å®¹ï¼Œå°‡åœ¨ JS åˆå§‹åŒ–å¾Œè¢«è¦†è“‹ -->
                <div class="dashboard-card p-10 text-center">
                    <p class="text-xl text-blue-400 mb-4">è«‹å¾å·¦å´å°èˆªé¸æ“‡ä¸€å€‹æ¨¡çµ„</p>
                    <p class="text-gray-400">æ•´åˆäº†è²¡å‹™ã€æ¡è³¼å’Œå¯©æ‰¹çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç‚ºæ‚¨çš„æˆ°ç•¥æ±ºç­–æä¾›å¯¦æ™‚æ•¸æ“šæ”¯æŒã€‚</p>
                    <div class="mt-8 flex justify-center space-x-4">
                        <button onclick="renderModule('AccountingAnalysis')" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">æŸ¥çœ‹è²¡å‹™ KPI</button>
                        <button onclick="renderModule('Procurement')" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">é€²å…¥æ¡è³¼ä¸­å¿ƒ</button>
                    </div>
                </div>
            </div>

            <!-- æ–°å¢: éŒ¯èª¤æ—¥èªŒé¢æ¿ -->
            <div id="error-log-panel" class="dashboard-card p-4 mt-8 hidden">
                <h3 class="text-lg font-semibold text-red-400 mb-3 border-b border-gray-700 pb-2">ğŸš¨ ç³»çµ±éŒ¯èª¤æ—¥èªŒ (Firebase)</h3>
                <ul id="error-log-list" class="space-y-1 text-sm text-red-300 max-h-40 overflow-y-auto">
                    <!-- éŒ¯èª¤è¨Šæ¯å°‡è¢«æ’å…¥æ­¤è™• -->
                </ul>
                <p class="text-xs text-gray-500 mt-3">å¦‚æœæ“ä½œå¤±æ•—ï¼Œè«‹å°‡ä¸Šæ–¹è¨Šæ¯æˆªåœ–æˆ–è¤‡è£½çµ¦æˆ‘ã€‚</p>
            </div>
        </main>
    </div>

    <!-- æ¨¡æ…‹æ¡†/é€šçŸ¥å€åŸŸ (å–ä»£ alert/confirm) -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50"></div>

    <script type="module">
        // =========================================================
        // æ ¸å¿ƒè¨­å®šèˆ‡åˆå§‹åŒ–
        // =========================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // å¼•å…¥ Google ç™»å…¥æ‰€éœ€çš„æ–°æ¨¡çµ„
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // å¼•å…¥å¯¦æ™‚ç›£è½æ‰€éœ€å‡½æ•¸
        import { getFirestore, collection, addDoc, setLogLevel, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase Log Level
        setLogLevel('Debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // ç’°å¢ƒè®Šæ•¸
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let revenueCostChart = null;
        let mdmDoughnutChart = null;
        let currentUserId = null;
        let currentModule = 'Home';
        let isAuthReady = false; // æ–°å¢ç‹€æ…‹è¿½è¹¤

        // æ ¸å¿ƒæ•¸æ“šç‹€æ…‹ï¼šç”¨æ–¼å„²å­˜å¾ Firestore å¯¦æ™‚ç²å–çš„è¨˜éŒ„
        let expenses = [];
        let purchaseOrders = [];
        let transactions = [];

        // æ‰€æœ‰å¸¶æœ‰æäº¤åŠŸèƒ½çš„æŒ‰éˆ• ID åˆ—è¡¨
        const submitButtonIds = ['expense-submit-btn', 'po-submit-btn', 'finance-submit-btn'];


        /**
         * æ–°å¢éŒ¯èª¤æ—¥èªŒåŠŸèƒ½
         * @param {string} message éŒ¯èª¤è¨Šæ¯
         */
        const logError = (message) => {
            const logPanel = document.getElementById('error-log-panel');
            const logList = document.getElementById('error-log-list');
            const timestamp = new Date().toLocaleTimeString('zh-TW');

            const listItem = document.createElement('li');
            listItem.className = 'bg-gray-900 p-2 rounded';
            listItem.innerHTML = `<strong class="text-gray-400">[${timestamp}]</strong> ${message}`;

            logList.prepend(listItem);
            logPanel.classList.remove('hidden');

            // ä¿æŒåˆ—è¡¨ä¸è¶…é 10 æ¢è¨˜éŒ„
            while (logList.children.length > 10) {
                logList.removeChild(logList.lastChild);
            }
            customAlert('æ“ä½œå¤±æ•—ï¼šè«‹æŸ¥çœ‹åº•éƒ¨çš„éŒ¯èª¤æ—¥èªŒä»¥ç²å–è©³ç´°è³‡è¨Šã€‚', 'red');
        };

        /**
         * æ ¹æ“šèªè­‰ç‹€æ…‹æ›´æ–°å–®å€‹æäº¤æŒ‰éˆ•çš„ç‹€æ…‹
         * @param {string} buttonId
         */
        const updateSubmitButtonState = (buttonId) => {
            const btn = document.getElementById(buttonId);
            if (!btn) return;

            btn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-red-600', 'bg-blue-600', 'bg-green-600', 'bg-indigo-600');

            if (!isAuthReady) {
                btn.disabled = true;
                btn.textContent = 'èªè­‰è¼‰å…¥ä¸­...';
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            } else if (!currentUserId) {
                btn.disabled = true;
                btn.textContent = 'âŒ èªè­‰å¤±æ•—ï¼Œç„¡æ³•æäº¤';
                btn.classList.add('bg-red-600', 'opacity-75', 'cursor-not-allowed');
            } else {
                btn.disabled = false;
                btn.textContent =
                    buttonId === 'po-submit-btn' ? 'æäº¤ PO' :
                    (buttonId === 'expense-submit-btn' ? 'æäº¤å¯©æ‰¹è«‹æ±‚' :
                    (buttonId === 'finance-submit-btn' ? 'è¨˜éŒ„äº¤æ˜“' : 'æäº¤'));

                // æ¢å¾©æ¨¡çµ„ç‰¹å®šçš„é¡è‰²
                btn.classList.add(
                    buttonId === 'po-submit-btn' ? 'bg-blue-600' :
                    (buttonId === 'expense-submit-btn' ? 'bg-green-600' :
                    (buttonId === 'finance-submit-btn' ? 'bg-indigo-600' : 'bg-gray-600'))
                );
            }
        };

        /**
         * æ›´æ–°æ‰€æœ‰æ¨¡çµ„ä¸­æäº¤æŒ‰éˆ•çš„ç‹€æ…‹
         */
        const updateAllSubmitButtons = () => {
            submitButtonIds.forEach(id => updateSubmitButtonState(id));
        };

        /**
         * æ¸²æŸ“ Google ç™»å…¥/ç™»å‡ºæŒ‰éˆ•
         */
        const renderAuthActions = () => {
            const authActions = document.getElementById('auth-actions');
            if (!authActions) return;

            authActions.innerHTML = '';

            if (currentUserId && !auth.currentUser?.isAnonymous) {
                // å¦‚æœå·²ç™»å…¥ä¸”éåŒ¿åç”¨æˆ¶ï¼Œé¡¯ç¤ºç™»å‡ºæŒ‰éˆ•
                authActions.innerHTML = `
                    <button id="sign-out-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 rounded-lg transition duration-200 text-sm flex items-center justify-center space-x-2">
                        <span>ğŸšª ç™»å‡º (${auth.currentUser?.email || 'ç”¨æˆ¶'})</span>
                    </button>
                `;
                document.getElementById('sign-out-btn').onclick = handleSignOut;
            } else if (!currentUserId || auth.currentUser?.isAnonymous) {
                // å¦‚æœæœªç™»å…¥æˆ–åŒ¿åç™»å…¥ï¼Œé¡¯ç¤º Google ç™»å…¥æŒ‰éˆ•
                authActions.innerHTML = `
                    <p class="text-xs text-gray-500 mb-2">æˆ–åˆ‡æ›èº«ä»½ï¼š</p>
                    <button id="google-sign-in-btn" class="w-full bg-white text-gray-800 font-medium py-2 rounded-lg transition duration-200 text-sm flex items-center justify-center space-x-2 shadow-md hover:bg-gray-200">
                        <!-- Google SVG Icon -->
                        <svg class="w-4 h-4" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M44.5 20h-2.5V18c0-.55-.45-1-1-1h-3c-.55 0-1 .45-1 1v2H34c-.55 0-1 .45-1 1v3c0 .55.45 1 1 1h3v2c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-2h2.5c.55 0 1-.45 1-1v-3c0-.55-.45-1-1-1z" fill="#4285F4"/>
                            <path d="M44.5 20h-2.5V18c0-.55-.45-1-1-1h-3c-.55 0-1 .45-1 1v2H34c-.55 0-1 .45-1 1v3c0 .55.45 1 1 1h3v2c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-2h2.5c.55 0 1-.45 1-1v-3c0-.55-.45-1-1-1z" fill="#4285F4"/>
                            <path d="M22.5 8c2.4 0 4.6.8 6.4 2.2l4.1-4.1C29.2 3.7 26 2 22.5 2 13.9 2 6.5 7 3 14h6.3C10.7 9.8 16 6.5 22.5 6.5c3.5 0 6.6 1.1 9.3 2.8l-4.2 4.2c-1.8-1.2-4-2-6.4-2zm-.1 6.5c-3.1 0-5.7 1.8-6.9 4.3H33c-1.3-2.5-3.8-4.3-6.9-4.3zm-7.6 13.5c0-1.8.3-3.6.9-5.3l-5-4.1c-1 1.7-1.6 3.6-1.6 5.4s.6 3.7 1.6 5.4zM24 39c-4.4 0-8.2-2.7-9.8-6.4h20.6c-1.7 3.7-5.5 6.4-9.8 6.4zm8.6-13.5c0 1.8-.3 3.6-.9 5.3l5 4.1c1-1.7 1.6-3.6 1.6-5.4s-.6-3.7-1.6-5.4zM22.5 31c-3.5 0-6.6-1.1-9.3-2.8l4.2-4.2c1.8 1.2 4 2 6.4 2zm-7.6-13.5c0-1.8-.3-3.6-.9-5.3l-5-4.1c-1 1.7-1.6 3.6-1.6 5.4s.6 3.7 1.6 5.4z"/>
                            <path d="M12.9 23.5c0 1.8.3 3.6.9 5.3l5 4.1c1-1.7 1.6-3.6 1.6-5.4s-.6-3.7-1.6-5.4z" fill="#FFC107"/>
                            <path d="M22.5 8c2.4 0 4.6.8 6.4 2.2l4.1-4.1C29.2 3.7 26 2 22.5 2 13.9 2 6.5 7 3 14h6.3C10.7 9.8 16 6.5 22.5 6.5c3.5 0 6.6 1.1 9.3 2.8l-4.2 4.2c-1.8-1.2-4-2-6.4-2zm-.1 6.5c-3.1 0-5.7 1.8-6.9 4.3H33c-1.3-2.5-3.8-4.3-6.9-4.3zm-7.6 13.5c0-1.8.3-3.6.9-5.3l-5-4.1c-1 1.7-1.6 3.6-1.6 5.4s.6 3.7 1.6 5.4zM24 39c-4.4 0-8.2-2.7-9.8-6.4h20.6c-1.7 3.7-5.5 6.4-9.8 6.4zm8.6-13.5c0 1.8-.3 3.6-.9 5.3l5 4.1c1-1.7 1.6-3.6 1.6-5.4s-.6-3.7-1.6-5.4zM22.5 31c-3.5 0-6.6-1.1-9.3-2.8l4.2-4.2c1.8 1.2 4 2 6.4 2zm-7.6-13.5c0-1.8-.3-3.6-.9-5.3l-5-4.1c-1 1.7-1.6 3.6-1.6 5.4s.6 3.7 1.6 5.4z"/>
                            <path d="M44.5 20h-2.5V18c0-.55-.45-1-1-1h-3c-.55 0-1 .45-1 1v2H34c-.55 0-1 .45-1 1v3c0 .55.45 1 1 1h3v2c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-2h2.5c.55 0 1-.45 1-1v-3c0-.55-.45-1-1-1z" fill="#4285F4"/>
                            <path d="M44.5 20h-2.5V18c0-.55-.45-1-1-1h-3c-.55 0-1 .45-1 1v2H34c-.55 0-1 .45-1 1v3c0 .55.45 1 1 1h3v2c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-2h2.5c.55 0 1-.45 1-1v-3c0-.55-.45-1-1-1z" fill="#4285F4"/>
                            <path d="M12.9 23.5c0 1.8.3 3.6.9 5.3l5 4.1c1-1.7 1.6-3.6 1.6-5.4s-.6-3.7-1.6-5.4z" fill="#4285F4"/>
                            <path d="M22.5 8c2.4 0 4.6.8 6.4 2.2l4.1-4.1C29.2 3.7 26 2 22.5 2 13.9 2 6.5 7 3 14h6.3C10.7 9.8 16 6.5 22.5 6.5c3.5 0 6.6 1.1 9.3 2.8l-4.2 4.2c-1.8-1.2-4-2-6.4-2zm-.1 6.5c-3.1 0-5.7 1.8-6.9 4.3H33c-1.3-2.5-3.8-4.3-6.9-4.3zm-7.6 13.5c0-1.8.3-3.6.9-5.3l-5-4.1c-1 1.7-1.6 3.6-1.6 5.4s.6 3.7 1.6 5.4zM24 39c-4.4 0-8.2-2.7-9.8-6.4h20.6c-1.7 3.7-5.5 6.4-9.8 6.4zm8.6-13.5c0 1.8-.3 3.6-.9 5.3l5 4.1c1-1.7 1.6-3.6 1.6-5.4s-.6-3.7-1.6-5.4zM22.5 31c-3.5 0-6.6-1.1-9.3-2.8l4.2-4.2c1.8 1.2 4 2 6.4 2zm-7.6-13.5c0-1.8-.3-3.6-.9-5.3l-5-4.1c-1 1.7-1.6 3.6-1.6 5.4s.6 3.7 1.6 5.4z"/>
                            <path d="M44.5 20h-2.5V18c0-.55-.45-1-1-1h-3c-.55 0-1 .45-1 1v2H34c-.55 0-1 .45-1 1v3c0 .55.45 1 1 1h3v2c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-2h2.5c.55 0 1-.45 1-1v-3c0-.55-.45-1-1-1z" fill="#4285F4"/>
                            <path d="M44.5 20h-2.5V18c0-.55-.45-1-1-1h-3c-.55 0-1 .45-1 1v2H34c-.55 0-1 .45-1 1v3c0 .55.45 1 1 1h3v2c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-2h2.5c.55 0 1-.45 1-1v-3c0-.55-.45-1-1-1z" fill="#4285F4"/>
                            <path d="M12.9 23.5c0 1.8.3 3.6.9 5.3l5 4.1c1-1.7 1.6-3.6 1.6-5.4s-.6-3.7-1.6-5.4z" fill="#4285F4"/>
                            <path d="M12.9 23.5c0 1.8.3 3.6.9 5.3l5 4.1c1-1.7 1.6-3.6 1.6-5.4s-.6-3.7-1.6-5.4z" fill="#4285F4"/>
                            <path d="M22.5 8c2.4 0 4.6.8 6.4 2.2l4.1-4.1C29.2 3.7 26 2 22.5 2 13.9 2 6.5 7 3 14h6.3C10.7 9.8 16 6.5 22.5 6.5c3.5 0 6.6 1.1 9.3 2.8l-4.2 4.2c-1.8-1.2-4-2-6.4-2zm-.1 6.5c-3.1 0-5.7 1.8-6.9 4.3H33c-1.3-2.5-3.8-4.3-6.9-4.3zm-7.6 13.5c0-1.8.3-3.6.9-5.3l-5-4.1c-1 1.7-1.6 3.6-1.6 5.4s.6 3.7 1.6 5.4zM24 39c-4.4 0-8.2-2.7-9.8-6.4h20.6c-1.7 3.7-5.5 6.4-9.8 6.4zm8.6-13.5c0 1.8-.3 3.6-.9 5.3l5 4.1c1-1.7 1.6-3.6 1.6-5.4s-.6-3.7-1.6-5.4zM22.5 31c-3.5 0-6.6-1.1-9.3-2.8l4.2-4.2c1.8 1.2 4 2 6.4 2zm-7.6-13.5c0-1.8-.3-3.6-.9-5.3l-5-4.1c-1 1.7-1.6 3.6-1.6 5.4s.6 3.7 1.6 5.4z"/>
                            <path d="M12.9 23.5c0 1.8.3 3.6.9 5.3l5 4.1c1-1.7 1.6-3.6 1.6-5.4s-.6-3.7-1.6-5.4z" fill="#FFC107"/>
                            <path d="M12.9 23.5c0 1.8.3 3.6.9 5.3l5 4.1c1-1.7 1.6-3.6 1.6-5.4s-.6-3.7-1.6-5.4z" fill="#FFC107"/>
                            <path d="M44.5 20h-2.5V18c0-.55-.45-1-1-1h-3c-.55 0-1 .45-1 1v2H34c-.55 0-1 .45-1 1v3c0 .55.45 1 1 1h3v2c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-2h2.5c.55 0 1-.45 1-1v-3c0-.55-.45-1-1-1z" fill="#4285F4"/>
                            <path d="M44.5 20h-2.5V18c0-.55-.45-1-1-1h-3c-.55 0-1 .45-1 1v2H34c-.55 0-1 .45-1 1v3c0 .55.45 1 1 1h3v2c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-2h2.5c.55 0 1-.45 1-1v-3c0-.55-.45-1-1-1z" fill="#4285F4"/>
                            <path d="M22.5 8c2.4 0 4.6.8 6.4 2.2l4.1-4.1C29.2 3.7 26 2 22.5 2 13.9 2 6.5 7 3 14h6.3C10.7 9.8 16 6.5 22.5 6.5c3.5 0 6.6 1.1 9.3 2.8l-4.2 4.2c-1.8-1.2-4-2-6.4-2zm-.1 6.5c-3.1 0-5.7 1.8-6.9 4.3H33c-1.3-2.5-3.8-4.3-6.9-4.3zm-7.6 13.5c0-1.8.3-3.6.9-5.3l-5-4.1c-1 1.7-1.6 3.6-1.6 5.4s.6 3.7 1.6 5.4zM24 39c-4.4 0-8.2-2.7-9.8-6.4h20.6c-1.7 3.7-5.5 6.4-9.8 6.4zm8.6-13.5c0 1.8-.3 3.6-.9 5.3l5 4.1c1-1.7 1.6-3.6 1.6-5.4s-.6-3.7-1.6-5.4zM22.5 31c-3.5 0-6.6-1.1-9.3-2.8l4.2-4.2c1.8 1.2 4 2 6.4 2zm-7.6-13.5c0-1.8-.3-3.6-.9-5.3l-5-4.1c-1 1.7-1.6 3.6-1.6 5.4s.6 3.7 1.6 5.4z"/>
                        </svg>
                        <span>ä½¿ç”¨ Google ç™»å…¥/è¨»å†Š</span>
                    </button>
                `;
                document.getElementById('google-sign-in-btn').onclick = handleGoogleSignIn;
            }
        };


        /**
         * è™•ç† Google ç™»å…¥ (ä½¿ç”¨å½ˆå‡ºè¦–çª—)
         */
        const handleGoogleSignIn = async () => {
            const provider = new GoogleAuthProvider();
            try {
                // å¦‚æœå·²ç¶“æ˜¯åŒ¿åç”¨æˆ¶ï¼ŒFirebase æœƒè‡ªå‹•å°‡å…¶éˆæ¥åˆ°æ–°çš„ Google å¸³æˆ¶
                const result = await signInWithPopup(auth, provider);
                // const user = result.user; // ç”¨æˆ¶å·²åœ¨ onAuthStateChanged ä¸­è™•ç†
                customAlert('âœ… Google ç™»å…¥æˆåŠŸï¼', 'green');
            } catch (error) {
                console.error("Google ç™»å…¥å¤±æ•—:", error);
                logError(`Google ç™»å…¥å¤±æ•—: ${error.message}`);
            }
        };

        /**
         * è™•ç†ç™»å‡º
         */
        const handleSignOut = async () => {
            try {
                await signOut(auth);
                // ç™»å‡ºå¾Œè‡ªå‹•åˆ‡æ›å›åŒ¿åç™»å…¥ (ä¿æŒé€£ç·šç‹€æ…‹)
                await signInAnonymously(auth);
                customAlert('ğŸšª æ‚¨å·²æˆåŠŸç™»å‡ºï¼Œç›®å‰ç‚ºåŒ¿åèº«ä»½ã€‚', 'blue');
            } catch (error) {
                console.error("ç™»å‡ºå¤±æ•—:", error);
                logError(`ç™»å‡ºå¤±æ•—: ${error.message}`);
            }
        };


        /**
         * è¨­å®šæ‰€æœ‰æ¨¡çµ„çš„å¯¦æ™‚æ•¸æ“šè¨‚é–± (onSnapshot)
         * @param {string} userId ç•¶å‰ç”¨æˆ¶ ID
         */
        const subscribeToAllData = (userId) => {
             // ç§»é™¤èˆŠçš„è¨‚é–± (å¦‚æœå­˜åœ¨) - é›–ç„¶ onSnapshot æœ¬èº«æœƒè¿”å›ä¸€å€‹å–æ¶ˆå‡½æ•¸ï¼Œä½†ç”±æ–¼æˆ‘å€‘åœ¨èªè­‰æ™‚é‡æ–°åˆå§‹åŒ–ï¼Œé€™è£¡ä¸»è¦ä¾é  onAuthStateChanged çš„å–®æ¬¡è§¸ç™¼ã€‚
             // ç‚ºäº†é¿å…é‡è¤‡è¨‚é–±ï¼Œåœ¨å¯¦éš›ç”Ÿç”¢ç’°å¢ƒä¸­æ‡‰ä½¿ç”¨ cancellation tokenã€‚åœ¨å–®æ–‡ä»¶ç’°å¢ƒä¸­ï¼Œæˆ‘å€‘ç¢ºä¿åªåœ¨ç”¨æˆ¶ ID ç¢ºå®šå¾ŒåŸ·è¡Œä¸€æ¬¡ã€‚

            const collectionsToSubscribe = [
                // è²»ç”¨å¯©æ‰¹
                { name: 'expenses', setter: (data) => expenses = data, renderer: renderExpenseApproval },
                // IGB ERP æ¡è³¼
                { name: 'purchase_orders', setter: (data) => purchaseOrders = data, renderer: renderProcurement },
                // è²¡å‹™è¿½è¹¤å™¨
                { name: 'transactions', setter: (data) => transactions = data, renderer: renderFinanceTracker },
            ];

            collectionsToSubscribe.forEach(({ name, setter, renderer }) => {
                // æ³¨æ„ï¼šå¦‚æœç”¨æˆ¶å¾åŒ¿ååˆ‡æ›åˆ° Google ç™»å…¥ï¼Œé€™å€‹è·¯å¾‘ä¹Ÿæœƒæ”¹è®Š
                // é€™æ˜¯ç§æœ‰è³‡æ–™ (private data) çš„è·¯å¾‘
                const path = `artifacts/${appId}/users/${userId}/${name}`;
                // å¯¦æ™‚ç›£è½æŸ¥è©¢
                const q = query(collection(db, path));

                onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // å®¢æˆ¶ç«¯æ’åºï¼šæŒ‰æäº¤æ™‚é–“æˆ³ (é™åº)
                    data.sort((a, b) => (b.submittedAt || b.created || b.recordedAt) - (a.submittedAt || a.created || a.recordedAt));

                    setter(data);
                    console.log(`[Firestore Realtime] ${name} updated. Count: ${data.length}`);

                    // æª¢æŸ¥ç•¶å‰æ¨¡çµ„æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“åˆ—è¡¨
                    const moduleKey = name === 'expenses' ? 'ExpenseApproval' :
                                    (name === 'purchase_orders' ? 'Procurement' :
                                    (name === 'transactions' ? 'FinanceTracker' : null));

                    if (moduleKey && moduleKey === currentModule) {
                        // å»¶é²æ¸²æŸ“ä»¥ç¢ºä¿ DOM å·²æº–å‚™å°±ç·’
                        setTimeout(() => renderer(true), 10);
                    }
                }, (error) => {
                    console.error(`Error subscribing to ${name}:`, error);
                    logError(`å¯¦æ™‚è¨‚é–±å¤±æ•— (${name}): ${error.message}`);
                });
            });
        };


        /**
         * è™•ç† Firebase èªè­‰é‚è¼¯ï¼šå„ªå…ˆä½¿ç”¨ Custom Tokenï¼Œå¦å‰‡åŒ¿åç™»å…¥ã€‚
         */
        const initializeAuth = async () => {
            const userIdElement = document.getElementById('user-id');
            const statusElement = document.getElementById('system-status');

            // 1. è¨­å®šåˆå§‹ç‹€æ…‹
            statusElement.textContent = 'é€£ç·šä¸­...';
            userIdElement.textContent = 'ç­‰å¾…èº«ä»½é©—è­‰...'; // æ›´æ¸…æ™°çš„ä½”ä½ç¬¦
            renderAuthActions(); // æ¸²æŸ“åˆå§‹æŒ‰éˆ•

            // 2. è¨­å®šç‹€æ…‹è§€å¯Ÿè€… (Listener) - å¿…é ˆåœ¨ç™»å…¥å‰è¨­å®š
            let unsubscribeFromData = null; // ç”¨æ–¼å„²å­˜å–æ¶ˆè¨‚é–±çš„å‡½æ•¸

            onAuthStateChanged(auth, (user) => {
                isAuthReady = true; // èªè­‰ç¨‹åºåŸ·è¡Œå®Œç•¢
                updateAllSubmitButtons(); // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹

                // æ¸…é™¤ä¹‹å‰çš„æ•¸æ“šè¨‚é–±
                if (unsubscribeFromData) {
                    unsubscribeFromData();
                    unsubscribeFromData = null;
                }

                if (user) {
                    // æˆåŠŸç‹€æ…‹
                    currentUserId = user.uid;
                    userIdElement.textContent = user.email || user.uid; // å¦‚æœæœ‰ email å‰‡é¡¯ç¤º email
                    userIdElement.className = 'font-mono text-xs break-all ' + (user.isAnonymous ? 'text-yellow-400' : 'text-green-400');
                    statusElement.textContent = user.isAnonymous ? 'âš ï¸ åŒ¿åé€£ç·š' : 'âœ… é€£ç·šæˆåŠŸ';
                    statusElement.className = user.isAnonymous ? 'text-yellow-400' : 'text-green-400';
                    console.log("Firebase Authentication OK. User ID:", currentUserId, "isAnonymous:", user.isAnonymous);

                    // æˆåŠŸèªè­‰å¾Œï¼Œé–‹å§‹å¯¦æ™‚æ•¸æ“šè¨‚é–±
                    // é€™è£¡æˆ‘å€‘ä¸ä½¿ç”¨ subscribeToAllDataï¼Œå› ç‚º onSnapshot æœƒè¢«å¤šæ¬¡å‘¼å«
                    // ç”±æ–¼ onSnapshot æœ¬èº«æœƒè¿”å›ä¸€å€‹å–æ¶ˆå‡½æ•¸ï¼Œæˆ‘å€‘éœ€è¦åœ¨å¯¦éš›ç”Ÿç”¢ç’°å¢ƒä¸­è™•ç†
                    // åœ¨æ­¤å–®æ–‡ä»¶æ‡‰ç”¨ä¸­ï¼Œæˆ‘å€‘ç°¡å–®åœ°ä¾è³´ onAuthStateChanged è§¸ç™¼ï¼Œä¸¦é‡æ–°æ¸²æŸ“ç™»å…¥æ“ä½œ
                    subscribeToAllData(currentUserId);
                    renderAuthActions();

                } else {
                    // ç™»å‡ºç‹€æ…‹
                    currentUserId = null;
                    console.warn("ç”¨æˆ¶æœªç™»å…¥ã€‚");
                    statusElement.textContent = 'âš  å·²ç™»å‡º';
                    statusElement.className = 'text-red-400';
                    userIdElement.textContent = 'è«‹ç™»å…¥æˆ–åˆ·æ–°é é¢';
                    renderAuthActions();
                }
            });

            // 3. åŸ·è¡Œåˆå§‹ç™»å…¥ (é€™å°‡è§¸ç™¼ onAuthStateChanged)
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                // 4. ç™»å…¥éŒ¯èª¤è™•ç†
                console.error("Firebase ç™»å…¥åˆå§‹åŒ–å¤±æ•—:", error);
                statusElement.textContent = 'âŒ ç™»å…¥éŒ¯èª¤';
                statusElement.className = 'text-red-400';
                userIdElement.textContent = 'åˆå§‹åŒ–å¤±æ•—';
                logError("Firebase ç™»å…¥åˆå§‹åŒ–éŒ¯èª¤ï¼š" + error.message);

                isAuthReady = true;
                updateAllSubmitButtons();
            }
        };


        // =========================================================
        // UI æ¸²æŸ“èˆ‡å°èˆªé‚è¼¯
        // =========================================================

        const modules = {
            'ExpenseApproval': { title: 'è²»ç”¨å¯©æ‰¹ç³»çµ±', icon: 'Wallet', render: renderExpenseApproval },
            'AccountingAnalysis': { title: 'æœƒè¨ˆåˆ†ææ‡‰ç”¨ç¨‹å¼', icon: 'BarChart3', render: renderAccountingAnalysis },
            'Procurement': { title: 'IGB ERP æ¡è³¼', icon: 'ShoppingBag', render: renderProcurement },
            'FinanceTracker': { title: 'è²¡å‹™è¿½è¹¤å™¨', icon: 'DollarSign', render: renderFinanceTracker }
        };

        // å°èˆªæ¸²æŸ“
        const renderNavigation = () => {
            const navContainer = document.getElementById('nav-container');
            navContainer.innerHTML = '';

            const iconMap = {
                'Wallet': 'ğŸ’°',
                'BarChart3': 'ğŸ“Š',
                'ShoppingBag': 'ğŸ›ï¸',
                'DollarSign': 'ğŸ’µ'
            };

            Object.keys(modules).forEach(key => {
                const module = modules[key];
                const isActive = key === currentModule ? 'active' : '';

                const iconSymbol = iconMap[module.icon] || 'âš™ï¸';

                const link = document.createElement('a');
                link.href = `#${key}`;
                link.className = `nav-link ${isActive} flex items-center p-3 text-sm font-medium rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out`;
                link.innerHTML = `<span class="icon mr-3 text-lg">${iconSymbol}</span> ${module.title}`;
                link.onclick = (e) => {
                    e.preventDefault();
                    renderModule(key);
                };
                navContainer.appendChild(link);
            });
        };

        // æ ¸å¿ƒæ¨¡çµ„æ¸²æŸ“å‡½æ•¸
        window.renderModule = (moduleKey) => {
            const moduleInfo = modules[moduleKey];
            const content = document.getElementById('module-content');

            // è™•ç† Home æ¨¡çµ„æˆ–ç„¡æ•ˆæ¨¡çµ„éµ
            if (!moduleInfo || moduleKey === 'Home') {
                currentModule = 'Home';
                document.getElementById('module-title').textContent = 'æ­¡è¿ä½¿ç”¨ ERP 2.0 æˆ°ç•¥æŒ‡æ®ä¸­å¿ƒ';
                content.innerHTML = `
                    <div class="dashboard-card p-10 text-center">
                        <p class="text-xl text-blue-400 mb-4">è«‹å¾å·¦å´å°èˆªé¸æ“‡ä¸€å€‹æ¨¡çµ„</p>
                        <p class="text-gray-400">æ•´åˆäº†è²¡å‹™ã€æ¡è³¼å’Œå¯©æ‰¹çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç‚ºæ‚¨çš„æˆ°ç•¥æ±ºç­–æä¾›å¯¦æ™‚æ•¸æ“šæ”¯æŒã€‚</p>
                        <div class="mt-8 flex justify-center space-x-4">
                            <button onclick="renderModule('AccountingAnalysis')" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">æŸ¥çœ‹è²¡å‹™ KPI</button>
                            <button onclick="renderModule('Procurement')" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">é€²å…¥æ¡è³¼ä¸­å¿ƒ</button>
                        </div>
                    </div>
                `;
            }

            if (moduleInfo) {
                currentModule = moduleKey;
                document.getElementById('module-title').textContent = moduleInfo.title;
                // å‘¼å«æ¨¡çµ„æ¸²æŸ“ï¼Œéå¯¦æ™‚æ›´æ–°æ¨¡å¼ (false)
                moduleInfo.render(false);
            }

            // æ›´æ–°å°èˆªåˆ—çš„ active ç‹€æ…‹
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.querySelector(`.nav-link[href="#${currentModule}"]`);
            if (activeLink) {
                 activeLink.classList.add('active');
            }
        };

        // =========================================================
        // æ¨¡çµ„ 1: è²»ç”¨å¯©æ‰¹ç³»çµ± (Expense Approval System)
        // =========================================================

        /** æ¸²æŸ“å–®å€‹å¯©æ‰¹é …ç›®çš„ HTML æ¨£å¼ */
        const renderApprovalItem = (type, title, amount, status, color) => {
            const displayStatus = status || 'å¾…å¯©æ‰¹'; // Default status
            let displayColor = color || 'yellow';

            if (displayStatus === 'å¾…å¯©æ‰¹') displayColor = 'yellow';
            else if (displayStatus === 'å·²é€šé') displayColor = 'green';
            else if (displayStatus === 'å·²æ‹’çµ•') displayColor = 'red';

            return `
                <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition duration-150">
                    <div class="flex-grow">
                        <p class="text-sm font-medium text-white">${title} (${type})</p>
                        <p class="text-xs text-gray-400">NT$ ${amount.toLocaleString()}</p>
                    </div>
                    <span class="text-xs font-bold px-3 py-1 rounded-full bg-${displayColor}-500/20 text-${displayColor}-400">${displayStatus}</span>
                    <button class="ml-4 text-blue-400 hover:text-blue-200 text-sm font-semibold">å¯©æ‰¹</button>
                </div>
            `;
        };

        /** æ¸²æŸ“è²»ç”¨åˆ—è¡¨ */
        const renderExpenseList = (data) => {
            const listContainer = document.getElementById('expense-list');
            const countElement = document.getElementById('expense-count');

            if (!listContainer) return;

            if (countElement) countElement.textContent = data.length;

            listContainer.innerHTML = data.length === 0
                ? '<p class="text-gray-500 italic">ç›®å‰æ²’æœ‰è²»ç”¨è«‹æ±‚è¨˜éŒ„ã€‚</p>'
                : data.map(item => {
                    return renderApprovalItem('è²»ç”¨', item.title, item.amount, item.status || 'å¾…å¯©æ‰¹', item.status === 'å·²é€šé' ? 'green' : (item.status === 'å·²æ‹’çµ•' ? 'red' : 'yellow'));
                }).join('');
        }

        /** æ¸²æŸ“è²»ç”¨å¯©æ‰¹æ¨¡çµ„ä¸»é«” */
        function renderExpenseApproval(isRealtimeUpdate = false) {
            const content = document.getElementById('module-content');

            // åªæœ‰åœ¨ç¬¬ä¸€æ¬¡è¼‰å…¥æˆ–éå¯¦æ™‚æ›´æ–°æ™‚æ‰é‡æ–°ç¹ªè£½æ•´å€‹æ¨¡çµ„çµæ§‹
            if (!isRealtimeUpdate) {
                content.innerHTML = `
                    <div class="dashboard-card p-6">
                        <h3 class="text-xl font-semibold text-blue-300 mb-4 border-b border-gray-700 pb-2">å¾…å¯©æ‰¹è«‹æ±‚ (<span id="expense-count">0</span> ç­†)</h3>
                        <div id="expense-list" class="space-y-3">
                            <!-- è²»ç”¨åˆ—è¡¨å°‡è¢«å¯¦æ™‚æ›´æ–° -->
                        </div>

                        <h3 class="text-xl font-semibold text-blue-300 mb-4 mt-8 border-b border-gray-700 pb-2">æäº¤æ–°è«‹æ±‚</h3>
                        <form id="expense-form" class="space-y-4">
                            <input type="text" id="expense-title" placeholder="æ¨™é¡Œ (e.g. å·®æ—…, å ±éŠ·)" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-blue-500" required>
                            <input type="number" id="expense-amount" placeholder="é‡‘é¡ (TWD)" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-blue-500" required>
                            <textarea id="expense-details" placeholder="è©³ç´°èªªæ˜" rows="3" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-blue-500 resize-none"></textarea>
                            <button type="submit" id="expense-submit-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 rounded-lg transition duration-200">æäº¤å¯©æ‰¹è«‹æ±‚</button>
                        </form>
                    </div>
                `;
                document.getElementById('expense-form').onsubmit = handleExpenseSubmission;
                updateSubmitButtonState('expense-submit-btn'); // ç¢ºä¿æ¸²æŸ“æ™‚æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            }

            // å¯¦æ™‚æ›´æ–°è²»ç”¨åˆ—è¡¨
            renderExpenseList(expenses);
        }

        const handleExpenseSubmission = async (e) => {
            e.preventDefault();

            // å¢å¼·æ—¥èªŒæª¢æŸ¥
            console.log(`%c[Submission Check - Expense] isAuthReady: ${isAuthReady}, currentUserId: ${currentUserId}`, 'color: yellow; font-weight: bold;');


            if (!isAuthReady) {
                logError('æ‡‰ç”¨ç¨‹å¼ä»åœ¨åˆå§‹åŒ–ä¸­ï¼Œè«‹ç¨å€™å†æäº¤ã€‚');
                return;
            }
            if (!currentUserId) {
                logError('éŒ¯èª¤ï¼šç”¨æˆ¶èº«ä»½æœªç¢ºå®š (User ID is null)ï¼Œç„¡æ³•æäº¤ã€‚');
                return;
            }

            const title = document.getElementById('expense-title').value;
            const amount = document.getElementById('expense-amount').value;
            const details = document.getElementById('expense-details').value;

            try {
                const path = `artifacts/${appId}/users/${currentUserId}/expenses`;
                await addDoc(collection(db, path), {
                    title, amount: parseFloat(amount), details, status: 'å¾…å¯©æ‰¹', submittedAt: Date.now()
                });
                customAlert('è²»ç”¨è«‹æ±‚å·²æˆåŠŸæäº¤ï¼', 'green');
                document.getElementById('expense-form').reset();
            } catch (error) {
                console.error("è²»ç”¨æäº¤å¤±æ•—:", error);
                logError(`è²»ç”¨æäº¤å¤±æ•—: ${error.message}. è«‹æª¢æŸ¥æ‚¨çš„ Firestore å¯«å…¥æ¬Šé™ã€‚`);
            }
        };


        // =========================================================
        // åœ–è¡¨æ•¸æ“šæ¨¡å‹èˆ‡æ ¸å¿ƒç¹ªåœ–å‡½å¼ (çœç•¥ï¼Œæœªæ”¹å‹•)
        // =========================================================

        // æ¨¡æ“¬æ•¸æ“š
        const chartData = [
            { month: "2024-05", revenue: 1200000, cost: 750000 },
            { month: "2024-06", revenue: 1350000, cost: 800000 },
            { month: "2024-07", revenue: 1500000, cost: 900000 },
            { month: "2024-08", revenue: 1600000, cost: 950000 },
            { month: "2024-09", revenue: 1800000, cost: 1050000 },
            { month: "2024-10", revenue: 1950000, cost: 1100000 },
            { month: "2024-11", revenue: 2100000, cost: 1200000 },
            { month: "2024-12", revenue: 2200000, cost: 1250000 },
            { month: "2025-01", revenue: 2400000, cost: 1350000 },
            { month: "2025-02", revenue: 2600000, cost: 1400000 },
            { month: "2025-03", revenue: 2800000, cost: 1500000 },
            { month: "2024-04", revenue: 3000000, cost: 1600000 },
        ];
        let mdmChartData = {
            labels: ['å·²å®Œæˆ', 'é€²è¡Œä¸­', 'å·²å–æ¶ˆ', 'å¾…è™•ç†'],
            data: [45, 30, 15, 10]
        };

        const formatCurrency = (num) => {
            return 'NT$ ' + Math.round(num).toLocaleString('en-US', { minimumFractionDigits: 0 });
        };
        const formatPercentage = (num) => num.toFixed(1) + '%';


        const renderRevenueCostChart = (data) => {
            const ctx = document.getElementById('revenueCostChart');
            if (!ctx || typeof window.Chart === 'undefined') {
                console.error("Chart.js æœªè¼‰å…¥æˆ– canvas ID ä¸å­˜åœ¨");
                return;
            }

            if (revenueCostChart) revenueCostChart.destroy();

            const labels = data.map(d => d.month);
            const revenues = data.map(d => d.revenue);
            const costs = data.map(d => d.cost);

            revenueCostChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        type: 'line',
                        label: 'éŠ·è²¨æ”¶å…¥',
                        data: revenues,
                        borderColor: '#3b82f6', // è—è‰²
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        fill: false,
                        yAxisID: 'y'
                    }, {
                        type: 'bar',
                        label: 'éŠ·è²¨æˆæœ¬',
                        data: costs,
                        backgroundColor: '#ef4444', // ç´…è‰²
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { callbacks: { label: (context) => context.dataset.label + ': ' + formatCurrency(context.parsed.y) } }
                    },
                    scales: {
                        y: {
                            type: 'linear', display: true, position: 'left',
                            title: { display: true, text: 'é‡‘é¡ ($)' },
                            ticks: { callback: (value) => formatCurrency(value) }
                        },
                        y1: {
                            type: 'linear', display: false, position: 'right', grid: { drawOnChartArea: false },
                        }
                    }
                }
            });
        };

        const createMdmDoughnutChart = () => {
            const ctx = document.getElementById('mdmDoughnutChart');
            if (!ctx || typeof window.Chart === 'undefined') return;

            if (mdmDoughnutChart) mdmDoughnutChart.destroy();

            mdmDoughnutChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: mdmChartData.labels,
                    datasets: [{
                        data: mdmChartData.data,
                        backgroundColor: ['#3b82f6', '#f97316', '#16a34a', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const value = context.parsed;
                                    const percentage = formatPercentage((value / total) * 100);
                                    return `${context.label}: ${value} (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });
        };

        const filterChartData = (data, startMonth, endMonth) => {
            return data.filter(d => d.month >= startMonth && d.month <= endMonth);
        };

        const updateKPIs = (data) => {
            const totalRevenue = data.reduce((sum, d) => sum + d.revenue, 0);
            const totalCost = data.reduce((sum, d) => sum + d.cost, 0);
            const grossProfit = totalRevenue - totalCost;

            const revenueElement = document.getElementById('totalRevenue');
            const costElement = document.getElementById('totalCost');
            const profitElement = document.getElementById('grossProfit');

            if (revenueElement) revenueElement.textContent = formatCurrency(totalRevenue);
            if (costElement) costElement.textContent = formatCurrency(totalCost);
            if (profitElement) profitElement.textContent = formatCurrency(grossProfit);
        };

        const applyFiltersAndRender = () => {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            let dataToRender = chartData;

            if (startDate && endDate) {
                dataToRender = filterChartData(chartData, startDate, endDate);
            }

            renderRevenueCostChart(dataToRender);
            updateKPIs(dataToRender);
        };

        const setupAccountingAnalysisCharts = () => {
            renderRevenueCostChart(chartData);
            createMdmDoughnutChart();
            updateKPIs(chartData);

            const startDateElement = document.getElementById('startDate');
            const endDateElement = document.getElementById('endDate');

            if (startDateElement && endDateElement) {
                startDateElement.addEventListener('change', applyFiltersAndRender);
                endDateElement.addEventListener('change', applyFiltersAndRender);
            }
        };


        // =========================================================
        // æ¨¡çµ„ 2: æœƒè¨ˆåˆ†ææ‡‰ç”¨ç¨‹å¼ (Accounting Analysis App)
        // =========================================================
        function renderAccountingAnalysis() {
            const content = document.getElementById('module-content');
            content.innerHTML = `
                <!-- ç¯©é¸å™¨å€å¡Š -->
                <div class="dashboard-card p-4 mb-6 flex space-x-4 items-center flex-wrap">
                    <h3 class="text-lg font-semibold text-gray-400 mr-4 my-1">æ•¸æ“šç¯„åœ:</h3>
                    <div class="flex items-center space-x-2 my-1">
                        <label for="startDate" class="text-sm font-medium text-gray-500">èµ·å§‹æœˆä»½:</label>
                        <input type="month" id="startDate" class="border border-gray-600 rounded-md p-1.5 text-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white">
                    </div>
                    <div class="flex items-center space-x-2 my-1">
                        <label for="endDate" class="text-sm font-medium text-gray-500">çµæŸæœˆä»½:</label>
                        <input type="month" id="endDate" class="border border-gray-600 rounded-md p-1.5 text-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white">
                    </div>
                </div>

                <!-- KPI å€å¡Š -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    ${renderKpiCard('ç¸½æ”¶å…¥ (å€é–“)', '<span id="totalRevenue">NT$ 0</span>', 'å€é–“ç¸½å’Œ', 'green')}
                    ${renderKpiCard('ç¸½æ¯›åˆ©', '<span id="grossProfit">NT$ 0</span>', 'æ·¨åˆ©æ½¤è¨ˆç®—', 'red')}
                    ${renderKpiCard('éŠ·è²¨æˆæœ¬', '<span id="totalCost">NT$ 0</span>', 'å€é–“ç¸½å’Œ', 'yellow')}
                </div>

                <!-- åœ–è¡¨å€å¡Š -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                    <!-- éŠ·è²¨æ”¶å…¥èˆ‡æˆæœ¬è¶¨å‹¢åœ– -->
                    <div class="col-span-1 lg:col-span-2 dashboard-card p-6">
                        <h3 class="text-xl font-semibold text-blue-300 mb-4 border-b border-gray-700 pb-2">éŠ·è²¨æ”¶å…¥èˆ‡æˆæœ¬è¶¨å‹¢åœ– (æœˆä»½)</h3>
                        <div class="h-80">
                            <canvas id="revenueCostChart"></canvas>
                        </div>
                    </div>

                    <!-- MDM ç‹€æ…‹åˆ†ä½ˆç”œç”œåœˆåœ– -->
                    <div class="col-span-1 lg:col-span-1 dashboard-card p-6">
                        <h3 class="text-xl font-semibold text-blue-300 mb-4 border-b border-gray-700 pb-2">MDM ç‹€æ…‹åˆ†ä½ˆ</h3>
                        <div class="h-80 flex items-center justify-center">
                            <canvas id="mdmDoughnutChart"></canvas>
                        </div>
                    </div>
                </div>
            `;

            setupAccountingAnalysisCharts();
        }


        const renderKpiCard = (title, value, trend, color) => `
            <div class="dashboard-card p-5 border-l-4 border-${color}-500">
                <p class="text-sm font-medium text-gray-400">${title}</p>
                <p class="text-3xl font-bold text-white mt-1">${value}</p>
                <div class="flex items-center mt-2">
                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-${color}-500/20 text-${color}-400">${trend}</span>
                </div>
            </div>
        `;

        // =========================================================
        // æ¨¡çµ„ 3: IGB ERP æ¡è³¼ (Procurement)
        // =========================================================

        /** æ¸²æŸ“å–®å€‹ PO é …ç›®çš„ HTML æ¨£å¼ */
        const renderPOItem = (supplier, item, quantity, price, status) => `
            <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition duration-150">
                <div class="flex-grow">
                    <p class="text-sm font-medium text-white">${item} (${supplier})</p>
                    <p class="text-xs text-gray-400">æ•¸é‡: ${quantity} x NT$ ${price.toLocaleString()} = NT$ ${(quantity * price).toLocaleString()}</p>
                </div>
                <span class="text-xs font-bold px-3 py-1 rounded-full bg-blue-500/20 text-blue-400">${status}</span>
                <button class="ml-4 text-green-400 hover:text-green-200 text-sm font-semibold">æ›´æ–°</button>
            </div>
        `;

        /** æ¸²æŸ“æ¡è³¼è¨‚å–®åˆ—è¡¨ */
        const renderPOList = (data) => {
            const listContainer = document.getElementById('po-list');
            const countElement = document.getElementById('po-count');

            if (!listContainer) return;

            if (countElement) countElement.textContent = data.length;

            listContainer.innerHTML = data.length === 0
                ? '<p class="text-gray-500 italic">ç›®å‰æ²’æœ‰æ¡è³¼è¨‚å–®è¨˜éŒ„ã€‚</p>'
                : data.map(item => {
                    return renderPOItem(item.supplier, item.item, item.quantity, item.price, item.status || 'å¾…ç™¼é€');
                }).join('');
        }

        /** æ¸²æŸ“æ¡è³¼æ¨¡çµ„ä¸»é«” */
        function renderProcurement(isRealtimeUpdate = false) {
            const content = document.getElementById('module-content');

            if (!isRealtimeUpdate) {
                content.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- å»ºç«‹ PO å€å¡Š -->
                        <div class="lg:col-span-1 dashboard-card p-6 h-fit">
                            <h3 class="text-xl font-semibold text-blue-300 mb-4 border-b border-gray-700 pb-2">å»ºç«‹æ¡è³¼è¨‚å–® (PO)</h3>
                            <form id="po-form" class="space-y-4">
                                <input type="text" id="supplier" placeholder="ä¾›æ‡‰å•†åç¨±" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-blue-500" required>
                                <input type="text" id="item" placeholder="æ¡è³¼é …ç›®/SKU" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-blue-500" required>
                                <input type="number" id="quantity" placeholder="æ•¸é‡" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-blue-500" required>
                                <input type="number" id="price" placeholder="å–®åƒ¹ (TWD)" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-blue-500" required>
                                <button type="submit" id="po-submit-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition duration-200">æäº¤ PO</button>
                            </form>
                        </div>

                        <!-- åº«å­˜è­¦å‘Šèˆ‡æœ€è¿‘è¨‚å–® -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- åº«å­˜è­¦å‘Š (ä¿æŒæ¨¡æ“¬æ•¸æ“š) -->
                            <div class="dashboard-card p-6">
                                <h3 class="text-xl font-semibold text-red-400 mb-4 border-b border-gray-700 pb-2">åº«å­˜é è­¦ (ä½æ–¼å®‰å…¨åº«å­˜)</h3>
                                <div class="space-y-3">
                                    ${renderInventoryItem('æ™¶ç‰‡çµ„ (A-100)', 45, 100, 'red')}
                                    ${renderInventoryItem('ä¸»æ©Ÿæ¿ (B-200)', 80, 100, 'red')}
                                    ${renderInventoryItem('è¨˜æ†¶é«”æ¨¡çµ„', 250, 200, 'green')}
                                </div>
                            </div>

                            <!-- æœ€è¿‘ PO (å¯¦æ™‚æ›´æ–°å€å¡Š) -->
                            <div class="dashboard-card p-6">
                                <h3 class="text-xl font-semibold text-blue-300 mb-4 border-b border-gray-700 pb-2">æœ€è¿‘æ¡è³¼è¨‚å–® (<span id="po-count">0</span> ç­†)</h3>
                                <div id="po-list" class="space-y-3">
                                    <!-- æ¡è³¼è¨‚å–®åˆ—è¡¨å°‡è¢«å¯¦æ™‚æ›´æ–° -->
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('po-form').onsubmit = handlePOFormSubmission;
                updateSubmitButtonState('po-submit-btn'); // ç¢ºä¿æ¸²æŸ“æ™‚æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            }

            // å¯¦æ™‚æ›´æ–°æ¡è³¼åˆ—è¡¨
            renderPOList(purchaseOrders);
        }

        const renderInventoryItem = (item, current, safety, color) => `
            <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg">
                <p class="text-sm font-medium text-white">${item}</p>
                <div class="flex space-x-4 items-center">
                    <span class="text-xs text-gray-400">ç›®å‰: ${current} / å®‰å…¨åº«å­˜: ${safety}</span>
                    <span class="text-xs font-bold px-2 py-0.5 rounded-full bg-${color}-500/20 text-${color}-400">${current < safety ? 'éœ€è£œè²¨' : 'å……è¶³'}</span>
                </div>
            </div>
        `;

        const handlePOFormSubmission = async (e) => {
            e.preventDefault();

            // å¢å¼·æ—¥èªŒæª¢æŸ¥
            console.log(`%c[Submission Check - PO] isAuthReady: ${isAuthReady}, currentUserId: ${currentUserId}`, 'color: yellow; font-weight: bold;');


            if (!isAuthReady) {
                logError('æ‡‰ç”¨ç¨‹å¼ä»åœ¨åˆå§‹åŒ–ä¸­ï¼Œè«‹ç¨å€™å†æäº¤ã€‚');
                return;
            }
            if (!currentUserId) {
                logError('éŒ¯èª¤ï¼šç”¨æˆ¶èº«ä»½æœªç¢ºå®š (User ID is null)ï¼Œç„¡æ³•æäº¤ã€‚');
                return;
            }

            const supplier = document.getElementById('supplier').value;
            const item = document.getElementById('item').value;
            const quantity = document.getElementById('quantity').value;
            const price = document.getElementById('price').value;

            try {
                const total = parseInt(quantity) * parseFloat(price);
                const path = `artifacts/${appId}/users/${currentUserId}/purchase_orders`;
                await addDoc(collection(db, path), {
                    supplier, item, quantity: parseInt(quantity), price: parseFloat(price), total: total, status: 'å¾…ç™¼é€', created: Date.now()
                });
                customAlert(`PO [${item}] å·²å»ºç«‹ï¼Œç¸½è¨ˆ NT$ ${total.toLocaleString()}ã€‚`, 'blue');
                document.getElementById('po-form').reset();
            } catch (error) {
                console.error("PO æäº¤å¤±æ•—:", error);
                logError(`PO æäº¤å¤±æ•—: ${error.message}. è«‹æª¢æŸ¥æ‚¨çš„ Firestore å¯«å…¥æ¬Šé™ã€‚`);
            }
        };

        // =========================================================
        // æ¨¡çµ„ 4: è²¡å‹™è¿½è¹¤å™¨ (Finance Tracker)
        // =========================================================

        /** æ¸²æŸ“å–®å€‹äº¤æ˜“é …ç›®çš„ HTML æ¨£å¼ */
        const renderTransactionItem = (type, desc, amount, date, color) => `
            <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg">
                <div class="flex items-center space-x-3">
                    <span class="text-xl text-${color}-400">${type === 'æ”¶å…¥' ? 'â¬†ï¸' : 'â¬‡ï¸'}</span>
                    <div class="flex-grow">
                        <p class="text-sm font-medium text-white">${desc}</p>
                        <p class="text-xs text-gray-400">${date}</p>
                    </div>
                </div>
                <span class="text-base font-bold text-${color}-400">${type === 'æ”¶å…¥' ? '+' : '-'} NT$ ${amount.toLocaleString()}</span>
            </div>
        `;

        /** æ¸²æŸ“äº¤æ˜“åˆ—è¡¨ */
        const renderTransactionList = (data) => {
            const listContainer = document.getElementById('transaction-list');
            const countElement = document.getElementById('transaction-count');

            if (!listContainer) return;

            if (countElement) countElement.textContent = data.length;

            listContainer.innerHTML = data.length === 0
                ? '<p class="text-gray-500 italic">ç›®å‰æ²’æœ‰äº¤æ˜“è¨˜éŒ„ã€‚</p>'
                : data.map(item => {
                    const color = item.type === 'æ”¶å…¥' ? 'green' : 'red';
                    const date = new Date(item.recordedAt).toLocaleDateString('zh-TW');
                    return renderTransactionItem(item.type, item.description, item.amount, date, color);
                }).join('');
        }

        /** æ¸²æŸ“è²¡å‹™è¿½è¹¤å™¨ä¸»é«” */
        function renderFinanceTracker(isRealtimeUpdate = false) {
            const content = document.getElementById('module-content');

            if (!isRealtimeUpdate) {
                content.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${renderBalanceCard('æœ¬æœˆç¸½æ”¶å…¥', 850000, 'green')}
                        ${renderBalanceCard('æœ¬æœˆç¸½æ”¯å‡º', 420000, 'red')}
                    </div>

                    <div class="dashboard-card p-6 mt-6">
                        <h3 class="text-xl font-semibold text-blue-300 mb-4 border-b border-gray-700 pb-2">æ–°å¢äº¤æ˜“è¨˜éŒ„</h3>
                        <form id="finance-form" class="space-y-4">
                            <select id="type" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-blue-500" required>
                                <option value="æ”¶å…¥">æ”¶å…¥</option>
                                <option value="æ”¯å‡º">æ”¯å‡º</option>
                            </select>
                            <input type="text" id="description" placeholder="æè¿° (e.g. è–ªè³‡å…¥å¸³, è¾¦å…¬ç”¨å“)" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-blue-500" required>
                            <input type="number" id="amount" placeholder="é‡‘é¡ (TWD)" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-blue-500" required>
                            <button type="submit" id="finance-submit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 rounded-lg transition duration-200">è¨˜éŒ„äº¤æ˜“</button>
                        </form>
                    </div>

                    <div class="dashboard-card p-6 mt-6">
                        <h3 class="text-xl font-semibold text-blue-300 mb-4 border-b border-gray-700 pb-2">æœ€è¿‘äº¤æ˜“ (<span id="transaction-count">0</span> ç­†)</h3>
                        <div id="transaction-list" class="space-y-2">
                            <!-- äº¤æ˜“åˆ—è¡¨å°‡è¢«å¯¦æ™‚æ›´æ–° -->
                        </div>
                    </div>
                `;
                document.getElementById('finance-form').onsubmit = handleFinanceFormSubmission;
                updateSubmitButtonState('finance-submit-btn'); // ç¢ºä¿æ¸²æŸ“æ™‚æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            }

            // å¯¦æ™‚æ›´æ–°äº¤æ˜“åˆ—è¡¨
            renderTransactionList(transactions);
        }

        const renderBalanceCard = (title, amount, color) => `
            <div class="dashboard-card p-5 border-b-4 border-${color}-500">
                <p class="text-sm font-medium text-gray-400">${title}</p>
                <p class="text-3xl font-bold text-white mt-1 text-${color}-400">NT$ ${amount.toLocaleString()}</p>
            </div>
        `;

        const handleFinanceFormSubmission = async (e) => {
            e.preventDefault();

            // å¢å¼·æ—¥èªŒæª¢æŸ¥
            console.log(`%c[Submission Check - Finance] isAuthReady: ${isAuthReady}, currentUserId: ${currentUserId}`, 'color: yellow; font-weight: bold;');


            if (!isAuthReady) {
                logError('æ‡‰ç”¨ç¨‹å¼ä»åœ¨åˆå§‹åŒ–ä¸­ï¼Œè«‹ç¨å€™å†æäº¤ã€‚');
                return;
            }
            if (!currentUserId) {
                logError('éŒ¯èª¤ï¼šç”¨æˆ¶èº«ä»½æœªç¢ºå®š (User ID is null)ï¼Œç„¡æ³•æäº¤ã€‚');
                return;
            }

            const type = document.getElementById('type').value;
            const description = document.getElementById('description').value;
            const amount = document.getElementById('amount').value;

            try {
                const path = `artifacts/${appId}/users/${currentUserId}/transactions`;
                await addDoc(collection(db, path), {
                    type, description, amount: parseFloat(amount), recordedAt: Date.now()
                });
                customAlert(`æˆåŠŸè¨˜éŒ„ä¸€ç­† ${type} äº¤æ˜“ï¼šNT$ ${parseFloat(amount).toLocaleString()}ã€‚`, 'indigo');
                document.getElementById('finance-form').reset();
            } catch (error) {
                console.error("äº¤æ˜“è¨˜éŒ„å¤±æ•—:", error);
                logError(`äº¤æ˜“è¨˜éŒ„å¤±æ•—: ${error.message}. è«‹æª¢æŸ¥æ‚¨çš„ Firestore å¯«å…¥æ¬Šé™ã€‚`);
            }
        };

        // =========================================================
        // é€šç”¨ UI å‡½æ•¸ (å–ä»£ alert å’Œ confirm)
        // =========================================================

        // æ¨¡æ…‹æ¡†/é€šçŸ¥
        const customAlert = (message, color = 'blue') => {
            const bgColorMap = { 'blue': 'bg-blue-600', 'green': 'bg-green-600', 'red': 'bg-red-600', 'indigo': 'bg-indigo-600' };
            const bgColor = bgColorMap[color] || bgColorMap['blue'];

            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed bottom-4 right-4 z-[60] ${bgColor} text-white p-4 rounded-xl shadow-2xl transition-opacity duration-300 transform translate-y-0 opacity-100`;
            alertDiv.textContent = message;

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.style.opacity = '0';
                alertDiv.style.transform = 'translateY(20px)';
                setTimeout(() => alertDiv.remove(), 300);
            }, 3000);
        };

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        window.onload = () => {
            initializeAuth(); // ç¢ºä¿èªè­‰åœ¨æ‰€æœ‰å…§å®¹æ¸²æŸ“å‰å•Ÿå‹•
            renderNavigation();

            // ã€ä¿®å¾©ã€‘æ˜ç¢ºå‘¼å« renderModule ä»¥ç¢ºä¿å…§å®¹å€åŸŸé¡¯ç¤º
            const initialModule = window.location.hash ? window.location.hash.substring(1) : 'Home';
            renderModule(initialModule);

            updateAllSubmitButtons(); // åˆå§‹åŒ–æ™‚ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
        };

    </script>
</body>
</html>
