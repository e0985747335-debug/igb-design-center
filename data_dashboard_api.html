<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGB ERP æ•¸æ“šå„€è¡¨æ¿ (å«æ¨¡æ“¬ API)</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Chart.js ç”¨æ–¼åœ–è¡¨ç¹ªè£½ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* ä½¿ç”¨ Inter ä½œç‚ºä¸»è¦å­—é«” */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .data-card {
            transition: all 0.3s ease;
            transform: translateY(0);
        }
        .data-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        .spinner {
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- ä¸»å„€è¡¨æ¿å®¹å™¨ -->
    <div id="app-container" class="max-w-7xl mx-auto p-4 md:p-8">
        <header class="mb-8 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-gray-900">IGB ç‡Ÿé‹æ•ˆç‡å„€è¡¨æ¿</h1>
            <p class="text-gray-500 mt-1">å³æ™‚åˆ†æè¨‚å–®ã€åº«å­˜èˆ‡å‡ºè²¨è¡¨ç¾</p>
        </header>

        <!-- æ•¸æ“š API é…ç½®å€å¡Š -->
        <div class="bg-indigo-50 p-4 rounded-xl shadow-inner mb-8 border-l-4 border-indigo-500">
            <h3 class="text-lg font-bold text-indigo-800 mb-2 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h3.28a1 1 0 01.76.34L11 6h2a2 2 0 012 2v1H6a2 2 0 00-2 2v7a2 2 0 01-2-2V4zm10.707 5.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L10 12.586l3.293-3.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
                API é€£ç·šé…ç½® (IT å°ˆç”¨)
            </h3>
            <p class="text-sm text-indigo-700">
                <span class="font-semibold">ç•¶å‰æ¨¡å¼:</span> <span id="current-mode">æ¨¡æ“¬æ•¸æ“š</span>
            </p>
            <p class="text-xs text-indigo-600 font-mono break-all mt-1">
                ERP_API_ENDPOINT: <span id="api-endpoint-display">/api/v1/erp-data</span>
            </p>
        </div>

        <!-- æ•¸æ“šç¸½è¦½å¡ç‰‡ -->
        <div id="kpi-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- å¡ç‰‡ 1: å¾…è™•ç†è¨‚å–®ç¸½é‡ -->
            <div class="data-card bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-100 p-2 rounded-full text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">å¾…è™•ç†è¨‚å–®ç¸½é‡</p>
                        <p id="kpi-orders" class="text-2xl font-bold text-gray-900">
                            <span class="spinner w-6 h-6 border-4 border-gray-200"></span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- å¡ç‰‡ 2: ç¸½åº«å­˜åƒ¹å€¼ -->
            <div class="data-card bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <div class="flex items-center space-x-3">
                    <div class="bg-green-100 p-2 rounded-full text-green-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">ç¸½åº«å­˜åƒ¹å€¼ (NTD)</p>
                        <p id="kpi-inventory" class="text-2xl font-bold text-gray-900">
                            <span class="spinner w-6 h-6 border-4 border-gray-200"></span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- å¡ç‰‡ 3: å‡ºè²¨æº–æ™‚ç‡ (æœ€æ–°) -->
            <div class="data-card bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <div class="flex items-center space-x-3">
                    <div class="bg-yellow-100 p-2 rounded-full text-yellow-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">å‡ºè²¨æº–æ™‚ç‡ (æœ€æ–°)</p>
                        <p id="kpi-shipment" class="text-2xl font-bold text-gray-900">
                            <span class="spinner w-6 h-6 border-4 border-gray-200"></span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- å¡ç‰‡ 4: æ´»èºéƒ¨é–€ -->
            <div class="data-card bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <div class="flex items-center space-x-3">
                    <div class="bg-red-100 p-2 rounded-full text-red-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-3H17v3zM6 19h5v-2H6v2zM12 11h5V8H12v3zM3 13h5V6H3v7zM15 5h5V2h-5v3zM6 9h5V2H6v7z" /></svg>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">æœ€è¿‘æ´»èºéƒ¨é–€</p>
                        <p id="kpi-department" class="text-2xl font-bold text-gray-900">
                            <span class="spinner w-6 h-6 border-4 border-gray-200"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- åœ–è¡¨å€åŸŸ: èª¿æ•´ç‚º 3 æ¬„ä½ˆå±€ -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">

            <!-- åœ–è¡¨ 1: å¾…è™•ç†è¨‚å–®è¶¨å‹¢ -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 h-[450px]">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">å¾…è™•ç†è¨‚å–®è¶¨å‹¢ (ç·šåœ–)</h3>
                <canvas id="ordersChart" class="w-full h-full"></canvas>
                <div id="orders-loading" class="text-center py-12 text-gray-500 hidden">æ•¸æ“šåŠ è¼‰ä¸­...</div>
            </div>

            <!-- åœ–è¡¨ 2: åº«å­˜åƒ¹å€¼èˆ‡å‡ºè²¨æº–æ™‚ç‡æ¯”è¼ƒ -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 h-[450px]">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">åº«å­˜åƒ¹å€¼èˆ‡å‡ºè²¨æº–æ™‚ç‡ (è¤‡åˆåœ–)</h3>
                <canvas id="inventoryShipmentChart" class="w-full h-full"></canvas>
                <div id="inventory-loading" class="text-center py-12 text-gray-500 hidden">æ•¸æ“šåŠ è¼‰ä¸­...</div>
            </div>

            <!-- æ–°å¢åœ–è¡¨ 3: æ´»èºéƒ¨é–€åˆ†ä½ˆ -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 h-[450px] md:col-span-2 xl:col-span-1">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">æ´»èºéƒ¨é–€åˆ†ä½ˆ (æœ€è¿‘ 30 å¤©)</h3>
                <div class="h-full flex items-center justify-center -mt-10">
                    <canvas id="departmentChart" class="w-full max-h-[350px]"></canvas>
                </div>
                <div id="department-loading" class="text-center py-12 text-gray-500 hidden">æ•¸æ“šåŠ è¼‰ä¸­...</div>
            </div>

        </div>

    </div>

    <script>
        // ====================================================================
        // é…ç½®å€å¡Š (IT åœ˜éšŠå°ˆæ³¨æ–¼æ­¤)
        // ====================================================================

        // ğŸš¨ é€™æ˜¯æ‚¨çš„ IT åœ˜éšŠéœ€è¦æ›¿æ›çš„çœŸå¯¦ API ç«¯é» URL
        const ERP_API_ENDPOINT = 'http://your.erp.system/api/v1/erp-data';

        // ğŸš¨ å°‡æ­¤è¨­å®šç‚º false å³å¯åˆ‡æ›åˆ°çœŸå¯¦ API æ•¸æ“š
        const USE_MOCK_DATA = true;

        // æ¨¡æ“¬æ•¸æ“šåŠ è¼‰å»¶é² (æ¯«ç§’)
        const MOCK_DELAY_MS = 1500;

        // éƒ¨é–€åç¨±å°æ‡‰
        const deptMap = {
            'production': 'ç”Ÿç”¢è£½é€ ',
            'logistics': 'ç‰©æµå€‰å„²',
            'finance': 'è²¡å‹™æœƒè¨ˆ',
            '': 'æœªçŸ¥éƒ¨é–€'
        };


        // ====================================================================
        // è¼”åŠ©å‡½æ•¸
        // ====================================================================

        /**
         * æ¨¡æ“¬å¾Œç«¯å»¶é²ï¼Œä¸¦æ ¹æ“šè¦æ ¼è¿”å›æ¨¡æ“¬æ•¸æ“šã€‚
         */
        function fetchMockData() {
            // æ¨¡æ“¬ä¸€å€‹æœˆ (30 å¤©) çš„æ•¸æ“š
            const mockData = [];
            const departments = ['production', 'logistics', 'finance'];
            const today = new Date('2025-10-26'); // å‡è¨­é€™æ˜¯æœ€å¾Œä¸€å€‹æ•¸æ“šé»

            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateString = date.toISOString().slice(0, 10);

                const baseOrders = 500;
                const baseInventory = 800000;

                // è®“ production å’Œ logistics æ›´æ´»èºä¸€é»
                let department;
                const randomVal = Math.random();
                if (randomVal < 0.45) {
                    department = 'production';
                } else if (randomVal < 0.9) {
                    department = 'logistics';
                } else {
                    department = 'finance';
                }


                mockData.push({
                    date: dateString,
                    orders: Math.floor(baseOrders + Math.random() * 200 - 100), // 400-600
                    inventory_value: Math.floor(baseInventory + Math.random() * 100000 - 50000), // 75è¬-85è¬
                    shipment_rate: parseFloat((0.85 + Math.random() * 0.15).toFixed(2)), // 0.85-1.00
                    department: department
                });
            }

            return new Promise((resolve) => {
                setTimeout(() => resolve(mockData), MOCK_DELAY_MS);
            });
        }

        /**
         * åŸ·è¡Œ API è«‹æ±‚æˆ–æ¨¡æ“¬è«‹æ±‚ã€‚
         * @returns {Promise<Array>} è¿”å›ç¬¦åˆè¦æ ¼çš„æ•¸æ“šé™£åˆ—ã€‚
         */
        async function fetchERPData() {
            if (USE_MOCK_DATA) {
                console.log("[Data Load] æ­£åœ¨ä½¿ç”¨æ¨¡æ“¬æ•¸æ“š...");
                document.getElementById('current-mode').textContent = 'æ¨¡æ“¬æ•¸æ“š (å»¶é² ' + MOCK_DELAY_MS + 'ms)';
                return fetchMockData();
            }

            // å¯¦éš› API å‘¼å«é‚è¼¯ (å‡è¨­ç‚º GET è«‹æ±‚)
            document.getElementById('current-mode').textContent = 'çœŸå¯¦ API é€£ç·š';
            try {
                const response = await fetch(ERP_API_ENDPOINT);
                if (!response.ok) {
                    throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.statusText}`);
                }
                const data = await response.json();
                console.log("[Data Load] æˆåŠŸå¾ API è¼‰å…¥çœŸå¯¦æ•¸æ“šã€‚", data);
                return data;
            } catch (error) {
                console.error("[Data Load] ç²å–çœŸå¯¦æ•¸æ“šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API ç«¯é»å’Œç¶²è·¯:", error);
                throw new Error("æ•¸æ“šåŠ è¼‰å¤±æ•—ã€‚è«‹æª¢æŸ¥é€£ç·šã€‚");
            }
        }

        /**
         * æ›´æ–°å„€è¡¨æ¿å·¦ä¸Šæ–¹çš„ KPI ç¸½çµæ•¸æ“šã€‚
         * @param {Array} data - è™•ç†å¾Œçš„æ•¸æ“šé™£åˆ—ã€‚
         */
        function updateKPIs(data) {
            if (data.length === 0) return;

            // æœ€æ–°æ•¸æ“šé»
            const latestData = data[data.length - 1];

            // å¾…è™•ç†è¨‚å–®ç¸½é‡ (å–æœ€å¾Œä¸ƒå¤©ç¸½å’Œ)
            const recentOrders = data.slice(-7).map(d => d.orders);
            const totalOrders = recentOrders.reduce((sum, val) => sum + val, 0);

            // ç¸½åº«å­˜åƒ¹å€¼ (å–æœ€æ–°å€¼)
            const inventoryValue = latestData.inventory_value;

            // å‡ºè²¨æº–æ™‚ç‡ (å–æœ€æ–°å€¼)
            const shipmentRate = latestData.shipment_rate;

            // æœ€è¿‘æ´»èºéƒ¨é–€
            const department = latestData.department;


            document.getElementById('kpi-orders').textContent = totalOrders.toLocaleString('zh-TW');
            document.getElementById('kpi-inventory').textContent = Math.floor(inventoryValue).toLocaleString('zh-TW', {
                style: 'currency',
                currency: 'TWD',
                minimumFractionDigits: 0
            }).replace('NT$', 'NTD '); // èª¿æ•´è²¨å¹£ç¬¦è™Ÿé¡¯ç¤º

            document.getElementById('kpi-shipment').textContent = (shipmentRate * 100).toFixed(1) + '%';

            document.getElementById('kpi-department').textContent = deptMap[department] || department;

            // ç§»é™¤åŠ è¼‰ Spinner
            document.querySelectorAll('#kpi-cards .spinner').forEach(s => s.remove());
        }

        // ====================================================================
        // åœ–è¡¨æ¸²æŸ“
        // ====================================================================

        let ordersChartInstance = null;
        let inventoryShipmentChartInstance = null;
        let departmentChartInstance = null; // æ–°å¢åœ–è¡¨å¯¦ä¾‹

        /**
         * æ¸²æŸ“è¨‚å–®è¶¨å‹¢åœ–è¡¨ã€‚
         * @param {Array} data - è™•ç†å¾Œçš„æ•¸æ“šé™£åˆ—ã€‚
         */
        function renderOrdersChart(data) {
            const labels = data.map(d => d.date.substring(5)); // é¡¯ç¤ºæœˆä»½å’Œæ—¥æœŸ (MM-DD)
            const orders = data.map(d => d.orders);

            if (ordersChartInstance) ordersChartInstance.destroy();

            const ctx = document.getElementById('ordersChart').getContext('2d');
            ordersChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å¾…è™•ç†è¨‚å–®é‡',
                        data: orders,
                        borderColor: '#4f46e5', // Indigo-600
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'è¨‚å–®æ•¸é‡ (ä»¶)'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    }
                }
            });
            document.getElementById('orders-loading').classList.add('hidden');
        }

        /**
         * æ¸²æŸ“åº«å­˜åƒ¹å€¼èˆ‡å‡ºè²¨æº–æ™‚ç‡çš„æ··åˆåœ–è¡¨ã€‚
         * @param {Array} data - è™•ç†å¾Œçš„æ•¸æ“šé™£åˆ—ã€‚
         */
        function renderInventoryShipmentChart(data) {
            const labels = data.map(d => d.date.substring(5));
            const inventoryValues = data.map(d => d.inventory_value);
            const shipmentRates = data.map(d => d.shipment_rate);

            if (inventoryShipmentChartInstance) inventoryShipmentChartInstance.destroy();

            const ctx = document.getElementById('inventoryShipmentChart').getContext('2d');
            inventoryShipmentChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ç¸½åº«å­˜åƒ¹å€¼ (NTD)',
                            data: inventoryValues,
                            backgroundColor: 'rgba(220, 38, 38, 0.8)', // Red-600
                            yAxisID: 'y1',
                        },
                        {
                            label: 'å‡ºè²¨æº–æ™‚ç‡ (%)',
                            data: shipmentRates.map(r => r * 100),
                            type: 'line',
                            borderColor: '#059669', // Emerald-600
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            tension: 0.4,
                            yAxisID: 'y2',
                            pointRadius: 5,
                            pointBackgroundColor: '#059669',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y1: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'åº«å­˜åƒ¹å€¼ (NTD)' },
                            grid: { drawOnChartArea: true },
                            ticks: {
                                callback: function(value) { return value.toLocaleString('zh-TW', { notation: 'compact', compactDisplay: 'short' }); }
                            }
                        },
                        y2: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'æº–æ™‚ç‡ (%)' },
                            min: 0,
                            max: 100,
                            grid: { drawOnChartArea: false },
                            ticks: {
                                callback: function(value) { return value + '%'; }
                            }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.yAxisID === 'y2') {
                                        label += context.parsed.y.toFixed(1) + '%';
                                    } else {
                                        label += context.parsed.y.toLocaleString('zh-TW');
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            document.getElementById('inventory-loading').classList.add('hidden');
        }

        /**
         * æ¸²æŸ“æ´»èºéƒ¨é–€åˆ†ä½ˆç”œç”œåœˆåœ–ã€‚
         * @param {Array} data - è™•ç†å¾Œçš„æ•¸æ“šé™£åˆ—ã€‚
         */
        function renderDepartmentDistributionChart(data) {
            // 1. è¨ˆç®—éƒ¨é–€æ´»å‹•æ¬¡æ•¸
            const departmentCounts = data.reduce((acc, item) => {
                const dept = item.department;
                acc[dept] = (acc[dept] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(departmentCounts).map(key => deptMap[key] || key);
            const counts = Object.values(departmentCounts);

            if (departmentChartInstance) departmentChartInstance.destroy();

            const ctx = document.getElementById('departmentChart').getContext('2d');
            departmentChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: [
                            '#3b82f6', // è—è‰² (Blue-500) - Production
                            '#10b981', // ç¶ è‰² (Emerald-500) - Logistics
                            '#f59e0b', // é»ƒè‰² (Amber-500) - Finance
                            '#ef4444'  // ç´…è‰² (Red-500) - Unknown
                        ],
                        hoverOffset: 15,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%', // ç”œç”œåœˆçš„åšåº¦
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = counts.reduce((a, b) => a + b, 0);
                                    const value = context.parsed;
                                    const percentage = ((value / total) * 100).toFixed(1) + '%';
                                    return `${context.label}: ${value} æ¬¡ (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });
            document.getElementById('department-loading').classList.add('hidden');
        }


        // ====================================================================
        // æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–
        // ====================================================================

        /**
         * å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ä¸¦åŠ è¼‰æ•¸æ“šã€‚
         */
        async function initApp() {
            // é¡¯ç¤ºé…ç½®ä¿¡æ¯
            document.getElementById('api-endpoint-display').textContent = ERP_API_ENDPOINT;

            // é¡¯ç¤ºåœ–è¡¨åŠ è¼‰ç‹€æ…‹
            document.getElementById('orders-loading').classList.remove('hidden');
            document.getElementById('inventory-loading').classList.remove('hidden');
            document.getElementById('department-loading').classList.remove('hidden'); // æ–°å¢åŠ è¼‰ç‹€æ…‹

            try {
                // 1. ç²å–æ•¸æ“š (çœŸå¯¦ API æˆ–æ¨¡æ“¬)
                const rawData = await fetchERPData();

                // 2. é©—è­‰æ•¸æ“šçµæ§‹
                if (!Array.isArray(rawData) || rawData.length === 0) {
                    throw new Error("API è¿”å›çš„æ•¸æ“šç„¡æ•ˆæˆ–ç‚ºç©ºã€‚");
                }

                // 3. æ’åºæ•¸æ“š (ç¢ºä¿æ˜¯æŒ‰æ—¥æœŸå‡åº)
                rawData.sort((a, b) => new Date(a.date) - new Date(b.date));

                // 4. æ›´æ–° KPI ç¸½çµ
                updateKPIs(rawData);

                // 5. æ¸²æŸ“åœ–è¡¨
                renderOrdersChart(rawData);
                renderInventoryShipmentChart(rawData);
                renderDepartmentDistributionChart(rawData); // æ¸²æŸ“æ–°çš„ç”œç”œåœˆåœ–

            } catch (error) {
                console.error("å„€è¡¨æ¿å•Ÿå‹•å¤±æ•—:", error);
                // åœ¨ UI ä¸Šé¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
                document.getElementById('kpi-cards').innerHTML = `<div class="col-span-4 bg-red-100 p-4 rounded-xl text-red-800 font-semibold shadow-lg border border-red-200">âŒ æ•¸æ“šåŠ è¼‰éŒ¯èª¤: ${error.message}</div>`;
                document.getElementById('orders-loading').innerHTML = 'âŒ åœ–è¡¨æ•¸æ“šåŠ è¼‰å¤±æ•—';
                document.getElementById('inventory-loading').innerHTML = 'âŒ åœ–è¡¨æ•¸æ“šåŠ è¼‰å¤±æ•—';
                document.getElementById('department-loading').innerHTML = 'âŒ åœ–è¡¨æ•¸æ“šåŠ è¼‰å¤±æ•—';
            }
        }

        // é é¢åŠ è¼‰å®Œæˆå¾Œå•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        window.onload = initApp;
    </script>
</body>
</html>
