<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘ç›®é¤˜é¡è¶¨å‹¢åˆ†æ</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Chart.js for charting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- å¼•å…¥ Inter å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* è‡ªå®šç¾©æ¨£å¼ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* æ·±è‰²èƒŒæ™¯ */
            color: #e5e7eb; /* æ·ºç°æ–‡æœ¬ */
            padding: 20px;
        }

        /* å®¹å™¨æ¨£å¼ */
        .report-container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            background-color: #161b22; /* å¡ç‰‡èƒŒæ™¯ */
            border: 1px solid #30363d;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
        }

        /* Chart.js çš„å®¹å™¨ï¼Œç¢ºä¿éŸ¿æ‡‰å¼ */
        .chart-wrapper {
            position: relative;
            height: 400px; /* å›ºå®šé«˜åº¦ä»¥ä¿æŒåœ–è¡¨è¦–è¦ºç©©å®šæ€§ */
            width: 100%;
        }

        /* è¡¨æ ¼æ¨£å¼ */
        .data-table th, .data-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #2d333b;
        }

        .data-table th:first-child, .data-table td:first-child {
            text-align: left;
        }

        .data-table th {
            background-color: #1f252c;
            color: #9ca3af;
        }

        /* è¡¨å–®æ§åˆ¶é …æ¨£å¼ */
        .input-control {
            background-color: #0d1117;
            border: 1px solid #30363d;
            color: #e5e7eb;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            transition: border-color 0.2s;
        }
        .input-control:focus {
            border-color: #3b82f6;
            outline: none;
        }
        /* é‡å° select ä¸‹æ‹‰é¸å–®åœ¨æ·±è‰²ä¸»é¡Œä¸‹çš„ç®­é ­é¡è‰²èª¿æ•´ï¼Œä»¥æé«˜å¯è¦‹æ€§ */
        select.input-control {
            appearance: none; /* ç§»é™¤ç€è¦½å™¨é è¨­æ¨£å¼ */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%239ca3af'%3E%3Cpath fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 10.99l3.71-3.76a.75.75 0 111.08 1.04l-4.25 4.38a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem; /* ç‚ºç®­é ­ç•™å‡ºç©ºé–“ */
        }
    </style>
</head>
<body>

    <div class="report-container rounded-lg p-4 sm:p-8">

        <header class="mb-8 border-b pb-4 border-gray-700">
            <h1 class="text-3xl font-bold text-blue-400">ç§‘ç›®é¤˜é¡è¶¨å‹¢åˆ†æ</h1>
        </header>

        <!-- åˆ†ææ¢ä»¶è¨­å®šå€å¡Š -->
        <section class="mb-10 p-4 border border-gray-700 rounded-lg bg-[#0d1117]">
            <h2 class="text-xl font-semibold mb-4 text-white">åˆ†ææ¢ä»¶è¨­å®š - åˆ†æ”¶å…¥åŠæ”¯å‡º</h2>

            <!-- é¸é …å€å¡Š -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end">

                <!-- æ”¶å…¥/è³‡ç”¢/æˆæœ¬/è²»ç”¨ (ä¸»è¦ç§‘ç›®) é¸æ“‡ - å·²èª¿æ•´ç‚ºæ›´ç¬¦åˆ ERP è¦æ ¼çš„æœƒè¨ˆç§‘ç›®è¡¨çµæ§‹ -->
                <div class="flex flex-col">
                    <label for="income-select" class="text-sm font-medium mb-1 text-gray-400">ä¸»è¦æœƒè¨ˆç§‘ç›® (è³‡ç”¢/æ”¶ç›Š/æˆæœ¬/è²»ç”¨)</label>
                    <select id="income-select" onchange="handleSelectionChange('income')" class="input-control">
                        <option value="" disabled selected>è«‹é¸æ“‡ä¸»è¦ç§‘ç›®</option>

                        <!-- I. è³‡ç”¢ç§‘ç›® (Assets) - 1XXX é–‹é ­ -->
                        <optgroup label="I. è³‡ç”¢ç§‘ç›® (Assets)">
                            <option value="1001 - ç¾é‡‘">1001 - ç¾é‡‘</option>
                            <option value="1201 - æ‡‰æ”¶å¸³æ¬¾">1201 - æ‡‰æ”¶å¸³æ¬¾</option>
                            <option value="1501 - å­˜è²¨">1501 - å­˜è²¨</option>
                        </optgroup>

                        <!-- II. æ”¶å…¥/æ”¶ç›Šç§‘ç›® (Revenue/Income) - 4XXX é–‹é ­ -->
                        <optgroup label="II. æ”¶å…¥/æ”¶ç›Šç§‘ç›® (Revenue/Income) - 4XXX">
                            <option value="4101 - éŠ·è²¨æ”¶å…¥">4101 - éŠ·è²¨æ”¶å…¥ (ä¸»è¦æ¥­å‹™)</option>
                            <option value="4201 - å‹å‹™æ”¶å…¥">4201 - å‹å‹™æ”¶å…¥ (æœå‹™é¡)</option>
                            <option value="4301 - åˆ©æ¯æ”¶å…¥">4301 - åˆ©æ¯æ”¶å…¥ (éç‡Ÿæ¥­)</option>
                            <option value="4401 - ç§Ÿè³ƒæ”¶å…¥">4401 - ç§Ÿè³ƒæ”¶å…¥</option>
                            <option value="4999 - å…¶ä»–ç‡Ÿæ¥­å¤–æ”¶å…¥">4999 - å…¶ä»–ç‡Ÿæ¥­å¤–æ”¶å…¥</option>
                        </optgroup>

                        <!-- III. æˆæœ¬/è²»ç”¨å¤§é¡ (Costs/Expenses) - 5/6XXX é–‹é ­ -->
                        <optgroup label="III. æˆæœ¬/è²»ç”¨å¤§é¡ (Costs/Expenses) - 5/6XXX">
                            <option value="5001 - éŠ·è²¨æˆæœ¬">5001 - éŠ·è²¨æˆæœ¬ (COGS)</option>
                            <option value="6001 - éŠ·å”®è²»ç”¨">6001 - éŠ·å”®è²»ç”¨</option>
                            <option value="6201 - ç®¡ç†è²»ç”¨">6201 - ç®¡ç†è²»ç”¨</option>
                        </optgroup>
                    </select>
                </div>

                <!-- è²»ç”¨ç§‘ç›®é¸æ“‡ (åŒ…å«æ‰€æœ‰ç´°é …) -->
                <div class="flex flex-col">
                    <label for="expense-select" class="text-sm font-medium mb-1 text-gray-400">è²»ç”¨ç§‘ç›®ç´°é …</label>
                    <select id="expense-select" onchange="handleSelectionChange('expense')" class="input-control">
                        <option value="" disabled selected>è«‹é¸æ“‡è²»ç”¨é¡åˆ¥</option>

                        <!-- ğŸ’¼ æ—…è²»åŠäº¤é€šè²» (Travel & Transport) - å¢åŠ ç´°é … -->
                        <optgroup label="ğŸ’¼ æ—…è²»åŠäº¤é€šè²» (Travel & Transport)">
                            <option value="åœ‹å…§å·®æ—…è²»">åœ‹å…§å·®æ—…è²» (Domestic)</option>
                            <option value="åœ‹å¤–å·®æ—…è²»">åœ‹å¤–å·®æ—…è²» (International)</option>
                            <option value="å¸‚å€äº¤é€šè²»">å¸‚å€äº¤é€šè²» (Local Transit)</option>
                            <option value="é«˜éµ/ç«è»Šç¥¨">é«˜éµ/ç«è»Šç¥¨ (Rail Fare)</option>
                            <option value="æ©Ÿç¥¨è²»ç”¨">æ©Ÿç¥¨è²»ç”¨ (Airfare)</option>
                            <option value="ä½å®¿è²»ç”¨">ä½å®¿è²»ç”¨ (Accommodation)</option>
                        </optgroup>

                        <!-- ğŸ½ï¸ é¤è²»åŠæ‹›å¾…è²» (Meals & Entertainment) - å¢åŠ ç´°é … -->
                        <optgroup label="ğŸ½ï¸ é¤è²»åŠæ‹›å¾…è²» (Meals & Entertainment)">
                            <option value="å®¢æˆ¶æ‹›å¾…è²»">å®¢æˆ¶æ‹›å¾…è²» (Client Entertainment)</option>
                            <option value="å“¡å·¥ç¦åˆ©é¤è²»">å“¡å·¥ç¦åˆ©é¤è²» (Staff Welfare)</option>
                            <option value="å…§éƒ¨æœƒè­°é¤é£²">å…§éƒ¨æœƒè­°é¤é£² (Internal Meeting F&B)</option>
                        </optgroup>

                        <!-- ğŸ“¦ è¾¦å…¬èˆ‡è¡Œæ”¿è²» (Office & Admin) - å¢åŠ ç´°é … -->
                        <optgroup label="ğŸ“¦ è¾¦å…¬èˆ‡è¡Œæ”¿è²» (Office & Admin)">
                            <option value="è¾¦å…¬ç”¨å“åŠè€—æ">è¾¦å…¬ç”¨å“åŠè€—æ (Supplies)</option>
                            <option value="éƒµé›»/é€šè¨Šè²»">éƒµé›»/é€šè¨Šè²» (Post & Telecom)</option>
                            <option value="ç§Ÿé‡‘æ”¯å‡º">ç§Ÿé‡‘æ”¯å‡º (Rent Expense)</option>
                            <option value="æ°´é›»ç“¦æ–¯è²»">æ°´é›»ç“¦æ–¯è²» (Utilities)</option>
                            <option value="ä¿®ç¹•èˆ‡ç¶­è­·è²»">ä¿®ç¹•èˆ‡ç¶­è­·è²» (Repair & Maint.)</option>
                            <option value="å ±ç« é›œèªŒè¨‚é–±è²»">å ±ç« é›œèªŒè¨‚é–±è²» (Subscriptions)</option>
                        </optgroup>

                        <!-- ğŸ’» è³‡è¨Šèˆ‡è»Ÿé«”è²» (IT & Software) - å¢åŠ ç´°é … -->
                        <optgroup label="ğŸ’» è³‡è¨Šèˆ‡è»Ÿé«”è²» (IT & Software)">
                            <option value="è»Ÿé«”è¨‚é–±è²»">è»Ÿé«”è¨‚é–±è²» (Software Subscription)</option>
                            <option value="ç¡¬é«”æ¡è³¼è²»">ç¡¬é«”æ¡è³¼è²» (Hardware Purchase)</option>
                            <option value="è³‡è¨Šæœå‹™è²»">è³‡è¨Šæœå‹™è²» (IT Services)</option>
                            <option value="é›²ç«¯æœå‹™è²»">é›²ç«¯æœå‹™è²» (Cloud Services)</option>
                            <option value="ç¶²ç«™ç¶²åŸŸåç¨±è²»">ç¶²ç«™ç¶²åŸŸåç¨±è²» (Domain/Web Fees)</option>
                        </optgroup>

                        <!-- ğŸ“ˆ è¡ŒéŠ·èˆ‡æ¥­å‹™è²» (Marketing & Sales) - å¢åŠ ç´°é … -->
                        <optgroup label="ğŸ“ˆ è¡ŒéŠ·èˆ‡æ¥­å‹™è²» (Marketing & Sales)">
                            <option value="å»£å‘Šèˆ‡å®£å‚³è²»">å»£å‘Šèˆ‡å®£å‚³è²» (Advertising)</option>
                            <option value="æ¥­å‹™äº¤éš›è²»">æ¥­å‹™äº¤éš›è²» (Sales Relations)</option>
                            <option value="å±•è¦½è²»">å±•è¦½è²» (Exhibition Fees)</option>
                            <option value="å°åˆ·å®£å‚³å“">å°åˆ·å®£å‚³å“ (Printed Materials)</option>
                            <option value="å¸‚å ´èª¿ç ”è²»">å¸‚å ´èª¿ç ”è²» (Market Research)</option>
                        </optgroup>

                        <!-- ğŸ“š åŸ¹è¨“èˆ‡äººæ‰è²» (Training & HR) - å¢åŠ ç´°é … -->
                        <optgroup label="ğŸ“š åŸ¹è¨“èˆ‡äººæ‰è²» (Training & HR)">
                            <option value="å°ˆæ¥­åŸ¹è¨“è²»">å°ˆæ¥­åŸ¹è¨“è²» (Professional Training)</option>
                            <option value="æ‹›å‹Ÿè²»ç”¨">æ‹›å‹Ÿè²»ç”¨ (Recruitment Costs)</option>
                            <option value="æ•™è‚²è¨“ç·´èª²ç¨‹è²»">æ•™è‚²è¨“ç·´èª²ç¨‹è²» (Course Fees)</option>
                            <option value="å“¡å·¥å¥åº·æª¢æŸ¥è²»">å“¡å·¥å¥åº·æª¢æŸ¥è²» (Health Check-ups)</option>
                        </optgroup>

                        <!-- ğŸ§‘â€ğŸ’» å°ˆæ¥­æœå‹™è²» (Professional Services) - å¢åŠ ç´°é … -->
                        <optgroup label="ğŸ§‘â€ğŸ’» å°ˆæ¥­æœå‹™è²» (Professional Services)">
                            <option value="é¡§å•è²»">é¡§å•è²» (Consulting)</option>
                            <option value="æ³•å¾‹åŠæœƒè¨ˆè²»ç”¨">æ³•å¾‹åŠæœƒè¨ˆè²»ç”¨ (Legal & Accounting)</option>
                            <option value="å¤–éƒ¨å¯©è¨ˆè²»">å¤–éƒ¨å¯©è¨ˆè²» (External Audit)</option>
                            <option value="ç¿»è­¯/å£è­¯è²»">ç¿»è­¯/å£è­¯è²» (Translation/Interpreting)</option>
                        </optgroup>

                        <!-- ğŸ¦ è²¡å‹™èˆ‡é›œé …è²» (Financial & Misc.) - å¢åŠ ç´°é … -->
                        <optgroup label="ğŸ¦ è²¡å‹™èˆ‡é›œé …è²» (Financial & Misc.)">
                            <option value="éŠ€è¡Œæ‰‹çºŒè²»">éŠ€è¡Œæ‰‹çºŒè²» (Bank Charges)</option>
                            <option value="åˆ©æ¯æ”¯å‡º">åˆ©æ¯æ”¯å‡º (Interest Expense)</option>
                            <option value="æ”¿åºœè¦è²»èˆ‡ç½°é°">æ”¿åºœè¦è²»èˆ‡ç½°é° (Fees & Penalties)</option>
                            <option value="ä¿éšªè²»">ä¿éšªè²» (Insurance Premiums)</option>
                            <option value="æ…ˆå–„æè´ˆ">æ…ˆå–„æè´ˆ (Donations)</option>
                        </optgroup>

                        <!-- â“ å…¶ä»–é›œé …è²»ç”¨ (Miscellaneous) -->
                        <optgroup label="â“ å…¶ä»–é›œé …è²»ç”¨ (Miscellaneous)">
                            <option value="å…¶ä»–é›œé …è²»ç”¨">å…¶ä»–é›œé …è²»ç”¨ (Misc. Other)</option>
                        </optgroup>
                    </select>
                </div>

                <!-- èµ·å§‹æœˆä»½ -->
                <div class="flex flex-col">
                    <label for="start-month" class="text-sm font-medium mb-1 text-gray-400">èµ·å§‹æœˆä»½</label>
                    <input type="month" id="start-month" value="2025-04" min="2025-01" max="2025-12" class="input-control">
                </div>

                <!-- çµæŸæœˆä»½ -->
                <div class="flex flex-col">
                    <label for="end-month" class="text-sm font-medium mb-1 text-gray-400">çµæŸæœˆä»½</label>
                    <input type="month" id="end-month" value="2025-09" min="2025-01" max="2025-12" class="input-control">
                </div>
            </div>

            <!-- åŸ·è¡ŒæŒ‰éˆ•ç¨ç«‹ä¸€è¡Œ -->
            <div class="mt-4 flex justify-end">
                <button onclick="loadReportData()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200">
                    è¼‰å…¥ä¸¦åˆ†ææ•¸æ“š
                </button>
            </div>
        </section>

        <!-- åœ–è¡¨å€å¡Š -->
        <section class="mb-10 p-4 border border-gray-700 rounded-lg bg-[#0d1117]">
            <h2 id="chart-title" class="text-xl font-semibold mb-4 text-white">è«‹é¸æ“‡ä¸€å€‹ç§‘ç›®é€²è¡Œåˆ†æ</h2>
            <div class="chart-wrapper">
                <canvas id="balanceChart"></canvas>
            </div>
        </section>

        <!-- æ˜ç´°è¡¨æ ¼å€å¡Š -->
        <section class="p-4 border border-gray-700 rounded-lg bg-[#0d1117]">
            <h2 id="table-title" class="text-xl font-semibold mb-4 text-white">é¤˜é¡è®Šå‹•æ˜ç´°</h2>
            <div class="overflow-x-auto">
                <table id="detail-table" class="data-table min-w-full text-sm text-gray-300 rounded-lg">
                    <thead>
                        <tr>
                            <th>æœˆä»½</th>
                            <th>æœŸæœ«é¤˜é¡ (å–®ä½:å…ƒ)</th>
                            <th>æœˆè®Šå‹•é¡</th>
                            <th>æœˆè®Šå‹•ç‡</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- è¡¨æ ¼å…§å®¹å°‡ç”± JavaScript è¼‰å…¥ -->
                        <tr><td colspan="4" class="text-center py-8 text-gray-500">è«‹é¸æ“‡ç§‘ç›®ä¸¦é»æ“Šã€Œè¼‰å…¥ä¸¦åˆ†ææ•¸æ“šã€</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

    </div>

    <script>
        // å…¨å±€è®Šé‡ç”¨æ–¼å„²å­˜ Chart å¯¦ä¾‹
        let balanceChartInstance = null;

        // å ±è¡¨æ•¸æ“š - æ¨¡æ“¬æ•¸æ“š
        const defaultReportData = [
            { month: '2025-04', balance: 880000, changeAmount: 0, changeRate: null, isIncrease: false },
            { month: '2025-05', balance: 950000, changeAmount: 70000, changeRate: 0.0795, isIncrease: true },
            { month: '2025-06', balance: 1100000, changeAmount: 150000, changeRate: 0.1579, isIncrease: true },
            { month: '2025-07', balance: 1050000, changeAmount: -50000, changeRate: -0.0455, isIncrease: false },
            { month: '2025-08', balance: 1200000, changeAmount: 150000, changeRate: 0.1429, isIncrease: true },
            { month: '2025-09', balance: 1400000, changeAmount: 200000, changeRate: 0.1667, isIncrease: true },
        ];

        // æ¨¡æ“¬ä¸åŒç§‘ç›®çš„æ•¸æ“š
        function fetchSimulatedData(accountId, startMonth, endMonth) {
            console.log(`æ¨¡æ“¬å¾ ${startMonth} åˆ° ${endMonth} ç²å–ç§‘ç›® ${accountId} çš„æ•¸æ“š...`);

            // åˆ¤æ–·æ˜¯å¦ç‚ºè²»ç”¨æˆ–æˆæœ¬ç§‘ç›® (5XXX/6XXX é–‹é ­æˆ–è²»ç”¨ç§‘ç›®ç´°é …)
            const isExpenseOrCost = accountId.startsWith('5') || accountId.startsWith('6') || !accountId.includes('-');

            if (isExpenseOrCost) {
                const simulatedExpenseData = [];
                // è²»ç”¨/æˆæœ¬çš„åˆå§‹é¤˜é¡è¼ƒä½
                let prevBalance = accountId.includes('æˆæœ¬') ? 200000 : 50000;

                // æ ¹æ“šæœˆä»½ç”Ÿæˆæ¨¡æ“¬æ•¸æ“š
                const months = defaultReportData.map(d => d.month); // å¯¦éš›æ‡‰è©²åŸºæ–¼ startMonth å’Œ endMonth ç”Ÿæˆæœˆä»½

                months.forEach((month, index) => {
                    // éš¨æ©Ÿç”Ÿæˆä¸€å€‹è¼ƒå°çš„è²»ç”¨åŸºæ•¸å’Œæ³¢å‹•
                    let base = (accountId.includes('æˆæœ¬') ? 200000 : 50000) + index * 8000; // æˆæœ¬æ›´é«˜
                    const balance = base + Math.floor(Math.random() * 20000);

                    const changeAmount = balance - prevBalance;
                    const changeRate = index > 0 ? changeAmount / prevBalance : null;

                    simulatedExpenseData.push({
                        month: month,
                        balance: balance,
                        changeAmount: changeAmount,
                        changeRate: changeRate,
                        isIncrease: changeAmount > 0,
                    });
                    prevBalance = balance;
                });

                return Promise.resolve(simulatedExpenseData);
            }

            // æ¨¡æ“¬æ”¶å…¥/è³‡ç”¢ç§‘ç›®æ•¸æ“š (ä½¿ç”¨é è¨­çš„è¼ƒé«˜é‡‘é¡)
            return Promise.resolve(defaultReportData.map(d => ({...d})));
        }

        // è™•ç†é¸å–®è®Šæ›´ï¼Œç¢ºä¿åªæœ‰ä¸€å€‹é¸å–®æœ‰å€¼
        function handleSelectionChange(source) {
            const incomeSelect = document.getElementById('income-select');
            const expenseSelect = document.getElementById('expense-select');

            if (source === 'income' && incomeSelect.value !== "") {
                expenseSelect.value = ""; // æ¸…é™¤è²»ç”¨é¸å–®
            } else if (source === 'expense' && expenseSelect.value !== "") {
                incomeSelect.value = ""; // æ¸…é™¤æ”¶å…¥é¸å–®
            }
        }


        // æ ¼å¼åŒ–æ•¸å­—ç‚ºè²¨å¹£æ ¼å¼ (å¸¶é€—è™Ÿ)
        function formatCurrency(number, unit = '') {
            if (number === null || number === undefined) return '-';
            const sign = number < 0 ? '-' : '';
            const absoluteNumber = Math.abs(number);
            return sign + absoluteNumber.toLocaleString('en-US') + unit;
        }

        // æ ¼å¼åŒ–ç™¾åˆ†æ¯”
        function formatPercentage(rate) {
            if (rate === null) return '-';
            return (rate * 100).toFixed(2) + '%';
        }

        // æ¸²æŸ“æ˜ç´°è¡¨æ ¼
        function renderTable(reportData, balanceColumnTitle) {
            const tbody = document.getElementById('detail-table').querySelector('tbody');
            tbody.innerHTML = ''; // æ¸…ç©ºç¾æœ‰å…§å®¹

            // å‹•æ…‹æ›´æ–°è¡¨æ ¼ç¬¬äºŒæ¬„æ¨™é¡Œ
            const balanceHeader = document.querySelector('#detail-table thead tr th:nth-child(2)');
            if (balanceHeader) {
                balanceHeader.textContent = `${balanceColumnTitle} (å–®ä½:å…ƒ)`;
            }

            if (reportData.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">æ­¤æœŸé–“ç„¡æ•¸æ“šã€‚</td></tr>';
                 return;
            }

            reportData.forEach(item => {
                const changeRateText = formatPercentage(item.changeRate);
                const changeRateColor = item.changeRate > 0 ? 'text-green-400' : (item.changeRate < 0 ? 'text-red-400' : 'text-gray-400');
                const changeAmountColor = item.changeAmount > 0 ? 'text-green-400' : (item.changeAmount < 0 ? 'text-red-400' : 'text-gray-400');

                // å¦‚æœæ˜¯è³‡ç”¢/æ”¶å…¥ç§‘ç›®ï¼Œé¤˜é¡å¢åŠ æ‡‰é¡¯ç¤ºç‚ºç¶ è‰²
                // é€™è£¡çš„é‚è¼¯éœ€è¦èˆ‡ loadReportData ä¸­çš„ balanceColumnTitle ä¿æŒä¸€è‡´
                const isExpenseOrCost = balanceColumnTitle.includes('æ”¯å‡º') || balanceColumnTitle.includes('æˆæœ¬');

                let balanceColorClass = 'text-gray-300';
                if (!isExpenseOrCost) {
                    // è³‡ç”¢æˆ–æ”¶å…¥ï¼šæ­£æ•¸ç‚ºå¥½ (ç¶ è‰²)
                    balanceColorClass = item.balance > 0 ? 'text-green-400' : 'text-red-400';
                }

                const row = document.createElement('tr');
                row.className = 'hover:bg-[#1f252c] transition';
                row.innerHTML = `
                    <td class="text-left">${item.month}</td>
                    <td class="${balanceColorClass}">${formatCurrency(item.balance, '')}</td>
                    <td class="${changeAmountColor}">${formatCurrency(item.changeAmount, '')}</td>
                    <td class="${changeRateColor}">${changeRateText}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // æ¸²æŸ“åœ–è¡¨ (å·²æ›´æ–°ç‚ºé›™è»¸åœ–è¡¨)
        function renderChart(reportData, balanceColumnTitle) {
            if (balanceChartInstance) {
                balanceChartInstance.destroy();
            }

            const ctx = document.getElementById('balanceChart').getContext('2d');

            Chart.defaults.color = '#9ca3af';
            Chart.defaults.font.family = 'Inter, sans-serif';

            // ç¢ºä¿ç¬¬ä¸€å€‹é»çš„ changeAmount æ˜¯ 0ï¼Œä»¥ä¾¿åœ–è¡¨å¾ 0 é–‹å§‹ç¹ªè£½
            const changeAmounts = reportData.map(item => item.changeAmount);
            if (changeAmounts.length > 0 && (changeAmounts[0] === null || changeAmounts[0] === undefined)) {
                changeAmounts[0] = 0;
            }

            // åˆ¤æ–·æ˜¯å¦ç‚ºè²»ç”¨æˆ–æˆæœ¬ç§‘ç›®ï¼Œç”¨æ–¼èª¿æ•´åœ–è¡¨é¡è‰²
            const isExpenseOrCost = balanceColumnTitle.includes('æ”¯å‡º') || balanceColumnTitle.includes('æˆæœ¬');

            balanceChartInstance = new Chart(ctx, {
                data: {
                    labels: reportData.map(item => item.month),
                    datasets: [
                        {
                            // æ•¸æ“šé›† 1: æœŸæœ«é¤˜é¡/ç´¯ç©æ”¶å…¥/ç´¯ç©æ”¯å‡º (æŠ˜ç·šåœ– - å·¦å´ Y è»¸)
                            label: balanceColumnTitle,
                            data: reportData.map(item => item.balance),
                            type: 'line', // æ˜ç¢ºæŒ‡å®šé¡å‹
                            yAxisID: 'yBalance', // ç¶å®šåˆ° yBalance è»¸
                            // è²»ç”¨/æˆæœ¬é¡ç”¨ç´…è‰²ç³»ï¼Œè³‡ç”¢/æ”¶å…¥é¡ç”¨è—è‰²ç³»
                            borderColor: isExpenseOrCost ? '#ef4444' : '#3b82f6',
                            backgroundColor: isExpenseOrCost ? 'rgba(239, 68, 68, 0.2)' : 'rgba(59, 130, 246, 0.2)',
                            tension: 0.3,
                            pointRadius: 6,
                            pointBackgroundColor: isExpenseOrCost ? '#ef4444' : '#3b82f6',
                            fill: true,
                            order: 1 // ç¢ºä¿æŠ˜ç·šåœ–åœ¨æŸ±ç‹€åœ–ä¹‹ä¸Š
                        },
                        {
                            // æ•¸æ“šé›† 2: æœˆè®Šå‹•é¡ (æŸ±ç‹€åœ– - å³å´ Y è»¸)
                            label: 'æœˆè®Šå‹•é¡',
                            data: changeAmounts,
                            type: 'bar', // æ˜ç¢ºæŒ‡å®šé¡å‹
                            yAxisID: 'yChange', // ç¶å®šåˆ° yChange è»¸
                            backgroundColor: changeAmounts.map(amount =>
                                amount > 0 ? 'rgba(34, 197, 94, 0.6)' : 'rgba(239, 68, 68, 0.6)' // ç¶ è‰²/ç´…è‰²
                            ),
                            borderColor: changeAmounts.map(amount =>
                                amount > 0 ? '#22c55e' : '#ef4444' // ç¶ è‰²/ç´…è‰²
                            ),
                            borderWidth: 1,
                            order: 2 // ç¢ºä¿æŸ±ç‹€åœ–åœ¨æŠ˜ç·šåœ–ä¹‹ä¸‹ (è¦–è¦ºä¸Š)
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index', // å•Ÿç”¨æ‡¸åœæ™‚é¡¯ç¤ºæ‰€æœ‰æ•¸æ“šé›†
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                usePointStyle: true, // æŠ˜ç·šåœ–ä½¿ç”¨é»æ¨£å¼ï¼ŒæŸ±ç‹€åœ–ä½¿ç”¨æ–¹å¡Š
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y, ' NTD');
                                    }
                                    return label;
                                }
                            },
                            backgroundColor: '#161b22',
                            borderColor: '#30363d',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æœˆä»½',
                                color: '#9ca3af'
                            },
                            grid: {
                                color: '#2d333b',
                                borderColor: '#30363d'
                            }
                        },
                        // ä¸»è¦ Y è»¸ (å·¦å´) - é¤˜é¡/ç´¯ç©
                        yBalance: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: balanceColumnTitle + ' (å–®ä½: å…ƒ)',
                                color: isExpenseOrCost ? '#ef4444' : '#3b82f6' // é¡è‰²èˆ‡æŠ˜ç·šåœ–ä¸€è‡´
                            },
                            beginAtZero: false,
                            grid: {
                                color: '#2d333b',
                                borderColor: '#30363d'
                            },
                            ticks: {
                                callback: function(value, index, ticks) {
                                    return formatCurrency(value, '');
                                }
                            }
                        },
                        // æ¬¡è¦ Y è»¸ (å³å´) - è®Šå‹•é¡
                        yChange: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'æœˆè®Šå‹•é¡ (å–®ä½: å…ƒ)',
                                color: '#22c55e' // ä½¿ç”¨ç¶ è‰²å¼·èª¿è®Šå‹•é¡è»¸
                            },
                            grid: {
                                drawOnChartArea: false, // ä¸åœ¨åœ–è¡¨å€ç¹ªè£½ç¶²æ ¼ç·šï¼Œä¿æŒæ¸…çˆ½
                                borderColor: '#30363d'
                            },
                            ticks: {
                                callback: function(value, index, ticks) {
                                    return formatCurrency(value, '');
                                }
                            }
                        }
                    }
                }
            });
        }

        // è¼‰å…¥æ•¸æ“šå’Œæ›´æ–°å ±è¡¨çš„ä¸»è¦å‡½å¼
        async function loadReportData() {
            const incomeSelect = document.getElementById('income-select');
            const expenseSelect = document.getElementById('expense-select');
            const startMonth = document.getElementById('start-month').value;
            const endMonth = document.getElementById('end-month').value;

            let selectedAccountText = "";
            let accountId = "";
            let balanceColumnTitle = 'æœŸæœ«é¤˜é¡'; // é è¨­ç‚ºã€ŒæœŸæœ«é¤˜é¡ã€

            // ç¢ºå®šå“ªå€‹ä¸‹æ‹‰é¸å–®è¢«é¸ä¸­
            if (incomeSelect.value !== "") {
                selectedAccountText = incomeSelect.options[incomeSelect.selectedIndex].text;
                accountId = incomeSelect.value;

                // æ ¹æ“š ERP æ…£ä¾‹çš„ç§‘ç›®ç·¨è™Ÿåˆ¤æ–·é¡å‹ (1xxx è³‡ç”¢, 4xxx æ”¶ç›Š, 5/6xxx æˆæœ¬/è²»ç”¨)
                const accountCodePrefix = accountId.substring(0, 4);

                if (accountCodePrefix.startsWith('4')) {
                    // 4xxx æ”¶å…¥/æ”¶ç›Šç§‘ç›®
                    balanceColumnTitle = 'ç•¶æœŸç´¯ç©æ”¶å…¥';
                } else if (accountCodePrefix.startsWith('5') || accountCodePrefix.startsWith('6')) {
                    // 5xxx/6xxx æˆæœ¬/è²»ç”¨ç§‘ç›®
                    balanceColumnTitle = 'ç•¶æœŸç´¯ç©æ”¯å‡º/æˆæœ¬';
                } else {
                    // 1xxx è³‡ç”¢ç§‘ç›® (æˆ–æœªåˆ†é¡/å…¶ä»–)
                    balanceColumnTitle = 'æœŸæœ«é¤˜é¡';
                }

            } else if (expenseSelect.value !== "") {
                selectedAccountText = expenseSelect.options[expenseSelect.selectedIndex].text;
                accountId = expenseSelect.value;
                // è²»ç”¨ç§‘ç›®ç´°é …æ˜ç¢ºæ¨™ç¤ºç‚ºã€Œç•¶æœŸç´¯ç©æ”¯å‡ºã€
                balanceColumnTitle = 'ç•¶æœŸç´¯ç©æ”¯å‡º';
            } else {
                // å¦‚æœå…©å€‹éƒ½æ²’æœ‰é¸ä¸­
                document.getElementById('chart-title').textContent = `è«‹é¸æ“‡ä¸€å€‹ç§‘ç›®é€²è¡Œåˆ†æ`;
                document.getElementById('table-title').textContent = `é¤˜é¡è®Šå‹•æ˜ç´°`;
                // éŠ·æ¯€åœ–è¡¨
                if (balanceChartInstance) { balanceChartInstance.destroy(); balanceChartInstance = null; }
                renderTable([], balanceColumnTitle); // æ¸…ç©ºè¡¨æ ¼
                console.warn('è«‹å…ˆåœ¨ã€Œä¸»è¦æœƒè¨ˆç§‘ç›®ã€æˆ–ã€Œè²»ç”¨ç§‘ç›®ç´°é …ã€ä¸­é¸æ“‡ä¸€å€‹ç§‘ç›®é€²è¡Œåˆ†æã€‚');
                return;
            }

            // 1. æ›´æ–°æ¨™é¡Œ
            const titleSuffix = ` (${startMonth} ~ ${endMonth})`;
            document.getElementById('chart-title').textContent = `${selectedAccountText} é¤˜é¡è¶¨å‹¢åœ– ${titleSuffix}`;
            document.getElementById('table-title').textContent = `${selectedAccountText} é¤˜é¡è®Šå‹•æ˜ç´° ${titleSuffix}`;

            // 2. ç²å–æ•¸æ“š (é€™è£¡ä½¿ç”¨æ¨¡æ“¬çš„ fetch)
            try {
                const fetchedData = await fetchSimulatedData(accountId, startMonth, endMonth);

                // 3. æ¸²æŸ“å ±è¡¨ (å‚³å…¥ balanceColumnTitle ä»¥ä¾¿è¡¨æ ¼å’Œåœ–è¡¨æ¨™ç±¤ä½¿ç”¨)
                renderTable(fetchedData, balanceColumnTitle);
                renderChart(fetchedData, balanceColumnTitle);

                console.log('å ±è¡¨å·²æ›´æ–°ã€‚');

            } catch (error) {
                console.error('è¼‰å…¥æ•¸æ“šå¤±æ•—:', error);
                // ä½¿ç”¨è‡ªå®šç¾©çš„æç¤ºæ–¹å¼ï¼Œé¿å… alert()
                console.error('è¼‰å…¥æ•¸æ“šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ– API ç‹€æ…‹ã€‚');
            }
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.onload = () => {
            // é é¢è¼‰å…¥æ™‚ä¸è‡ªå‹•è¼‰å…¥æ•¸æ“šï¼Œç­‰å¾…ç”¨æˆ¶é¸æ“‡ã€‚
            // è¨­ç½®æ¨™é¡Œç‚ºæç¤ºè¨Šæ¯
            document.getElementById('chart-title').textContent = `è«‹é¸æ“‡ä¸€å€‹ç§‘ç›®é€²è¡Œåˆ†æ`;
            document.getElementById('table-title').textContent = `é¤˜é¡è®Šå‹•æ˜ç´°`;
            // åˆå§‹åŒ–è¡¨æ ¼æ¨™é¡Œ
            const balanceHeader = document.querySelector('#detail-table thead tr th:nth-child(2)');
            if (balanceHeader) {
                balanceHeader.textContent = `æœŸæœ«é¤˜é¡ (å–®ä½:å…ƒ)`;
            }
        };
    </script>
</body>
</html>
