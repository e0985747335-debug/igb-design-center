<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGB è²»ç”¨ç®¡ç†ä¸­å¿ƒ - ç¨ç«‹æ¨¡çµ„ (V2.3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#10497E',
                        'secondary-gray': '#F7F9FB',
                        'accent-orange': '#FF7A00',
                        'status-draft': '#9CA3AF', /* Gray-400 */
                        'status-pending': '#F97316', /* Orange-500 */
                        'status-approved': '#10B981', /* Green-500 */
                        'status-rejected': '#EF4444', /* Red-500 */
                        
                        /* çµ±ä¸€æ¨£å¼ï¼šç”¨æ–¼æ–°è¡¨å–®çš„é¡è‰² */
                        'primary-indigo': '#10497E', /* å·²çµ±ä¸€ç‚º Primary Blue */
                        'light-indigo': '#E0F2FE', /* å·²çµ±ä¸€ç‚º Light Blue */
                        'compliance-yellow': '#FFFBEB', /* Yellow-50 */
                        'compliance-yellow-text': '#B45309', /* Amber-700 */
                        'compliance-yellow-border': '#FDE68A', /* Amber-200 */
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <style>
        .claim-row { cursor: pointer; transition: background-color 0.2s; }
        .claim-row:hover:not(.active) { background-color: #f3f4f6; }
        .claim-row.active { background-color: #E0F2F1; border-left: 4px solid theme('colors.primary-blue'); }
        .view-switch-btn.active { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transform: translateY(-2px); }
        
        #messageBox.hidden { display: none !important; }
        #messageBox.flex { display: flex !important; }

        .kpi-card { transition: transform 0.2s, box-shadow 0.2s; }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 sm:p-8">

    <div id="mainAppContainer" class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl">

        <header class="bg-primary-blue text-white p-6 rounded-t-xl flex justify-between items-center flex-wrap">
            <h1 class="text-3xl font-bold mb-2 sm:mb-0">è²»ç”¨ç®¡ç†ä¸­å¿ƒ</h1>
            <div id="viewSelector" class="flex space-x-4 p-1 bg-white/10 rounded-lg">
                <button id="claimerViewBtn" onclick="switchView('claimer')" class="view-switch-btn py-2 px-4 rounded-md text-sm font-semibold bg-accent-orange text-white active">å ±éŠ·äººå„€è¡¨æ¿</button>
                <button id="approverViewBtn" onclick="switchView('approver')" class="view-switch-btn py-2 px-4 rounded-md text-sm font-semibold bg-white text-primary-blue hover:bg-gray-100">å¯©æ‰¹äººä¸­å¿ƒ</button>
            </div>
        </header>

        <main class="p-6">
            
            <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full transform transition-all scale-100 opacity-100">
                    <h3 id="msgTitle" class="text-xl font-bold mb-3 text-primary-blue">æç¤º</h3>
                    <p id="msgText" class="text-gray-700 mb-4">æ“ä½œè¨Šæ¯ã€‚</p>
                    <div class="flex justify-end">
                        <button onclick="closeMessageBox()" class="bg-primary-blue text-white py-2 px-4 rounded-md hover:bg-primary-blue/90">ç¢ºå®š</button>
                    </div>
                </div>
            </div>

            <div id="claimerViewContainer" class="view-container">
                <h2 class="text-2xl font-semibold text-primary-blue mb-6 border-b pb-2">æˆ‘çš„å ±éŠ·å–®è¿½è¹¤ (<span id="claimerName">ç‹å°æ˜</span>)</h2>

                <div id="claimerDashboardView" class="view-section">
                
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="kpi-card bg-white p-5 rounded-lg shadow-lg border-l-4 border-status-draft">
                            <p class="text-sm font-medium text-gray-500">å¾…è™•ç† (è‰ç¨¿)</p>
                            <p id="statClaimerDraft" class="text-3xl font-bold text-status-draft mt-1">0</p>
                        </div>
                        <div class="kpi-card bg-white p-5 rounded-lg shadow-lg border-l-4 border-status-pending">
                            <p class="text-sm font-medium text-gray-500">å¯©æ ¸ä¸­ (å¾…å¯©æ‰¹)</p>
                            <p id="statClaimerPending" class="text-3xl font-bold text-status-pending mt-1">0</p>
                        </div>
                        <div class="kpi-card bg-white p-5 rounded-lg shadow-lg border-l-4 border-status-rejected">
                            <p class="text-sm font-medium text-gray-500">å·²é§å› (éœ€ä¿®æ”¹)</p>
                            <p id="statClaimerRejected" class="text-3xl font-bold text-status-rejected mt-1">0</p>
                        </div>
                    </div>

                    <div class="flex flex-wrap justify-between items-center mb-4 gap-3">
                        <div>
                            <button onclick="changeClaimerFilter('All')" class="claimer-filter-btn py-1 px-3 text-sm font-medium rounded-full bg-primary-blue text-white shadow-md transition duration-150" data-filter="All">å…¨éƒ¨</button>
                            <button onclick="changeClaimerFilter('Draft')" class="claimer-filter-btn py-1 px-3 text-sm font-medium rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition duration-150" data-filter="Draft">è‰ç¨¿</button>
                            <button onclick="changeClaimerFilter('Pending')" class="claimer-filter-btn py-1 px-3 text-sm font-medium rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition duration-150" data-filter="Pending">å¾…å¯©æ‰¹</button>
                            <button onclick="changeClaimerFilter('Rejected')" class="claimer-filter-btn py-1 px-3 text-sm font-medium rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition duration-150" data-filter="Rejected">å·²é§å›</button>
                        </div>
                        <button onclick="createNewClaim()" class="flex items-center space-x-1 py-2 px-4 bg-accent-orange text-white rounded-lg hover:bg-accent-orange/90 font-semibold shadow-md transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            <span>æ–°å¢å ±éŠ·å–®</span>
                        </button>
                    </div>

                    <div class="bg-secondary-gray p-4 rounded-lg shadow-inner">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-primary-blue/10">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">æ¨™é¡Œ</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">é—œè¯å°ˆæ¡ˆ</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">ç¸½é‡‘é¡</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">ç‹€æ…‹</th>
                                    <th class="px-4 py-3 text-right text-xs font-bold text-gray-600 uppercase w-20">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="claimerClaimListBody" class="bg-white divide-y divide-gray-100">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="claimerEditFormView" class="view-section hidden max-w-2xl mx-auto p-6 bg-white border border-gray-200 rounded-lg shadow-lg">
                    <h3 class="text-xl font-bold text-primary-blue mb-4"><span id="formActionTitle">ç·¨è¼¯</span>å ±éŠ·å–® <span id="editClaimIdDisplay" class="text-accent-orange">#N/A</span></h3>

                    <form id="editForm" class="space-y-4">
                        <div>
                            <label for="editTitle" class="block text-sm font-medium text-gray-700 mb-1">å ±éŠ·å–®æ¨™é¡Œ</label>
                            <input type="text" id="editTitle" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                        </div>

                        <div>
                            <label for="editProjectId" class="block text-sm font-medium text-gray-700 mb-1">é—œè¯å°ˆæ¡ˆ/æ¨¡çµ„ç·¨è™Ÿ</label>
                            <select id="editProjectId" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                                </select>
                        </div>
                        
                        <div>
                            <label for="editTotal" class="block text-sm font-medium text-gray-700 mb-1">ç¸½é‡‘é¡ (TWD)</label>
                            <input type="number" id="editTotal" required min="1" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                        </div>

                        <div>
                            <label for="editPurpose" class="block text-sm font-medium text-gray-700 mb-1">å ±éŠ·äº‹ç”±</label>
                            <textarea id="editPurpose" rows="3" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue"></textarea>
                        </div>

                        <div>
                            <p class="text-sm font-medium text-gray-700 mb-1">è²»ç”¨æ˜ç´° (æ¯è¡Œä¸€é …)</p>
                            <textarea id="editDetails" rows="5" placeholder="ä¾‹å¦‚ï¼š
äº¤é€šè²»: TWD 3000
é¤é£²è²»: TWD 850" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue"></textarea>
                        </div>

                        <div id="rejectedReasonBox" class="p-3 bg-status-rejected/10 border border-status-rejected rounded-lg hidden">
                            <p class="font-bold text-status-rejected mb-1">åŸé§å›ç†ç”±:</p>
                            <p id="rejectedReasonText" class="text-sm text-gray-700 italic"></p>
                        </div>

                        <div class="flex justify-end space-x-3 pt-3">
                            <button type="button" onclick="cancelEdit()" class="py-2 px-4 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-semibold">
                                å–æ¶ˆ
                            </button>
                            <button type="button" onclick="saveClaim('Draft')" class="py-2 px-4 bg-accent-orange text-white rounded-lg hover:bg-accent-orange/90 font-semibold">
                                <span id="saveDraftText">å„²å­˜è‰ç¨¿</span>
                            </button>
                            <button type="button" onclick="saveClaim('Pending')" class="py-2 px-4 bg-status-approved text-white rounded-lg hover:bg-status-approved/90 font-semibold">
                                <span id="resubmitText">æäº¤å¯©æ‰¹</span>
                            </button>
                        </div>
                    </form>
                </div>
                
                <div id="newClaimFormView" class="view-section hidden max-w-2xl mx-auto p-6 bg-white border border-gray-200 rounded-lg shadow-lg">
                    <h3 class="text-2xl font-bold text-primary-blue mb-6 border-b pb-3 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-primary-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        æ–°å¢è²»ç”¨ç”³å ± (å»ºç«‹è‰ç¨¿)
                    </h3>
                    <p class="text-gray-500 mb-8">è«‹å¡«å¯«å–®ç­†è²»ç”¨è³‡è¨Šã€‚å„²å­˜å¾Œå°‡åœ¨æ‚¨çš„å„€è¡¨æ¿å»ºç«‹ä¸€ç­†æ–°è‰ç¨¿ï¼Œæ‚¨ä¹‹å¾Œå¯ä»¥å†ç·¨è¼¯ç¸½æ¨™é¡Œå’Œåˆä½µæ˜ç´°ã€‚</p>

                    <form id="newExpenseForm" onsubmit="handleNewExpenseSubmit(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label for="new-category-final" class="block text-sm font-medium text-gray-700">æœƒè¨ˆç§‘ç›® (å¤§é … | ç´°ç›®)*</label>
                                <select id="new-category-final" name="category-final" required onchange="checkCompliance()"
                                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-blue focus:border-primary-blue sm:text-sm rounded-md border shadow-sm">
                                    </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="new-amount" class="block text-sm font-medium text-gray-700">é‡‘é¡ (Amount)*</label>
                                <input type="number" step="0.01" min="0.01" id="new-amount" name="amount" required oninput="checkCompliance()"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-blue focus:border-primary-blue sm:text-sm" placeholder="1200.00">
                            </div>
                            <div>
                                <label for="new-currency" class="block text-sm font-medium text-gray-700">å¹£åˆ¥ (Currency)*</label>
                                <select id="new-currency" name="currency" required
                                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-blue focus:border-primary-blue sm:text-sm rounded-md border shadow-sm">
                                    <option value="TWD" selected>TWD (æ–°è‡ºå¹£)</option>
                                    <option value="USD">USD (ç¾å…ƒ)</option>
                                    <option value="EUR">EUR (æ­å…ƒ)</option>
                                    <option value="JPY">JPY (æ—¥åœ“)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="compliance-prompt" class="p-4 bg-compliance-yellow border border-compliance-yellow-border rounded-lg hidden">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-compliance-yellow-text" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.636-1.107 2.37-1.107 3.006 0l7.236 12.533c.636 1.107-.23 2.502-1.503 2.502H2.524c-1.273 0-2.139-1.395-1.503-2.502L8.257 3.099zM9 9a1 1 0 00-1 1v4a1 1 0 102 0v-4a1 1 0 00-1-1zm1 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-bold text-compliance-yellow-text">æ³•è¦éµå¾ªæç¤º</h3>
                                    <div id="compliance-text" class="mt-2 text-sm text-compliance-yellow-text/90">
                                        <ul class="list-disc list-inside space-y-1">
                                            </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label for="new-project" class="block text-sm font-medium text-gray-700">é—œè¯å°ˆæ¡ˆ/æ¨¡çµ„ ID*</label>
                            <select id="new-project" name="project-id" required
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-blue focus:border-primary-blue sm:text-sm rounded-md border shadow-sm">
                                </select>
                        </div>


                        <div>
                            <label for="new-date" class="block text-sm font-medium text-gray-700">ç™¼ç”Ÿæ—¥æœŸ (Date)*</label>
                            <input type="date" id="new-date" name="date" required
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-blue focus:border-primary-blue sm:text-sm">
                        </div>

                        <div class="md:col-span-2">
                            <label for="new-description" class="block text-sm font-medium text-gray-700">èªªæ˜/å‚™è¨» (Description)</label>
                            <textarea id="new-description" name="description" rows="3" placeholder="è«‹ç°¡è¿°é€™ç­†è²»ç”¨çš„ç”¨é€”..."
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-blue focus:border-primary-blue sm:text-sm"></textarea>
                        </div>
                        
                        <div class="pt-4 flex justify-end space-x-3">
                            <button type="button" onclick="cancelEdit()"
                                class="inline-flex justify-center rounded-lg border border-gray-300 bg-white px-5 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none transition duration-150 ease-in-out">
                                å–æ¶ˆ
                            </button>
                            <button id="new-save-button" type="submit"
                                class="inline-flex justify-center items-center py-3 px-6 border border-transparent shadow-lg text-sm font-medium rounded-lg text-white bg-primary-blue hover:bg-primary-blue/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-blue transition duration-150">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v8a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4L14 7m0 0l-2-2m2 2l2 2"/></svg>
                                å„²å­˜ç‚ºè‰ç¨¿
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="approverViewContainer" class="view-container-inner hidden">
                <h2 class="text-2xl font-semibold text-primary-blue mb-6 border-b pb-2">å¯©æ‰¹ä¸­å¿ƒ</h2>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                    <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="kpi-card bg-white p-5 rounded-lg shadow-lg border-l-4 border-status-pending">
                            <p class="text-sm font-medium text-gray-500">å¾…å¯©æ‰¹æ•¸é‡</p>
                            <p id="statPendingCount" class="text-3xl font-bold text-status-pending mt-1">0</p>
                        </div>
                        <div class="kpi-card bg-white p-5 rounded-lg shadow-lg border-l-4 border-accent-orange">
                            <p class="text-sm font-medium text-gray-500">å¾…å¯©æ‰¹ç¸½é‡‘é¡ (TWD)</p>
                            <p id="statPendingTotal" class="text-3xl font-bold text-accent-orange mt-1">0</p>
                        </div>
                        <div class="kpi-card bg-white p-5 rounded-lg shadow-lg border-l-4 border-status-approved">
                            <p class="text-sm font-medium text-gray-500">å·²æ‰¹å‡†ç¸½é‡‘é¡ (æœ¬æœŸ)</p>
                            <p id="statApprovedTotal" class="text-3xl font-bold text-status-approved mt-1">0</Lp>
                        </div>
                    </div>


                    <div class="lg:col-span-1 bg-secondary-gray p-4 rounded-lg shadow-inner border border-gray-200">
                        <h3 class="text-xl font-semibold text-primary-blue mb-4">å ±éŠ·å–®æ¸…å–® (å¾…è™•ç†ï¼š<span id="approverPendingCount" class="text-accent-orange">0</span> ç­†)</h3>

                        <div class="flex space-x-2 mb-4">
                            <button data-status="Pending" onclick="changeApproverFilter('Pending')" class="approver-status-tab py-1 px-3 text-sm font-medium rounded-full bg-primary-blue text-white shadow-md">å¾…å¯©æ‰¹</button>
                            <button data-status="Approved" onclick="changeApproverFilter('Approved')" class="approver-status-tab py-1 px-3 text-sm font-medium rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300">å·²æ‰¹å‡†</button>
                            <button data-status="Rejected" onclick="changeApproverFilter('Rejected')" class="approver-status-tab py-1 px-3 text-sm font-medium rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300">å·²é§å›</button>
                        </div>

                        <div class="overflow-y-auto max-h-[60vh]">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="sticky top-0 bg-primary-blue/10">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-bold text-gray-600">æ¨™é¡Œ/å ±éŠ·äºº</th>
                                        <th class="px-4 py-2 text-left text-xs font-bold text-gray-600 w-24">é‡‘é¡</th>
                                        <th class="px-4 py-2 text-left text-xs font-bold text-gray-600 w-24">ç‹€æ…‹</th>
                                    </tr>
                                </thead>
                                <tbody id="approverClaimListBody" class="bg-white divide-y divide-gray-100">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-xl border border-primary-blue/20">
                        <div id="approverDetailPlaceholder" class="text-center p-10 text-gray-500 mt-20">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 text-primary-blue/50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p class="text-lg font-medium">è«‹å¾å·¦å´æ¸…å–®é¸æ“‡ä¸€ç­†å ±éŠ·å–®ä»¥æŸ¥çœ‹è©³æƒ…ã€‚</p>
                        </div>

                        <div id="approverClaimDetailView" class="hidden space-y-6">
                            <div class="border-b pb-3 mb-4">
                                <h3 id="approverDetailTitle" class="text-2xl font-bold text-primary-blue"></h3>
                                <div class="flex items-center space-x-4 mt-2 text-sm text-gray-600 flex-wrap gap-y-2">
                                    <p>å ±éŠ·äºº: <span id="approverDetailClaimer" class="font-medium"></span></p>
                                    <p>éƒ¨é–€: <span id="approverDetailDepartment" class="font-medium"></span></p>
                                    <p>å°ˆæ¡ˆç·¨è™Ÿ: <span id="approverDetailProjectCode" class="font-medium text-primary-blue"></span></p>
                                    <p>æœƒè¨ˆç§‘ç›®: <span id="approverDetailAccountCode" class="font-medium text-primary-blue"></span></p>
                                    <p>æäº¤æ—¥æœŸ: <span id="approverDetailSubmitDate" class="font-medium"></span></p>
                                    <p>ç¸½é‡‘é¡: <span id="approverDetailTotal" class="text-lg font-extrabold text-accent-orange"></span></p>
                                    <span id="approverDetailStatus" class="px-3 py-1 text-xs font-semibold rounded-full"></span>
                                </div>
                            </div>

                            <div>
                                <p class="text-lg font-semibold text-gray-800 mb-2">å ±éŠ·äº‹ç”±ï¼š</p>
                                <div id="approverDetailPurpose" class="p-3 bg-secondary-gray rounded-md border border-gray-300 text-gray-700 italic mb-4"></div>
                                <p class="text-md font-semibold text-gray-800 mb-1">è²»ç”¨æ˜ç´°ï¼š</p>
                                <ul id="approverDetailMockDetails" class="list-disc list-inside ml-4 mt-2 space-y-1 text-gray-700 text-sm"></ul>
                            </div>

                            <div class="pt-6 border-t border-dashed mt-6 space-y-4">
                                <p class="text-lg font-semibold text-primary-blue" id="approverActionTitle">å¯©æ‰¹æ„è¦‹èˆ‡æ“ä½œ</p>

                                <div id="approverActionsDiv">
                                    <textarea id="approverNotesInput" rows="3" placeholder="è«‹è¼¸å…¥å¯©æ‰¹æ„è¦‹ï¼ˆæ‰¹å‡†æ™‚å¯é¸å¡«ï¼Œé§å›æ™‚å¿…å¡«ï¼‰" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue transition duration-150"></textarea>

                                    <div class="flex justify-end space-x-4 mt-3">
                                        <button onclick="handleApproval('Rejected')" class="bg-status-rejected text-white py-2 px-4 rounded-lg hover:bg-status-rejected/90 font-semibold shadow-md">é§å›</button>
                                        <button onclick="handleApproval('Approved')" class="bg-status-approved text-white py-2 px-4 rounded-lg hover:bg-status-approved/90 font-semibold shadow-md">æ‰¹å‡†</button>
                                    </div>
                                </div>

                                <div id="approverHistoryDiv" class="hidden space-y-2">
                                    <p id="approverHistoryStatus" class="font-bold text-lg"></p>
                                    <p class="text-sm text-gray-600">å¯©æ‰¹äººå‚™è¨»:</p>
                                    <div id="approverHistoryNotes" class="p-3 bg-gray-100 rounded-md border border-gray-200 italic text-gray-700"></div>
                                    <p class="text-xs text-gray-500 pt-1">å¯©æ‰¹æ™‚é–“: <span id="approverHistoryDate"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // === è¼”åŠ©å‡½æ•¸ï¼šæ—¥æœŸæ™‚é–“æ ¼å¼åŒ– ===
        function getFormattedDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        // === æ¨¡æ“¬æ•¸æ“šèˆ‡å…¨å±€è®Šæ•¸ ===
        const CURRENT_USER_NAME = "ç‹å°æ˜";
        let currentView = 'claimer'; // 'claimer' or 'approver'

        let mockClaims = [
            // ç‹å°æ˜çš„å¾…å¯©æ‰¹
            { id: 101, title: "2025å¹´11æœˆå®¢æˆ¶æ‹œè¨ªè²»ç”¨", claimer: "ç‹å°æ˜", department: "æ¥­å‹™ç™¼å±•éƒ¨", total: 7350, submitDate: "2025-10-25 09:00", lastUpdate: "2025-10-25 09:00", status: "Pending", approverNotes: "", approverDate: "",
              purpose: "æ‹œè¨ªå°åŒ—é‡è¦å®¢æˆ¶ï¼Œè¨è«–å¹´åº¦åˆä½œæ–¹æ¡ˆã€‚", details: ["äº¤é€šè²»: TWD 3,000", "é¤é£²è²»: TWD 850", "ä½å®¿è²»: TWD 3,500"], projectCode: "P-2025-Q4-01", accountCode: "åœ‹å…§å·®æ—…è²» (Domestic)" },
            // ç‹å°æ˜çš„è‰ç¨¿ (åªæœ‰è‡ªå·±çœ‹å¾—åˆ°)
            { id: 102, title: "è¾¦å…¬å®¤ç”¨å“æ¡è³¼", claimer: "ç‹å°æ˜", department: "æ¥­å‹™ç™¼å±•éƒ¨", total: 1200, submitDate: "2025-10-24 14:30", lastUpdate: "2025-10-24 14:30", status: "Draft", approverNotes: "", approverDate: "",
              purpose: "è³¼è²·å½±å°ç´™å’Œå¢¨æ°´ã€‚", details: ["å½±å°ç´™: TWD 700", "å¢¨æ°´åŒ£: TWD 500"], projectCode: "OPEX-GEN", accountCode: "è¾¦å…¬ç”¨å“åŠè€—æ (Supplies)" },
            // æå¤§è¯çš„å·²æ‰¹å‡† (å¯©æ‰¹äººä¸­å¿ƒçœ‹å¾—åˆ°)
            { id: 103, title: "ä¼ºæœå™¨æ¡è³¼å°¾æ¬¾", claimer: "æå¤§è¯", department: "è³‡è¨ŠæŠ€è¡“éƒ¨", total: 85000, submitDate: "2025-10-20 10:00", lastUpdate: "2025-10-20 10:00", status: "Approved", approverNotes: "é‡‘é¡ç¬¦åˆé ç®—ï¼Œå·²ç¢ºèªè¦æ ¼ã€‚", approverDate: "2025-10-21 11:30",
              purpose: "æ›´æ–°è€èˆŠçš„è³‡æ–™åº«ä¼ºæœå™¨ã€‚", details: ["ç¡¬é«”æ¡è³¼å°¾æ¬¾: TWD 85,000"], projectCode: "IT-2025-03", accountCode: "ç¡¬é«”æ¡è³¼è²» (Hardware Purchase)" },
            // æ—ä½³ç©çš„å·²é§å› (å¯©æ‰¹äººä¸­å¿ƒçœ‹å¾—åˆ°)
            { id: 104, title: "åŸ¹è¨“èª²ç¨‹å ±å", claimer: "æ—ä½³ç©", department: "å¸‚å ´è¡ŒéŠ·éƒ¨", total: 9800, submitDate: "2025-10-18 15:00", lastUpdate: "2025-10-19 10:00", status: "Rejected", approverNotes: "æ­¤èª²ç¨‹èˆ‡æœ¬å¹´åº¦éƒ¨é–€åŸ¹è¨“è¨ˆç•«ä¸ç¬¦ï¼Œè«‹æ”¹å ±å…§éƒ¨æŒ‡å®šèª²ç¨‹ã€‚", approverDate: "2025-10-19 10:00",
              purpose: "åƒåŠ  Google Analytics é«˜ç´šèª²ç¨‹ã€‚", details: ["èª²ç¨‹è²»ç”¨: TWD 9,800"], projectCode: "HR-2025-P02", accountCode: "æ•™è‚²è¨“ç·´èª²ç¨‹è²» (Course Fees)" },
            // ç‹å°æ˜çš„å¾…å¯©æ‰¹
            { id: 105, title: "é«˜é›„å‡ºå·®é«˜éµç¥¨", claimer: "ç‹å°æ˜", department: "æ¥­å‹™ç™¼å±•éƒ¨", total: 2980, submitDate: "2025-10-15 11:00", lastUpdate: "2025-10-15 11:00", status: "Pending", approverNotes: "", approverDate: "",
              purpose: "åƒåŠ é«˜é›„è¡Œæ¥­ç ”è¨æœƒã€‚", details: ["é«˜éµç¥¨(ä¾†å›): TWD 2,980"], projectCode: "P-2025-Q4-01", accountCode: "é«˜éµ/ç«è»Šç¥¨ (Rail Fare)" },
        ];
        
        // --- è²»ç”¨ç”³å ±è¡¨å–®æ•¸æ“š ---
        const expenseCategories = [
            { title: "ğŸ’¼ æ—…è²»åŠäº¤é€šè²»", subItems: ["åœ‹å…§å·®æ—…è²» (Domestic)", "åœ‹å¤–å·®æ—…è²» (International)", "å¸‚å€äº¤é€šè²» (Local Transit)", "é«˜éµ/ç«è»Šç¥¨ (Rail Fare)", "æ©Ÿç¥¨è²»ç”¨ (Airfare)", "ä½å®¿è²»ç”¨ (Accommodation)"] },
            { title: "ğŸ½ï¸ é¤è²»åŠæ‹›å¾…è²»", subItems: ["å®¢æˆ¶æ‹›å¾…è²» (Client Entertainment)", "å“¡å·¥ç¦åˆ©é¤è²» (Staff Welfare)", "å…§éƒ¨æœƒè­°é¤é£² (Internal Meeting F&B)"] },
            { title: "ğŸ“¦ è¾¦å…¬èˆ‡è¡Œæ”¿è²»", subItems: ["è¾¦å…¬ç”¨å“åŠè€—æ (Supplies)", "éƒµé›»/é€šè¨Šè²» (Post & Telecom)", "ç§Ÿé‡‘æ”¯å‡º (Rent Expense)", "æ°´é›»ç“¦æ–¯è²» (Utilities)", "ä¿®ç¹•èˆ‡ç¶­è­·è²» (Repair & Maint.)", "å ±ç« é›œèªŒè¨‚é–±è²» (Subscriptions)"] },
            { title: "ğŸ’» è³‡è¨Šèˆ‡è»Ÿé«”è²»", subItems: ["è»Ÿé«”è¨‚é–±è²» (Software Subscription)", "ç¡¬é«”æ¡è³¼è²» (Hardware Purchase)", "è³‡è¨Šæœå‹™è²» (IT Services)", "é›²ç«¯æœå‹™è²» (Cloud Services)", "ç¶²ç«™ç¶²åŸŸåç¨±è²» (Domain/Web Fees)"] },
            { title: "ğŸ“ˆ è¡ŒéŠ·èˆ‡æ¥­å‹™è²»", subItems: ["å»£å‘Šèˆ‡å®£å‚³è²» (Advertising)", "æ¥­å‹™äº¤éš›è²» (Sales Relations)", "å±•è¦½è²» (Exhibition Fees)", "å°åˆ·å®£å‚³å“ (Printed Materials)", "å¸‚å ´èª¿ç ”è²» (Market Research)"] },
            { title: "ğŸ“š åŸ¹è¨“èˆ‡äººæ‰è²»", subItems: ["å°ˆæ¥­åŸ¹è¨“è²» (Professional Training)", "æ‹›å‹Ÿè²»ç”¨ (Recruitment Costs)", "æ•™è‚²è¨“ç·´èª²ç¨‹è²» (Course Fees)", "å“¡å·¥å¥åº·æª¢æŸ¥è²» (Health Check-ups)"] },
            { title: "ğŸ§‘â€ğŸ’» å°ˆæ¥­æœå‹™è²»", subItems: ["é¡§å•è²» (Consulting)", "æ³•å¾‹åŠæœƒè¨ˆè²»ç”¨ (Legal & Accounting)", "å¤–éƒ¨å¯©è¨ˆè²» (External Audit)", "ç¿»è­¯/å£è­¯è²» (Translation/Interpreting)"] },
            { title: "ğŸ¦ è²¡å‹™èˆ‡é›œé …è²»", subItems: ["éŠ€è¡Œæ‰‹çºŒè²» (Bank Charges)", "åˆ©æ¯æ”¯å‡º (Interest Expense)", "æ”¿åºœè¦è²»èˆ‡ç½°é° (Fees & Penalties)", "ä¿éšªè²» (Insurance Premiums)", "æ…ˆå–„æè´ˆ (Donations)"] },
            { title: "â“ å…¶ä»–é›œé …è²»ç”¨", subItems: ["å…¶ä»–é›œé …è²»ç”¨ (Misc. Other)"] }
        ];

        // æ¨¡æ“¬å°ˆæ¡ˆæ¸…å–®/æ¨¡çµ„æ¡è³¼æ¸…å–®
        const mockProjects = [
            { id: '', name: 'è«‹é¸æ“‡å°ˆæ¡ˆ (å¿…é¸)' },
            { id: 'None', name: 'ç„¡é—œè¯å°ˆæ¡ˆ/ä¸€èˆ¬ç‡Ÿé‹' },
            { id: 'P2025-4', name: 'P2025-4 (DDR5 è¨˜æ†¶é«”æ¡è³¼)' },
            { id: 'P2025-5', name: 'P2025-5 (OLED é¡¯ç¤ºæ¨¡çµ„æ¡è³¼)' },
            { id: 'RND-001', name: 'RND-001 (ç”¢å“åŸå‹è¨­è¨ˆ)' },
        ];


        // å ±éŠ·äººè¦–åœ–ç‹€æ…‹
        let currentClaimerFilter = 'All';
        let currentEditingClaimId = null; // null for new claim

        // å¯©æ‰¹äººè¦–åœ–ç‹€æ…‹
        let currentApproverFilter = 'Pending';
        let selectedApproverClaimId = null;


        // === å…ƒç´ å¼•ç”¨ ===
        // (åœ¨ DOMContentLoaded ä¸­ç²å–)
        let claimerViewContainer, approverViewContainer, claimerViewBtn, approverViewBtn;
        let claimerDashboardView, claimerEditFormView, claimerClaimListBody;
        let newClaimFormView, newExpenseForm;
        let approverClaimListBody, approverDetailPlaceholder, approverClaimDetailView, approverPendingCount;
        let statPendingCount, statPendingTotal, statApprovedTotal;
        let messageBox, msgTitle, msgText;
        let compliancePrompt, complianceText;

        // === è¼”åŠ©å‡½æ•¸ï¼šç‹€æ…‹èˆ‡è¨Šæ¯ ===
        function getStatusText(status) {
            switch (status) {
                case 'Draft': return 'è‰ç¨¿';
                case 'Pending': return 'å¾…å¯©æ‰¹';
                case 'Approved': return 'å·²æ‰¹å‡†';
                case 'Rejected': return 'å·²é§å›';
                default: return 'æœªçŸ¥';
            }
        }

        function getStatusColor(status) {
            switch (status) {
                case 'Draft': return { bg: 'bg-status-draft/10', text: 'text-status-draft', primary: 'status-draft' };
                case 'Pending': return { bg: 'bg-status-pending/10', text: 'text-status-pending', primary: 'status-pending' };
                case 'Approved': return { bg: 'bg-status-approved/10', text: 'text-status-approved', primary: 'status-approved' };
                case 'Rejected': return { bg: 'bg-status-rejected/10', text: 'text-status-rejected', primary: 'status-rejected' };
                default: return { bg: 'bg-gray-100', text: 'text-gray-500', primary: 'gray' };
            }
        }
        
        function getProjectDisplayId(name) {
             const match = name.match(/^([^ (]+)/);
             return match ? match[1] : name;
        }

        function getProjectName(id) {
             if (!id) id = 'None';
             const project = mockProjects.find(p => p.id === id);
             return project ? getProjectDisplayId(project.name) : (id === 'None' ? 'ä¸€èˆ¬ç‡Ÿé‹' : id);
        }

        function showMessageBox(title, message, isError = false) {
            msgTitle.textContent = title;
            msgText.innerHTML = message;
            msgTitle.classList.toggle('text-status-rejected', isError);
            msgTitle.classList.toggle('text-primary-blue', !isError);
            messageBox.classList.remove('hidden');
            messageBox.classList.add('flex');
        }

        function closeMessageBox() {
            messageBox.classList.add('hidden');
            messageBox.classList.remove('flex');
            // å¦‚æœæ˜¯åœ¨å¯©æ‰¹äººè¦–åœ–æ‰¹å‡†/é§å›å¾Œï¼Œéœ€è¦é‡æ–°æ¸²æŸ“å„€è¡¨æ¿
            if (currentView === 'approver') {
                renderApproverDashboard();
            } else {
                renderClaimerDashboard();
            }
        }

        // === è¦–åœ–åˆ‡æ›é‚è¼¯ (ä¸»å°èˆª) ===
        // (çœç•¥ switchModule é‚è¼¯ï¼Œå› ç‚ºå®ƒèˆ‡ command_center.html ç›¸é—œ)
        // é€™è£¡æˆ‘å€‘åªç”¨ expense-center å…§éƒ¨çš„åˆ‡æ›é‚è¼¯
        
        // === è²»ç”¨ç®¡ç†ä¸­å¿ƒå­è¦–åœ–åˆ‡æ› (Expense Sub-View Logic) ===
        
        function switchView(subView) {
            currentView = subView;
            
            // éš±è—æ‰€æœ‰å­è¦–åœ–
            claimerDashboardView.classList.add('hidden');
            claimerEditFormView.classList.add('hidden');
            newClaimFormView.classList.add('hidden');
            approverViewContainer.classList.add('hidden');
            
            if (subView === 'claimer') {
                claimerViewContainer.classList.remove('hidden');
                claimerDashboardView.classList.remove('hidden');
                renderClaimerDashboard();
                claimerViewBtn.classList.add('active', 'bg-accent-orange', 'text-white');
                approverViewBtn.classList.remove('active', 'bg-accent-orange', 'text-white');
                approverViewBtn.classList.add('bg-white', 'text-primary-blue', 'hover:bg-gray-100');
            } else if (subView === 'approver') {
                claimerViewContainer.classList.add('hidden');
                approverViewContainer.classList.remove('hidden');
                renderApproverDashboard();
                approverViewBtn.classList.add('active', 'bg-accent-orange', 'text-white');
                claimerViewBtn.classList.remove('active', 'bg-accent-orange', 'text-white');
                claimerViewBtn.classList.add('bg-white', 'text-primary-blue', 'hover:bg-gray-100');
            }
        }

        // === å ±éŠ·äººè¦–åœ– (Claimer View) é‚è¼¯ ===

        function renderClaimerStats(userClaims) {
            const draftCount = userClaims.filter(c => c.status === 'Draft').length;
            const pendingCount = userClaims.filter(c => c.status === 'Pending').length;
            const rejectedCount = userClaims.filter(c => c.status === 'Rejected').length;
            
            document.getElementById('statClaimerDraft').textContent = draftCount;
            document.getElementById('statClaimerPending').textContent = pendingCount;
            document.getElementById('statClaimerRejected').textContent = rejectedCount;
        }

        function createNewClaim() {
            currentEditingClaimId = null; 

            claimerDashboardView.classList.add('hidden');
            claimerEditFormView.classList.add('hidden');
            newClaimFormView.classList.remove('hidden');

            newExpenseForm.reset();
            renderNewClaimFormSelects();
            checkCompliance(); // åˆå§‹åŒ–æ™‚ä¹Ÿæª¢æŸ¥ä¸€æ¬¡ (ç¢ºä¿æç¤ºæ¡†éš±è—)
        }
        
        function renderNewClaimFormSelects() {
            const finalSelect = document.getElementById('new-category-final');
            const projectSelect = document.getElementById('new-project');
            
            if (!finalSelect || !projectSelect) return;
            
            finalSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡è²»ç”¨ç§‘ç›® (å¤§é … | ç´°ç›®)</option>';
            expenseCategories.forEach(cat => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = cat.title;
                cat.subItems.forEach(minor => {
                    const option = document.createElement('option');
                    option.value = `${cat.title} | ${minor}`;
                    option.textContent = minor;
                    optgroup.appendChild(option);
                });
                finalSelect.appendChild(optgroup);
            });
            
            projectSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡å°ˆæ¡ˆ (å¿…é¸)</option>';
            mockProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${project.id} - ${project.name.replace(/ *\([^)]*\) */g, "")}`;
                if (project.id === '') {
                    option.disabled = true;
                }
                if (project.id === 'None') { // é è¨­é¸ä¸­ 'None'
                    option.selected = true;
                }
                projectSelect.appendChild(option);
            });
        }
        
        // â˜…â˜…â˜… æ–°å¢ï¼šå³æ™‚æ³•è¦æª¢æŸ¥ â˜…â˜…â˜…
        function checkCompliance() {
            const categorySelect = document.getElementById('new-category-final');
            const amountInput = document.getElementById('new-amount');
            const promptBox = document.getElementById('compliance-prompt');
            const promptText = document.getElementById('compliance-text').querySelector('ul');

            if (!categorySelect || !amountInput || !promptBox || !promptText) return;

            const selectedCategory = categorySelect.value || "";
            const amount = parseFloat(amountInput.value) || 0;
            
            let messages = [];

            // è¦å‰‡ 1: ç§‘ç›®
            if (selectedCategory.includes("å®¢æˆ¶æ‹›å¾…è²»")) {
                messages.push("ã€Œå®¢æˆ¶æ‹›å¾…è²»ã€ï¼šä¾è¦å®šéœ€ä¸Šå‚³ç™¼ç¥¨æ­£æœ¬ï¼Œä¸¦åœ¨èªªæ˜æ¬„è¨»æ˜å°æ–¹å–®ä½èˆ‡äº‹ç”±ã€‚");
            }
            if (selectedCategory.includes("ç¦®å“") || selectedCategory.includes("æè´ˆ")) {
                messages.push("ã€Œç¦®å“/æè´ˆã€ï¼šè«‹ç¢ºèªç¬¦åˆå…¬å¸å…¬é—œæ”¿ç­–ï¼Œä¸¦å–å¾—æ ¸å¯ã€‚");
            }

            // è¦å‰‡ 2: é‡‘é¡
            if (amount > 5000) {
                messages.push("é‡‘é¡è¶…é $5,000ï¼šä¾è¦å®šéœ€é™„ä¸Šä¼°åƒ¹å–®æˆ–åˆç´„å‰¯æœ¬ã€‚");
            }
            if (amount > 50000) {
                messages.push("é‡‘é¡è¶…é $50,000ï¼šæ­¤å–®æ“šéœ€ç¶“ç¸½ç¶“ç†å®¤è¤‡æ ¸ã€‚");
            }

            // æ¸²æŸ“æç¤º
            if (messages.length > 0) {
                promptText.innerHTML = messages.map(msg => `<li>${msg}</li>`).join('');
                promptBox.classList.remove('hidden');
            } else {
                promptBox.classList.add('hidden');
                promptText.innerHTML = '';
            }
        }


        function renderClaimerDashboard() {
            claimerDashboardView.classList.remove('hidden');
            claimerEditFormView.classList.add('hidden');
            newClaimFormView.classList.add('hidden'); 

            claimerClaimListBody.innerHTML = '';

            let userClaims = mockClaims.filter(claim => claim.claimer === CURRENT_USER_NAME);
            
            renderClaimerStats(userClaims); 

            const filteredClaims = userClaims.filter(claim =>
                currentClaimerFilter === 'All' || claim.status === currentClaimerFilter
            ).sort((a, b) => b.id - a.id);

            document.getElementById('claimerName').textContent = CURRENT_USER_NAME;

            if (filteredClaims.length === 0) {
                claimerClaimListBody.innerHTML = `<tr><td colspan="5" class="p-6 text-center text-gray-500 italic">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å ±éŠ·å–®ã€‚</td></tr>`;
                return;
            }

            filteredClaims.forEach(claim => {
                const row = claimerClaimListBody.insertRow();
                row.className = `claim-row hover:shadow-md transition duration-150`;

                let cell = row.insertCell();
                cell.className = 'px-4 py-3 text-sm font-medium text-gray-900 truncate max-w-xs';
                cell.textContent = claim.title;

                let cellProj = row.insertCell();
                cellProj.className = 'px-4 py-3 text-xs text-gray-500';
                cellProj.textContent = getProjectName(claim.projectCode); 

                let cellTotal = row.insertCell();
                cellTotal.className = 'px-4 py-3 text-sm text-left text-gray-700 font-semibold';
                cellTotal.textContent = `TWD ${claim.total.toLocaleString()}`;

                let cellStatus = row.insertCell();
                cellStatus.className = 'px-4 py-3 text-left';
                const statusColor = getStatusColor(claim.status);
                cellStatus.innerHTML = `<span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor.bg} ${statusColor.text}">${getStatusText(claim.status)}</span>`;
                
                let cellAction = row.insertCell();
                cellAction.className = 'px-4 py-3 text-right';

                if (claim.status === 'Draft' || claim.status === 'Rejected') {
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'ç·¨è¼¯';
                    editBtn.className = 'text-sm font-medium text-primary-blue hover:text-accent-orange transition duration-150';
                    editBtn.onclick = () => loadEditForm(claim.id);
                    cellAction.appendChild(editBtn);
                } else {
                    cellAction.textContent = 'æŸ¥çœ‹';
                    cellAction.onclick = () => showMessageBox("è©³æƒ…", `å ±éŠ·å–® #${claim.id} ç‹€æ…‹ç‚º ${getStatusText(claim.status)}ã€‚`);
                    cellAction.classList.add('cursor-pointer', 'text-gray-500');
                }
            });

            updateClaimerFilterStyles();
        }
        
        function changeClaimerFilter(filter) {
            currentClaimerFilter = filter;
            renderClaimerDashboard();
        }

        function updateClaimerFilterStyles() {
            document.querySelectorAll('.claimer-filter-btn').forEach(btn => {
                if (btn.dataset.filter === currentClaimerFilter) {
                    btn.classList.replace('bg-gray-200', 'bg-primary-blue');
                    btn.classList.replace('text-gray-700', 'text-white');
                    btn.classList.remove('hover:bg-gray-300');
                } else {
                    btn.classList.replace('bg-primary-blue', 'bg-gray-200');
                    btn.classList.replace('text-white', 'text-gray-700');
                    btn.classList.add('hover:bg-gray-300');
                }
            });
        }
        
        function populateProjectSelect_EditForm(currentProjectId) {
            const editProjectIdSelect = document.getElementById('editProjectId');
            editProjectIdSelect.innerHTML = '';
            mockProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${project.id} - ${project.name.replace(/ *\([^)]*\) */g, "")}`;
                if (project.id === currentProjectId) {
                    option.selected = true;
                }
                editProjectIdSelect.appendChild(option);
            });
        }
        
        function loadEditForm(id) {
            const claim = mockClaims.find(c => c.id === id);
            if (!claim || claim.claimer !== CURRENT_USER_NAME) {
                showMessageBox("éŒ¯èª¤", "æ‰¾ä¸åˆ°è©²å ±éŠ·å–®æˆ–æ‚¨ç„¡æ¬Šç·¨è¼¯ã€‚", true);
                return;
            }

            currentEditingClaimId = id;

            claimerDashboardView.classList.add('hidden');
            newClaimFormView.classList.add('hidden');
            claimerEditFormView.classList.remove('hidden');

            document.getElementById('editClaimIdDisplay').textContent = `#${claim.id}`;
            document.getElementById('formActionTitle').textContent = `ç·¨è¼¯`;
            document.getElementById('editTitle').value = claim.title;
            document.getElementById('editTotal').value = claim.total;
            document.getElementById('editPurpose').value = claim.purpose;
            document.getElementById('editDetails').value = claim.details.join('\n');
            
            populateProjectSelect_EditForm(claim.projectCode || 'None'); 

            const rejectedReasonBox = document.getElementById('rejectedReasonBox');
            if (claim.status === 'Rejected') {
                rejectedReasonBox.classList.remove('hidden');
                document.getElementById('rejectedReasonText').textContent = claim.approverNotes || 'å¯©æ‰¹äººæœªæä¾›å…·é«”é§å›ç†ç”±ã€‚';
                document.getElementById('saveDraftText').textContent = 'å„²å­˜ä¿®æ”¹';
                document.getElementById('resubmitText').textContent = 'é‡æ–°æäº¤å¯©æ‰¹';
            } else {
                rejectedReasonBox.classList.add('hidden');
                document.getElementById('saveDraftText').textContent = 'å„²å­˜è‰ç¨¿';
                document.getElementById('resubmitText').textContent = 'ç›´æ¥æäº¤å¯©æ‰¹';
            }
        }
        
        function cancelEdit() {
            currentEditingClaimId = null;
            claimerEditFormView.classList.add('hidden');
            newClaimFormView.classList.add('hidden'); 
            claimerDashboardView.classList.remove('hidden');
            renderClaimerDashboard();
        }
        
        function generateNewId() {
            const maxId = (mockClaims.length > 0) ? Math.max(...mockClaims.map(c => c.id)) : 100;
            return maxId + 1;
        }

        function saveClaim(newStatus) {
            const newTotal = parseInt(document.getElementById('editTotal').value, 10);
            const newDetailsString = document.getElementById('editDetails').value.trim();
            const newTitle = document.getElementById('editTitle').value.trim();
            const newPurpose = document.getElementById('editPurpose').value.trim();
            const newProjectId = document.getElementById('editProjectId').value; 

            if (newTotal <= 0 || !newTitle || !newPurpose || !newDetailsString) {
                showMessageBox("éŒ¯èª¤", "è«‹ç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½å·²å¡«å¯«ä¸¦é‡‘é¡æœ‰æ•ˆã€‚", true);
                return;
            }

            const currentTime = getFormattedDate();
            let claimId = currentEditingClaimId;
            let messageAction = 'ä¿®æ”¹ä¸¦å„²å­˜';
            
            const index = mockClaims.findIndex(c => c.id === currentEditingClaimId);
            if (index === -1) {
                 showMessageBox("éŒ¯èª¤", "å„²å­˜å¤±æ•—ï¼Œæ‰¾ä¸åˆ°å ±éŠ·å–®ã€‚", true);
                 return;
            }
            
            if (mockClaims[index].status === 'Rejected' && newStatus === 'Pending') {
                messageAction = 'é‡æ–°æäº¤';
            }

            // æ›´æ–°æ•¸æ“š
            mockClaims[index].title = newTitle;
            mockClaims[index].total = newTotal;
            mockClaims[index].status = newStatus;
            mockClaims[index].projectCode = newProjectId; 
            mockClaims[index].purpose = newPurpose;
            mockClaims[index].details = newDetailsString.split('\n').map(d => d.trim()).filter(d => d.length > 0);
            mockClaims[index].lastUpdate = currentTime;
            
            if (newStatus === 'Pending' && mockClaims[index].status !== 'Pending') {
                mockClaims[index].submitDate = currentTime; 
            }

            showMessageBox(`${getStatusText(newStatus)} æˆåŠŸ`, `å ±éŠ·å–® #${claimId} å·²æˆåŠŸ${messageAction}ã€‚`);
            cancelEdit(); // è¿”å›å ±éŠ·äººå„€è¡¨æ¿
        }
        
        // â˜…â˜…â˜… è™•ç†æ–°å»ºè¡¨å–®çš„æäº¤ â˜…â˜…â˜…
        function handleNewExpenseSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const categoryFinal = formData.get('category-final');
            const projectId = formData.get('project-id'); 
            const amount = parseFloat(formData.get('amount'));

            if (!form.checkValidity() || projectId === "" || categoryFinal === "" || categoryFinal === null || isNaN(amount) || amount <= 0) {
                 showMessageBox("éŒ¯èª¤", "è«‹ç¢ºä¿æ‰€æœ‰å¿…å¡«æ¬„ä½éƒ½å·²å¡«å¯«ï¼Œä¸”é‡‘é¡æœ‰æ•ˆã€‚", true);
                 form.reportValidity();
                 return;
            }
            
            const [majorCategoryTitle, minorCategory] = categoryFinal.split('|').map(s => s.trim());
            const claimId = generateNewId();

            const newClaim = {
                id: claimId,
                title: `${minorCategory} - ${formData.get('date')}`,
                total: amount,
                submitDate: new Date().toISOString().slice(0, 10),
                lastUpdate: new Date().toISOString().slice(0, 10),
                status: 'Draft', 
                projectCode: projectId, 
                accountCode: minorCategory, 
                purpose: formData.get('description') || 'ç„¡è©³ç´°èªªæ˜',
                details: [`${minorCategory}: ${formData.get('currency')} ${formData.get('amount')}`],
                claimer: CURRENT_USER_NAME,
                department: "æ¥­å‹™ç™¼å±•éƒ¨"
            };

            mockClaims.push(newClaim);
            
            showMessageBox(
                `è‰ç¨¿å·²å»ºç«‹`, 
                `å ±éŠ·å–® #${claimId} (${minorCategory}) å·²æˆåŠŸå„²å­˜ç‚ºè‰ç¨¿ã€‚`
            );
            
            form.reset();
            cancelEdit(); // è¿”å›å„€è¡¨æ¿
        }

        
        // === å¯©æ‰¹äººè¦–åœ– (Approver View) é‚è¼¯ ===

        function renderApproverStats(claims) {
            const pendingClaims = claims.filter(c => c.status === 'Pending');
            const approvedClaims = claims.filter(c => c.status === 'Approved');

            const pendingCount = pendingClaims.length;
            const pendingTotal = pendingClaims.reduce((sum, c) => sum + c.total, 0);
            const approvedTotal = approvedClaims.reduce((sum, c) => sum + c.total, 0);

            statPendingCount.textContent = pendingCount.toLocaleString();
            statPendingTotal.textContent = pendingTotal.toLocaleString();
            statApprovedTotal.textContent = approvedTotal.toLocaleString();
        }

        function renderApproverDashboard() {
            const claimsForApprover = mockClaims.filter(c => c.status !== 'Draft');
            renderApproverStats(claimsForApprover);
            const filteredClaims = claimsForApprover.filter(claim => claim.status === currentApproverFilter);
            approverPendingCount.textContent = claimsForApprover.filter(c => c.status === 'Pending').length;

            approverClaimListBody.innerHTML = '';
            if (filteredClaims.length === 0) {
                 approverClaimListBody.innerHTML = `<tr><td colspan="3" class="p-6 text-center text-gray-500 italic">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å ±éŠ·å–®ã€‚</td></tr>`;
                 hideApproverDetailView();
                 return;
            }

            filteredClaims.forEach(claim => {
                const row = approverClaimListBody.insertRow();
                row.className = `claim-row ${(selectedApproverClaimId === claim.id) ? 'active' : ''}`;
                row.dataset.id = claim.id;
                row.onclick = () => selectApproverClaim(claim.id);

                let cell = row.insertCell();
                cell.className = 'px-4 py-3 text-sm font-medium text-gray-900 truncate max-w-xs';
                cell.innerHTML = `<strong>#${claim.id} - ${claim.title}</strong><br><span class="text-xs text-gray-500">${claim.claimer}</span>`;

                let cellTotal = row.insertCell();
                cellTotal.className = 'px-4 py-3 text-sm text-left text-gray-700 font-semibold';
                cellTotal.textContent = `TWD ${claim.total.toLocaleString()}`;

                let cellStatus = row.insertCell();
                cellStatus.className = 'px-4 py-3 text-center';
                const statusColor = getStatusColor(claim.status);
                cellStatus.innerHTML = `<span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor.bg} ${statusColor.text}">${getStatusText(claim.status)}</span>`;
            });

            updateApproverTabStyles();

            if (selectedApproverClaimId && filteredClaims.some(c => c.id === selectedApproverClaimId)) {
                selectApproverClaim(selectedApproverClaimId);
            } else {
                 hideApproverDetailView();
            }
        }

        function updateApproverTabStyles() {
            document.querySelectorAll('.approver-status-tab').forEach(tab => {
                if (tab.dataset.status === currentApproverFilter) {
                    tab.classList.replace('bg-gray-200', 'bg-primary-blue');
                    tab.classList.replace('text-gray-700', 'text-white');
                    tab.classList.remove('hover:bg-gray-300');
                } else {
                    tab.classList.replace('bg-primary-blue', 'bg-gray-200');
                    tab.classList.replace('text-white', 'text-gray-700');
                    tab.classList.add('hover:bg-gray-300');
                }
            });
        }

        function changeApproverFilter(filter) {
            currentApproverFilter = filter;
            renderApproverDashboard();
        }

        function selectApproverClaim(id) {
            const claim = mockClaims.find(c => c.id === id);
            if (!claim || claim.status === 'Draft') {
                hideApproverDetailView();
                return;
            }
            selectedApproverClaimId = id;

            document.querySelectorAll('#approverClaimListBody .claim-row').forEach(row => {
                row.classList.remove('active');
                if (parseInt(row.dataset.id) === id) {
                    row.classList.add('active');
                }
            });

            approverDetailPlaceholder.classList.add('hidden');
            approverClaimDetailView.classList.remove('hidden');

            document.getElementById('approverDetailTitle').textContent = `å ±éŠ·å–® #${claim.id}: ${claim.title}`;
            document.getElementById('approverDetailClaimer').textContent = claim.claimer;
            document.getElementById('approverDetailDepartment').textContent = claim.department;
            document.getElementById('approverDetailProjectCode').textContent = claim.projectCode;
            document.getElementById('approverDetailAccountCode').textContent = claim.accountCode;
            document.getElementById('approverDetailSubmitDate').textContent = claim.submitDate; 
            document.getElementById('approverDetailTotal').textContent = `TWD ${claim.total.toLocaleString()}`;
            document.getElementById('approverDetailPurpose').textContent = claim.purpose;

            const statusColor = getStatusColor(claim.status);
            document.getElementById('approverDetailStatus').textContent = getStatusText(claim.status);
            document.getElementById('approverDetailStatus').className = `px-3 py-1 text-xs font-semibold rounded-full ${statusColor.bg} ${statusColor.text}`;

            const detailsList = document.getElementById('approverDetailMockDetails');
            detailsList.innerHTML = '';
            claim.details.forEach(detail => {
                const li = document.createElement('li');
                li.textContent = detail;
                detailsList.appendChild(li);
            });

            const approverActionsDiv = document.getElementById('approverActionsDiv');
            const approverHistoryDiv = document.getElementById('approverHistoryDiv');

            if (claim.status === 'Pending') {
                approverActionsDiv.classList.remove('hidden');
                approverHistoryDiv.classList.add('hidden');
                document.getElementById('approverActionTitle').textContent = "å¯©æ‰¹æ„è¦‹èˆ‡æ“ä½œ";
                document.getElementById('approverNotesInput').value = '';
                document.getElementById('approverNotesInput').disabled = false;
            } else {
                approverActionsDiv.classList.add('hidden');
                approverHistoryDiv.classList.remove('hidden');
                document.getElementById('approverActionTitle').textContent = "å¯©æ‰¹æ­·å²è¨˜éŒ„";
                const historyStatus = document.getElementById('approverHistoryStatus');
                historyStatus.textContent = `å¯©æ‰¹çµæœ: ${getStatusText(claim.status)}`;
                historyStatus.style.color = statusColor.text;
                document.getElementById('approverHistoryNotes').textContent = claim.approverNotes || 'ç„¡å‚™è¨»ã€‚';
                document.getElementById('approverHistoryDate').textContent = claim.approverDate;
            }
        }

        function hideApproverDetailView() {
            selectedApproverClaimId = null;
            approverDetailPlaceholder.classList.remove('hidden');
            approverClaimDetailView.classList.add('hidden');
        }

        function handleApproval(newStatus) {
            const claimIndex = mockClaims.findIndex(c => c.id === selectedApproverClaimId);
            if (claimIndex === -1 || mockClaims[claimIndex].status !== 'Pending') {
                showMessageBox("éŒ¯èª¤", "å ±éŠ·å–®ç‹€æ…‹ä¸æ­£ç¢ºæˆ–æœªé¸ä¸­ã€‚", true);
                return;
            }

            const notes = document.getElementById('approverNotesInput').value.trim();
            const currentTime = getFormattedDate();

            if (newStatus === 'Rejected' && !notes) {
                 showMessageBox("é§å›å¤±æ•—", "é§å›æ™‚ï¼Œå¿…é ˆå¡«å¯«é§å›ç†ç”±ã€‚", true);
                 return;
            }

            mockClaims[claimIndex].approverNotes = notes || (newStatus === 'Approved' ? "å¯©æ‰¹é€šéã€‚" : "");
            mockClaims[claimAacountCode].status = newStatus;
            mockClaims[claimIndex].approverDate = currentTime; 
            mockClaims[claimIndex].lastUpdate = currentTime;

            showMessageBox(
                `${getStatusText(newStatus)} æˆåŠŸ`,
                `å ±éŠ·å–® #${mockClaims[claimIndex].id} å·²è¢«${getStatusText(newStatus)}ã€‚`
            );
            
            currentApproverFilter = newStatus;
        }


        // === æ‡‰ç”¨ç¨‹åºåˆå§‹åŒ– ===
        document.addEventListener('DOMContentLoaded', () => {
            // ç²å–æ‰€æœ‰å…ƒç´ å¼•ç”¨
            claimerViewContainer = document.getElementById('claimerViewContainer');
            approverViewContainer = document.getElementById('approverViewContainer');
            claimerViewBtn = document.getElementById('claimerViewBtn');
            approverViewBtn = document.getElementById('approverViewBtn');
            claimerDashboardView = document.getElementById('claimerDashboardView');
            claimerEditFormView = document.getElementById('claimerEditFormView');
            claimerClaimListBody = document.getElementById('claimerClaimListBody');
            newClaimFormView = document.getElementById('newClaimFormView');
            newExpenseForm = document.getElementById('newExpenseForm');
            approverClaimListBody = document.getElementById('approverClaimListBody');
            approverDetailPlaceholder = document.getElementById('approverDetailPlaceholder');
            approverClaimDetailView = document.getElementById('approverClaimDetailView');
            approverPendingCount = document.getElementById('approverPendingCount');
            statPendingCount = document.getElementById('statPendingCount');
            statPendingTotal = document.getElementById('statPendingTotal');
            statApprovedTotal = document.getElementById('statApprovedTotal');
            messageBox = document.getElementById('messageBox');
            msgTitle = document.getElementById('msgTitle');
            msgText = document.getElementById('msgText');
            compliancePrompt = document.getElementById('compliance-prompt');
            complianceText = document.getElementById('compliance-text').querySelector('ul');


            // ç¶å®šæ–°è¡¨å–®çš„æäº¤äº‹ä»¶
            if (newExpenseForm) {
                newExpenseForm.addEventListener('submit', handleNewExpenseSubmit);
            }
            
            // é è¨­ç‚ºå ±éŠ·äººè¦–åœ–
            switchView('claimer');
        };

    </script>
</body>
</html>
